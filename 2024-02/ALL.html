<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Lovem & ndash; the low overhead virtual embedded machine. And the journey getting there."><meta name=author content=kratenko><link rel=canonical href=https://kratenko.github.io/lovem/2024-02/ALL.html><link rel=icon href=../assets/images/favicon.png><meta name=generator content="mkdocs-1.5.3, mkdocs-material-8.5.10"><title>February 2024 complete - Lovem</title><link rel=stylesheet href=../assets/stylesheets/main.975780f9.min.css><link rel=stylesheet href=../assets/stylesheets/palette.2505c338.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../stylesheets/custom.css><script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=None data-md-color-accent=None> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#complete-month-of-february-2024 class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../index.html title=Lovem class="md-header__button md-logo" aria-label=Lovem data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Lovem </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> February 2024 complete </span> </div> </div> </div> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/kratenko/lovem title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> kratenko/lovem </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../index.html title=Lovem class="md-nav__button md-logo" aria-label=Lovem data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg> </a> Lovem </label> <div class=md-nav__source> <a href=https://github.com/kratenko/lovem title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> kratenko/lovem </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../index.html class=md-nav__link> The Journey </a> </li> <li class=md-nav__item> <a href=../source-code.html class=md-nav__link> Source Code </a> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle=__nav_3 type=checkbox id=__nav_3 checked> <div class="md-nav__link md-nav__link--index "> <a href=../journal/index.html>Journal</a> <label for=__nav_3> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav aria-label=Journal data-md-level=1> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Journal </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle=__nav_3_2 type=checkbox id=__nav_3_2 checked> <div class="md-nav__link md-nav__link--index "> <a href=index.html>February 2024</a> <label for=__nav_3_2> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav aria-label="February 2024" data-md-level=2> <label class=md-nav__title for=__nav_3_2> <span class="md-nav__icon md-icon"></span> February 2024 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=we-have-variables.html class=md-nav__link> We have variables! </a> </li> <li class=md-nav__item> <a href=stop-right-there-that-s-far-enough.html class=md-nav__link> Stop right there, that's far enough! </a> </li> <li class=md-nav__item> <a href=it-has-been-a-while.html class=md-nav__link> It has been a while... </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle=__nav_3_3 type=checkbox id=__nav_3_3 checked> <div class="md-nav__link md-nav__link--index "> <a href=../2022-08/index.html>August 2022</a> <label for=__nav_3_3> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav aria-label="August 2022" data-md-level=2> <label class=md-nav__title for=__nav_3_3> <span class="md-nav__icon md-icon"></span> August 2022 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../2022-08/what-if.html class=md-nav__link> What if? </a> </li> <li class=md-nav__item> <a href=../2022-08/you-labeled-me-i-ll-label-you.html class=md-nav__link> You labeled me, I'll label you </a> </li> <li class=md-nav__item> <a href=../2022-08/running-assembler-programs.html class=md-nav__link> Running assembler programs </a> </li> <li class=md-nav__item> <a href=../2022-08/assembling-bytes.html class=md-nav__link> Assembling bytes </a> </li> <li class=md-nav__item> <a href=../2022-08/handling-instructions.html class=md-nav__link> Handling instructions </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle=__nav_3_4 type=checkbox id=__nav_3_4 checked> <div class="md-nav__link md-nav__link--index "> <a href=../2022-07/index.html>July 2022</a> <label for=__nav_3_4> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav aria-label="July 2022" data-md-level=2> <label class=md-nav__title for=__nav_3_4> <span class="md-nav__icon md-icon"></span> July 2022 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../2022-07/parsing-the-source.html class=md-nav__link> Parsing the source </a> </li> <li class=md-nav__item> <a href=../2022-07/assemble.html class=md-nav__link> Assemble! </a> </li> <li class=md-nav__item> <a href=../2022-07/don-t-byte-me.html class=md-nav__link> Don't byte me! </a> </li> <li class=md-nav__item> <a href=../2022-07/go-ahead-and-jump.html class=md-nav__link> Go ahead and jump! </a> </li> <li class=md-nav__item> <a href=../2022-07/reverse-polish-notation.html class=md-nav__link> Reverse polish notation </a> </li> <li class=md-nav__item> <a href=../2022-07/more-operations.html class=md-nav__link> More operations </a> </li> <li class=md-nav__item> <a href=../2022-07/early-vm-decisions.html class=md-nav__link> Early VM decisions </a> </li> <li class=md-nav__item> <a href=../2022-07/to-the-library.html class=md-nav__link> To the library! </a> </li> <li class=md-nav__item> <a href=../2022-07/becoming-social.html class=md-nav__link> Becoming social </a> </li> <li class=md-nav__item> <a href=../2022-07/turn-fragile-into-rusty.html class=md-nav__link> Turn "fragile" into "rusty" </a> </li> <li class=md-nav__item> <a href=../2022-07/running-our-first-program.html class=md-nav__link> Running our first program </a> </li> <li class=md-nav__item> <a href=../2022-07/a-vm.html class=md-nav__link> A VM </a> </li> <li class=md-nav__item> <a href=../2022-07/it-looks-so-weird.html class=md-nav__link> It looks so weird </a> </li> <li class=md-nav__item> <a href=../2022-07/let-there-be-source-code.html class=md-nav__link> Let there be source code </a> </li> <li class=md-nav__item> <a href=../2022-07/making-virtual-a-reality.html class=md-nav__link> Making virtual a reality </a> </li> <li class=md-nav__item> <a href=../2022-07/what-is-a-virtual-machine-anyway.html class=md-nav__link> What is a Virtual Machine anyway? </a> </li> <li class=md-nav__item> <a href=../2022-07/all-new-once-more.html class=md-nav__link> All new once more </a> </li> <li class=md-nav__item> <a href=../2022-07/state-of-the-journal.html class=md-nav__link> State of the Journal </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle=__nav_3_5 type=checkbox id=__nav_3_5 checked> <div class="md-nav__link md-nav__link--index "> <a href=../2022-06/index.html>June 2022</a> <label for=__nav_3_5> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav aria-label="June 2022" data-md-level=2> <label class=md-nav__title for=__nav_3_5> <span class="md-nav__icon md-icon"></span> June 2022 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../2022-06/script-or-virtual.html class=md-nav__link> Script or virtual </a> </li> <li class=md-nav__item> <a href=../2022-06/that-use-case.html class=md-nav__link> That use-case I was talking about </a> </li> <li class=md-nav__item> <a href=../2022-06/we-need-another-wheel.html class=md-nav__link> We need another wheel </a> </li> <li class=md-nav__item> <a href=../2022-06/lovem-again.html class=md-nav__link> Lovem again! </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4 type=checkbox id=__nav_4 checked> <label class=md-nav__link for=__nav_4> Journal (complete months) <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Journal (complete months)" data-md-level=1> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Journal (complete months) </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> February 2024 complete <span class="md-nav__icon md-icon"></span> </label> <a href=ALL.html class="md-nav__link md-nav__link--active"> February 2024 complete </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#it-has-been-a-while class=md-nav__link> It has been a while... </a> </li> <li class=md-nav__item> <a href=#stop-right-there-thats-far-enough class=md-nav__link> Stop right there, that's far enough! </a> <nav class=md-nav aria-label="Stop right there, that's far enough!"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#looping-a-long-time class=md-nav__link> Looping a long time </a> </li> <li class=md-nav__item> <a href=#limited-execution class=md-nav__link> Limited execution </a> </li> <li class=md-nav__item> <a href=#testing-it class=md-nav__link> Testing it </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#we-have-variables class=md-nav__link> We have variables! </a> <nav class=md-nav aria-label="We have variables!"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#tell-me-were-to-stick-it class=md-nav__link> Tell me were to stick it </a> </li> <li class=md-nav__item> <a href=#variable-operations class=md-nav__link> Variable operations </a> </li> <li class=md-nav__item> <a href=#variables-in-the-assembler class=md-nav__link> Variables in the assembler </a> </li> <li class=md-nav__item> <a href=#a-new-program class=md-nav__link> A new Program </a> </li> <li class=md-nav__item> <a href=#variables-in-the-vm class=md-nav__link> Variables in the VM </a> </li> <li class=md-nav__item> <a href=#show-me-your-values class=md-nav__link> Show me your values </a> </li> <li class=md-nav__item> <a href=#a-new-program_1 class=md-nav__link> A new program! </a> </li> <li class=md-nav__item> <a href=#oh-and-a-bugfix class=md-nav__link> Oh... and a bugfix </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../2022-08/ALL.html class=md-nav__link> August 2022 complete </a> </li> <li class=md-nav__item> <a href=../2022-07/ALL.html class=md-nav__link> July 2022 complete </a> </li> <li class=md-nav__item> <a href=../2022-06/ALL.html class=md-nav__link> June 2022 complete </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#it-has-been-a-while class=md-nav__link> It has been a while... </a> </li> <li class=md-nav__item> <a href=#stop-right-there-thats-far-enough class=md-nav__link> Stop right there, that's far enough! </a> <nav class=md-nav aria-label="Stop right there, that's far enough!"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#looping-a-long-time class=md-nav__link> Looping a long time </a> </li> <li class=md-nav__item> <a href=#limited-execution class=md-nav__link> Limited execution </a> </li> <li class=md-nav__item> <a href=#testing-it class=md-nav__link> Testing it </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#we-have-variables class=md-nav__link> We have variables! </a> <nav class=md-nav aria-label="We have variables!"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#tell-me-were-to-stick-it class=md-nav__link> Tell me were to stick it </a> </li> <li class=md-nav__item> <a href=#variable-operations class=md-nav__link> Variable operations </a> </li> <li class=md-nav__item> <a href=#variables-in-the-assembler class=md-nav__link> Variables in the assembler </a> </li> <li class=md-nav__item> <a href=#a-new-program class=md-nav__link> A new Program </a> </li> <li class=md-nav__item> <a href=#variables-in-the-vm class=md-nav__link> Variables in the VM </a> </li> <li class=md-nav__item> <a href=#show-me-your-values class=md-nav__link> Show me your values </a> </li> <li class=md-nav__item> <a href=#a-new-program_1 class=md-nav__link> A new program! </a> </li> <li class=md-nav__item> <a href=#oh-and-a-bugfix class=md-nav__link> Oh... and a bugfix </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=complete-month-of-february-2024>Complete month of February 2024<a class=headerlink href=#complete-month-of-february-2024 title="Permanent link">&para;</a></h1> <h2 id=it-has-been-a-while>It has been a while...<a class=headerlink href=#it-has-been-a-while title="Permanent link">&para;</a></h2> <p><strong>Love is not dead! It just got distracted.</strong></p> <aside class=mdx-author> <p><img alt=@kratenko src=https://avatars.githubusercontent.com/kratenko></p> <p><span><strong>kratenko</strong> · <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 16 16"><path fill-rule=evenodd d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"/></svg></span> <a href=https://github.com/kratenko>kratenko</a></span> <span> <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path fill-rule=evenodd d="M6.75 0a.75.75 0 0 1 .75.75V3h9V.75a.75.75 0 0 1 1.5 0V3h2.75c.966 0 1.75.784 1.75 1.75v16a1.75 1.75 0 0 1-1.75 1.75H3.25a1.75 1.75 0 0 1-1.75-1.75v-16C1.5 3.784 2.284 3 3.25 3H6V.75A.75.75 0 0 1 6.75 0zm-3.5 4.5a.25.25 0 0 0-.25.25V8h18V4.75a.25.25 0 0 0-.25-.25H3.25zM21 9.5H3v11.25c0 .138.112.25.25.25h17.5a.25.25 0 0 0 .25-.25V9.5z"/></svg></span> 2024-02-01 · <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path fill-rule=evenodd d="M0 3.75A.75.75 0 0 1 .75 3h7.497c1.566 0 2.945.8 3.751 2.014A4.496 4.496 0 0 1 15.75 3h7.5a.75.75 0 0 1 .75.75v15.063a.75.75 0 0 1-.755.75l-7.682-.052a3 3 0 0 0-2.142.878l-.89.891a.75.75 0 0 1-1.061 0l-.902-.901a3 3 0 0 0-2.121-.879H.75a.75.75 0 0 1-.75-.75v-15zm11.247 3.747a3 3 0 0 0-3-2.997H1.5V18h6.947a4.5 4.5 0 0 1 2.803.98l-.003-11.483zm1.503 11.485V7.5a3 3 0 0 1 3-3h6.75v13.558l-6.927-.047a4.5 4.5 0 0 0-2.823.971z"/></svg></span> Entry #28 · <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12.5 7.25a.75.75 0 0 0-1.5 0v5.5c0 .27.144.518.378.651l3.5 2a.75.75 0 0 0 .744-1.302L12.5 12.315V7.25z"/><path fill-rule=evenodd d="M12 1C5.925 1 1 5.925 1 12s4.925 11 11 11 11-4.925 11-11S18.075 1 12 1zM2.5 12a9.5 9.5 0 1 1 19 0 9.5 9.5 0 0 1-19 0z"/></svg></span> 1 min read </span></p> </aside> <hr> <p>Yes, I have been gone for a while. More than a year, in fact. The project &ndash; <em>lovem</em> &ndash; is not dead, however. In fact, I even have multiple posts already written, that I just need to publish. So let's start doing that. After this short intermission, I will publish an additional entry in the journey, that will take us further along the path to creating our VM.</p> <p>To be quite honest &ndash; I dated this entry back to yesterday. The reason is, that my journal, as I currently run it, does not really support multiple entries on the same day. Yes, I could simply add a time to the publication date, but that breaks continuity. And I don't plan to normally release multiple entries on the same day, as I want to keep the pace not too high. One post every two or three days is what I aim for, just the way I used to have it.</p> <p>A few things have changed in the meantime. For reasons that I have no desire to explain, I have removed the link to my Twitter account from the journal, and replaced it with a link to my Mastodon account. You can find me under <a href=https://chaos.social/@kratenko>@kratenko@chaos.social</a> there. I also used to announce new entries over Twitter. I guess I will move that over to Mastodon as well. I guess we will see how that goes.</p> <p>But now let's get back to the journey. We will next implement a simple feature, that makes allows the VM to limit the processing time of a program &ndash; which can be very useful, especially when running user supplied code inside the machine. Building an endless loop inside a turing complete (or not even) language is quite easy. Having an embedded device stuck in an endless loop is often a catastrophe...</p> <h2 id=stop-right-there-thats-far-enough>Stop right there, that's far enough!<a class=headerlink href=#stop-right-there-thats-far-enough title="Permanent link">&para;</a></h2> <p><strong>We introduce an optional execution limit to our VM.</strong></p> <aside class=mdx-author> <p><img alt=@kratenko src=https://avatars.githubusercontent.com/kratenko></p> <p><span><strong>kratenko</strong> · <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 16 16"><path fill-rule=evenodd d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"/></svg></span> <a href=https://github.com/kratenko>kratenko</a></span> <span> <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path fill-rule=evenodd d="M6.75 0a.75.75 0 0 1 .75.75V3h9V.75a.75.75 0 0 1 1.5 0V3h2.75c.966 0 1.75.784 1.75 1.75v16a1.75 1.75 0 0 1-1.75 1.75H3.25a1.75 1.75 0 0 1-1.75-1.75v-16C1.5 3.784 2.284 3 3.25 3H6V.75A.75.75 0 0 1 6.75 0zm-3.5 4.5a.25.25 0 0 0-.25.25V8h18V4.75a.25.25 0 0 0-.25-.25H3.25zM21 9.5H3v11.25c0 .138.112.25.25.25h17.5a.25.25 0 0 0 .25-.25V9.5z"/></svg></span> 2024-02-02 · <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path fill-rule=evenodd d="M0 3.75A.75.75 0 0 1 .75 3h7.497c1.566 0 2.945.8 3.751 2.014A4.496 4.496 0 0 1 15.75 3h7.5a.75.75 0 0 1 .75.75v15.063a.75.75 0 0 1-.755.75l-7.682-.052a3 3 0 0 0-2.142.878l-.89.891a.75.75 0 0 1-1.061 0l-.902-.901a3 3 0 0 0-2.121-.879H.75a.75.75 0 0 1-.75-.75v-15zm11.247 3.747a3 3 0 0 0-3-2.997H1.5V18h6.947a4.5 4.5 0 0 1 2.803.98l-.003-11.483zm1.503 11.485V7.5a3 3 0 0 1 3-3h6.75v13.558l-6.927-.047a4.5 4.5 0 0 0-2.823.971z"/></svg></span> Entry #29 · <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12.5 7.25a.75.75 0 0 0-1.5 0v5.5c0 .27.144.518.378.651l3.5 2a.75.75 0 0 0 .744-1.302L12.5 12.315V7.25z"/><path fill-rule=evenodd d="M12 1C5.925 1 1 5.925 1 12s4.925 11 11 11 11-4.925 11-11S18.075 1 12 1zM2.5 12a9.5 9.5 0 1 1 19 0 9.5 9.5 0 0 1-19 0z"/></svg></span> 3 min read · <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M7.75 6.5a1.25 1.25 0 1 0 0 2.5 1.25 1.25 0 0 0 0-2.5z"/><path fill-rule=evenodd d="M2.5 1A1.5 1.5 0 0 0 1 2.5v8.44c0 .397.158.779.44 1.06l10.25 10.25a1.5 1.5 0 0 0 2.12 0l8.44-8.44a1.5 1.5 0 0 0 0-2.12L12 1.44A1.5 1.5 0 0 0 10.94 1H2.5zm0 1.5h8.44l10.25 10.25-8.44 8.44L2.5 10.94V2.5z"/></svg></span> <a href=https://github.com/kratenko/lovem/releases/tag/v0.0.12-journey>v0.0.12-journey</a> </span></p> </aside> <hr> <p>Since we have <code>goto</code>, we can write looping programs. With <code>if*</code> we have potentially looping programs as well. Both of this open the potential for endless loops. There are situations, in which endless loops are required. But often they are something to be avoided.</p> <h3 id=looping-a-long-time>Looping a long time<a class=headerlink href=#looping-a-long-time title="Permanent link">&para;</a></h3> <p>Let us look at a little program: <div class=highlight><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>pgm/long-loop.lva</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-0-1> 1</a></span>
<span class=normal><a href=#__codelineno-0-2> 2</a></span>
<span class=normal><a href=#__codelineno-0-3> 3</a></span>
<span class=normal><a href=#__codelineno-0-4> 4</a></span>
<span class=normal><a href=#__codelineno-0-5> 5</a></span>
<span class=normal><a href=#__codelineno-0-6> 6</a></span>
<span class=normal><a href=#__codelineno-0-7> 7</a></span>
<span class=normal><a href=#__codelineno-0-8> 8</a></span>
<span class=normal><a href=#__codelineno-0-9> 9</a></span>
<span class=normal><a href=#__codelineno-0-10>10</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-0-1 name=__codelineno-0-1></a>## Looping a looooong time.
<a id=__codelineno-0-2 name=__codelineno-0-2></a>## This program will not run forever, but you will not see it terminate either.
<a id=__codelineno-0-3 name=__codelineno-0-3></a>  push_u8 0
<a id=__codelineno-0-4 name=__codelineno-0-4></a>loop:
<a id=__codelineno-0-5 name=__codelineno-0-5></a>  push_u8 1
<a id=__codelineno-0-6 name=__codelineno-0-6></a>  add
<a id=__codelineno-0-7 name=__codelineno-0-7></a>  dup
<a id=__codelineno-0-8 name=__codelineno-0-8></a>  ifgt loop
<a id=__codelineno-0-9 name=__codelineno-0-9></a>  pop
<a id=__codelineno-0-10 name=__codelineno-0-10></a>  fin
</code></pre></div></td></tr></table></div></p> <p>Someone messed up the loop condition there. If you run this program, it will be running for a long time. We start at zero and add to the value until our number is smaller than 0. Sounds impossible to reach for normal people, programmers will now better. Eventually we will reach the integer overflow, and our signed integer will loop around from its highest possible value to the lowest possible one. But do remember, what type we currently use to store our values: <code>i64</code>. So how big is that highest number?</p> <div class=highlight><pre><span></span><code>9223372036854775807
</code></pre></div> <p>Is that a lot? That depends. Last entry I had my program loop for 1 million rounds. It took my modern laptop about half a second. So reaching that number should take 9223372036854.775807 times as long, that is around 4611686018427 seconds or just about 146135 years. Is that a lot?</p> <p>Oh, and by the way, the Rust professionals reading this will have spotted a potentially false claim there. While we run our program in debug mode, there will be no integer wraparound, instead the program will panic. If we build our Rust program in release mode, we will have integer wraparound, and will (theoretically) eventually reach the end of our loop. But that is besides the point.</p> <h3 id=limited-execution>Limited execution<a class=headerlink href=#limited-execution title="Permanent link">&para;</a></h3> <p>The reason I started writing <em>lovem</em>, is that I need an embeddable lightweight VM to execute programmable handlers when certain events occur on my restrained embedded devices. So we are talking about some form of user generated content that is executed as a program! We can never trust those programs to be solid. We need a way to limit execution in some way, so that the device has the possibility to terminate those programs. There is an easy way to achieve that with what we already have. We put a limit on the number of operations the VM will execute.</p> <p>We add a few lines to our VM's main loop:</p> <div class=highlight><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>src/vm.rs</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-1-137>137</a></span>
<span class=normal><a href=#__codelineno-1-138>138</a></span>
<span class=normal><a href=#__codelineno-1-139>139</a></span>
<span class=normal><a href=#__codelineno-1-140>140</a></span>
<span class=normal><a href=#__codelineno-1-141>141</a></span>
<span class=normal><a href=#__codelineno-1-142>142</a></span>
<span class=normal><a href=#__codelineno-1-143>143</a></span>
<span class=normal><a href=#__codelineno-1-144>144</a></span>
<span class=normal><a href=#__codelineno-1-145>145</a></span>
<span class=normal><a href=#__codelineno-1-146>146</a></span>
<span class=normal><a href=#__codelineno-1-147>147</a></span>
<span class=normal><a href=#__codelineno-1-148>148</a></span>
<span class=normal><a href=#__codelineno-1-149>149</a></span>
<span class=normal><a href=#__codelineno-1-150>150</a></span>
<span class=normal><a href=#__codelineno-1-151>151</a></span>
<span class=normal><a href=#__codelineno-1-152>152</a></span>
<span class=normal><a href=#__codelineno-1-153>153</a></span>
<span class=normal><a href=#__codelineno-1-154>154</a></span>
<span class=normal><a href=#__codelineno-1-155>155</a></span>
<span class=normal><a href=#__codelineno-1-156>156</a></span>
<span class=normal><a href=#__codelineno-1-157>157</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-1-137 name=__codelineno-1-137></a><span class=c1>// Loop going through the whole program, one instruction at a time.</span>
<a id=__codelineno-1-138 name=__codelineno-1-138></a><span class=k>loop</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-1-139 name=__codelineno-1-139></a><span class=w>    </span><span class=c1>// Log the vm&#39;s complete state, so we can follow what happens in console:</span>
<a id=__codelineno-1-140 name=__codelineno-1-140></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>trace</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-1-141 name=__codelineno-1-141></a><span class=w>        </span><span class=fm>println!</span><span class=p>(</span><span class=s>&quot;{:?}&quot;</span><span class=p>,</span><span class=w> </span><span class=bp>self</span><span class=p>);</span>
<a id=__codelineno-1-142 name=__codelineno-1-142></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-1-143 name=__codelineno-1-143></a><span class=w>    </span><span class=c1>// Fetch next opcode from program (increases program counter):</span>
<a id=__codelineno-1-144 name=__codelineno-1-144></a><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>opcode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>fetch_u8</span><span class=p>(</span><span class=n>pgm</span><span class=p>)</span><span class=o>?</span><span class=p>;</span>
<a id=__codelineno-1-145 name=__codelineno-1-145></a><span class=hll><span class=w>    </span><span class=c1>// Limit execution by number of instructions that will be executed:</span>
</span><a id=__codelineno-1-146 name=__codelineno-1-146></a><span class=hll><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>instruction_limit</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>op_cnt</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>instruction_limit</span><span class=w> </span><span class=p>{</span>
</span><a id=__codelineno-1-147 name=__codelineno-1-147></a><span class=hll><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nb>Err</span><span class=p>(</span><span class=n>RuntimeError</span>::<span class=n>InstructionLimitExceeded</span><span class=p>);</span>
</span><a id=__codelineno-1-148 name=__codelineno-1-148></a><span class=hll><span class=w>    </span><span class=p>}</span>
</span><a id=__codelineno-1-149 name=__codelineno-1-149></a><span class=w>    </span><span class=c1>// We count the number of instructions we execute:</span>
<a id=__codelineno-1-150 name=__codelineno-1-150></a><span class=w>    </span><span class=bp>self</span><span class=p>.</span><span class=n>op_cnt</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span>
<a id=__codelineno-1-151 name=__codelineno-1-151></a><span class=w>    </span><span class=c1>// If we are done, break loop and stop execution:</span>
<a id=__codelineno-1-152 name=__codelineno-1-152></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=n>opcode</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>op</span>::<span class=n>FIN</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-1-153 name=__codelineno-1-153></a><span class=w>        </span><span class=k>break</span><span class=p>;</span>
<a id=__codelineno-1-154 name=__codelineno-1-154></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-1-155 name=__codelineno-1-155></a><span class=w>    </span><span class=c1>// Execute the current instruction (with the opcode we loaded already):</span>
<a id=__codelineno-1-156 name=__codelineno-1-156></a><span class=w>    </span><span class=bp>self</span><span class=p>.</span><span class=n>execute_op</span><span class=p>(</span><span class=n>pgm</span><span class=p>,</span><span class=w> </span><span class=n>opcode</span><span class=p>)</span><span class=o>?</span><span class=p>;</span>
<a id=__codelineno-1-157 name=__codelineno-1-157></a><span class=p>}</span>
</code></pre></div></td></tr></table></div> <p>And of course we also add that new <code>RuntimeError::InstructionLimitExceeded</code> and a new field <code>pub instruction_limit: usize,</code> to our VM struct.</p> <p><code>lovas</code> gets a new optional parameter:</p> <div class=highlight><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>src/bin/lovas.rs</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-2-34>34</a></span>
<span class=normal><a href=#__codelineno-2-35>35</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-2-34 name=__codelineno-2-34></a>#<span class=cp>#[clap(long, default_value_t = 1000000, help = </span><span class=s>&quot;Limit max number of instructions allowed for execution. 0 for unlimited.&quot;</span><span class=cp>)]</span>
<a id=__codelineno-2-35 name=__codelineno-2-35></a><span class=n>instruction_limit</span>: <span class=kt>usize</span><span class=p>,</span>
</code></pre></div></td></tr></table></div> <p>And we need to pass that to the VM in the <code>run()</code> function:</p> <div class=highlight><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>src/bin/lovas.rs</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-3-38>38</a></span>
<span class=normal><a href=#__codelineno-3-39>39</a></span>
<span class=normal><a href=#__codelineno-3-40>40</a></span>
<span class=normal><a href=#__codelineno-3-41>41</a></span>
<span class=normal><a href=#__codelineno-3-42>42</a></span>
<span class=normal><a href=#__codelineno-3-43>43</a></span>
<span class=normal><a href=#__codelineno-3-44>44</a></span>
<span class=normal><a href=#__codelineno-3-45>45</a></span>
<span class=normal><a href=#__codelineno-3-46>46</a></span>
<span class=normal><a href=#__codelineno-3-47>47</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-3-38 name=__codelineno-3-38></a><span class=sd>/// Executes a program in a freshly created lovem VM.</span>
<a id=__codelineno-3-39 name=__codelineno-3-39></a><span class=k>fn</span> <span class=nf>run</span><span class=p>(</span><span class=n>pgm</span>: <span class=kp>&amp;</span><span class=nc>Pgm</span><span class=p>,</span><span class=w> </span><span class=n>args</span>: <span class=kp>&amp;</span><span class=nc>Cli</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=p>()</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-3-40 name=__codelineno-3-40></a><span class=w>    </span><span class=c1>// Create our VM instance.</span>
<a id=__codelineno-3-41 name=__codelineno-3-41></a><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>vm</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>VM</span>::<span class=n>new</span><span class=p>(</span><span class=n>args</span><span class=p>.</span><span class=n>stack_size</span><span class=p>);</span>
<a id=__codelineno-3-42 name=__codelineno-3-42></a><span class=w>    </span><span class=n>vm</span><span class=p>.</span><span class=n>trace</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>args</span><span class=p>.</span><span class=n>trace</span><span class=p>;</span>
<a id=__codelineno-3-43 name=__codelineno-3-43></a><span class=hll><span class=w>    </span><span class=n>vm</span><span class=p>.</span><span class=n>instruction_limit</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>args</span><span class=p>.</span><span class=n>instruction_limit</span><span class=p>;</span>
</span><a id=__codelineno-3-44 name=__codelineno-3-44></a><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>start</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Instant</span>::<span class=n>now</span><span class=p>();</span>
<a id=__codelineno-3-45 name=__codelineno-3-45></a><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>outcome</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>vm</span><span class=p>.</span><span class=n>run</span><span class=p>(</span><span class=o>&amp;</span><span class=n>pgm</span><span class=p>.</span><span class=n>text</span><span class=p>);</span>
<a id=__codelineno-3-46 name=__codelineno-3-46></a><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>duration</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>start</span><span class=p>.</span><span class=n>elapsed</span><span class=p>();</span>
<a id=__codelineno-3-47 name=__codelineno-3-47></a><span class=o>..</span><span class=p>.</span>
</code></pre></div></td></tr></table></div> <p>And, well, that's it. We now have an optional execution limitation that we default at 1 million.</p> <h3 id=testing-it>Testing it<a class=headerlink href=#testing-it title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a>kratenko@jotun:~/git/lovem$ cargo run --bin lovas -- -r pgm/long-loop.lva --print
<a id=__codelineno-4-2 name=__codelineno-4-2 href=#__codelineno-4-2></a>    Finished dev [unoptimized + debuginfo] target(s) in 0.02s
<a id=__codelineno-4-3 name=__codelineno-4-3 href=#__codelineno-4-3></a>     Running `target/debug/lovas -r pgm/long-loop.lva --print`
<a id=__codelineno-4-4 name=__codelineno-4-4 href=#__codelineno-4-4></a>Pgm { name: &quot;pgm/long-loop.lva&quot;, text: [2, 0, 2, 1, 16, 3, 37, 255, 249, 1, 255] }
<a id=__codelineno-4-5 name=__codelineno-4-5 href=#__codelineno-4-5></a>Runtime error!
<a id=__codelineno-4-6 name=__codelineno-4-6 href=#__codelineno-4-6></a>Runtime=142.400812ms
<a id=__codelineno-4-7 name=__codelineno-4-7 href=#__codelineno-4-7></a>op_cnt=1000000, pc=7, stack-depth=2, watermark=2
<a id=__codelineno-4-8 name=__codelineno-4-8 href=#__codelineno-4-8></a>Error: InstructionLimitExceeded
</code></pre></div> <p>We can adjust it easily:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a>kratenko@jotun:~/git/lovem$ cargo run --bin lovas -- -r pgm/long-loop.lva --print --instruction-limit=100
<a id=__codelineno-5-2 name=__codelineno-5-2 href=#__codelineno-5-2></a>    Finished dev [unoptimized + debuginfo] target(s) in 0.02s
<a id=__codelineno-5-3 name=__codelineno-5-3 href=#__codelineno-5-3></a>     Running `target/debug/lovas -r pgm/long-loop.lva --print --instruction-limit=100`
<a id=__codelineno-5-4 name=__codelineno-5-4 href=#__codelineno-5-4></a>Pgm { name: &quot;pgm/long-loop.lva&quot;, text: [2, 0, 2, 1, 16, 3, 37, 255, 249, 1, 255] }
<a id=__codelineno-5-5 name=__codelineno-5-5 href=#__codelineno-5-5></a>Runtime error!
<a id=__codelineno-5-6 name=__codelineno-5-6 href=#__codelineno-5-6></a>Runtime=19.096µs
<a id=__codelineno-5-7 name=__codelineno-5-7 href=#__codelineno-5-7></a>op_cnt=100, pc=7, stack-depth=2, watermark=2
<a id=__codelineno-5-8 name=__codelineno-5-8 href=#__codelineno-5-8></a>Error: InstructionLimitExceeded
</code></pre></div> <p>And we can just as well disable it completely:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a>kratenko@jotun:~/git/lovem$ cargo run --bin lovas -- -r pgm/long-loop.lva --print --instruction-limit=0
<a id=__codelineno-6-2 name=__codelineno-6-2 href=#__codelineno-6-2></a>    Finished dev [unoptimized + debuginfo] target(s) in 0.02s
<a id=__codelineno-6-3 name=__codelineno-6-3 href=#__codelineno-6-3></a>     Running `target/debug/lovas -r pgm/long-loop.lva --print --instruction-limit=0`
<a id=__codelineno-6-4 name=__codelineno-6-4 href=#__codelineno-6-4></a>Pgm { name: &quot;pgm/long-loop.lva&quot;, text: [2, 0, 2, 1, 16, 3, 37, 255, 249, 1, 255] }
</code></pre></div> <p>Good luck waiting for this one. I hope you know how to terminate a running program on your system...</p> <h2 id=we-have-variables>We have variables!<a class=headerlink href=#we-have-variables title="Permanent link">&para;</a></h2> <p><strong>A stack alone is not that mighty. But now we can stow data away.</strong></p> <aside class=mdx-author> <p><img alt=@kratenko src=https://avatars.githubusercontent.com/kratenko></p> <p><span><strong>kratenko</strong> · <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 16 16"><path fill-rule=evenodd d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"/></svg></span> <a href=https://github.com/kratenko>kratenko</a></span> <span> <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path fill-rule=evenodd d="M6.75 0a.75.75 0 0 1 .75.75V3h9V.75a.75.75 0 0 1 1.5 0V3h2.75c.966 0 1.75.784 1.75 1.75v16a1.75 1.75 0 0 1-1.75 1.75H3.25a1.75 1.75 0 0 1-1.75-1.75v-16C1.5 3.784 2.284 3 3.25 3H6V.75A.75.75 0 0 1 6.75 0zm-3.5 4.5a.25.25 0 0 0-.25.25V8h18V4.75a.25.25 0 0 0-.25-.25H3.25zM21 9.5H3v11.25c0 .138.112.25.25.25h17.5a.25.25 0 0 0 .25-.25V9.5z"/></svg></span> 2024-02-11 · <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path fill-rule=evenodd d="M0 3.75A.75.75 0 0 1 .75 3h7.497c1.566 0 2.945.8 3.751 2.014A4.496 4.496 0 0 1 15.75 3h7.5a.75.75 0 0 1 .75.75v15.063a.75.75 0 0 1-.755.75l-7.682-.052a3 3 0 0 0-2.142.878l-.89.891a.75.75 0 0 1-1.061 0l-.902-.901a3 3 0 0 0-2.121-.879H.75a.75.75 0 0 1-.75-.75v-15zm11.247 3.747a3 3 0 0 0-3-2.997H1.5V18h6.947a4.5 4.5 0 0 1 2.803.98l-.003-11.483zm1.503 11.485V7.5a3 3 0 0 1 3-3h6.75v13.558l-6.927-.047a4.5 4.5 0 0 0-2.823.971z"/></svg></span> Entry #30 · <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12.5 7.25a.75.75 0 0 0-1.5 0v5.5c0 .27.144.518.378.651l3.5 2a.75.75 0 0 0 .744-1.302L12.5 12.315V7.25z"/><path fill-rule=evenodd d="M12 1C5.925 1 1 5.925 1 12s4.925 11 11 11 11-4.925 11-11S18.075 1 12 1zM2.5 12a9.5 9.5 0 1 1 19 0 9.5 9.5 0 0 1-19 0z"/></svg></span> 4 min read · <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M7.75 6.5a1.25 1.25 0 1 0 0 2.5 1.25 1.25 0 0 0 0-2.5z"/><path fill-rule=evenodd d="M2.5 1A1.5 1.5 0 0 0 1 2.5v8.44c0 .397.158.779.44 1.06l10.25 10.25a1.5 1.5 0 0 0 2.12 0l8.44-8.44a1.5 1.5 0 0 0 0-2.12L12 1.44A1.5 1.5 0 0 0 10.94 1H2.5zm0 1.5h8.44l10.25 10.25-8.44 8.44L2.5 10.94V2.5z"/></svg></span> <a href=https://github.com/kratenko/lovem/releases/tag/v0.0.13-journey>v0.0.13-journey</a> </span></p> </aside> <hr> <p>I implemented variables for the VM. And I did it in a way, that will freak out programmers, who have only ever worked with high languages in well-behaved environments &ndash; we now have variable support, but for global variables only.</p> <p>Why would I do that? Well, it was easy. You might be surprised how easy it was. And it helps a lot in having something useful. For what I am going for, it would actually be a viable thing, too. You could do a lot. But don't worry, I want local variables, too.</p> <h3 id=tell-me-were-to-stick-it>Tell me were to stick it<a class=headerlink href=#tell-me-were-to-stick-it title="Permanent link">&para;</a></h3> <p>Variables need to live somewhere. When I first talked about stack machines, I said that "no other <em>direct</em> manipulations of the stack [were] allowed [but push or pop]." We will now see, why I added the <em>direct</em> there.</p> <p>Variables hold values; words, to be more precise. We have an entity, that can hold an arbitrary number of words: the stack. So, what is the idea? When I write a program, I will know how many variables it will need. Actually, our assembler now can do that for us. When I pass the program to the VM for execution, it looks at that number, and pushes that many zeros on the stack. Then it marks the current stack position as the new bottom. It does that by the newly introduces special <em>Frame Base Register (FB)</em>.</p> <p>What's with that funny name? This is something I will need later, when I introduce real function calls inside the VM. A call will create a new frame that is somewhat like a new local execution environment. This will also allow for local variables (told ya, I want those). But for now we have up to 256 global variables at our disposal. That is quite a bit. </p> <h3 id=variable-operations>Variable operations<a class=headerlink href=#variable-operations title="Permanent link">&para;</a></h3> <p>There are two new operations for handling global variables:</p> <ul> <li><code>store</code>: pop a value from the stack and store it in the global variable identified by the 1-byte oparg.</li> <li><code>load</code>: read value from the global variable identified by the 1-byte oparg and push it to the stack.</li> </ul> <h3 id=variables-in-the-assembler>Variables in the assembler<a class=headerlink href=#variables-in-the-assembler title="Permanent link">&para;</a></h3> <p>This took more work than the changes in the VM. That is good, because we want to hide complexity away from the VM. The assembler runs on a powerful computer, and typically programs are run more often than they are assembled/compiled. I want named variables in assembler source. The VM works only with numbers to identify them. Our assembler translates that for us.</p> <p><code>store</code> and <code>load</code> each take the name of a variable as argument. When the assembler finds a new variable name, it is assigned a number (starting at 0). We actually just chunk them in a Vector and run through it everytime. We only support 256 variables, so there is no need to optimise there. It's fast enough. The index number is written as <code>u8</code> as a single byte oparg. I leave it to you to look at the new source code in <code>asm.rs</code> this time. It is not too hard, and you should know enough Rust by now.</p> <h3 id=a-new-program>A new Program<a class=headerlink href=#a-new-program title="Permanent link">&para;</a></h3> <p>There is more information to store for a Program now, than only the text (aka. the bytecode): the global variables. The information we store is just the number of variables the program has. That is all we need, we are not interested in their names. And it is the bytecode's responsibility, to access the correct variables.</p> <p>But since we now need that information in the VM, we finally change the parameter passed to <code>run()</code> from <code>&amp;[u8]</code> to <code>&amp;Pgm</code>. That is what caused the most changes inside <code>vm.rs</code>. The real additions are few.</p> <h3 id=variables-in-the-vm>Variables in the VM<a class=headerlink href=#variables-in-the-vm title="Permanent link">&para;</a></h3> <p>The VM itself gets a new field: <code>fb: usize</code>. That is the frame base register, and it currently does nothing but point to the position inside the stack behind the last global variable. So with zero variables, nothing changes. We also add <code>RuntimeError::InvalidVariable</code>.</p> <p>Initialising the VM now includes making space for the variables: <div class=highlight><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>src/vm.rs</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-7-146>146</a></span>
<span class=normal><a href=#__codelineno-7-147>147</a></span>
<span class=normal><a href=#__codelineno-7-148>148</a></span>
<span class=normal><a href=#__codelineno-7-149>149</a></span>
<span class=normal><a href=#__codelineno-7-150>150</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-7-146 name=__codelineno-7-146></a><span class=c1>// create global variables in stack:</span>
<a id=__codelineno-7-147 name=__codelineno-7-147></a><span class=k>for</span><span class=w> </span><span class=n>_</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=mi>0</span><span class=o>..</span><span class=n>pgm</span><span class=p>.</span><span class=n>vars</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-7-148 name=__codelineno-7-148></a><span class=w>    </span><span class=bp>self</span><span class=p>.</span><span class=n>push</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span><span class=o>?</span><span class=p>;</span>
<a id=__codelineno-7-149 name=__codelineno-7-149></a><span class=p>}</span>
<a id=__codelineno-7-150 name=__codelineno-7-150></a><span class=bp>self</span><span class=p>.</span><span class=n>fb</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pgm</span><span class=p>.</span><span class=n>vars</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>usize</span><span class=p>;</span>
</code></pre></div></td></tr></table></div></p> <p>Popping values now needs to respect the frame base register, so it now looks this: <div class=highlight><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>src/vm.rs</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-8-68>68</a></span>
<span class=normal><a href=#__codelineno-8-69>69</a></span>
<span class=normal><a href=#__codelineno-8-70>70</a></span>
<span class=normal><a href=#__codelineno-8-71>71</a></span>
<span class=normal><a href=#__codelineno-8-72>72</a></span>
<span class=normal><a href=#__codelineno-8-73>73</a></span>
<span class=normal><a href=#__codelineno-8-74>74</a></span>
<span class=normal><a href=#__codelineno-8-75>75</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-8-68 name=__codelineno-8-68></a><span class=sd>/// Tries and pops a value from value stack, respecting frame base.</span>
<a id=__codelineno-8-69 name=__codelineno-8-69></a><span class=k>fn</span> <span class=nf>pop</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=kt>i64</span><span class=p>,</span><span class=w> </span><span class=n>RuntimeError</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-8-70 name=__codelineno-8-70></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>stack</span><span class=p>.</span><span class=n>len</span><span class=p>()</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>fb</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-8-71 name=__codelineno-8-71></a><span class=w>        </span><span class=nb>Ok</span><span class=p>(</span><span class=bp>self</span><span class=p>.</span><span class=n>stack</span><span class=p>.</span><span class=n>pop</span><span class=p>().</span><span class=n>unwrap</span><span class=p>())</span>
<a id=__codelineno-8-72 name=__codelineno-8-72></a><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-8-73 name=__codelineno-8-73></a><span class=w>        </span><span class=nb>Err</span><span class=p>(</span><span class=n>RuntimeError</span>::<span class=n>StackUnderflow</span><span class=p>)</span>
<a id=__codelineno-8-74 name=__codelineno-8-74></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-8-75 name=__codelineno-8-75></a><span class=p>}</span>
</code></pre></div></td></tr></table></div></p> <p>And we need operation handlers, of course: <div class=highlight><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>src/vm.rs</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-9-304>304</a></span>
<span class=normal><a href=#__codelineno-9-305>305</a></span>
<span class=normal><a href=#__codelineno-9-306>306</a></span>
<span class=normal><a href=#__codelineno-9-307>307</a></span>
<span class=normal><a href=#__codelineno-9-308>308</a></span>
<span class=normal><a href=#__codelineno-9-309>309</a></span>
<span class=normal><a href=#__codelineno-9-310>310</a></span>
<span class=normal><a href=#__codelineno-9-311>311</a></span>
<span class=normal><a href=#__codelineno-9-312>312</a></span>
<span class=normal><a href=#__codelineno-9-313>313</a></span>
<span class=normal><a href=#__codelineno-9-314>314</a></span>
<span class=normal><a href=#__codelineno-9-315>315</a></span>
<span class=normal><a href=#__codelineno-9-316>316</a></span>
<span class=normal><a href=#__codelineno-9-317>317</a></span>
<span class=normal><a href=#__codelineno-9-318>318</a></span>
<span class=normal><a href=#__codelineno-9-319>319</a></span>
<span class=normal><a href=#__codelineno-9-320>320</a></span>
<span class=normal><a href=#__codelineno-9-321>321</a></span>
<span class=normal><a href=#__codelineno-9-322>322</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-9-304 name=__codelineno-9-304></a><span class=n>op</span>::<span class=n>STORE</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-9-305 name=__codelineno-9-305></a><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>idx</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>fetch_u8</span><span class=p>(</span><span class=n>pgm</span><span class=p>)</span><span class=o>?</span><span class=p>;</span>
<a id=__codelineno-9-306 name=__codelineno-9-306></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=n>idx</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>pgm</span><span class=p>.</span><span class=n>vars</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-9-307 name=__codelineno-9-307></a><span class=w>        </span><span class=nb>Err</span><span class=p>(</span><span class=n>RuntimeError</span>::<span class=n>InvalidVariable</span><span class=p>)</span>
<a id=__codelineno-9-308 name=__codelineno-9-308></a><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-9-309 name=__codelineno-9-309></a><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>v</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>pop</span><span class=p>()</span><span class=o>?</span><span class=p>;</span>
<a id=__codelineno-9-310 name=__codelineno-9-310></a><span class=w>        </span><span class=bp>self</span><span class=p>.</span><span class=n>stack</span><span class=p>[</span><span class=n>idx</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>usize</span><span class=p>]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>v</span><span class=p>;</span>
<a id=__codelineno-9-311 name=__codelineno-9-311></a><span class=w>        </span><span class=nb>Ok</span><span class=p>(())</span>
<a id=__codelineno-9-312 name=__codelineno-9-312></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-9-313 name=__codelineno-9-313></a><span class=p>},</span>
<a id=__codelineno-9-314 name=__codelineno-9-314></a><span class=n>op</span>::<span class=n>LOAD</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-9-315 name=__codelineno-9-315></a><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>idx</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>fetch_u8</span><span class=p>(</span><span class=n>pgm</span><span class=p>)</span><span class=o>?</span><span class=p>;</span>
<a id=__codelineno-9-316 name=__codelineno-9-316></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=n>idx</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>pgm</span><span class=p>.</span><span class=n>vars</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-9-317 name=__codelineno-9-317></a><span class=w>        </span><span class=nb>Err</span><span class=p>(</span><span class=n>RuntimeError</span>::<span class=n>InvalidVariable</span><span class=p>)</span>
<a id=__codelineno-9-318 name=__codelineno-9-318></a><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-9-319 name=__codelineno-9-319></a><span class=w>        </span><span class=bp>self</span><span class=p>.</span><span class=n>push</span><span class=p>(</span><span class=bp>self</span><span class=p>.</span><span class=n>stack</span><span class=p>[</span><span class=n>idx</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>usize</span><span class=p>])</span><span class=o>?</span><span class=p>;</span>
<a id=__codelineno-9-320 name=__codelineno-9-320></a><span class=w>        </span><span class=nb>Ok</span><span class=p>(())</span>
<a id=__codelineno-9-321 name=__codelineno-9-321></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-9-322 name=__codelineno-9-322></a><span class=p>},</span>
</code></pre></div></td></tr></table></div></p> <p>That's it. We now support variables!</p> <h3 id=show-me-your-values>Show me your values<a class=headerlink href=#show-me-your-values title="Permanent link">&para;</a></h3> <p>I added another operation with the opname <code>out</code>. It pops a value from the stack and prints it to stdout. This is not an operation that you would normally want in your VM. Output should be generated by function calls. But we don't have those, yet. I want something to easily show values during development, so you can see what happens, without always using <code>--trace</code>. We can always remove it, later. There is nothing new to that operation, so I won't discuss the code here.</p> <h3 id=a-new-program_1>A new program!<a class=headerlink href=#a-new-program_1 title="Permanent link">&para;</a></h3> <div class=highlight><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>pgm/duplicate.lva</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-10-1> 1</a></span>
<span class=normal><a href=#__codelineno-10-2> 2</a></span>
<span class=normal><a href=#__codelineno-10-3> 3</a></span>
<span class=normal><a href=#__codelineno-10-4> 4</a></span>
<span class=normal><a href=#__codelineno-10-5> 5</a></span>
<span class=normal><a href=#__codelineno-10-6> 6</a></span>
<span class=normal><a href=#__codelineno-10-7> 7</a></span>
<span class=normal><a href=#__codelineno-10-8> 8</a></span>
<span class=normal><a href=#__codelineno-10-9> 9</a></span>
<span class=normal><a href=#__codelineno-10-10>10</a></span>
<span class=normal><a href=#__codelineno-10-11>11</a></span>
<span class=normal><a href=#__codelineno-10-12>12</a></span>
<span class=normal><a href=#__codelineno-10-13>13</a></span>
<span class=normal><a href=#__codelineno-10-14>14</a></span>
<span class=normal><a href=#__codelineno-10-15>15</a></span>
<span class=normal><a href=#__codelineno-10-16>16</a></span>
<span class=normal><a href=#__codelineno-10-17>17</a></span>
<span class=normal><a href=#__codelineno-10-18>18</a></span>
<span class=normal><a href=#__codelineno-10-19>19</a></span>
<span class=normal><a href=#__codelineno-10-20>20</a></span>
<span class=normal><a href=#__codelineno-10-21>21</a></span>
<span class=normal><a href=#__codelineno-10-22>22</a></span>
<span class=normal><a href=#__codelineno-10-23>23</a></span>
<span class=normal><a href=#__codelineno-10-24>24</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-10-1 name=__codelineno-10-1></a>## A program demonstrating use of variables.
<a id=__codelineno-10-2 name=__codelineno-10-2></a>start:
<a id=__codelineno-10-3 name=__codelineno-10-3></a>    # val = 1
<a id=__codelineno-10-4 name=__codelineno-10-4></a>    push_u8 1
<a id=__codelineno-10-5 name=__codelineno-10-5></a>    store val   # variable is declared implicitly here. We only have one type: i64
<a id=__codelineno-10-6 name=__codelineno-10-6></a>    # for loop, 5 rounds:
<a id=__codelineno-10-7 name=__codelineno-10-7></a>    push_u8 5
<a id=__codelineno-10-8 name=__codelineno-10-8></a>loop:
<a id=__codelineno-10-9 name=__codelineno-10-9></a>    # val = val * 2:
<a id=__codelineno-10-10 name=__codelineno-10-10></a>    load val
<a id=__codelineno-10-11 name=__codelineno-10-11></a>    push_u8 2
<a id=__codelineno-10-12 name=__codelineno-10-12></a>    mul
<a id=__codelineno-10-13 name=__codelineno-10-13></a>    store val
<a id=__codelineno-10-14 name=__codelineno-10-14></a>    # check loop counter:
<a id=__codelineno-10-15 name=__codelineno-10-15></a>    push_u8 1
<a id=__codelineno-10-16 name=__codelineno-10-16></a>    sub
<a id=__codelineno-10-17 name=__codelineno-10-17></a>    dup
<a id=__codelineno-10-18 name=__codelineno-10-18></a>    ifgt loop
<a id=__codelineno-10-19 name=__codelineno-10-19></a>end:
<a id=__codelineno-10-20 name=__codelineno-10-20></a>    pop
<a id=__codelineno-10-21 name=__codelineno-10-21></a>    # output final value of val
<a id=__codelineno-10-22 name=__codelineno-10-22></a>    load val
<a id=__codelineno-10-23 name=__codelineno-10-23></a>    out
<a id=__codelineno-10-24 name=__codelineno-10-24></a>    fin
</code></pre></div></td></tr></table></div> <p>The program is documented with comments. And you might have noticed that I define labels that I never use. I just want to structure the program and name its parts. We don't have functions, so I use what we have.</p> <div class=highlight><pre><span></span><code><a id=__codelineno-11-1 name=__codelineno-11-1 href=#__codelineno-11-1></a>kratenko@jotun:~/git/lovem$ cargo run --bin lovas -- -r pgm/duplicate.lva --print
<a id=__codelineno-11-2 name=__codelineno-11-2 href=#__codelineno-11-2></a>   Compiling lovem v0.0.13 (/home/kratenko/git/lovem)
<a id=__codelineno-11-3 name=__codelineno-11-3 href=#__codelineno-11-3></a>    Finished dev [unoptimized + debuginfo] target(s) in 2.66s
<a id=__codelineno-11-4 name=__codelineno-11-4 href=#__codelineno-11-4></a>     Running `target/debug/lovas -r pgm/duplicate.lva --print`
<a id=__codelineno-11-5 name=__codelineno-11-5 href=#__codelineno-11-5></a>Pgm { name: &quot;pgm/duplicate.lva&quot;, text: [2, 1, 4, 0, 2, 5, 5, 0, 2, 2, 18, 4, 0, 2, 1, 17, 3, 37, 255, 242, 1, 5, 0, 6, 255], vars: 1 }
<a id=__codelineno-11-6 name=__codelineno-11-6 href=#__codelineno-11-6></a><span class=hll>Out: 32 (@46)
</span><a id=__codelineno-11-7 name=__codelineno-11-7 href=#__codelineno-11-7></a>Terminated.
<a id=__codelineno-11-8 name=__codelineno-11-8 href=#__codelineno-11-8></a>Runtime=18.156µs
<a id=__codelineno-11-9 name=__codelineno-11-9 href=#__codelineno-11-9></a>op_cnt=47, pc=25, stack-depth=1, watermark=4
</code></pre></div> <p>It outputs a 32. That is good, because we start with a 1 and multiply it by 2 five times. We can write programs!</p> <h3 id=oh-and-a-bugfix>Oh... and a bugfix<a class=headerlink href=#oh-and-a-bugfix title="Permanent link">&para;</a></h3> <p>I found out that I introduced a bug when writing the parsing label definitions. I parsed for the colon <code>:</code>, before I removed the comments. So a line with no label definition, but with a comment containing a colon did produce a parsing error.</p> <div class=highlight><pre><span></span><code><a id=__codelineno-12-1 name=__codelineno-12-1 href=#__codelineno-12-1></a>## this was fine
<a id=__codelineno-12-2 name=__codelineno-12-2 href=#__codelineno-12-2></a>:label # this was fine
<a id=__codelineno-12-3 name=__codelineno-12-3 href=#__codelineno-12-3></a>:another # even this : was fine
<a id=__codelineno-12-4 name=__codelineno-12-4 href=#__codelineno-12-4></a><span class=hll>## but this would produce an error: just a colon in a comment
</span></code></pre></div> <p>I fixed that by removing comments from lines first.</p> </article> </div> </div> <a href=# class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg> Back to top </a> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../2022-06/lovem-again.html class="md-footer__link md-footer__link--prev" aria-label="Previous:  Lovem again!" rel=prev> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </div> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Previous </span> Lovem again! </div> </div> </a> <a href=../2022-08/ALL.html class="md-footer__link md-footer__link--next" aria-label="Next: August 2022 complete" rel=next> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Next </span> August 2022 complete </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-social> <a href=https://github.com/kratenko target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg> </a> <a href=https://chaos.social/@kratenko target=_blank rel=noopener title=chaos.social class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48 0 0 0-63.72 28.5-63.72 125.7 0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54 0 0 1-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "..", "features": ["navigation.indexes", "navigation.sections", "navigation.top", "navigation.tracking", "navigation.expand"], "search": "../assets/javascripts/workers/search.16e2a7d4.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script> <script src=../assets/javascripts/bundle.5a2dcb6a.min.js></script> </body> </html>