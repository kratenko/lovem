<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Lovem & ndash; the low overhead virtual embedded machine. And the journey getting there."><meta name=author content=kratenko><link rel=canonical href=https://kratenko.github.io/lovem/2022-08/running-assembler-programs.html><link rel=icon href=../assets/images/favicon.png><meta name=generator content="mkdocs-1.5.3, mkdocs-material-8.5.10"><title>Running assembler programs - Lovem</title><link rel=stylesheet href=../assets/stylesheets/main.975780f9.min.css><link rel=stylesheet href=../assets/stylesheets/palette.2505c338.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../stylesheets/custom.css><script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=None data-md-color-accent=None> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#running-assembler-programs class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../index.html title=Lovem class="md-header__button md-logo" aria-label=Lovem data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Lovem </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Running assembler programs </span> </div> </div> </div> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/kratenko/lovem title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> kratenko/lovem </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../index.html title=Lovem class="md-nav__button md-logo" aria-label=Lovem data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg> </a> Lovem </label> <div class=md-nav__source> <a href=https://github.com/kratenko/lovem title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> kratenko/lovem </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../index.html class=md-nav__link> The Journey </a> </li> <li class=md-nav__item> <a href=../source-code.html class=md-nav__link> Source Code </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3 type=checkbox id=__nav_3 checked> <div class="md-nav__link md-nav__link--index "> <a href=../journal/index.html>Journal</a> <label for=__nav_3> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav aria-label=Journal data-md-level=1> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Journal </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle=__nav_3_2 type=checkbox id=__nav_3_2 checked> <div class="md-nav__link md-nav__link--index "> <a href=../2024-02/index.html>February 2024</a> <label for=__nav_3_2> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav aria-label="February 2024" data-md-level=2> <label class=md-nav__title for=__nav_3_2> <span class="md-nav__icon md-icon"></span> February 2024 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../2024-02/we-have-variables.html class=md-nav__link> We have variables! </a> </li> <li class=md-nav__item> <a href=../2024-02/stop-right-there-that-s-far-enough.html class=md-nav__link> Stop right there, that's far enough! </a> </li> <li class=md-nav__item> <a href=../2024-02/it-has-been-a-while.html class=md-nav__link> It has been a while... </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_3 type=checkbox id=__nav_3_3 checked> <div class="md-nav__link md-nav__link--index "> <a href=index.html>August 2022</a> <label for=__nav_3_3> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav aria-label="August 2022" data-md-level=2> <label class=md-nav__title for=__nav_3_3> <span class="md-nav__icon md-icon"></span> August 2022 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=what-if.html class=md-nav__link> What if? </a> </li> <li class=md-nav__item> <a href=you-labeled-me-i-ll-label-you.html class=md-nav__link> You labeled me, I'll label you </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> Running assembler programs <span class="md-nav__icon md-icon"></span> </label> <a href=running-assembler-programs.html class="md-nav__link md-nav__link--active"> Running assembler programs </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#execution class=md-nav__link> Execution </a> </li> <li class=md-nav__item> <a href=#trace-log class=md-nav__link> Trace Log </a> </li> <li class=md-nav__item> <a href=#diagnostics class=md-nav__link> Diagnostics </a> </li> <li class=md-nav__item> <a href=#our-programs class=md-nav__link> Our programs </a> </li> <li class=md-nav__item> <a href=#file-extension class=md-nav__link> File extension </a> </li> <li class=md-nav__item> <a href=#playing-around class=md-nav__link> Playing around </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=assembling-bytes.html class=md-nav__link> Assembling bytes </a> </li> <li class=md-nav__item> <a href=handling-instructions.html class=md-nav__link> Handling instructions </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle=__nav_3_4 type=checkbox id=__nav_3_4 checked> <div class="md-nav__link md-nav__link--index "> <a href=../2022-07/index.html>July 2022</a> <label for=__nav_3_4> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav aria-label="July 2022" data-md-level=2> <label class=md-nav__title for=__nav_3_4> <span class="md-nav__icon md-icon"></span> July 2022 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../2022-07/parsing-the-source.html class=md-nav__link> Parsing the source </a> </li> <li class=md-nav__item> <a href=../2022-07/assemble.html class=md-nav__link> Assemble! </a> </li> <li class=md-nav__item> <a href=../2022-07/don-t-byte-me.html class=md-nav__link> Don't byte me! </a> </li> <li class=md-nav__item> <a href=../2022-07/go-ahead-and-jump.html class=md-nav__link> Go ahead and jump! </a> </li> <li class=md-nav__item> <a href=../2022-07/reverse-polish-notation.html class=md-nav__link> Reverse polish notation </a> </li> <li class=md-nav__item> <a href=../2022-07/more-operations.html class=md-nav__link> More operations </a> </li> <li class=md-nav__item> <a href=../2022-07/early-vm-decisions.html class=md-nav__link> Early VM decisions </a> </li> <li class=md-nav__item> <a href=../2022-07/to-the-library.html class=md-nav__link> To the library! </a> </li> <li class=md-nav__item> <a href=../2022-07/becoming-social.html class=md-nav__link> Becoming social </a> </li> <li class=md-nav__item> <a href=../2022-07/turn-fragile-into-rusty.html class=md-nav__link> Turn "fragile" into "rusty" </a> </li> <li class=md-nav__item> <a href=../2022-07/running-our-first-program.html class=md-nav__link> Running our first program </a> </li> <li class=md-nav__item> <a href=../2022-07/a-vm.html class=md-nav__link> A VM </a> </li> <li class=md-nav__item> <a href=../2022-07/it-looks-so-weird.html class=md-nav__link> It looks so weird </a> </li> <li class=md-nav__item> <a href=../2022-07/let-there-be-source-code.html class=md-nav__link> Let there be source code </a> </li> <li class=md-nav__item> <a href=../2022-07/making-virtual-a-reality.html class=md-nav__link> Making virtual a reality </a> </li> <li class=md-nav__item> <a href=../2022-07/what-is-a-virtual-machine-anyway.html class=md-nav__link> What is a Virtual Machine anyway? </a> </li> <li class=md-nav__item> <a href=../2022-07/all-new-once-more.html class=md-nav__link> All new once more </a> </li> <li class=md-nav__item> <a href=../2022-07/state-of-the-journal.html class=md-nav__link> State of the Journal </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle=__nav_3_5 type=checkbox id=__nav_3_5 checked> <div class="md-nav__link md-nav__link--index "> <a href=../2022-06/index.html>June 2022</a> <label for=__nav_3_5> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav aria-label="June 2022" data-md-level=2> <label class=md-nav__title for=__nav_3_5> <span class="md-nav__icon md-icon"></span> June 2022 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../2022-06/script-or-virtual.html class=md-nav__link> Script or virtual </a> </li> <li class=md-nav__item> <a href=../2022-06/that-use-case.html class=md-nav__link> That use-case I was talking about </a> </li> <li class=md-nav__item> <a href=../2022-06/we-need-another-wheel.html class=md-nav__link> We need another wheel </a> </li> <li class=md-nav__item> <a href=../2022-06/lovem-again.html class=md-nav__link> Lovem again! </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle=__nav_4 type=checkbox id=__nav_4 checked> <label class=md-nav__link for=__nav_4> Journal (complete months) <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Journal (complete months)" data-md-level=1> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Journal (complete months) </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../2024-02/ALL.html class=md-nav__link> February 2024 complete </a> </li> <li class=md-nav__item> <a href=ALL.html class=md-nav__link> August 2022 complete </a> </li> <li class=md-nav__item> <a href=../2022-07/ALL.html class=md-nav__link> July 2022 complete </a> </li> <li class=md-nav__item> <a href=../2022-06/ALL.html class=md-nav__link> June 2022 complete </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#execution class=md-nav__link> Execution </a> </li> <li class=md-nav__item> <a href=#trace-log class=md-nav__link> Trace Log </a> </li> <li class=md-nav__item> <a href=#diagnostics class=md-nav__link> Diagnostics </a> </li> <li class=md-nav__item> <a href=#our-programs class=md-nav__link> Our programs </a> </li> <li class=md-nav__item> <a href=#file-extension class=md-nav__link> File extension </a> </li> <li class=md-nav__item> <a href=#playing-around class=md-nav__link> Playing around </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=running-assembler-programs>Running assembler programs<a class=headerlink href=#running-assembler-programs title="Permanent link">&para;</a></h1> <p><strong>We will extend our assembler to do something useful, finally: execute our programs on lovem.</strong></p> <aside class=mdx-author> <p><img alt=@kratenko src=https://avatars.githubusercontent.com/kratenko></p> <p><span><strong>kratenko</strong> · <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 16 16"><path fill-rule=evenodd d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"/></svg></span> <a href=https://github.com/kratenko>kratenko</a></span> <span> <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path fill-rule=evenodd d="M6.75 0a.75.75 0 0 1 .75.75V3h9V.75a.75.75 0 0 1 1.5 0V3h2.75c.966 0 1.75.784 1.75 1.75v16a1.75 1.75 0 0 1-1.75 1.75H3.25a1.75 1.75 0 0 1-1.75-1.75v-16C1.5 3.784 2.284 3 3.25 3H6V.75A.75.75 0 0 1 6.75 0zm-3.5 4.5a.25.25 0 0 0-.25.25V8h18V4.75a.25.25 0 0 0-.25-.25H3.25zM21 9.5H3v11.25c0 .138.112.25.25.25h17.5a.25.25 0 0 0 .25-.25V9.5z"/></svg></span> 2022-08-10 · <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path fill-rule=evenodd d="M0 3.75A.75.75 0 0 1 .75 3h7.497c1.566 0 2.945.8 3.751 2.014A4.496 4.496 0 0 1 15.75 3h7.5a.75.75 0 0 1 .75.75v15.063a.75.75 0 0 1-.755.75l-7.682-.052a3 3 0 0 0-2.142.878l-.89.891a.75.75 0 0 1-1.061 0l-.902-.901a3 3 0 0 0-2.121-.879H.75a.75.75 0 0 1-.75-.75v-15zm11.247 3.747a3 3 0 0 0-3-2.997H1.5V18h6.947a4.5 4.5 0 0 1 2.803.98l-.003-11.483zm1.503 11.485V7.5a3 3 0 0 1 3-3h6.75v13.558l-6.927-.047a4.5 4.5 0 0 0-2.823.971z"/></svg></span> Entry #25 · <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12.5 7.25a.75.75 0 0 0-1.5 0v5.5c0 .27.144.518.378.651l3.5 2a.75.75 0 0 0 .744-1.302L12.5 12.315V7.25z"/><path fill-rule=evenodd d="M12 1C5.925 1 1 5.925 1 12s4.925 11 11 11 11-4.925 11-11S18.075 1 12 1zM2.5 12a9.5 9.5 0 1 1 19 0 9.5 9.5 0 0 1-19 0z"/></svg></span> 6 min read · <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M7.75 6.5a1.25 1.25 0 1 0 0 2.5 1.25 1.25 0 0 0 0-2.5z"/><path fill-rule=evenodd d="M2.5 1A1.5 1.5 0 0 0 1 2.5v8.44c0 .397.158.779.44 1.06l10.25 10.25a1.5 1.5 0 0 0 2.12 0l8.44-8.44a1.5 1.5 0 0 0 0-2.12L12 1.44A1.5 1.5 0 0 0 10.94 1H2.5zm0 1.5h8.44l10.25 10.25-8.44 8.44L2.5 10.94V2.5z"/></svg></span> <a href=https://github.com/kratenko/lovem/releases/tag/v0.0.9-journey>v0.0.9-journey</a> </span></p> </aside> <hr> <p>We have created ourselves an assembler in ~300 lines of code. And it has a command line interface, an API to be used in a program, and even useful error reporting. That is cool! But what do we do with the bytecode? It just dumps them to the console. That is not very useful. We could copy/paste that into one of our example binaries... This is not what we wanted. So let us enhance our assembler.</p> <h2 id=execution>Execution<a class=headerlink href=#execution title="Permanent link">&para;</a></h2> <p>We add some features to <a href=https://github.com/kratenko/lovem/blob/v0.0.9-journey/src/bin/lovas.rs><code>lovas.rs</code></a>. A new command line parameter <code>--run</code>, that takes no arguments. If you add that flag to the call, <code>lovas</code> will take the assembled program (if there are no errors), create an instance of the VM and run the program on it. Thanks to clap, that is really easy to do. We add another field to our <code>Cli</code> struct. Actually, while we are at it, we add four new parameters:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=cp>#[clap(short, long, help = </span><span class=s>&quot;Run the assembled program in lovem.&quot;</span><span class=cp>)]</span>
<a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=n>run</span>: <span class=kt>bool</span><span class=p>,</span>
<a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a>
<a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=cp>#[clap(long, help = </span><span class=s>&quot;Enable tracing log when running lovem.&quot;</span><span class=cp>)]</span>
<a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=n>trace</span>: <span class=kt>bool</span><span class=p>,</span>
<a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a>
<a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a><span class=cp>#[clap(long, help = </span><span class=s>&quot;Output the program to stdout.&quot;</span><span class=cp>)]</span>
<a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a><span class=n>print</span>: <span class=kt>bool</span><span class=p>,</span>
<a id=__codelineno-0-9 name=__codelineno-0-9 href=#__codelineno-0-9></a>
<a id=__codelineno-0-10 name=__codelineno-0-10 href=#__codelineno-0-10></a><span class=cp>#[clap(long, default_value_t = 100, help = </span><span class=s>&quot;Setting the stack size for lovem when running the program.&quot;</span><span class=cp>)]</span>
<a id=__codelineno-0-11 name=__codelineno-0-11 href=#__codelineno-0-11></a><span class=n>stack_size</span>: <span class=kt>usize</span><span class=p>,</span>
</code></pre></div> <p>And we change what we do with a successfully created program, depending on our new flag:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a><span class=c1>// run the assembler:</span>
<a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a><span class=k>match</span><span class=w> </span><span class=n>asm</span>::<span class=n>assemble</span><span class=p>(</span><span class=o>&amp;</span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>content</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-1-3 name=__codelineno-1-3 href=#__codelineno-1-3></a><span class=w>    </span><span class=nb>Ok</span><span class=p>(</span><span class=n>pgm</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-1-4 name=__codelineno-1-4 href=#__codelineno-1-4></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=n>args</span><span class=p>.</span><span class=n>print</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-1-5 name=__codelineno-1-5 href=#__codelineno-1-5></a><span class=w>            </span><span class=fm>println!</span><span class=p>(</span><span class=s>&quot;{:?}&quot;</span><span class=p>,</span><span class=w> </span><span class=n>pgm</span><span class=p>);</span>
<a id=__codelineno-1-6 name=__codelineno-1-6 href=#__codelineno-1-6></a><span class=w>        </span><span class=p>}</span>
<a id=__codelineno-1-7 name=__codelineno-1-7 href=#__codelineno-1-7></a><span class=w>        </span><span class=c1>// we succeeded and now have a program with bytecode:</span>
<a id=__codelineno-1-8 name=__codelineno-1-8 href=#__codelineno-1-8></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=n>args</span><span class=p>.</span><span class=n>run</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-1-9 name=__codelineno-1-9 href=#__codelineno-1-9></a><span class=w>            </span><span class=c1>// lovas was called with `--run`, so create a VM and execute program:</span>
<a id=__codelineno-1-10 name=__codelineno-1-10 href=#__codelineno-1-10></a><span class=w>            </span><span class=n>run</span><span class=p>(</span><span class=o>&amp;</span><span class=n>pgm</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>args</span><span class=p>)</span><span class=o>?</span>
<a id=__codelineno-1-11 name=__codelineno-1-11 href=#__codelineno-1-11></a><span class=w>        </span><span class=p>}</span>
<a id=__codelineno-1-12 name=__codelineno-1-12 href=#__codelineno-1-12></a><span class=w>        </span><span class=nb>Ok</span><span class=p>(())</span>
<a id=__codelineno-1-13 name=__codelineno-1-13 href=#__codelineno-1-13></a><span class=w>    </span><span class=p>},</span>
<a id=__codelineno-1-14 name=__codelineno-1-14 href=#__codelineno-1-14></a><span class=w>    </span><span class=nb>Err</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-1-15 name=__codelineno-1-15 href=#__codelineno-1-15></a><span class=w>        </span><span class=c1>// Something went wrong during assembly.</span>
<a id=__codelineno-1-16 name=__codelineno-1-16 href=#__codelineno-1-16></a><span class=w>        </span><span class=c1>// Convert the error report, so that `anyhow` can do its magic</span>
<a id=__codelineno-1-17 name=__codelineno-1-17 href=#__codelineno-1-17></a><span class=w>        </span><span class=c1>// and display some helpful error message:</span>
<a id=__codelineno-1-18 name=__codelineno-1-18 href=#__codelineno-1-18></a><span class=w>        </span><span class=nb>Err</span><span class=p>(</span><span class=n>Error</span>::<span class=n>from</span><span class=p>(</span><span class=n>e</span><span class=p>))</span>
<a id=__codelineno-1-19 name=__codelineno-1-19 href=#__codelineno-1-19></a><span class=w>    </span><span class=p>},</span>
<a id=__codelineno-1-20 name=__codelineno-1-20 href=#__codelineno-1-20></a><span class=p>}</span>
</code></pre></div> <p>Just printing the program to stdout is no very useful default behaviour for an assembler. It might still come in handy, if you want to see what you are executing, so we make it optional and for the caller to decide with the <code>--print</code> flag. If the <code>--run</code> flag is set, we call <code>run()</code>. So what does <code>run()</code> do?</p> <div class=highlight><pre><span></span><code><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a><span class=sd>/// Executes a program in a freshly created lovem VM.</span>
<a id=__codelineno-2-2 name=__codelineno-2-2 href=#__codelineno-2-2></a><span class=k>fn</span> <span class=nf>run</span><span class=p>(</span><span class=n>pgm</span>: <span class=kp>&amp;</span><span class=nc>Pgm</span><span class=p>,</span><span class=w> </span><span class=n>args</span>: <span class=kp>&amp;</span><span class=nc>Cli</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=p>()</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-2-3 name=__codelineno-2-3 href=#__codelineno-2-3></a><span class=w>    </span><span class=c1>// Create our VM instance.</span>
<a id=__codelineno-2-4 name=__codelineno-2-4 href=#__codelineno-2-4></a><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>vm</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>VM</span>::<span class=n>new</span><span class=p>(</span><span class=n>args</span><span class=p>.</span><span class=n>stack_size</span><span class=p>);</span>
<a id=__codelineno-2-5 name=__codelineno-2-5 href=#__codelineno-2-5></a><span class=w>    </span><span class=n>vm</span><span class=p>.</span><span class=n>trace</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>args</span><span class=p>.</span><span class=n>trace</span><span class=p>;</span>
<a id=__codelineno-2-6 name=__codelineno-2-6 href=#__codelineno-2-6></a><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>start</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Instant</span>::<span class=n>now</span><span class=p>();</span>
<a id=__codelineno-2-7 name=__codelineno-2-7 href=#__codelineno-2-7></a><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>outcome</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>vm</span><span class=p>.</span><span class=n>run</span><span class=p>(</span><span class=o>&amp;</span><span class=n>pgm</span><span class=p>.</span><span class=n>text</span><span class=p>);</span>
<a id=__codelineno-2-8 name=__codelineno-2-8 href=#__codelineno-2-8></a><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>duration</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>start</span><span class=p>.</span><span class=n>elapsed</span><span class=p>();</span>
<a id=__codelineno-2-9 name=__codelineno-2-9 href=#__codelineno-2-9></a><span class=w>    </span><span class=k>match</span><span class=w> </span><span class=n>outcome</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-2-10 name=__codelineno-2-10 href=#__codelineno-2-10></a><span class=w>        </span><span class=nb>Ok</span><span class=p>(</span><span class=n>_</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-2-11 name=__codelineno-2-11 href=#__codelineno-2-11></a><span class=w>            </span><span class=c1>// Execution successful, program terminated:</span>
<a id=__codelineno-2-12 name=__codelineno-2-12 href=#__codelineno-2-12></a><span class=w>            </span><span class=fm>eprintln!</span><span class=p>(</span><span class=s>&quot;Terminated.</span><span class=se>\n</span><span class=s>Runtime={:?}</span><span class=se>\n</span><span class=s>op_cnt={}, pc={}, stack-depth={}, watermark={}&quot;</span><span class=p>,</span>
<a id=__codelineno-2-13 name=__codelineno-2-13 href=#__codelineno-2-13></a><span class=w>                      </span><span class=n>duration</span><span class=p>,</span>
<a id=__codelineno-2-14 name=__codelineno-2-14 href=#__codelineno-2-14></a><span class=w>                      </span><span class=n>vm</span><span class=p>.</span><span class=n>op_cnt</span><span class=p>,</span><span class=w> </span><span class=n>vm</span><span class=p>.</span><span class=n>pc</span><span class=p>,</span><span class=w> </span><span class=n>vm</span><span class=p>.</span><span class=n>stack</span><span class=p>.</span><span class=n>len</span><span class=p>(),</span><span class=w> </span><span class=n>vm</span><span class=p>.</span><span class=n>watermark</span>
<a id=__codelineno-2-15 name=__codelineno-2-15 href=#__codelineno-2-15></a><span class=w>            </span><span class=p>);</span>
<a id=__codelineno-2-16 name=__codelineno-2-16 href=#__codelineno-2-16></a><span class=w>            </span><span class=nb>Ok</span><span class=p>(())</span>
<a id=__codelineno-2-17 name=__codelineno-2-17 href=#__codelineno-2-17></a><span class=w>        </span><span class=p>},</span>
<a id=__codelineno-2-18 name=__codelineno-2-18 href=#__codelineno-2-18></a><span class=w>        </span><span class=nb>Err</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-2-19 name=__codelineno-2-19 href=#__codelineno-2-19></a><span class=w>            </span><span class=c1>// Runtime error. Error will be printed on return of main.</span>
<a id=__codelineno-2-20 name=__codelineno-2-20 href=#__codelineno-2-20></a><span class=w>            </span><span class=fm>eprintln!</span><span class=p>(</span><span class=s>&quot;Runtime error!</span><span class=se>\n</span><span class=s>Runtime={:?}</span><span class=se>\n</span><span class=s>op_cnt={}, pc={}, stack-depth={}, watermark={}&quot;</span><span class=p>,</span>
<a id=__codelineno-2-21 name=__codelineno-2-21 href=#__codelineno-2-21></a><span class=w>                      </span><span class=n>duration</span><span class=p>,</span><span class=w> </span><span class=n>vm</span><span class=p>.</span><span class=n>op_cnt</span><span class=p>,</span><span class=w> </span><span class=n>vm</span><span class=p>.</span><span class=n>pc</span><span class=p>,</span><span class=w> </span><span class=n>vm</span><span class=p>.</span><span class=n>stack</span><span class=p>.</span><span class=n>len</span><span class=p>(),</span><span class=w> </span><span class=n>vm</span><span class=p>.</span><span class=n>watermark</span><span class=p>);</span>
<a id=__codelineno-2-22 name=__codelineno-2-22 href=#__codelineno-2-22></a><span class=w>            </span><span class=nb>Err</span><span class=p>(</span><span class=n>Error</span>::<span class=n>from</span><span class=p>(</span><span class=n>e</span><span class=p>))</span>
<a id=__codelineno-2-23 name=__codelineno-2-23 href=#__codelineno-2-23></a><span class=w>        </span><span class=p>}</span>
<a id=__codelineno-2-24 name=__codelineno-2-24 href=#__codelineno-2-24></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-2-25 name=__codelineno-2-25 href=#__codelineno-2-25></a><span class=p>}</span>
</code></pre></div> <p>We create a VM instance, and we run the program on it. If there is a <code>RuntimeError</code>, we return it, just as we did with the <code>AsmErrorReport</code>. Back in our examples, we created a VM with a stack size of <code>100</code> - simply because we needed a number there. <code>100</code> is still the default, but now you can choose the stack size, when calling <code>lovas</code>. If you do </p> <div class=highlight><pre><span></span><code>lovas --run pgm/some-program.lva --stack-size 512
</code></pre></div> <p>lovas will execute the program in a VM with a stack that can hold 512 values.</p> <h2 id=trace-log>Trace Log<a class=headerlink href=#trace-log title="Permanent link">&para;</a></h2> <p>When we were running a program in our VM, we did always get a lot of output during execution. That is nice for understanding, what a stack machine does, but in general it is not a got idea for a VM to do that. It can be very beneficial, if you run into a problem with your program, so it is an easily available tool for debugging. That is why I removed all those log messages from lovem, but I let some in that can be activated, if you set <code>vm.trace = true</code>. That is what we added the new command line parameter <code>--trace</code> for. You can now control, if you want to see it.</p> <h2 id=diagnostics>Diagnostics<a class=headerlink href=#diagnostics title="Permanent link">&para;</a></h2> <p>There is some output by <code>lovas</code>, after the execution. It reports if the run was successfully terminated (by executing a <code>fin</code> instruction), or if there was a <code>RuntimeError</code>. In both cases it will show you the time the execution took (wallclock time), as well as the number of instructions executed by the VM, the final position of the programm counter, the number of values on the stack at termination, and the highest number of values on the stack at any time during execution (the watermark). This can give you some quick insight on what your program did and maybe where it ran into trouble.</p> <p>All this lead to some changes to <code>vm.rs</code>, but nothing that should give you any problems to understand. Remember that we have the power of git at our disposal, so you can easily find out what changed in a file between two releases. You could do that for <code>vm.rs</code> with this handy link:</p> <p><a href=https://github.com/kratenko/lovem/compare/v0.0.8-journey...v0.0.9-journey#diff-3bc51552cab41d1a2dbf07842cb438088563f6134a9c69a266dfd0d79b631495>https://github.com/kratenko/lovem/compare/v0.0.8-journey...v0.0.9-journey#diff-3bc51552cab41d1a2dbf07842cb438088563f6134a9c69a266dfd0d79b631495</a></p> <h2 id=our-programs>Our programs<a class=headerlink href=#our-programs title="Permanent link">&para;</a></h2> <p>We have written a few example programs so far. Each is its own binary in <code>src/bin/</code>, and all of them consist of the same Rust code of creating a VM and running a program. Only the bytecode changed between them. </p> <p>I got rid of all of those (except for the most basic one) and translated the programs into assembly programs that live in <code>pgm/</code>. You can now execute those using <code>lovas</code>, like this:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a>kratenko@jotun:~/git/lovem$ cargo run --bin lovas -- -r pgm/reverse-polish.lva --trace
<a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a>
<a id=__codelineno-3-3 name=__codelineno-3-3 href=#__codelineno-3-3></a>   Compiling lovem v0.0.9 (/home/kratenko/git/lovem)
<a id=__codelineno-3-4 name=__codelineno-3-4 href=#__codelineno-3-4></a>    Finished dev [unoptimized + debuginfo] target(s) in 2.02s
<a id=__codelineno-3-5 name=__codelineno-3-5 href=#__codelineno-3-5></a>     Running `target/debug/lovas -r pgm/reverse-polish.lva --trace`
<a id=__codelineno-3-6 name=__codelineno-3-6 href=#__codelineno-3-6></a>VM { stack: [], pc: 0, op_cnt: 0, trace: true, watermark: 0 }
<a id=__codelineno-3-7 name=__codelineno-3-7 href=#__codelineno-3-7></a>Executing op 0x02
<a id=__codelineno-3-8 name=__codelineno-3-8 href=#__codelineno-3-8></a>VM { stack: [5], pc: 2, op_cnt: 1, trace: true, watermark: 1 }
<a id=__codelineno-3-9 name=__codelineno-3-9 href=#__codelineno-3-9></a>Executing op 0x02
<a id=__codelineno-3-10 name=__codelineno-3-10 href=#__codelineno-3-10></a>VM { stack: [5, 7], pc: 4, op_cnt: 2, trace: true, watermark: 2 }
<a id=__codelineno-3-11 name=__codelineno-3-11 href=#__codelineno-3-11></a>Executing op 0x02
<a id=__codelineno-3-12 name=__codelineno-3-12 href=#__codelineno-3-12></a>VM { stack: [5, 7, 11], pc: 6, op_cnt: 3, trace: true, watermark: 3 }
<a id=__codelineno-3-13 name=__codelineno-3-13 href=#__codelineno-3-13></a>Executing op 0x11
<a id=__codelineno-3-14 name=__codelineno-3-14 href=#__codelineno-3-14></a>VM { stack: [5, -4], pc: 7, op_cnt: 4, trace: true, watermark: 3 }
<a id=__codelineno-3-15 name=__codelineno-3-15 href=#__codelineno-3-15></a>Executing op 0x12
<a id=__codelineno-3-16 name=__codelineno-3-16 href=#__codelineno-3-16></a>VM { stack: [-20], pc: 8, op_cnt: 5, trace: true, watermark: 3 }
<a id=__codelineno-3-17 name=__codelineno-3-17 href=#__codelineno-3-17></a>Executing op 0x02
<a id=__codelineno-3-18 name=__codelineno-3-18 href=#__codelineno-3-18></a>VM { stack: [-20, 13], pc: 10, op_cnt: 6, trace: true, watermark: 3 }
<a id=__codelineno-3-19 name=__codelineno-3-19 href=#__codelineno-3-19></a>Executing op 0x02
<a id=__codelineno-3-20 name=__codelineno-3-20 href=#__codelineno-3-20></a>VM { stack: [-20, 13, 17], pc: 12, op_cnt: 7, trace: true, watermark: 3 }
<a id=__codelineno-3-21 name=__codelineno-3-21 href=#__codelineno-3-21></a>Executing op 0x10
<a id=__codelineno-3-22 name=__codelineno-3-22 href=#__codelineno-3-22></a>VM { stack: [-20, 30], pc: 13, op_cnt: 8, trace: true, watermark: 3 }
<a id=__codelineno-3-23 name=__codelineno-3-23 href=#__codelineno-3-23></a>Executing op 0x10
<a id=__codelineno-3-24 name=__codelineno-3-24 href=#__codelineno-3-24></a>VM { stack: [10], pc: 14, op_cnt: 9, trace: true, watermark: 3 }
<a id=__codelineno-3-25 name=__codelineno-3-25 href=#__codelineno-3-25></a>Executing op 0x01
<a id=__codelineno-3-26 name=__codelineno-3-26 href=#__codelineno-3-26></a>VM { stack: [], pc: 15, op_cnt: 10, trace: true, watermark: 3 }
<a id=__codelineno-3-27 name=__codelineno-3-27 href=#__codelineno-3-27></a>Terminated!
<a id=__codelineno-3-28 name=__codelineno-3-28 href=#__codelineno-3-28></a>VM { stack: [], pc: 16, op_cnt: 11, trace: true, watermark: 3 }
<a id=__codelineno-3-29 name=__codelineno-3-29 href=#__codelineno-3-29></a>Terminated.
<a id=__codelineno-3-30 name=__codelineno-3-30 href=#__codelineno-3-30></a>Runtime=49.33µs
<a id=__codelineno-3-31 name=__codelineno-3-31 href=#__codelineno-3-31></a>op_cnt=11, pc=16, stack size=0, watermark=3
</code></pre></div> <p>Remember to add <code>--trace</code> to the call, or you won't see very much. It has become a lot easier, to play around with the VM. No more writing bytecode by hand!</p> <h2 id=file-extension>File extension<a class=headerlink href=#file-extension title="Permanent link">&para;</a></h2> <p>You might have noticed that I changed the filename extension that I use for the assembly programs from <code>.lass</code> to <code>.lva</code>. There are multiple reasons, but the main one is, that I thought <em>Lass</em> could be a nice name for a programming language, when I will finally come to writing one for lovem. So I want to reserve the extension for that possible future.</p> <h2 id=playing-around>Playing around<a class=headerlink href=#playing-around title="Permanent link">&para;</a></h2> <p>The diagnostic information given after the execution can be interesting, when you mess around. Let us play a bit with the program <a href=https://github.com/kratenko/lovem/blob/v0.0.9-journey/pgm/endless-stack.lva><code>endless-stack.lva</code></a>.</p> <div class=highlight><pre><span></span><code><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a># This program runs in an endless loop, but it will push a new value to the stack on every iteration.
<a id=__codelineno-4-2 name=__codelineno-4-2 href=#__codelineno-4-2></a># It will inevitably lead to a stack overrun at some point and crash the program.
<a id=__codelineno-4-3 name=__codelineno-4-3 href=#__codelineno-4-3></a>push_u8 123
<a id=__codelineno-4-4 name=__codelineno-4-4 href=#__codelineno-4-4></a>goto -5
<a id=__codelineno-4-5 name=__codelineno-4-5 href=#__codelineno-4-5></a>fin
</code></pre></div> <p>The program will fill the stack until it is full, and then it will crash:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a>     Running `target/debug/lovas -r pgm/endless-stack.lva --print`
<a id=__codelineno-5-2 name=__codelineno-5-2 href=#__codelineno-5-2></a>Pgm { name: &quot;pgm/endless-stack.lva&quot;, text: [2, 123, 32, 255, 251, 255] }
<a id=__codelineno-5-3 name=__codelineno-5-3 href=#__codelineno-5-3></a>Runtime error!
<a id=__codelineno-5-4 name=__codelineno-5-4 href=#__codelineno-5-4></a>Runtime=41.589µs
<a id=__codelineno-5-5 name=__codelineno-5-5 href=#__codelineno-5-5></a>op_cnt=201, pc=2, stack-depth=100, watermark=100
<a id=__codelineno-5-6 name=__codelineno-5-6 href=#__codelineno-5-6></a>Error: StackOverflow
</code></pre></div> <p>After 201 executed instructions it crashes. The stack depth at the time of the crash is 100. That is the complete stack, the next instruction tried to push value 101, which must fail. Instruction number 201 did cause the crash. That makes sense, if you follow the execution in your head. And the program counter is on 2. The last instruction executed will be the one before that, which would be at 0. That is the <code>push_u8</code> instruction. There is no surprise that the watermark is at 100. That is the highest possible value for it and also the current value of out stack depth.</p> <p>As we can now easily change the stack size, let us try what happens with a bigger stack:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a>     Running `target/debug/lovas -r pgm/endless-stack.lva --print --stack-size 150`
<a id=__codelineno-6-2 name=__codelineno-6-2 href=#__codelineno-6-2></a>Pgm { name: &quot;pgm/endless-stack.lva&quot;, text: [2, 123, 32, 255, 251, 255] }
<a id=__codelineno-6-3 name=__codelineno-6-3 href=#__codelineno-6-3></a>Runtime error!
<a id=__codelineno-6-4 name=__codelineno-6-4 href=#__codelineno-6-4></a>Runtime=47.648µs
<a id=__codelineno-6-5 name=__codelineno-6-5 href=#__codelineno-6-5></a>op_cnt=301, pc=2, stack-depth=150, watermark=150
<a id=__codelineno-6-6 name=__codelineno-6-6 href=#__codelineno-6-6></a>Error: StackOverflow
</code></pre></div> <p>So now the stack overflows at over 150 values, of course. And it takes 301 instructions to fill it. Runtime has been longer, but only about 15%. I would not have expected a rise of 50%, as there is overhead for starting the program.</p> <p>What happens, if we activate <code>--trace</code>?</p> <div class=highlight><pre><span></span><code><a id=__codelineno-7-1 name=__codelineno-7-1 href=#__codelineno-7-1></a>     Running `target/debug/lovas -r pgm/endless-stack.lva --print --stack-size 150 --trace`
<a id=__codelineno-7-2 name=__codelineno-7-2 href=#__codelineno-7-2></a>Pgm { name: &quot;pgm/endless-stack.lva&quot;, text: [2, 123, 32, 255, 251, 255] }
<a id=__codelineno-7-3 name=__codelineno-7-3 href=#__codelineno-7-3></a>VM { stack: [], pc: 0, op_cnt: 0, trace: true, watermark: 0 }
<a id=__codelineno-7-4 name=__codelineno-7-4 href=#__codelineno-7-4></a>Executing op 0x02
<a id=__codelineno-7-5 name=__codelineno-7-5 href=#__codelineno-7-5></a>VM { stack: [123], pc: 2, op_cnt: 1, trace: true, watermark: 1 }
<a id=__codelineno-7-6 name=__codelineno-7-6 href=#__codelineno-7-6></a>Executing op 0x20
<a id=__codelineno-7-7 name=__codelineno-7-7 href=#__codelineno-7-7></a>
<a id=__codelineno-7-8 name=__codelineno-7-8 href=#__codelineno-7-8></a>[...]
<a id=__codelineno-7-9 name=__codelineno-7-9 href=#__codelineno-7-9></a>
<a id=__codelineno-7-10 name=__codelineno-7-10 href=#__codelineno-7-10></a>Executing op 0x02
<a id=__codelineno-7-11 name=__codelineno-7-11 href=#__codelineno-7-11></a>Runtime error!
<a id=__codelineno-7-12 name=__codelineno-7-12 href=#__codelineno-7-12></a>Runtime=67.312973ms
<a id=__codelineno-7-13 name=__codelineno-7-13 href=#__codelineno-7-13></a>op_cnt=301, pc=2, stack-depth=150, watermark=150
<a id=__codelineno-7-14 name=__codelineno-7-14 href=#__codelineno-7-14></a>Error: StackOverflow
</code></pre></div> <p>There is, of course, a lot of output, that I cut out. What is interesting is the change in execution time. I ran this inside the CLion IDE by JetBrains. The console there will not be a very fast console, as it does a lot with that output coming through. But the impact of the logging is enormous! The runtime until we hit our stack overflow is more than 1000 times longer! The exact numbers don't mean anything; we are running unoptimised Rust code with debuginfo, and the bottleneck is the console. But it is still fascinating to see.</p> <hr> <p><em>The source code for this post can be found under the tag <code>v0.0.9-journey</code></em>.</p> <ul> <li><span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path fill-rule=evenodd d="M8.78 4.97a.75.75 0 0 1 0 1.06L2.81 12l5.97 5.97a.75.75 0 1 1-1.06 1.06l-6.5-6.5a.75.75 0 0 1 0-1.06l6.5-6.5a.75.75 0 0 1 1.06 0zm6.44 0a.75.75 0 0 0 0 1.06L21.19 12l-5.97 5.97a.75.75 0 1 0 1.06 1.06l6.5-6.5a.75.75 0 0 0 0-1.06l-6.5-6.5a.75.75 0 0 0-1.06 0z"/></svg></span> <a href=https://github.com/kratenko/lovem/tree/v0.0.9-journey>v0.0.9-journey source code</a></li> <li><span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M7.75 6.5a1.25 1.25 0 1 0 0 2.5 1.25 1.25 0 0 0 0-2.5z"/><path fill-rule=evenodd d="M2.5 1A1.5 1.5 0 0 0 1 2.5v8.44c0 .397.158.779.44 1.06l10.25 10.25a1.5 1.5 0 0 0 2.12 0l8.44-8.44a1.5 1.5 0 0 0 0-2.12L12 1.44A1.5 1.5 0 0 0 10.94 1H2.5zm0 1.5h8.44l10.25 10.25-8.44 8.44L2.5 10.94V2.5z"/></svg></span> <a href=https://github.com/kratenko/lovem/releases/tag/v0.0.9-journey>v0.0.9-journey release</a></li> <li><span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M5 2.5a.5.5 0 0 0-.5.5v18a.5.5 0 0 0 .5.5h1.75a.75.75 0 0 1 0 1.5H5a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h9.982a2 2 0 0 1 1.414.586l4.018 4.018A2 2 0 0 1 21 7.018V21a2 2 0 0 1-2 2h-2.75a.75.75 0 0 1 0-1.5H19a.5.5 0 0 0 .5-.5V7.018a.5.5 0 0 0-.146-.354l-4.018-4.018a.5.5 0 0 0-.354-.146H5z"/><path d="M11.5 15.75a.75.75 0 0 1 .75-.75h1a.75.75 0 0 1 0 1.5h-1a.75.75 0 0 1-.75-.75zm.75-3.75a.75.75 0 0 0 0 1.5h1a.75.75 0 0 0 0-1.5h-1zm-.75-2.25a.75.75 0 0 1 .75-.75h1a.75.75 0 0 1 0 1.5h-1a.75.75 0 0 1-.75-.75zM12.25 6a.75.75 0 0 0 0 1.5h1a.75.75 0 0 0 0-1.5h-1zm-.75-2.25a.75.75 0 0 1 .75-.75h1a.75.75 0 0 1 0 1.5h-1a.75.75 0 0 1-.75-.75zM9.75 13.5a.75.75 0 0 0 0 1.5h1a.75.75 0 0 0 0-1.5h-1zM9 11.25a.75.75 0 0 1 .75-.75h1a.75.75 0 0 1 0 1.5h-1a.75.75 0 0 1-.75-.75zm.75-3.75a.75.75 0 0 0 0 1.5h1a.75.75 0 0 0 0-1.5h-1zM9 5.25a.75.75 0 0 1 .75-.75h1a.75.75 0 0 1 0 1.5h-1A.75.75 0 0 1 9 5.25z"/><path fill-rule=evenodd d="M11 17a2 2 0 0 0-2 2v4.25c0 .414.336.75.75.75h3.5a.75.75 0 0 0 .75-.75V19a2 2 0 0 0-2-2h-1zm-.5 2a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v3.5h-2V19z"/></svg></span> <a href=https://github.com/kratenko/lovem/archive/refs/tags/v0.0.9-journey.zip>v0.0.9-journey.zip</a></li> <li><span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M5 2.5a.5.5 0 0 0-.5.5v18a.5.5 0 0 0 .5.5h1.75a.75.75 0 0 1 0 1.5H5a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h9.982a2 2 0 0 1 1.414.586l4.018 4.018A2 2 0 0 1 21 7.018V21a2 2 0 0 1-2 2h-2.75a.75.75 0 0 1 0-1.5H19a.5.5 0 0 0 .5-.5V7.018a.5.5 0 0 0-.146-.354l-4.018-4.018a.5.5 0 0 0-.354-.146H5z"/><path d="M11.5 15.75a.75.75 0 0 1 .75-.75h1a.75.75 0 0 1 0 1.5h-1a.75.75 0 0 1-.75-.75zm.75-3.75a.75.75 0 0 0 0 1.5h1a.75.75 0 0 0 0-1.5h-1zm-.75-2.25a.75.75 0 0 1 .75-.75h1a.75.75 0 0 1 0 1.5h-1a.75.75 0 0 1-.75-.75zM12.25 6a.75.75 0 0 0 0 1.5h1a.75.75 0 0 0 0-1.5h-1zm-.75-2.25a.75.75 0 0 1 .75-.75h1a.75.75 0 0 1 0 1.5h-1a.75.75 0 0 1-.75-.75zM9.75 13.5a.75.75 0 0 0 0 1.5h1a.75.75 0 0 0 0-1.5h-1zM9 11.25a.75.75 0 0 1 .75-.75h1a.75.75 0 0 1 0 1.5h-1a.75.75 0 0 1-.75-.75zm.75-3.75a.75.75 0 0 0 0 1.5h1a.75.75 0 0 0 0-1.5h-1zM9 5.25a.75.75 0 0 1 .75-.75h1a.75.75 0 0 1 0 1.5h-1A.75.75 0 0 1 9 5.25z"/><path fill-rule=evenodd d="M11 17a2 2 0 0 0-2 2v4.25c0 .414.336.75.75.75h3.5a.75.75 0 0 0 .75-.75V19a2 2 0 0 0-2-2h-1zm-.5 2a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v3.5h-2V19z"/></svg></span> <a href=https://github.com/kratenko/lovem/archive/refs/tags/v0.0.9-journey.tar.gz>v0.0.9-journey.tar.gz</a></li> <li><code>git checkout v0.0.9-journey</code></li> </ul> <p><em><a href=../source-code.html#tags>What does this mean?</a></em></p> <script src=https://giscus.app/client.js data-repo=kratenko/lovem data-repo-id=R_kgDOHjmZ5Q data-category=Comments data-category-id=DIC_kwDOHjmZ5c4CQPDu data-mapping=pathname data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=light data-lang=en data-loading=lazy crossorigin=anonymous async>
</script> </article> </div> </div> <a href=# class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg> Back to top </a> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=you-labeled-me-i-ll-label-you.html class="md-footer__link md-footer__link--prev" aria-label="Previous:  You labeled me, I'll label you" rel=prev> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </div> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Previous </span> You labeled me, I'll label you </div> </div> </a> <a href=assembling-bytes.html class="md-footer__link md-footer__link--next" aria-label="Next:  Assembling bytes" rel=next> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Next </span> Assembling bytes </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-social> <a href=https://github.com/kratenko target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg> </a> <a href=https://chaos.social/@kratenko target=_blank rel=noopener title=chaos.social class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48 0 0 0-63.72 28.5-63.72 125.7 0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54 0 0 1-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "..", "features": ["navigation.indexes", "navigation.sections", "navigation.top", "navigation.tracking", "navigation.expand"], "search": "../assets/javascripts/workers/search.16e2a7d4.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script> <script src=../assets/javascripts/bundle.5a2dcb6a.min.js></script> </body> </html>