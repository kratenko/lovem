<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Lovem & ndash; the low overhead virtual embedded machine. And the journey getting there."><meta name=author content=kratenko><link rel=canonical href=https://kratenko.github.io/lovem/2022-08/ALL.html><link rel=icon href=../assets/images/favicon.png><meta name=generator content="mkdocs-1.5.3, mkdocs-material-8.5.10"><title>August 2022 complete - Lovem</title><link rel=stylesheet href=../assets/stylesheets/main.975780f9.min.css><link rel=stylesheet href=../assets/stylesheets/palette.2505c338.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../stylesheets/custom.css><script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=None data-md-color-accent=None> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#complete-month-of-august-2022 class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../index.html title=Lovem class="md-header__button md-logo" aria-label=Lovem data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Lovem </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> August 2022 complete </span> </div> </div> </div> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/kratenko/lovem title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> kratenko/lovem </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../index.html title=Lovem class="md-nav__button md-logo" aria-label=Lovem data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg> </a> Lovem </label> <div class=md-nav__source> <a href=https://github.com/kratenko/lovem title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> kratenko/lovem </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../index.html class=md-nav__link> The Journey </a> </li> <li class=md-nav__item> <a href=../source-code.html class=md-nav__link> Source Code </a> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle=__nav_3 type=checkbox id=__nav_3 checked> <div class="md-nav__link md-nav__link--index "> <a href=../journal/index.html>Journal</a> <label for=__nav_3> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav aria-label=Journal data-md-level=1> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Journal </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle=__nav_3_2 type=checkbox id=__nav_3_2 checked> <div class="md-nav__link md-nav__link--index "> <a href=../2024-02/index.html>February 2024</a> <label for=__nav_3_2> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav aria-label="February 2024" data-md-level=2> <label class=md-nav__title for=__nav_3_2> <span class="md-nav__icon md-icon"></span> February 2024 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../2024-02/we-have-variables.html class=md-nav__link> We have variables! </a> </li> <li class=md-nav__item> <a href=../2024-02/stop-right-there-that-s-far-enough.html class=md-nav__link> Stop right there, that's far enough! </a> </li> <li class=md-nav__item> <a href=../2024-02/it-has-been-a-while.html class=md-nav__link> It has been a while... </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle=__nav_3_3 type=checkbox id=__nav_3_3 checked> <div class="md-nav__link md-nav__link--index "> <a href=index.html>August 2022</a> <label for=__nav_3_3> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav aria-label="August 2022" data-md-level=2> <label class=md-nav__title for=__nav_3_3> <span class="md-nav__icon md-icon"></span> August 2022 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=what-if.html class=md-nav__link> What if? </a> </li> <li class=md-nav__item> <a href=you-labeled-me-i-ll-label-you.html class=md-nav__link> You labeled me, I'll label you </a> </li> <li class=md-nav__item> <a href=running-assembler-programs.html class=md-nav__link> Running assembler programs </a> </li> <li class=md-nav__item> <a href=assembling-bytes.html class=md-nav__link> Assembling bytes </a> </li> <li class=md-nav__item> <a href=handling-instructions.html class=md-nav__link> Handling instructions </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle=__nav_3_4 type=checkbox id=__nav_3_4 checked> <div class="md-nav__link md-nav__link--index "> <a href=../2022-07/index.html>July 2022</a> <label for=__nav_3_4> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav aria-label="July 2022" data-md-level=2> <label class=md-nav__title for=__nav_3_4> <span class="md-nav__icon md-icon"></span> July 2022 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../2022-07/parsing-the-source.html class=md-nav__link> Parsing the source </a> </li> <li class=md-nav__item> <a href=../2022-07/assemble.html class=md-nav__link> Assemble! </a> </li> <li class=md-nav__item> <a href=../2022-07/don-t-byte-me.html class=md-nav__link> Don't byte me! </a> </li> <li class=md-nav__item> <a href=../2022-07/go-ahead-and-jump.html class=md-nav__link> Go ahead and jump! </a> </li> <li class=md-nav__item> <a href=../2022-07/reverse-polish-notation.html class=md-nav__link> Reverse polish notation </a> </li> <li class=md-nav__item> <a href=../2022-07/more-operations.html class=md-nav__link> More operations </a> </li> <li class=md-nav__item> <a href=../2022-07/early-vm-decisions.html class=md-nav__link> Early VM decisions </a> </li> <li class=md-nav__item> <a href=../2022-07/to-the-library.html class=md-nav__link> To the library! </a> </li> <li class=md-nav__item> <a href=../2022-07/becoming-social.html class=md-nav__link> Becoming social </a> </li> <li class=md-nav__item> <a href=../2022-07/turn-fragile-into-rusty.html class=md-nav__link> Turn "fragile" into "rusty" </a> </li> <li class=md-nav__item> <a href=../2022-07/running-our-first-program.html class=md-nav__link> Running our first program </a> </li> <li class=md-nav__item> <a href=../2022-07/a-vm.html class=md-nav__link> A VM </a> </li> <li class=md-nav__item> <a href=../2022-07/it-looks-so-weird.html class=md-nav__link> It looks so weird </a> </li> <li class=md-nav__item> <a href=../2022-07/let-there-be-source-code.html class=md-nav__link> Let there be source code </a> </li> <li class=md-nav__item> <a href=../2022-07/making-virtual-a-reality.html class=md-nav__link> Making virtual a reality </a> </li> <li class=md-nav__item> <a href=../2022-07/what-is-a-virtual-machine-anyway.html class=md-nav__link> What is a Virtual Machine anyway? </a> </li> <li class=md-nav__item> <a href=../2022-07/all-new-once-more.html class=md-nav__link> All new once more </a> </li> <li class=md-nav__item> <a href=../2022-07/state-of-the-journal.html class=md-nav__link> State of the Journal </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle=__nav_3_5 type=checkbox id=__nav_3_5 checked> <div class="md-nav__link md-nav__link--index "> <a href=../2022-06/index.html>June 2022</a> <label for=__nav_3_5> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav aria-label="June 2022" data-md-level=2> <label class=md-nav__title for=__nav_3_5> <span class="md-nav__icon md-icon"></span> June 2022 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../2022-06/script-or-virtual.html class=md-nav__link> Script or virtual </a> </li> <li class=md-nav__item> <a href=../2022-06/that-use-case.html class=md-nav__link> That use-case I was talking about </a> </li> <li class=md-nav__item> <a href=../2022-06/we-need-another-wheel.html class=md-nav__link> We need another wheel </a> </li> <li class=md-nav__item> <a href=../2022-06/lovem-again.html class=md-nav__link> Lovem again! </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4 type=checkbox id=__nav_4 checked> <label class=md-nav__link for=__nav_4> Journal (complete months) <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Journal (complete months)" data-md-level=1> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Journal (complete months) </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../2024-02/ALL.html class=md-nav__link> February 2024 complete </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> August 2022 complete <span class="md-nav__icon md-icon"></span> </label> <a href=ALL.html class="md-nav__link md-nav__link--active"> August 2022 complete </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#handling-instructions class=md-nav__link> Handling instructions </a> <nav class=md-nav aria-label="Handling instructions"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#different-kind-of-instructions class=md-nav__link> Different kind of instructions </a> <nav class=md-nav aria-label="Different kind of instructions"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#a0 class=md-nav__link> a0 </a> </li> <li class=md-nav__item> <a href=#a1-push_u8 class=md-nav__link> a1: push_u8 </a> </li> <li class=md-nav__item> <a href=#a2-goto class=md-nav__link> a2: goto </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#parsing-completed class=md-nav__link> Parsing completed </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#assembling-bytes class=md-nav__link> Assembling bytes </a> <nav class=md-nav aria-label="Assembling bytes"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#parsed class=md-nav__link> Parsed </a> </li> <li class=md-nav__item> <a href=#connect-the-bytes class=md-nav__link> Connect the bytes </a> </li> <li class=md-nav__item> <a href=#run-the-assembler class=md-nav__link> Run the assembler </a> </li> <li class=md-nav__item> <a href=#running-into-errors class=md-nav__link> Running into errors </a> </li> <li class=md-nav__item> <a href=#why-asmpgm class=md-nav__link> Why AsmPgm? </a> </li> <li class=md-nav__item> <a href=#impl-errorerror class=md-nav__link> impl error::Error </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#running-assembler-programs class=md-nav__link> Running assembler programs </a> <nav class=md-nav aria-label="Running assembler programs"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#execution class=md-nav__link> Execution </a> </li> <li class=md-nav__item> <a href=#trace-log class=md-nav__link> Trace Log </a> </li> <li class=md-nav__item> <a href=#diagnostics class=md-nav__link> Diagnostics </a> </li> <li class=md-nav__item> <a href=#our-programs class=md-nav__link> Our programs </a> </li> <li class=md-nav__item> <a href=#file-extension class=md-nav__link> File extension </a> </li> <li class=md-nav__item> <a href=#playing-around class=md-nav__link> Playing around </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#you-labeled-me-ill-label-you class=md-nav__link> You labeled me, I'll label you </a> <nav class=md-nav aria-label="You labeled me, I'll label you"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#labels class=md-nav__link> Labels </a> </li> <li class=md-nav__item> <a href=#reconstruction class=md-nav__link> Reconstruction </a> </li> <li class=md-nav__item> <a href=#parsing-label-definitions class=md-nav__link> Parsing label definitions </a> </li> <li class=md-nav__item> <a href=#lifetime class=md-nav__link> Lifetime </a> <nav class=md-nav aria-label=Lifetime> <ul class=md-nav__list> <li class=md-nav__item> <a href=#an-example class=md-nav__link> An example </a> </li> <li class=md-nav__item> <a href=#easy-way-out class=md-nav__link> Easy way out </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#run-it-already class=md-nav__link> Run it already! </a> </li> <li class=md-nav__item> <a href=#homework class=md-nav__link> Homework </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#what-if class=md-nav__link> What if? </a> <nav class=md-nav aria-label="What if?"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#conditional-jump class=md-nav__link> Conditional jump </a> </li> <li class=md-nav__item> <a href=#new-operations class=md-nav__link> New operations </a> </li> <li class=md-nav__item> <a href=#extending-the-assembler class=md-nav__link> Extending the assembler </a> </li> <li class=md-nav__item> <a href=#adjust-the-vm class=md-nav__link> Adjust the VM </a> </li> <li class=md-nav__item> <a href=#a-for-loop class=md-nav__link> A for-loop </a> </li> <li class=md-nav__item> <a href=#homework_1 class=md-nav__link> Homework </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../2022-07/ALL.html class=md-nav__link> July 2022 complete </a> </li> <li class=md-nav__item> <a href=../2022-06/ALL.html class=md-nav__link> June 2022 complete </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#handling-instructions class=md-nav__link> Handling instructions </a> <nav class=md-nav aria-label="Handling instructions"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#different-kind-of-instructions class=md-nav__link> Different kind of instructions </a> <nav class=md-nav aria-label="Different kind of instructions"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#a0 class=md-nav__link> a0 </a> </li> <li class=md-nav__item> <a href=#a1-push_u8 class=md-nav__link> a1: push_u8 </a> </li> <li class=md-nav__item> <a href=#a2-goto class=md-nav__link> a2: goto </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#parsing-completed class=md-nav__link> Parsing completed </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#assembling-bytes class=md-nav__link> Assembling bytes </a> <nav class=md-nav aria-label="Assembling bytes"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#parsed class=md-nav__link> Parsed </a> </li> <li class=md-nav__item> <a href=#connect-the-bytes class=md-nav__link> Connect the bytes </a> </li> <li class=md-nav__item> <a href=#run-the-assembler class=md-nav__link> Run the assembler </a> </li> <li class=md-nav__item> <a href=#running-into-errors class=md-nav__link> Running into errors </a> </li> <li class=md-nav__item> <a href=#why-asmpgm class=md-nav__link> Why AsmPgm? </a> </li> <li class=md-nav__item> <a href=#impl-errorerror class=md-nav__link> impl error::Error </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#running-assembler-programs class=md-nav__link> Running assembler programs </a> <nav class=md-nav aria-label="Running assembler programs"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#execution class=md-nav__link> Execution </a> </li> <li class=md-nav__item> <a href=#trace-log class=md-nav__link> Trace Log </a> </li> <li class=md-nav__item> <a href=#diagnostics class=md-nav__link> Diagnostics </a> </li> <li class=md-nav__item> <a href=#our-programs class=md-nav__link> Our programs </a> </li> <li class=md-nav__item> <a href=#file-extension class=md-nav__link> File extension </a> </li> <li class=md-nav__item> <a href=#playing-around class=md-nav__link> Playing around </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#you-labeled-me-ill-label-you class=md-nav__link> You labeled me, I'll label you </a> <nav class=md-nav aria-label="You labeled me, I'll label you"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#labels class=md-nav__link> Labels </a> </li> <li class=md-nav__item> <a href=#reconstruction class=md-nav__link> Reconstruction </a> </li> <li class=md-nav__item> <a href=#parsing-label-definitions class=md-nav__link> Parsing label definitions </a> </li> <li class=md-nav__item> <a href=#lifetime class=md-nav__link> Lifetime </a> <nav class=md-nav aria-label=Lifetime> <ul class=md-nav__list> <li class=md-nav__item> <a href=#an-example class=md-nav__link> An example </a> </li> <li class=md-nav__item> <a href=#easy-way-out class=md-nav__link> Easy way out </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#run-it-already class=md-nav__link> Run it already! </a> </li> <li class=md-nav__item> <a href=#homework class=md-nav__link> Homework </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#what-if class=md-nav__link> What if? </a> <nav class=md-nav aria-label="What if?"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#conditional-jump class=md-nav__link> Conditional jump </a> </li> <li class=md-nav__item> <a href=#new-operations class=md-nav__link> New operations </a> </li> <li class=md-nav__item> <a href=#extending-the-assembler class=md-nav__link> Extending the assembler </a> </li> <li class=md-nav__item> <a href=#adjust-the-vm class=md-nav__link> Adjust the VM </a> </li> <li class=md-nav__item> <a href=#a-for-loop class=md-nav__link> A for-loop </a> </li> <li class=md-nav__item> <a href=#homework_1 class=md-nav__link> Homework </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=complete-month-of-august-2022>Complete month of August 2022<a class=headerlink href=#complete-month-of-august-2022 title="Permanent link">&para;</a></h1> <h2 id=handling-instructions>Handling instructions<a class=headerlink href=#handling-instructions title="Permanent link">&para;</a></h2> <aside class=mdx-author> <p><img alt=@kratenko src=https://avatars.githubusercontent.com/kratenko></p> <p><span><strong>kratenko</strong> 路 <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 16 16"><path fill-rule=evenodd d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"/></svg></span> <a href=https://github.com/kratenko>kratenko</a></span> <span> <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path fill-rule=evenodd d="M6.75 0a.75.75 0 0 1 .75.75V3h9V.75a.75.75 0 0 1 1.5 0V3h2.75c.966 0 1.75.784 1.75 1.75v16a1.75 1.75 0 0 1-1.75 1.75H3.25a1.75 1.75 0 0 1-1.75-1.75v-16C1.5 3.784 2.284 3 3.25 3H6V.75A.75.75 0 0 1 6.75 0zm-3.5 4.5a.25.25 0 0 0-.25.25V8h18V4.75a.25.25 0 0 0-.25-.25H3.25zM21 9.5H3v11.25c0 .138.112.25.25.25h17.5a.25.25 0 0 0 .25-.25V9.5z"/></svg></span> 2022-08-08 路 <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path fill-rule=evenodd d="M0 3.75A.75.75 0 0 1 .75 3h7.497c1.566 0 2.945.8 3.751 2.014A4.496 4.496 0 0 1 15.75 3h7.5a.75.75 0 0 1 .75.75v15.063a.75.75 0 0 1-.755.75l-7.682-.052a3 3 0 0 0-2.142.878l-.89.891a.75.75 0 0 1-1.061 0l-.902-.901a3 3 0 0 0-2.121-.879H.75a.75.75 0 0 1-.75-.75v-15zm11.247 3.747a3 3 0 0 0-3-2.997H1.5V18h6.947a4.5 4.5 0 0 1 2.803.98l-.003-11.483zm1.503 11.485V7.5a3 3 0 0 1 3-3h6.75v13.558l-6.927-.047a4.5 4.5 0 0 0-2.823.971z"/></svg></span> Entry #23 路 <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12.5 7.25a.75.75 0 0 0-1.5 0v5.5c0 .27.144.518.378.651l3.5 2a.75.75 0 0 0 .744-1.302L12.5 12.315V7.25z"/><path fill-rule=evenodd d="M12 1C5.925 1 1 5.925 1 12s4.925 11 11 11 11-4.925 11-11S18.075 1 12 1zM2.5 12a9.5 9.5 0 1 1 19 0 9.5 9.5 0 0 1-19 0z"/></svg></span> 4 min read 路 <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M7.75 6.5a1.25 1.25 0 1 0 0 2.5 1.25 1.25 0 0 0 0-2.5z"/><path fill-rule=evenodd d="M2.5 1A1.5 1.5 0 0 0 1 2.5v8.44c0 .397.158.779.44 1.06l10.25 10.25a1.5 1.5 0 0 0 2.12 0l8.44-8.44a1.5 1.5 0 0 0 0-2.12L12 1.44A1.5 1.5 0 0 0 10.94 1H2.5zm0 1.5h8.44l10.25 10.25-8.44 8.44L2.5 10.94V2.5z"/></svg></span> <a href=https://github.com/kratenko/lovem/releases/tag/v0.0.8-journey>v0.0.8-journey</a> </span></p> </aside> <hr> <p>We took care of all the dirty work inside the assembler during the previous posts. We now have a cleanly parsed instruction with an optional argument that we can evaluate. Let us dive into <code>parse_instruction()</code>:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=sd>/// Handles a single instruction of opcode an optional oparg parsed from Assembly file.</span>
<a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=k>fn</span> <span class=nf>parse_instruction</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>,</span><span class=w> </span><span class=n>opname</span>: <span class=kp>&amp;</span><span class=kt>str</span><span class=p>,</span><span class=w> </span><span class=n>oparg</span>: <span class=nb>Option</span><span class=o>&lt;&amp;</span><span class=kt>str</span><span class=o>&gt;</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=p>(),</span><span class=w> </span><span class=n>AsmError</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=w>    </span><span class=k>match</span><span class=w> </span><span class=n>opname</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=w>        </span><span class=s>&quot;nop&quot;</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>parse_a0_instruction</span><span class=p>(</span><span class=n>op</span>::<span class=n>NOP</span><span class=p>,</span><span class=w> </span><span class=n>oparg</span><span class=p>),</span>
<a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=w>        </span><span class=s>&quot;fin&quot;</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>parse_a0_instruction</span><span class=p>(</span><span class=n>op</span>::<span class=n>FIN</span><span class=p>,</span><span class=w> </span><span class=n>oparg</span><span class=p>),</span>
<a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=w>        </span><span class=s>&quot;pop&quot;</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>parse_a0_instruction</span><span class=p>(</span><span class=n>op</span>::<span class=n>POP</span><span class=p>,</span><span class=w> </span><span class=n>oparg</span><span class=p>),</span>
<a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a><span class=w>        </span><span class=s>&quot;add&quot;</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>parse_a0_instruction</span><span class=p>(</span><span class=n>op</span>::<span class=n>ADD</span><span class=p>,</span><span class=w> </span><span class=n>oparg</span><span class=p>),</span>
<a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a><span class=w>        </span><span class=s>&quot;sub&quot;</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>parse_a0_instruction</span><span class=p>(</span><span class=n>op</span>::<span class=n>SUB</span><span class=p>,</span><span class=w> </span><span class=n>oparg</span><span class=p>),</span>
<a id=__codelineno-0-9 name=__codelineno-0-9 href=#__codelineno-0-9></a><span class=w>        </span><span class=s>&quot;mul&quot;</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>parse_a0_instruction</span><span class=p>(</span><span class=n>op</span>::<span class=n>MUL</span><span class=p>,</span><span class=w> </span><span class=n>oparg</span><span class=p>),</span>
<a id=__codelineno-0-10 name=__codelineno-0-10 href=#__codelineno-0-10></a><span class=w>        </span><span class=s>&quot;div&quot;</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>parse_a0_instruction</span><span class=p>(</span><span class=n>op</span>::<span class=n>DIV</span><span class=p>,</span><span class=w> </span><span class=n>oparg</span><span class=p>),</span>
<a id=__codelineno-0-11 name=__codelineno-0-11 href=#__codelineno-0-11></a><span class=w>        </span><span class=s>&quot;mod&quot;</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>parse_a0_instruction</span><span class=p>(</span><span class=n>op</span>::<span class=n>MOD</span><span class=p>,</span><span class=w> </span><span class=n>oparg</span><span class=p>),</span>
<a id=__codelineno-0-12 name=__codelineno-0-12 href=#__codelineno-0-12></a><span class=w>        </span><span class=s>&quot;push_u8&quot;</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-0-13 name=__codelineno-0-13 href=#__codelineno-0-13></a><span class=w>            </span><span class=kd>let</span><span class=w> </span><span class=n>oparg</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>oparg</span><span class=p>.</span><span class=n>ok_or</span><span class=p>(</span><span class=n>AsmError</span>::<span class=n>MissingArgument</span><span class=p>)</span><span class=o>?</span><span class=p>;</span>
<a id=__codelineno-0-14 name=__codelineno-0-14 href=#__codelineno-0-14></a><span class=w>            </span><span class=kd>let</span><span class=w> </span><span class=n>v</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>parse_int</span>::<span class=n>parse</span>::<span class=o>&lt;</span><span class=kt>u8</span><span class=o>&gt;</span><span class=p>(</span><span class=n>oparg</span><span class=p>).</span><span class=n>or</span><span class=p>(</span><span class=nb>Err</span><span class=p>(</span><span class=n>AsmError</span>::<span class=n>InvalidArgument</span><span class=p>))</span><span class=o>?</span><span class=p>;</span>
<a id=__codelineno-0-15 name=__codelineno-0-15 href=#__codelineno-0-15></a><span class=w>            </span><span class=bp>self</span><span class=p>.</span><span class=n>push_a1_instruction</span><span class=p>(</span><span class=n>op</span>::<span class=n>PUSH_U8</span><span class=p>,</span><span class=w> </span><span class=n>v</span><span class=p>)</span>
<a id=__codelineno-0-16 name=__codelineno-0-16 href=#__codelineno-0-16></a><span class=w>        </span><span class=p>},</span>
<a id=__codelineno-0-17 name=__codelineno-0-17 href=#__codelineno-0-17></a><span class=w>        </span><span class=s>&quot;goto&quot;</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-0-18 name=__codelineno-0-18 href=#__codelineno-0-18></a><span class=w>            </span><span class=kd>let</span><span class=w> </span><span class=n>oparg</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>oparg</span><span class=p>.</span><span class=n>ok_or</span><span class=p>(</span><span class=n>AsmError</span>::<span class=n>MissingArgument</span><span class=p>)</span><span class=o>?</span><span class=p>;</span>
<a id=__codelineno-0-19 name=__codelineno-0-19 href=#__codelineno-0-19></a><span class=w>            </span><span class=kd>let</span><span class=w> </span><span class=n>v</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>parse_int</span>::<span class=n>parse</span>::<span class=o>&lt;</span><span class=kt>i16</span><span class=o>&gt;</span><span class=p>(</span><span class=n>oparg</span><span class=p>).</span><span class=n>or</span><span class=p>(</span><span class=nb>Err</span><span class=p>(</span><span class=n>AsmError</span>::<span class=n>InvalidArgument</span><span class=p>))</span><span class=o>?</span><span class=p>;</span>
<a id=__codelineno-0-20 name=__codelineno-0-20 href=#__codelineno-0-20></a><span class=w>            </span><span class=kd>let</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>v</span><span class=p>.</span><span class=n>to_be_bytes</span><span class=p>();</span>
<a id=__codelineno-0-21 name=__codelineno-0-21 href=#__codelineno-0-21></a><span class=w>            </span><span class=bp>self</span><span class=p>.</span><span class=n>push_a2_instruction</span><span class=p>(</span><span class=n>op</span>::<span class=n>GOTO</span><span class=p>,</span><span class=w> </span><span class=n>a</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span><span class=w> </span><span class=n>a</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span>
<a id=__codelineno-0-22 name=__codelineno-0-22 href=#__codelineno-0-22></a><span class=w>        </span><span class=p>},</span>
<a id=__codelineno-0-23 name=__codelineno-0-23 href=#__codelineno-0-23></a><span class=w>        </span><span class=n>_</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=nb>Err</span><span class=p>(</span><span class=n>AsmError</span>::<span class=n>UnknownInstruction</span><span class=p>(</span><span class=nb>String</span>::<span class=n>from</span><span class=p>(</span><span class=n>opname</span><span class=p>)))</span>
<a id=__codelineno-0-24 name=__codelineno-0-24 href=#__codelineno-0-24></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-0-25 name=__codelineno-0-25 href=#__codelineno-0-25></a><span class=p>}</span>
</code></pre></div> <p>That is a surprisingly simple function. It receives two parameters. <code>opname</code> is a <code>&amp;str</code> that holds the <code>opname</code> of the instruction. <code>oparg</code> is either <code>None</code>, if there was no argument in the instruction, or it holds a none-empty string that holds whatever argument was present in the instruction.</p> <p>The function only consists of a long <code>match</code>, that directly matches the <code>opname</code> against our known opnames. If there is no match, it returns a helpful error that even contains the unknown opname that was found.</p> <p>The explicit branches look a bit weirder. That is because I do not like to repeat myself when writing code. And Rust tends to allow some very dense source code. </p> <h3 id=different-kind-of-instructions>Different kind of instructions<a class=headerlink href=#different-kind-of-instructions title="Permanent link">&para;</a></h3> <p>I decided to group by instructions into three categories. They are grouped by the number of bytes an instruction uses as argument. An <code>a0</code> instruction has zero bytes of oparg, <code>a1</code> has one byte, and <code>a2</code> has two bytes. </p> <h4 id=a0>a0<a class=headerlink href=#a0 title="Permanent link">&para;</a></h4> <p>Most of our operations do not allow any argument at all. We want to make sure that there is none given in the instruction. And the only difference in handling those instructions inside the assembler is the byte that will be written to the bytecode. We can handle all of those with the same function: <code>parse_a0_instruction()</code>:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a><span class=sd>/// Helper that parses an instruction with no oparg and pushes it.</span>
<a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a><span class=k>fn</span> <span class=nf>parse_a0_instruction</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>,</span><span class=w> </span><span class=n>opcode</span>: <span class=kt>u8</span><span class=p>,</span><span class=w> </span><span class=n>oparg</span>: <span class=nb>Option</span><span class=o>&lt;&amp;</span><span class=kt>str</span><span class=o>&gt;</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=p>(),</span><span class=w> </span><span class=n>AsmError</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-1-3 name=__codelineno-1-3 href=#__codelineno-1-3></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=n>oparg</span><span class=p>.</span><span class=n>is_some</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-1-4 name=__codelineno-1-4 href=#__codelineno-1-4></a><span class=w>        </span><span class=nb>Err</span><span class=p>(</span><span class=n>AsmError</span>::<span class=n>UnexpectedArgument</span><span class=p>)</span>
<a id=__codelineno-1-5 name=__codelineno-1-5 href=#__codelineno-1-5></a><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-1-6 name=__codelineno-1-6 href=#__codelineno-1-6></a><span class=w>        </span><span class=bp>self</span><span class=p>.</span><span class=n>push_a0_instruction</span><span class=p>(</span><span class=n>opcode</span><span class=p>)</span>
<a id=__codelineno-1-7 name=__codelineno-1-7 href=#__codelineno-1-7></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-1-8 name=__codelineno-1-8 href=#__codelineno-1-8></a><span class=p>}</span>
</code></pre></div> <p>If we did get an argument, we fail, since that is not allowed. And then we push a very basic instruction to the back of our program. We have helper functions to do that:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a><span class=sd>/// Adds a single instruction to the end of the AsmProgram.</span>
<a id=__codelineno-2-2 name=__codelineno-2-2 href=#__codelineno-2-2></a><span class=k>fn</span> <span class=nf>push_instruction</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>,</span><span class=w> </span><span class=n>i</span>: <span class=nc>AsmInstruction</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=p>(),</span><span class=w> </span><span class=n>AsmError</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-2-3 name=__codelineno-2-3 href=#__codelineno-2-3></a><span class=w>    </span><span class=bp>self</span><span class=p>.</span><span class=n>text_pos</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>i</span><span class=p>.</span><span class=n>size</span><span class=p>();</span>
<a id=__codelineno-2-4 name=__codelineno-2-4 href=#__codelineno-2-4></a><span class=w>    </span><span class=bp>self</span><span class=p>.</span><span class=n>instructions</span><span class=p>.</span><span class=n>push</span><span class=p>(</span><span class=n>i</span><span class=p>);</span>
<a id=__codelineno-2-5 name=__codelineno-2-5 href=#__codelineno-2-5></a><span class=w>    </span><span class=nb>Ok</span><span class=p>(())</span>
<a id=__codelineno-2-6 name=__codelineno-2-6 href=#__codelineno-2-6></a><span class=p>}</span>
<a id=__codelineno-2-7 name=__codelineno-2-7 href=#__codelineno-2-7></a>
<a id=__codelineno-2-8 name=__codelineno-2-8 href=#__codelineno-2-8></a><span class=sd>/// Helper that creates an instruction with 0 bytes of oparg and pushes it.</span>
<a id=__codelineno-2-9 name=__codelineno-2-9 href=#__codelineno-2-9></a><span class=k>fn</span> <span class=nf>push_a0_instruction</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>,</span><span class=w> </span><span class=n>opcode</span>: <span class=kt>u8</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=p>(),</span><span class=w> </span><span class=n>AsmError</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-2-10 name=__codelineno-2-10 href=#__codelineno-2-10></a><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>AsmInstruction</span><span class=p>{</span>
<a id=__codelineno-2-11 name=__codelineno-2-11 href=#__codelineno-2-11></a><span class=w>        </span><span class=n>line_number</span>: <span class=nc>self</span><span class=p>.</span><span class=n>line_number</span><span class=p>,</span>
<a id=__codelineno-2-12 name=__codelineno-2-12 href=#__codelineno-2-12></a><span class=w>        </span><span class=n>opcode</span><span class=p>,</span>
<a id=__codelineno-2-13 name=__codelineno-2-13 href=#__codelineno-2-13></a><span class=w>        </span><span class=n>oparg</span>: <span class=nc>vec</span><span class=o>!</span><span class=p>[],</span>
<a id=__codelineno-2-14 name=__codelineno-2-14 href=#__codelineno-2-14></a><span class=w>        </span><span class=n>pos</span>: <span class=nc>self</span><span class=p>.</span><span class=n>text_pos</span><span class=p>,</span>
<a id=__codelineno-2-15 name=__codelineno-2-15 href=#__codelineno-2-15></a><span class=w>    </span><span class=p>};</span>
<a id=__codelineno-2-16 name=__codelineno-2-16 href=#__codelineno-2-16></a><span class=w>    </span><span class=bp>self</span><span class=p>.</span><span class=n>push_instruction</span><span class=p>(</span><span class=n>i</span><span class=p>)</span>
<a id=__codelineno-2-17 name=__codelineno-2-17 href=#__codelineno-2-17></a><span class=p>}</span>
</code></pre></div> <p>We create a new instruction instance and add it. We also track the position of every instruction in the bytecode, that is why we update the programs current position in the bytecode for every instruction we add (stored in <code>text_pos</code>).</p> <p>There is nothing we do with that information, yet. But we will need that information later.</p> <h4 id=a1-push_u8>a1: <code>push_u8</code><a class=headerlink href=#a1-push_u8 title="Permanent link">&para;</a></h4> <p>We only have one operation that needs a single byte of oparg, and that is <code>push_u8</code>. We use that operation to push values on the stack, taken directly from the bytecode. <code>u8</code> is the only type supported at the moment. That is not even a hard restriction; you can easily get any <code>i64</code> value to the stack by using basic arithmetics, and we have those.</p> <p>Parsing numbers is no fun. It is hard. So we let someone else do it for us. The crate we are using is called <a href=https://crates.io/crates/parse_int><code>parse_int</code></a>. Go take a look at what it can do. It allows us to enter numbers easily in hexadecimal, octal, or binary notation. That is a really handy feature in source code! Thanks, Rust community! So how are we parsing <code>push_u8</code>?</p> <div class=highlight><pre><span></span><code><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a><span class=s>&quot;push_u8&quot;</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>oparg</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>oparg</span><span class=p>.</span><span class=n>ok_or</span><span class=p>(</span><span class=n>AsmError</span>::<span class=n>MissingArgument</span><span class=p>)</span><span class=o>?</span><span class=p>;</span>
<a id=__codelineno-3-3 name=__codelineno-3-3 href=#__codelineno-3-3></a><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>v</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>parse_int</span>::<span class=n>parse</span>::<span class=o>&lt;</span><span class=kt>u8</span><span class=o>&gt;</span><span class=p>(</span><span class=n>oparg</span><span class=p>).</span><span class=n>or</span><span class=p>(</span><span class=nb>Err</span><span class=p>(</span><span class=n>AsmError</span>::<span class=n>InvalidArgument</span><span class=p>))</span><span class=o>?</span><span class=p>;</span>
<a id=__codelineno-3-4 name=__codelineno-3-4 href=#__codelineno-3-4></a><span class=w>    </span><span class=bp>self</span><span class=p>.</span><span class=n>push_a1_instruction</span><span class=p>(</span><span class=n>op</span>::<span class=n>PUSH_U8</span><span class=p>,</span><span class=w> </span><span class=n>v</span><span class=p>)</span>
<a id=__codelineno-3-5 name=__codelineno-3-5 href=#__codelineno-3-5></a><span class=p>},</span>
</code></pre></div> <p>First we make sure that we have an argument. If not, we fail. We can again use our handy <code>?</code> syntax. Then we try to parse it into a <code>u8</code>, using <code>parse_int</code>. The syntax for that call takes some getting used to - I'm still waiting for me to getting used to it. But if it works, we now have a valid <code>u8</code>. If it fails to parse, we quickly return with that failure information. If all goes well we will reach the third line, that calls our helper for adding a1 instructions. There is no big surprise in what that function does:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a><span class=sd>/// Helper that creates an instruction with 1 byte of oparg and pushes it.</span>
<a id=__codelineno-4-2 name=__codelineno-4-2 href=#__codelineno-4-2></a><span class=k>fn</span> <span class=nf>push_a1_instruction</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>,</span><span class=w> </span><span class=n>opcode</span>: <span class=kt>u8</span><span class=p>,</span><span class=w> </span><span class=n>a0</span>: <span class=kt>u8</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=p>(),</span><span class=w> </span><span class=n>AsmError</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-4-3 name=__codelineno-4-3 href=#__codelineno-4-3></a><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>AsmInstruction</span><span class=p>{</span>
<a id=__codelineno-4-4 name=__codelineno-4-4 href=#__codelineno-4-4></a><span class=w>        </span><span class=n>line_number</span>: <span class=nc>self</span><span class=p>.</span><span class=n>line_number</span><span class=p>,</span>
<a id=__codelineno-4-5 name=__codelineno-4-5 href=#__codelineno-4-5></a><span class=w>        </span><span class=n>opcode</span><span class=p>,</span>
<a id=__codelineno-4-6 name=__codelineno-4-6 href=#__codelineno-4-6></a><span class=w>        </span><span class=n>oparg</span>: <span class=nc>vec</span><span class=o>!</span><span class=p>[</span><span class=n>a0</span><span class=p>],</span>
<a id=__codelineno-4-7 name=__codelineno-4-7 href=#__codelineno-4-7></a><span class=w>        </span><span class=n>pos</span>: <span class=nc>self</span><span class=p>.</span><span class=n>text_pos</span><span class=p>,</span>
<a id=__codelineno-4-8 name=__codelineno-4-8 href=#__codelineno-4-8></a><span class=w>    </span><span class=p>};</span>
<a id=__codelineno-4-9 name=__codelineno-4-9 href=#__codelineno-4-9></a><span class=w>    </span><span class=bp>self</span><span class=p>.</span><span class=n>push_instruction</span><span class=p>(</span><span class=n>i</span><span class=p>)</span>
<a id=__codelineno-4-10 name=__codelineno-4-10 href=#__codelineno-4-10></a><span class=p>}</span>
</code></pre></div> <p>An interesting detail is, that <code>push_instruction()</code> returns a <code>Result</code>, even though it can never fail! It always returns <code>Ok(())</code>. And if you look at <code>push_a2_instruction()</code>, you will now see that it also will always return <code>Ok(())</code>. We do be bother? Take a look at the handler for <code>push_u8</code> again, in context of the complete function <code>parse_instruction()</code>. That function returns a <code>Result</code>, and it can return <code>Err(...)</code>. Because <code>push_a1_instruction()</code> has the same return value of <code>Result</code>, the calls integrate nicely with the layout of the complete function inside the <code>match</code>. For me, it gives the code a clean compactness.</p> <h4 id=a2-goto>a2: <code>goto</code><a class=headerlink href=#a2-goto title="Permanent link">&para;</a></h4> <p>There is one more branch to look at:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a><span class=s>&quot;goto&quot;</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-5-2 name=__codelineno-5-2 href=#__codelineno-5-2></a><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>oparg</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>oparg</span><span class=p>.</span><span class=n>ok_or</span><span class=p>(</span><span class=n>AsmError</span>::<span class=n>MissingArgument</span><span class=p>)</span><span class=o>?</span><span class=p>;</span>
<a id=__codelineno-5-3 name=__codelineno-5-3 href=#__codelineno-5-3></a><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>v</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>parse_int</span>::<span class=n>parse</span>::<span class=o>&lt;</span><span class=kt>i16</span><span class=o>&gt;</span><span class=p>(</span><span class=n>oparg</span><span class=p>).</span><span class=n>or</span><span class=p>(</span><span class=nb>Err</span><span class=p>(</span><span class=n>AsmError</span>::<span class=n>InvalidArgument</span><span class=p>))</span><span class=o>?</span><span class=p>;</span>
<a id=__codelineno-5-4 name=__codelineno-5-4 href=#__codelineno-5-4></a><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>v</span><span class=p>.</span><span class=n>to_be_bytes</span><span class=p>();</span>
<a id=__codelineno-5-5 name=__codelineno-5-5 href=#__codelineno-5-5></a><span class=w>    </span><span class=bp>self</span><span class=p>.</span><span class=n>push_a2_instruction</span><span class=p>(</span><span class=n>op</span>::<span class=n>GOTO</span><span class=p>,</span><span class=w> </span><span class=n>a</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span><span class=w> </span><span class=n>a</span><span class=p>[</span><span class=mi>1</span><span class=p>])</span>
<a id=__codelineno-5-6 name=__codelineno-5-6 href=#__codelineno-5-6></a><span class=p>},</span>
</code></pre></div> <p>This time we use <code>parse_int</code> to read a <code>i16</code>. Whether you like the <code>::&lt;i16&gt;</code> syntax or not, at least you can see what it is for. We need to unpack the two bytes of the <code>i16</code> after parsing, so that we can store the bytes correctly in the bytecode. <code>to_be_bytes()</code> gives us an array (of size 2) that holds the bytes in big endian byte order. <code>to_le_bytes()</code> is the little endian counterpart. I generally prefer big endian, when I can. And if you remember how we read the bytes in the VM, you can see that we are already using big endian there.</p> <p>There is nothing new in the <code>push_a2_instruction()</code> function, only one additional byte.</p> <div class=highlight><pre><span></span><code><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a><span class=sd>/// Helper that creates an instruction with 1 byte of oparg and pushes it.</span>
<a id=__codelineno-6-2 name=__codelineno-6-2 href=#__codelineno-6-2></a><span class=k>fn</span> <span class=nf>push_a2_instruction</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>,</span><span class=w> </span><span class=n>opcode</span>: <span class=kt>u8</span><span class=p>,</span><span class=w> </span><span class=n>a0</span>: <span class=kt>u8</span><span class=p>,</span><span class=w> </span><span class=n>a1</span>: <span class=kt>u8</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=p>(),</span><span class=w> </span><span class=n>AsmError</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-6-3 name=__codelineno-6-3 href=#__codelineno-6-3></a><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>AsmInstruction</span><span class=p>{</span>
<a id=__codelineno-6-4 name=__codelineno-6-4 href=#__codelineno-6-4></a><span class=w>        </span><span class=n>line_number</span>: <span class=nc>self</span><span class=p>.</span><span class=n>line_number</span><span class=p>,</span>
<a id=__codelineno-6-5 name=__codelineno-6-5 href=#__codelineno-6-5></a><span class=w>        </span><span class=n>opcode</span><span class=p>,</span>
<a id=__codelineno-6-6 name=__codelineno-6-6 href=#__codelineno-6-6></a><span class=w>        </span><span class=n>oparg</span>: <span class=nc>vec</span><span class=o>!</span><span class=p>[</span><span class=n>a0</span><span class=p>,</span><span class=w> </span><span class=n>a1</span><span class=p>],</span>
<a id=__codelineno-6-7 name=__codelineno-6-7 href=#__codelineno-6-7></a><span class=w>        </span><span class=n>pos</span>: <span class=nc>self</span><span class=p>.</span><span class=n>text_pos</span><span class=p>,</span>
<a id=__codelineno-6-8 name=__codelineno-6-8 href=#__codelineno-6-8></a><span class=w>    </span><span class=p>};</span>
<a id=__codelineno-6-9 name=__codelineno-6-9 href=#__codelineno-6-9></a><span class=w>    </span><span class=bp>self</span><span class=p>.</span><span class=n>push_instruction</span><span class=p>(</span><span class=n>i</span><span class=p>)</span>
<a id=__codelineno-6-10 name=__codelineno-6-10 href=#__codelineno-6-10></a><span class=p>}</span>
</code></pre></div> <h3 id=parsing-completed>Parsing completed<a class=headerlink href=#parsing-completed title="Permanent link">&para;</a></h3> <p>We have now parsed the complete program source into the <code>AsmPgm</code> structure. Or we have failed to do so, in which case there is an Error stored in <code>AsmPgm</code>. Either way, you have now seen all the code that does the parsing. Next journal entry will finally produce the bytecode we are longing for.</p> <h2 id=assembling-bytes>Assembling bytes<a class=headerlink href=#assembling-bytes title="Permanent link">&para;</a></h2> <aside class=mdx-author> <p><img alt=@kratenko src=https://avatars.githubusercontent.com/kratenko></p> <p><span><strong>kratenko</strong> 路 <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 16 16"><path fill-rule=evenodd d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"/></svg></span> <a href=https://github.com/kratenko>kratenko</a></span> <span> <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path fill-rule=evenodd d="M6.75 0a.75.75 0 0 1 .75.75V3h9V.75a.75.75 0 0 1 1.5 0V3h2.75c.966 0 1.75.784 1.75 1.75v16a1.75 1.75 0 0 1-1.75 1.75H3.25a1.75 1.75 0 0 1-1.75-1.75v-16C1.5 3.784 2.284 3 3.25 3H6V.75A.75.75 0 0 1 6.75 0zm-3.5 4.5a.25.25 0 0 0-.25.25V8h18V4.75a.25.25 0 0 0-.25-.25H3.25zM21 9.5H3v11.25c0 .138.112.25.25.25h17.5a.25.25 0 0 0 .25-.25V9.5z"/></svg></span> 2022-08-09 路 <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path fill-rule=evenodd d="M0 3.75A.75.75 0 0 1 .75 3h7.497c1.566 0 2.945.8 3.751 2.014A4.496 4.496 0 0 1 15.75 3h7.5a.75.75 0 0 1 .75.75v15.063a.75.75 0 0 1-.755.75l-7.682-.052a3 3 0 0 0-2.142.878l-.89.891a.75.75 0 0 1-1.061 0l-.902-.901a3 3 0 0 0-2.121-.879H.75a.75.75 0 0 1-.75-.75v-15zm11.247 3.747a3 3 0 0 0-3-2.997H1.5V18h6.947a4.5 4.5 0 0 1 2.803.98l-.003-11.483zm1.503 11.485V7.5a3 3 0 0 1 3-3h6.75v13.558l-6.927-.047a4.5 4.5 0 0 0-2.823.971z"/></svg></span> Entry #24 路 <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12.5 7.25a.75.75 0 0 0-1.5 0v5.5c0 .27.144.518.378.651l3.5 2a.75.75 0 0 0 .744-1.302L12.5 12.315V7.25z"/><path fill-rule=evenodd d="M12 1C5.925 1 1 5.925 1 12s4.925 11 11 11 11-4.925 11-11S18.075 1 12 1zM2.5 12a9.5 9.5 0 1 1 19 0 9.5 9.5 0 0 1-19 0z"/></svg></span> 4 min read 路 <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M7.75 6.5a1.25 1.25 0 1 0 0 2.5 1.25 1.25 0 0 0 0-2.5z"/><path fill-rule=evenodd d="M2.5 1A1.5 1.5 0 0 0 1 2.5v8.44c0 .397.158.779.44 1.06l10.25 10.25a1.5 1.5 0 0 0 2.12 0l8.44-8.44a1.5 1.5 0 0 0 0-2.12L12 1.44A1.5 1.5 0 0 0 10.94 1H2.5zm0 1.5h8.44l10.25 10.25-8.44 8.44L2.5 10.94V2.5z"/></svg></span> <a href=https://github.com/kratenko/lovem/releases/tag/v0.0.8-journey>v0.0.8-journey</a> </span></p> </aside> <hr> <p>Our new assembler is almost done assembling. Over the last entries we learned how the program parses the assembly sourcecode and produces a list of parsed instructions. What we now need to do, is turn that into bytes.</p> <h3 id=parsed>Parsed<a class=headerlink href=#parsed title="Permanent link">&para;</a></h3> <p>Let us take a look at where we are. We have our sample program <a href=https://github.com/kratenko/lovem/blob/v0.0.8-journey/pgm/hallo-stack.lass><code>hallo-stack.lass</code></a>:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-7-1 name=__codelineno-7-1 href=#__codelineno-7-1></a>push_u8 123
<a id=__codelineno-7-2 name=__codelineno-7-2 href=#__codelineno-7-2></a>push_u8 200
<a id=__codelineno-7-3 name=__codelineno-7-3 href=#__codelineno-7-3></a>add
<a id=__codelineno-7-4 name=__codelineno-7-4 href=#__codelineno-7-4></a>pop
<a id=__codelineno-7-5 name=__codelineno-7-5 href=#__codelineno-7-5></a>fin
</code></pre></div> <p>If we debug-print the <code>AsmPgm</code> after the parsing, it looks like this:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-8-1 name=__codelineno-8-1 href=#__codelineno-8-1></a>AsmPgm { 
<a id=__codelineno-8-2 name=__codelineno-8-2 href=#__codelineno-8-2></a>    name: &quot;pgm/hallo-stack.lass&quot;, 
<a id=__codelineno-8-3 name=__codelineno-8-3 href=#__codelineno-8-3></a>    instructions: [
<a id=__codelineno-8-4 name=__codelineno-8-4 href=#__codelineno-8-4></a>        AsmInstruction { line_number: 1, opcode:   2, oparg: [123], pos: 0 },
<a id=__codelineno-8-5 name=__codelineno-8-5 href=#__codelineno-8-5></a>        AsmInstruction { line_number: 2, opcode:   2, oparg: [200], pos: 2 },
<a id=__codelineno-8-6 name=__codelineno-8-6 href=#__codelineno-8-6></a>        AsmInstruction { line_number: 3, opcode:  16, oparg: [],    pos: 4 },
<a id=__codelineno-8-7 name=__codelineno-8-7 href=#__codelineno-8-7></a>        AsmInstruction { line_number: 4, opcode:   1, oparg: [],    pos: 5 },
<a id=__codelineno-8-8 name=__codelineno-8-8 href=#__codelineno-8-8></a>        AsmInstruction { line_number: 5, opcode: 255, oparg: [],    pos: 6 }
<a id=__codelineno-8-9 name=__codelineno-8-9 href=#__codelineno-8-9></a>    ],
<a id=__codelineno-8-10 name=__codelineno-8-10 href=#__codelineno-8-10></a>    line_number: 5, 
<a id=__codelineno-8-11 name=__codelineno-8-11 href=#__codelineno-8-11></a>    text_pos: 7, 
<a id=__codelineno-8-12 name=__codelineno-8-12 href=#__codelineno-8-12></a>    error: None
<a id=__codelineno-8-13 name=__codelineno-8-13 href=#__codelineno-8-13></a>}
</code></pre></div> <p>No error, that is nice. And we can see all five instructions parsed. We have a function that connects those bytes.</p> <h3 id=connect-the-bytes>Connect the bytes<a class=headerlink href=#connect-the-bytes title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><a id=__codelineno-9-1 name=__codelineno-9-1 href=#__codelineno-9-1></a><span class=sd>/// Convert parsed assembly source to runnable program (or error report).</span>
<a id=__codelineno-9-2 name=__codelineno-9-2 href=#__codelineno-9-2></a><span class=k>fn</span> <span class=nf>to_program</span><span class=p>(</span><span class=o>&amp;</span><span class=bp>self</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=n>Pgm</span><span class=p>,</span><span class=w> </span><span class=n>AsmErrorReport</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-9-3 name=__codelineno-9-3 href=#__codelineno-9-3></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=kd>let</span><span class=w> </span><span class=nb>Some</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>&amp;</span><span class=bp>self</span><span class=p>.</span><span class=n>error</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-9-4 name=__codelineno-9-4 href=#__codelineno-9-4></a><span class=w>        </span><span class=c1>// Assembling failed:</span>
<a id=__codelineno-9-5 name=__codelineno-9-5 href=#__codelineno-9-5></a><span class=w>        </span><span class=nb>Err</span><span class=p>(</span><span class=n>AsmErrorReport</span><span class=p>{</span>
<a id=__codelineno-9-6 name=__codelineno-9-6 href=#__codelineno-9-6></a><span class=w>            </span><span class=n>name</span>: <span class=nc>self</span><span class=p>.</span><span class=n>name</span><span class=p>.</span><span class=n>clone</span><span class=p>(),</span>
<a id=__codelineno-9-7 name=__codelineno-9-7 href=#__codelineno-9-7></a><span class=w>            </span><span class=n>line</span>: <span class=nc>self</span><span class=p>.</span><span class=n>line_number</span><span class=p>,</span>
<a id=__codelineno-9-8 name=__codelineno-9-8 href=#__codelineno-9-8></a><span class=w>            </span><span class=n>error</span>: <span class=nc>e</span><span class=p>.</span><span class=n>clone</span><span class=p>(),</span>
<a id=__codelineno-9-9 name=__codelineno-9-9 href=#__codelineno-9-9></a><span class=w>        </span><span class=p>})</span>
<a id=__codelineno-9-10 name=__codelineno-9-10 href=#__codelineno-9-10></a><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-9-11 name=__codelineno-9-11 href=#__codelineno-9-11></a><span class=w>        </span><span class=c1>// Assembling succeeded, return a Pgm instance:</span>
<a id=__codelineno-9-12 name=__codelineno-9-12 href=#__codelineno-9-12></a><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>text</span>: <span class=nb>Vec</span><span class=o>&lt;</span><span class=kt>u8</span><span class=o>&gt;</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=fm>vec!</span><span class=p>[];</span>
<a id=__codelineno-9-13 name=__codelineno-9-13 href=#__codelineno-9-13></a><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=n>i</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=o>&amp;</span><span class=bp>self</span><span class=p>.</span><span class=n>instructions</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-9-14 name=__codelineno-9-14 href=#__codelineno-9-14></a><span class=w>            </span><span class=n>text</span><span class=p>.</span><span class=n>push</span><span class=p>(</span><span class=n>i</span><span class=p>.</span><span class=n>opcode</span><span class=p>);</span>
<a id=__codelineno-9-15 name=__codelineno-9-15 href=#__codelineno-9-15></a><span class=w>            </span><span class=n>text</span><span class=p>.</span><span class=n>extend</span><span class=p>(</span><span class=o>&amp;</span><span class=n>i</span><span class=p>.</span><span class=n>oparg</span><span class=p>);</span>
<a id=__codelineno-9-16 name=__codelineno-9-16 href=#__codelineno-9-16></a><span class=w>        </span><span class=p>}</span>
<a id=__codelineno-9-17 name=__codelineno-9-17 href=#__codelineno-9-17></a><span class=w>        </span><span class=nb>Ok</span><span class=p>(</span><span class=n>Pgm</span><span class=p>{</span>
<a id=__codelineno-9-18 name=__codelineno-9-18 href=#__codelineno-9-18></a><span class=w>            </span><span class=n>name</span>: <span class=nc>self</span><span class=p>.</span><span class=n>name</span><span class=p>.</span><span class=n>clone</span><span class=p>(),</span>
<a id=__codelineno-9-19 name=__codelineno-9-19 href=#__codelineno-9-19></a><span class=w>            </span><span class=n>text</span><span class=p>,</span>
<a id=__codelineno-9-20 name=__codelineno-9-20 href=#__codelineno-9-20></a><span class=w>        </span><span class=p>})</span>
<a id=__codelineno-9-21 name=__codelineno-9-21 href=#__codelineno-9-21></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-9-22 name=__codelineno-9-22 href=#__codelineno-9-22></a><span class=p>}</span>
</code></pre></div> <p>The error part is straightforward. A small detail is the <code>clone()</code> call for name and error. We need to do that, because we cannot move ownership of those values (they must still exist in the <code>AsmPgm</code> instance). And we cannot use references. There is no need to clone the line number; as an integer type it can simply be copied.</p> <p>The success part isn't complex either. We create a Vector of bytes and push all bytes into it: for each instruction the opcode and the opargs (which there can be zero). We have our bytecode now! Wrap it inside our new <code>Pgm</code> type, and we are done.</p> <h3 id=run-the-assembler>Run the assembler<a class=headerlink href=#run-the-assembler title="Permanent link">&para;</a></h3> <p>Let us see what our program looks like, assembled: <div class=highlight><pre><span></span><code><a id=__codelineno-10-1 name=__codelineno-10-1 href=#__codelineno-10-1></a>kratenko@jotun:~/git/lovem$ cargo run --bin lovas -- pgm/hallo-stack.lass 
<a id=__codelineno-10-2 name=__codelineno-10-2 href=#__codelineno-10-2></a>
<a id=__codelineno-10-3 name=__codelineno-10-3 href=#__codelineno-10-3></a>    Finished dev [unoptimized + debuginfo] target(s) in 0.02s
<a id=__codelineno-10-4 name=__codelineno-10-4 href=#__codelineno-10-4></a>     Running `target/debug/lovas pgm/hallo-stack.lass`
<a id=__codelineno-10-5 name=__codelineno-10-5 href=#__codelineno-10-5></a>Pgm { name: &quot;pgm/hallo-stack.lass&quot;, text: [2, 123, 2, 200, 16, 1, 255] }
</code></pre></div></p> <p>And how about our noisy program, <a href=https://github.com/kratenko/lovem/blob/v0.0.8-journey/pgm/noise.lass><code>noice.lass</code></a>?</p> <div class=highlight><pre><span></span><code><a id=__codelineno-11-1 name=__codelineno-11-1 href=#__codelineno-11-1></a>kratenko@jotun:~/git/lovem$ cargo run --bin lovas -- pgm/noise.lass 
<a id=__codelineno-11-2 name=__codelineno-11-2 href=#__codelineno-11-2></a>
<a id=__codelineno-11-3 name=__codelineno-11-3 href=#__codelineno-11-3></a>    Finished dev [unoptimized + debuginfo] target(s) in 0.03s
<a id=__codelineno-11-4 name=__codelineno-11-4 href=#__codelineno-11-4></a>     Running `target/debug/lovas pgm/noise.lass`
<a id=__codelineno-11-5 name=__codelineno-11-5 href=#__codelineno-11-5></a>Pgm { name: &quot;pgm/noise.lass&quot;, text: [2, 123, 2, 200, 16, 1, 255] }
</code></pre></div> <p>So it <em>does</em> produce the same bytecode for both. As we demanded.</p> <h3 id=running-into-errors>Running into errors<a class=headerlink href=#running-into-errors title="Permanent link">&para;</a></h3> <p>What happens, if our program has errors? Easy to find out, I included a broken program: <a href=https://github.com/kratenko/lovem/blob/v0.0.8-journey/pgm/syntax-error.lass><code>syntax-error.lass</code></a></p> <div class=highlight><pre><span></span><code><a id=__codelineno-12-1 name=__codelineno-12-1 href=#__codelineno-12-1></a>push_u8 123
<a id=__codelineno-12-2 name=__codelineno-12-2 href=#__codelineno-12-2></a>push_u8 300
<a id=__codelineno-12-3 name=__codelineno-12-3 href=#__codelineno-12-3></a>add
<a id=__codelineno-12-4 name=__codelineno-12-4 href=#__codelineno-12-4></a>pop
<a id=__codelineno-12-5 name=__codelineno-12-5 href=#__codelineno-12-5></a>fin
</code></pre></div> <p>Have you found the problem? Will the assembler?</p> <div class=highlight><pre><span></span><code><a id=__codelineno-13-1 name=__codelineno-13-1 href=#__codelineno-13-1></a>kratenko@jotun:~/git/lovem$ cargo run --bin lovas -- pgm/syntax-error.lass 
<a id=__codelineno-13-2 name=__codelineno-13-2 href=#__codelineno-13-2></a>
<a id=__codelineno-13-3 name=__codelineno-13-3 href=#__codelineno-13-3></a>    Finished dev [unoptimized + debuginfo] target(s) in 0.04s
<a id=__codelineno-13-4 name=__codelineno-13-4 href=#__codelineno-13-4></a>     Running `target/debug/lovas pgm/syntax-error.lass`
<a id=__codelineno-13-5 name=__codelineno-13-5 href=#__codelineno-13-5></a>Error: assembly failed in line 2 of program &#39;pgm/syntax-error.lass&#39;
<a id=__codelineno-13-6 name=__codelineno-13-6 href=#__codelineno-13-6></a>
<a id=__codelineno-13-7 name=__codelineno-13-7 href=#__codelineno-13-7></a>Caused by:
<a id=__codelineno-13-8 name=__codelineno-13-8 href=#__codelineno-13-8></a>    InvalidArgument
</code></pre></div> <p>It does find the error. Using the <code>parse_int</code> create already pays. And the error message really tells us, what is wrong and where. We get a lot of value for very few code we have written.</p> <h3 id=why-asmpgm>Why AsmPgm?<a class=headerlink href=#why-asmpgm title="Permanent link">&para;</a></h3> <p>There does not really seem to be a point of storing all that information inside <code>AsmPgm</code>. We could easily have created the bytecode directly. That would have been a lot easier. And if you have run the code yourself, you will have been bombarded with compiler warnings about unread fields.</p> <p>We will be needing that information soon, and it was easiest to build it like this right away. But let us just enjoy our new assembler for now.</p> <h3 id=impl-errorerror>impl error::Error<a class=headerlink href=#impl-errorerror title="Permanent link">&para;</a></h3> <p>Okay, before we leave for today, one more thing that you might have spotted. What's with that <code>impl</code> blocks?</p> <div class=highlight><pre><span></span><code><a id=__codelineno-14-1 name=__codelineno-14-1 href=#__codelineno-14-1></a><span class=k>impl</span><span class=w> </span><span class=n>Display</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=n>AsmError</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-14-2 name=__codelineno-14-2 href=#__codelineno-14-2></a><span class=w>    </span><span class=k>fn</span> <span class=nf>fmt</span><span class=p>(</span><span class=o>&amp;</span><span class=bp>self</span><span class=p>,</span><span class=w> </span><span class=n>f</span>: <span class=kp>&amp;</span><span class=nc>mut</span><span class=w> </span><span class=n>Formatter</span><span class=o>&lt;&#39;</span><span class=nb>_</span><span class=o>&gt;</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>std</span>::<span class=n>fmt</span>::<span class=nb>Result</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-14-3 name=__codelineno-14-3 href=#__codelineno-14-3></a><span class=w>        </span><span class=fm>write!</span><span class=p>(</span><span class=n>f</span><span class=p>,</span><span class=w> </span><span class=s>&quot;{:?}&quot;</span><span class=p>,</span><span class=w> </span><span class=bp>self</span><span class=p>)</span>
<a id=__codelineno-14-4 name=__codelineno-14-4 href=#__codelineno-14-4></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-14-5 name=__codelineno-14-5 href=#__codelineno-14-5></a><span class=p>}</span>
<a id=__codelineno-14-6 name=__codelineno-14-6 href=#__codelineno-14-6></a>
<a id=__codelineno-14-7 name=__codelineno-14-7 href=#__codelineno-14-7></a><span class=k>impl</span><span class=w> </span><span class=n>error</span>::<span class=n>Error</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=n>AsmError</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-14-8 name=__codelineno-14-8 href=#__codelineno-14-8></a><span class=p>}</span>
<a id=__codelineno-14-9 name=__codelineno-14-9 href=#__codelineno-14-9></a>
<a id=__codelineno-14-10 name=__codelineno-14-10 href=#__codelineno-14-10></a><span class=k>impl</span><span class=w> </span><span class=n>Display</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=n>AsmErrorReport</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-14-11 name=__codelineno-14-11 href=#__codelineno-14-11></a><span class=w>    </span><span class=k>fn</span> <span class=nf>fmt</span><span class=p>(</span><span class=o>&amp;</span><span class=bp>self</span><span class=p>,</span><span class=w> </span><span class=n>f</span>: <span class=kp>&amp;</span><span class=nc>mut</span><span class=w> </span><span class=n>Formatter</span><span class=o>&lt;&#39;</span><span class=nb>_</span><span class=o>&gt;</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>std</span>::<span class=n>fmt</span>::<span class=nb>Result</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-14-12 name=__codelineno-14-12 href=#__codelineno-14-12></a><span class=w>        </span><span class=fm>write!</span><span class=p>(</span><span class=n>f</span><span class=p>,</span><span class=w> </span><span class=s>&quot;assembly failed in line {} of program &#39;{}&#39;&quot;</span><span class=p>,</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>line</span><span class=p>,</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>name</span><span class=p>)</span>
<a id=__codelineno-14-13 name=__codelineno-14-13 href=#__codelineno-14-13></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-14-14 name=__codelineno-14-14 href=#__codelineno-14-14></a><span class=p>}</span>
<a id=__codelineno-14-15 name=__codelineno-14-15 href=#__codelineno-14-15></a>
<a id=__codelineno-14-16 name=__codelineno-14-16 href=#__codelineno-14-16></a><span class=k>impl</span><span class=w> </span><span class=n>error</span>::<span class=n>Error</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=n>AsmErrorReport</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-14-17 name=__codelineno-14-17 href=#__codelineno-14-17></a><span class=w>    </span><span class=k>fn</span> <span class=nf>source</span><span class=p>(</span><span class=o>&amp;</span><span class=bp>self</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Option</span><span class=o>&lt;&amp;</span><span class=p>(</span><span class=k>dyn</span><span class=w> </span><span class=n>error</span>::<span class=n>Error</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=o>&#39;</span><span class=nb>static</span><span class=p>)</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-14-18 name=__codelineno-14-18 href=#__codelineno-14-18></a><span class=w>        </span><span class=nb>Some</span><span class=p>(</span><span class=o>&amp;</span><span class=bp>self</span><span class=p>.</span><span class=n>error</span><span class=p>)</span>
<a id=__codelineno-14-19 name=__codelineno-14-19 href=#__codelineno-14-19></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-14-20 name=__codelineno-14-20 href=#__codelineno-14-20></a><span class=p>}</span>
</code></pre></div> <p>That is the price we have to pay when we want to use Rust magic. Rust's answer to writing generic code that can be applied to different types (that might not exist at the time of writing) are <em>traits</em>. A function can accept a trait as a type. If you implement that trait for your type, you can use that function. That is a very simplified introduction.</p> <p>A trait defines specific functions you have to write for a type. That is what we do here. We implement the trait <code>std::error::Error</code> for our <code>AsmError</code> and <code>AsmErrorReport</code>. To do so, we must also implement the trait <code>std::fmt::Display</code> (because the <code>Error</code> trait says so).</p> <p>There is not much we do there. Types implementing the <code>Display</code> trait can be printed using <code>println!("{}", value)</code>. What the <code>println!</code> macro does is just calling that <code>fmt</code> method we define. The trait <code>Debug</code> does a similar thing, but for use with <code>println!("{:?}", value)</code>. We can use any value with those constructs that implements the <code>Display</code> trait (for <code>"{}"</code>) or the <code>Debug</code> trait (for <code>"{:?}"</code>).</p> <p>The <code>Debug</code> trait we let the compiler implement (derive) for us. That is what the line <code>#[derive(Debug)]</code> does. And for our <code>Display</code> trait we are lazy and just use the function that was created by <code>#[derive(Debug)]</code>.</p> <p>The <code>Error</code> trait lets you implement a <code>source()</code> method, that is used to get a nested Error inside your Error, that was its cause. Think of exception stacks, only that we do not have exceptions, of course. That is exactly what we want for <code>AsmErrorReport</code>; it is, after all, a wrapper for <code>AsmError</code>. <code>AsmError</code> on the other hand does not have a nested error, so we do not implement the <code>source()</code> method. The empty <code>impl error::Error for AsmError</code> block is still needed. If you remove it, the <code>Error</code> trait will not be implemented for <code>AsmError</code>.</p> <p>Cool story, but why do we do all this? This is what enables us to use the magic of <code>anyhow</code> in our <code>lovas.rs</code>. We can use <code>AsmError</code> and <code>AsmErrorReport</code> (wrapped in an <code>Err()</code>) as return for our main function. It returns <code>anyhow::Result&lt;()&gt;</code>. And when there is an error returned by it, an error message is created and printed for us. With this we can easily create useful error messages in the error type itself, at the place where we understand, what errors exist and what they mean. And we need do it in that one place only. Every program that uses our library (as <code>lovas.rs</code> does) benefits from that without any extra work or even without knowing, error types can be returned by the library.</p> <h2 id=running-assembler-programs>Running assembler programs<a class=headerlink href=#running-assembler-programs title="Permanent link">&para;</a></h2> <p><strong>We will extend our assembler to do something useful, finally: execute our programs on lovem.</strong></p> <aside class=mdx-author> <p><img alt=@kratenko src=https://avatars.githubusercontent.com/kratenko></p> <p><span><strong>kratenko</strong> 路 <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 16 16"><path fill-rule=evenodd d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"/></svg></span> <a href=https://github.com/kratenko>kratenko</a></span> <span> <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path fill-rule=evenodd d="M6.75 0a.75.75 0 0 1 .75.75V3h9V.75a.75.75 0 0 1 1.5 0V3h2.75c.966 0 1.75.784 1.75 1.75v16a1.75 1.75 0 0 1-1.75 1.75H3.25a1.75 1.75 0 0 1-1.75-1.75v-16C1.5 3.784 2.284 3 3.25 3H6V.75A.75.75 0 0 1 6.75 0zm-3.5 4.5a.25.25 0 0 0-.25.25V8h18V4.75a.25.25 0 0 0-.25-.25H3.25zM21 9.5H3v11.25c0 .138.112.25.25.25h17.5a.25.25 0 0 0 .25-.25V9.5z"/></svg></span> 2022-08-10 路 <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path fill-rule=evenodd d="M0 3.75A.75.75 0 0 1 .75 3h7.497c1.566 0 2.945.8 3.751 2.014A4.496 4.496 0 0 1 15.75 3h7.5a.75.75 0 0 1 .75.75v15.063a.75.75 0 0 1-.755.75l-7.682-.052a3 3 0 0 0-2.142.878l-.89.891a.75.75 0 0 1-1.061 0l-.902-.901a3 3 0 0 0-2.121-.879H.75a.75.75 0 0 1-.75-.75v-15zm11.247 3.747a3 3 0 0 0-3-2.997H1.5V18h6.947a4.5 4.5 0 0 1 2.803.98l-.003-11.483zm1.503 11.485V7.5a3 3 0 0 1 3-3h6.75v13.558l-6.927-.047a4.5 4.5 0 0 0-2.823.971z"/></svg></span> Entry #25 路 <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12.5 7.25a.75.75 0 0 0-1.5 0v5.5c0 .27.144.518.378.651l3.5 2a.75.75 0 0 0 .744-1.302L12.5 12.315V7.25z"/><path fill-rule=evenodd d="M12 1C5.925 1 1 5.925 1 12s4.925 11 11 11 11-4.925 11-11S18.075 1 12 1zM2.5 12a9.5 9.5 0 1 1 19 0 9.5 9.5 0 0 1-19 0z"/></svg></span> 6 min read 路 <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M7.75 6.5a1.25 1.25 0 1 0 0 2.5 1.25 1.25 0 0 0 0-2.5z"/><path fill-rule=evenodd d="M2.5 1A1.5 1.5 0 0 0 1 2.5v8.44c0 .397.158.779.44 1.06l10.25 10.25a1.5 1.5 0 0 0 2.12 0l8.44-8.44a1.5 1.5 0 0 0 0-2.12L12 1.44A1.5 1.5 0 0 0 10.94 1H2.5zm0 1.5h8.44l10.25 10.25-8.44 8.44L2.5 10.94V2.5z"/></svg></span> <a href=https://github.com/kratenko/lovem/releases/tag/v0.0.9-journey>v0.0.9-journey</a> </span></p> </aside> <hr> <p>We have created ourselves an assembler in ~300 lines of code. And it has a command line interface, an API to be used in a program, and even useful error reporting. That is cool! But what do we do with the bytecode? It just dumps them to the console. That is not very useful. We could copy/paste that into one of our example binaries... This is not what we wanted. So let us enhance our assembler.</p> <h3 id=execution>Execution<a class=headerlink href=#execution title="Permanent link">&para;</a></h3> <p>We add some features to <a href=https://github.com/kratenko/lovem/blob/v0.0.9-journey/src/bin/lovas.rs><code>lovas.rs</code></a>. A new command line parameter <code>--run</code>, that takes no arguments. If you add that flag to the call, <code>lovas</code> will take the assembled program (if there are no errors), create an instance of the VM and run the program on it. Thanks to clap, that is really easy to do. We add another field to our <code>Cli</code> struct. Actually, while we are at it, we add four new parameters:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-15-1 name=__codelineno-15-1 href=#__codelineno-15-1></a>#<span class=cp>#[clap(short, long, help = </span><span class=s>&quot;Run the assembled program in lovem.&quot;</span><span class=cp>)]</span>
<a id=__codelineno-15-2 name=__codelineno-15-2 href=#__codelineno-15-2></a><span class=n>run</span>: <span class=kt>bool</span><span class=p>,</span>
<a id=__codelineno-15-3 name=__codelineno-15-3 href=#__codelineno-15-3></a>
<a id=__codelineno-15-4 name=__codelineno-15-4 href=#__codelineno-15-4></a>#<span class=cp>#[clap(long, help = </span><span class=s>&quot;Enable tracing log when running lovem.&quot;</span><span class=cp>)]</span>
<a id=__codelineno-15-5 name=__codelineno-15-5 href=#__codelineno-15-5></a><span class=n>trace</span>: <span class=kt>bool</span><span class=p>,</span>
<a id=__codelineno-15-6 name=__codelineno-15-6 href=#__codelineno-15-6></a>
<a id=__codelineno-15-7 name=__codelineno-15-7 href=#__codelineno-15-7></a>#<span class=cp>#[clap(long, help = </span><span class=s>&quot;Output the program to stdout.&quot;</span><span class=cp>)]</span>
<a id=__codelineno-15-8 name=__codelineno-15-8 href=#__codelineno-15-8></a><span class=n>print</span>: <span class=kt>bool</span><span class=p>,</span>
<a id=__codelineno-15-9 name=__codelineno-15-9 href=#__codelineno-15-9></a>
<a id=__codelineno-15-10 name=__codelineno-15-10 href=#__codelineno-15-10></a>#<span class=cp>#[clap(long, default_value_t = 100, help = </span><span class=s>&quot;Setting the stack size for lovem when running the program.&quot;</span><span class=cp>)]</span>
<a id=__codelineno-15-11 name=__codelineno-15-11 href=#__codelineno-15-11></a><span class=n>stack_size</span>: <span class=kt>usize</span><span class=p>,</span>
</code></pre></div> <p>And we change what we do with a successfully created program, depending on our new flag:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-16-1 name=__codelineno-16-1 href=#__codelineno-16-1></a><span class=c1>// run the assembler:</span>
<a id=__codelineno-16-2 name=__codelineno-16-2 href=#__codelineno-16-2></a><span class=k>match</span><span class=w> </span><span class=n>asm</span>::<span class=n>assemble</span><span class=p>(</span><span class=o>&amp;</span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>content</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-16-3 name=__codelineno-16-3 href=#__codelineno-16-3></a><span class=w>    </span><span class=nb>Ok</span><span class=p>(</span><span class=n>pgm</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-16-4 name=__codelineno-16-4 href=#__codelineno-16-4></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=n>args</span><span class=p>.</span><span class=n>print</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-16-5 name=__codelineno-16-5 href=#__codelineno-16-5></a><span class=w>            </span><span class=fm>println!</span><span class=p>(</span><span class=s>&quot;{:?}&quot;</span><span class=p>,</span><span class=w> </span><span class=n>pgm</span><span class=p>);</span>
<a id=__codelineno-16-6 name=__codelineno-16-6 href=#__codelineno-16-6></a><span class=w>        </span><span class=p>}</span>
<a id=__codelineno-16-7 name=__codelineno-16-7 href=#__codelineno-16-7></a><span class=w>        </span><span class=c1>// we succeeded and now have a program with bytecode:</span>
<a id=__codelineno-16-8 name=__codelineno-16-8 href=#__codelineno-16-8></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=n>args</span><span class=p>.</span><span class=n>run</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-16-9 name=__codelineno-16-9 href=#__codelineno-16-9></a><span class=w>            </span><span class=c1>// lovas was called with `--run`, so create a VM and execute program:</span>
<a id=__codelineno-16-10 name=__codelineno-16-10 href=#__codelineno-16-10></a><span class=w>            </span><span class=n>run</span><span class=p>(</span><span class=o>&amp;</span><span class=n>pgm</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>args</span><span class=p>)</span><span class=o>?</span>
<a id=__codelineno-16-11 name=__codelineno-16-11 href=#__codelineno-16-11></a><span class=w>        </span><span class=p>}</span>
<a id=__codelineno-16-12 name=__codelineno-16-12 href=#__codelineno-16-12></a><span class=w>        </span><span class=nb>Ok</span><span class=p>(())</span>
<a id=__codelineno-16-13 name=__codelineno-16-13 href=#__codelineno-16-13></a><span class=w>    </span><span class=p>},</span>
<a id=__codelineno-16-14 name=__codelineno-16-14 href=#__codelineno-16-14></a><span class=w>    </span><span class=nb>Err</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-16-15 name=__codelineno-16-15 href=#__codelineno-16-15></a><span class=w>        </span><span class=c1>// Something went wrong during assembly.</span>
<a id=__codelineno-16-16 name=__codelineno-16-16 href=#__codelineno-16-16></a><span class=w>        </span><span class=c1>// Convert the error report, so that `anyhow` can do its magic</span>
<a id=__codelineno-16-17 name=__codelineno-16-17 href=#__codelineno-16-17></a><span class=w>        </span><span class=c1>// and display some helpful error message:</span>
<a id=__codelineno-16-18 name=__codelineno-16-18 href=#__codelineno-16-18></a><span class=w>        </span><span class=nb>Err</span><span class=p>(</span><span class=n>Error</span>::<span class=n>from</span><span class=p>(</span><span class=n>e</span><span class=p>))</span>
<a id=__codelineno-16-19 name=__codelineno-16-19 href=#__codelineno-16-19></a><span class=w>    </span><span class=p>},</span>
<a id=__codelineno-16-20 name=__codelineno-16-20 href=#__codelineno-16-20></a><span class=p>}</span>
</code></pre></div> <p>Just printing the program to stdout is no very useful default behaviour for an assembler. It might still come in handy, if you want to see what you are executing, so we make it optional and for the caller to decide with the <code>--print</code> flag. If the <code>--run</code> flag is set, we call <code>run()</code>. So what does <code>run()</code> do?</p> <div class=highlight><pre><span></span><code><a id=__codelineno-17-1 name=__codelineno-17-1 href=#__codelineno-17-1></a><span class=sd>/// Executes a program in a freshly created lovem VM.</span>
<a id=__codelineno-17-2 name=__codelineno-17-2 href=#__codelineno-17-2></a><span class=k>fn</span> <span class=nf>run</span><span class=p>(</span><span class=n>pgm</span>: <span class=kp>&amp;</span><span class=nc>Pgm</span><span class=p>,</span><span class=w> </span><span class=n>args</span>: <span class=kp>&amp;</span><span class=nc>Cli</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=p>()</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-17-3 name=__codelineno-17-3 href=#__codelineno-17-3></a><span class=w>    </span><span class=c1>// Create our VM instance.</span>
<a id=__codelineno-17-4 name=__codelineno-17-4 href=#__codelineno-17-4></a><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>vm</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>VM</span>::<span class=n>new</span><span class=p>(</span><span class=n>args</span><span class=p>.</span><span class=n>stack_size</span><span class=p>);</span>
<a id=__codelineno-17-5 name=__codelineno-17-5 href=#__codelineno-17-5></a><span class=w>    </span><span class=n>vm</span><span class=p>.</span><span class=n>trace</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>args</span><span class=p>.</span><span class=n>trace</span><span class=p>;</span>
<a id=__codelineno-17-6 name=__codelineno-17-6 href=#__codelineno-17-6></a><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>start</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Instant</span>::<span class=n>now</span><span class=p>();</span>
<a id=__codelineno-17-7 name=__codelineno-17-7 href=#__codelineno-17-7></a><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>outcome</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>vm</span><span class=p>.</span><span class=n>run</span><span class=p>(</span><span class=o>&amp;</span><span class=n>pgm</span><span class=p>.</span><span class=n>text</span><span class=p>);</span>
<a id=__codelineno-17-8 name=__codelineno-17-8 href=#__codelineno-17-8></a><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>duration</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>start</span><span class=p>.</span><span class=n>elapsed</span><span class=p>();</span>
<a id=__codelineno-17-9 name=__codelineno-17-9 href=#__codelineno-17-9></a><span class=w>    </span><span class=k>match</span><span class=w> </span><span class=n>outcome</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-17-10 name=__codelineno-17-10 href=#__codelineno-17-10></a><span class=w>        </span><span class=nb>Ok</span><span class=p>(</span><span class=n>_</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-17-11 name=__codelineno-17-11 href=#__codelineno-17-11></a><span class=w>            </span><span class=c1>// Execution successful, program terminated:</span>
<a id=__codelineno-17-12 name=__codelineno-17-12 href=#__codelineno-17-12></a><span class=w>            </span><span class=fm>eprintln!</span><span class=p>(</span><span class=s>&quot;Terminated.</span><span class=se>\n</span><span class=s>Runtime={:?}</span><span class=se>\n</span><span class=s>op_cnt={}, pc={}, stack-depth={}, watermark={}&quot;</span><span class=p>,</span>
<a id=__codelineno-17-13 name=__codelineno-17-13 href=#__codelineno-17-13></a><span class=w>                      </span><span class=n>duration</span><span class=p>,</span>
<a id=__codelineno-17-14 name=__codelineno-17-14 href=#__codelineno-17-14></a><span class=w>                      </span><span class=n>vm</span><span class=p>.</span><span class=n>op_cnt</span><span class=p>,</span><span class=w> </span><span class=n>vm</span><span class=p>.</span><span class=n>pc</span><span class=p>,</span><span class=w> </span><span class=n>vm</span><span class=p>.</span><span class=n>stack</span><span class=p>.</span><span class=n>len</span><span class=p>(),</span><span class=w> </span><span class=n>vm</span><span class=p>.</span><span class=n>watermark</span>
<a id=__codelineno-17-15 name=__codelineno-17-15 href=#__codelineno-17-15></a><span class=w>            </span><span class=p>);</span>
<a id=__codelineno-17-16 name=__codelineno-17-16 href=#__codelineno-17-16></a><span class=w>            </span><span class=nb>Ok</span><span class=p>(())</span>
<a id=__codelineno-17-17 name=__codelineno-17-17 href=#__codelineno-17-17></a><span class=w>        </span><span class=p>},</span>
<a id=__codelineno-17-18 name=__codelineno-17-18 href=#__codelineno-17-18></a><span class=w>        </span><span class=nb>Err</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-17-19 name=__codelineno-17-19 href=#__codelineno-17-19></a><span class=w>            </span><span class=c1>// Runtime error. Error will be printed on return of main.</span>
<a id=__codelineno-17-20 name=__codelineno-17-20 href=#__codelineno-17-20></a><span class=w>            </span><span class=fm>eprintln!</span><span class=p>(</span><span class=s>&quot;Runtime error!</span><span class=se>\n</span><span class=s>Runtime={:?}</span><span class=se>\n</span><span class=s>op_cnt={}, pc={}, stack-depth={}, watermark={}&quot;</span><span class=p>,</span>
<a id=__codelineno-17-21 name=__codelineno-17-21 href=#__codelineno-17-21></a><span class=w>                      </span><span class=n>duration</span><span class=p>,</span><span class=w> </span><span class=n>vm</span><span class=p>.</span><span class=n>op_cnt</span><span class=p>,</span><span class=w> </span><span class=n>vm</span><span class=p>.</span><span class=n>pc</span><span class=p>,</span><span class=w> </span><span class=n>vm</span><span class=p>.</span><span class=n>stack</span><span class=p>.</span><span class=n>len</span><span class=p>(),</span><span class=w> </span><span class=n>vm</span><span class=p>.</span><span class=n>watermark</span><span class=p>);</span>
<a id=__codelineno-17-22 name=__codelineno-17-22 href=#__codelineno-17-22></a><span class=w>            </span><span class=nb>Err</span><span class=p>(</span><span class=n>Error</span>::<span class=n>from</span><span class=p>(</span><span class=n>e</span><span class=p>))</span>
<a id=__codelineno-17-23 name=__codelineno-17-23 href=#__codelineno-17-23></a><span class=w>        </span><span class=p>}</span>
<a id=__codelineno-17-24 name=__codelineno-17-24 href=#__codelineno-17-24></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-17-25 name=__codelineno-17-25 href=#__codelineno-17-25></a><span class=p>}</span>
</code></pre></div> <p>We create a VM instance, and we run the program on it. If there is a <code>RuntimeError</code>, we return it, just as we did with the <code>AsmErrorReport</code>. Back in our examples, we created a VM with a stack size of <code>100</code> - simply because we needed a number there. <code>100</code> is still the default, but now you can choose the stack size, when calling <code>lovas</code>. If you do </p> <div class=highlight><pre><span></span><code>lovas --run pgm/some-program.lva --stack-size 512
</code></pre></div> <p>lovas will execute the program in a VM with a stack that can hold 512 values.</p> <h3 id=trace-log>Trace Log<a class=headerlink href=#trace-log title="Permanent link">&para;</a></h3> <p>When we were running a program in our VM, we did always get a lot of output during execution. That is nice for understanding, what a stack machine does, but in general it is not a got idea for a VM to do that. It can be very beneficial, if you run into a problem with your program, so it is an easily available tool for debugging. That is why I removed all those log messages from lovem, but I let some in that can be activated, if you set <code>vm.trace = true</code>. That is what we added the new command line parameter <code>--trace</code> for. You can now control, if you want to see it.</p> <h3 id=diagnostics>Diagnostics<a class=headerlink href=#diagnostics title="Permanent link">&para;</a></h3> <p>There is some output by <code>lovas</code>, after the execution. It reports if the run was successfully terminated (by executing a <code>fin</code> instruction), or if there was a <code>RuntimeError</code>. In both cases it will show you the time the execution took (wallclock time), as well as the number of instructions executed by the VM, the final position of the programm counter, the number of values on the stack at termination, and the highest number of values on the stack at any time during execution (the watermark). This can give you some quick insight on what your program did and maybe where it ran into trouble.</p> <p>All this lead to some changes to <code>vm.rs</code>, but nothing that should give you any problems to understand. Remember that we have the power of git at our disposal, so you can easily find out what changed in a file between two releases. You could do that for <code>vm.rs</code> with this handy link:</p> <p><a href=https://github.com/kratenko/lovem/compare/v0.0.8-journey...v0.0.9-journey#diff-3bc51552cab41d1a2dbf07842cb438088563f6134a9c69a266dfd0d79b631495>https://github.com/kratenko/lovem/compare/v0.0.8-journey...v0.0.9-journey#diff-3bc51552cab41d1a2dbf07842cb438088563f6134a9c69a266dfd0d79b631495</a></p> <h3 id=our-programs>Our programs<a class=headerlink href=#our-programs title="Permanent link">&para;</a></h3> <p>We have written a few example programs so far. Each is its own binary in <code>src/bin/</code>, and all of them consist of the same Rust code of creating a VM and running a program. Only the bytecode changed between them. </p> <p>I got rid of all of those (except for the most basic one) and translated the programs into assembly programs that live in <code>pgm/</code>. You can now execute those using <code>lovas</code>, like this:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-18-1 name=__codelineno-18-1 href=#__codelineno-18-1></a>kratenko@jotun:~/git/lovem$ cargo run --bin lovas -- -r pgm/reverse-polish.lva --trace
<a id=__codelineno-18-2 name=__codelineno-18-2 href=#__codelineno-18-2></a>
<a id=__codelineno-18-3 name=__codelineno-18-3 href=#__codelineno-18-3></a>   Compiling lovem v0.0.9 (/home/kratenko/git/lovem)
<a id=__codelineno-18-4 name=__codelineno-18-4 href=#__codelineno-18-4></a>    Finished dev [unoptimized + debuginfo] target(s) in 2.02s
<a id=__codelineno-18-5 name=__codelineno-18-5 href=#__codelineno-18-5></a>     Running `target/debug/lovas -r pgm/reverse-polish.lva --trace`
<a id=__codelineno-18-6 name=__codelineno-18-6 href=#__codelineno-18-6></a>VM { stack: [], pc: 0, op_cnt: 0, trace: true, watermark: 0 }
<a id=__codelineno-18-7 name=__codelineno-18-7 href=#__codelineno-18-7></a>Executing op 0x02
<a id=__codelineno-18-8 name=__codelineno-18-8 href=#__codelineno-18-8></a>VM { stack: [5], pc: 2, op_cnt: 1, trace: true, watermark: 1 }
<a id=__codelineno-18-9 name=__codelineno-18-9 href=#__codelineno-18-9></a>Executing op 0x02
<a id=__codelineno-18-10 name=__codelineno-18-10 href=#__codelineno-18-10></a>VM { stack: [5, 7], pc: 4, op_cnt: 2, trace: true, watermark: 2 }
<a id=__codelineno-18-11 name=__codelineno-18-11 href=#__codelineno-18-11></a>Executing op 0x02
<a id=__codelineno-18-12 name=__codelineno-18-12 href=#__codelineno-18-12></a>VM { stack: [5, 7, 11], pc: 6, op_cnt: 3, trace: true, watermark: 3 }
<a id=__codelineno-18-13 name=__codelineno-18-13 href=#__codelineno-18-13></a>Executing op 0x11
<a id=__codelineno-18-14 name=__codelineno-18-14 href=#__codelineno-18-14></a>VM { stack: [5, -4], pc: 7, op_cnt: 4, trace: true, watermark: 3 }
<a id=__codelineno-18-15 name=__codelineno-18-15 href=#__codelineno-18-15></a>Executing op 0x12
<a id=__codelineno-18-16 name=__codelineno-18-16 href=#__codelineno-18-16></a>VM { stack: [-20], pc: 8, op_cnt: 5, trace: true, watermark: 3 }
<a id=__codelineno-18-17 name=__codelineno-18-17 href=#__codelineno-18-17></a>Executing op 0x02
<a id=__codelineno-18-18 name=__codelineno-18-18 href=#__codelineno-18-18></a>VM { stack: [-20, 13], pc: 10, op_cnt: 6, trace: true, watermark: 3 }
<a id=__codelineno-18-19 name=__codelineno-18-19 href=#__codelineno-18-19></a>Executing op 0x02
<a id=__codelineno-18-20 name=__codelineno-18-20 href=#__codelineno-18-20></a>VM { stack: [-20, 13, 17], pc: 12, op_cnt: 7, trace: true, watermark: 3 }
<a id=__codelineno-18-21 name=__codelineno-18-21 href=#__codelineno-18-21></a>Executing op 0x10
<a id=__codelineno-18-22 name=__codelineno-18-22 href=#__codelineno-18-22></a>VM { stack: [-20, 30], pc: 13, op_cnt: 8, trace: true, watermark: 3 }
<a id=__codelineno-18-23 name=__codelineno-18-23 href=#__codelineno-18-23></a>Executing op 0x10
<a id=__codelineno-18-24 name=__codelineno-18-24 href=#__codelineno-18-24></a>VM { stack: [10], pc: 14, op_cnt: 9, trace: true, watermark: 3 }
<a id=__codelineno-18-25 name=__codelineno-18-25 href=#__codelineno-18-25></a>Executing op 0x01
<a id=__codelineno-18-26 name=__codelineno-18-26 href=#__codelineno-18-26></a>VM { stack: [], pc: 15, op_cnt: 10, trace: true, watermark: 3 }
<a id=__codelineno-18-27 name=__codelineno-18-27 href=#__codelineno-18-27></a>Terminated!
<a id=__codelineno-18-28 name=__codelineno-18-28 href=#__codelineno-18-28></a>VM { stack: [], pc: 16, op_cnt: 11, trace: true, watermark: 3 }
<a id=__codelineno-18-29 name=__codelineno-18-29 href=#__codelineno-18-29></a>Terminated.
<a id=__codelineno-18-30 name=__codelineno-18-30 href=#__codelineno-18-30></a>Runtime=49.33碌s
<a id=__codelineno-18-31 name=__codelineno-18-31 href=#__codelineno-18-31></a>op_cnt=11, pc=16, stack size=0, watermark=3
</code></pre></div> <p>Remember to add <code>--trace</code> to the call, or you won't see very much. It has become a lot easier, to play around with the VM. No more writing bytecode by hand!</p> <h3 id=file-extension>File extension<a class=headerlink href=#file-extension title="Permanent link">&para;</a></h3> <p>You might have noticed that I changed the filename extension that I use for the assembly programs from <code>.lass</code> to <code>.lva</code>. There are multiple reasons, but the main one is, that I thought <em>Lass</em> could be a nice name for a programming language, when I will finally come to writing one for lovem. So I want to reserve the extension for that possible future.</p> <h3 id=playing-around>Playing around<a class=headerlink href=#playing-around title="Permanent link">&para;</a></h3> <p>The diagnostic information given after the execution can be interesting, when you mess around. Let us play a bit with the program <a href=https://github.com/kratenko/lovem/blob/v0.0.9-journey/pgm/endless-stack.lva><code>endless-stack.lva</code></a>.</p> <div class=highlight><pre><span></span><code><a id=__codelineno-19-1 name=__codelineno-19-1 href=#__codelineno-19-1></a>## This program runs in an endless loop, but it will push a new value to the stack on every iteration.
<a id=__codelineno-19-2 name=__codelineno-19-2 href=#__codelineno-19-2></a>## It will inevitably lead to a stack overrun at some point and crash the program.
<a id=__codelineno-19-3 name=__codelineno-19-3 href=#__codelineno-19-3></a>push_u8 123
<a id=__codelineno-19-4 name=__codelineno-19-4 href=#__codelineno-19-4></a>goto -5
<a id=__codelineno-19-5 name=__codelineno-19-5 href=#__codelineno-19-5></a>fin
</code></pre></div> <p>The program will fill the stack until it is full, and then it will crash:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-20-1 name=__codelineno-20-1 href=#__codelineno-20-1></a>     Running `target/debug/lovas -r pgm/endless-stack.lva --print`
<a id=__codelineno-20-2 name=__codelineno-20-2 href=#__codelineno-20-2></a>Pgm { name: &quot;pgm/endless-stack.lva&quot;, text: [2, 123, 32, 255, 251, 255] }
<a id=__codelineno-20-3 name=__codelineno-20-3 href=#__codelineno-20-3></a>Runtime error!
<a id=__codelineno-20-4 name=__codelineno-20-4 href=#__codelineno-20-4></a>Runtime=41.589碌s
<a id=__codelineno-20-5 name=__codelineno-20-5 href=#__codelineno-20-5></a>op_cnt=201, pc=2, stack-depth=100, watermark=100
<a id=__codelineno-20-6 name=__codelineno-20-6 href=#__codelineno-20-6></a>Error: StackOverflow
</code></pre></div> <p>After 201 executed instructions it crashes. The stack depth at the time of the crash is 100. That is the complete stack, the next instruction tried to push value 101, which must fail. Instruction number 201 did cause the crash. That makes sense, if you follow the execution in your head. And the program counter is on 2. The last instruction executed will be the one before that, which would be at 0. That is the <code>push_u8</code> instruction. There is no surprise that the watermark is at 100. That is the highest possible value for it and also the current value of out stack depth.</p> <p>As we can now easily change the stack size, let us try what happens with a bigger stack:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-21-1 name=__codelineno-21-1 href=#__codelineno-21-1></a>     Running `target/debug/lovas -r pgm/endless-stack.lva --print --stack-size 150`
<a id=__codelineno-21-2 name=__codelineno-21-2 href=#__codelineno-21-2></a>Pgm { name: &quot;pgm/endless-stack.lva&quot;, text: [2, 123, 32, 255, 251, 255] }
<a id=__codelineno-21-3 name=__codelineno-21-3 href=#__codelineno-21-3></a>Runtime error!
<a id=__codelineno-21-4 name=__codelineno-21-4 href=#__codelineno-21-4></a>Runtime=47.648碌s
<a id=__codelineno-21-5 name=__codelineno-21-5 href=#__codelineno-21-5></a>op_cnt=301, pc=2, stack-depth=150, watermark=150
<a id=__codelineno-21-6 name=__codelineno-21-6 href=#__codelineno-21-6></a>Error: StackOverflow
</code></pre></div> <p>So now the stack overflows at over 150 values, of course. And it takes 301 instructions to fill it. Runtime has been longer, but only about 15%. I would not have expected a rise of 50%, as there is overhead for starting the program.</p> <p>What happens, if we activate <code>--trace</code>?</p> <div class=highlight><pre><span></span><code><a id=__codelineno-22-1 name=__codelineno-22-1 href=#__codelineno-22-1></a>     Running `target/debug/lovas -r pgm/endless-stack.lva --print --stack-size 150 --trace`
<a id=__codelineno-22-2 name=__codelineno-22-2 href=#__codelineno-22-2></a>Pgm { name: &quot;pgm/endless-stack.lva&quot;, text: [2, 123, 32, 255, 251, 255] }
<a id=__codelineno-22-3 name=__codelineno-22-3 href=#__codelineno-22-3></a>VM { stack: [], pc: 0, op_cnt: 0, trace: true, watermark: 0 }
<a id=__codelineno-22-4 name=__codelineno-22-4 href=#__codelineno-22-4></a>Executing op 0x02
<a id=__codelineno-22-5 name=__codelineno-22-5 href=#__codelineno-22-5></a>VM { stack: [123], pc: 2, op_cnt: 1, trace: true, watermark: 1 }
<a id=__codelineno-22-6 name=__codelineno-22-6 href=#__codelineno-22-6></a>Executing op 0x20
<a id=__codelineno-22-7 name=__codelineno-22-7 href=#__codelineno-22-7></a>
<a id=__codelineno-22-8 name=__codelineno-22-8 href=#__codelineno-22-8></a>[...]
<a id=__codelineno-22-9 name=__codelineno-22-9 href=#__codelineno-22-9></a>
<a id=__codelineno-22-10 name=__codelineno-22-10 href=#__codelineno-22-10></a>Executing op 0x02
<a id=__codelineno-22-11 name=__codelineno-22-11 href=#__codelineno-22-11></a>Runtime error!
<a id=__codelineno-22-12 name=__codelineno-22-12 href=#__codelineno-22-12></a>Runtime=67.312973ms
<a id=__codelineno-22-13 name=__codelineno-22-13 href=#__codelineno-22-13></a>op_cnt=301, pc=2, stack-depth=150, watermark=150
<a id=__codelineno-22-14 name=__codelineno-22-14 href=#__codelineno-22-14></a>Error: StackOverflow
</code></pre></div> <p>There is, of course, a lot of output, that I cut out. What is interesting is the change in execution time. I ran this inside the CLion IDE by JetBrains. The console there will not be a very fast console, as it does a lot with that output coming through. But the impact of the logging is enormous! The runtime until we hit our stack overflow is more than 1000 times longer! The exact numbers don't mean anything; we are running unoptimised Rust code with debuginfo, and the bottleneck is the console. But it is still fascinating to see.</p> <h2 id=you-labeled-me-ill-label-you>You labeled me, I'll label you<a class=headerlink href=#you-labeled-me-ill-label-you title="Permanent link">&para;</a></h2> <p><strong>We add a feature to our assembler that we overlooked before.</strong></p> <aside class=mdx-author> <p><img alt=@kratenko src=https://avatars.githubusercontent.com/kratenko></p> <p><span><strong>kratenko</strong> 路 <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 16 16"><path fill-rule=evenodd d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"/></svg></span> <a href=https://github.com/kratenko>kratenko</a></span> <span> <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path fill-rule=evenodd d="M6.75 0a.75.75 0 0 1 .75.75V3h9V.75a.75.75 0 0 1 1.5 0V3h2.75c.966 0 1.75.784 1.75 1.75v16a1.75 1.75 0 0 1-1.75 1.75H3.25a1.75 1.75 0 0 1-1.75-1.75v-16C1.5 3.784 2.284 3 3.25 3H6V.75A.75.75 0 0 1 6.75 0zm-3.5 4.5a.25.25 0 0 0-.25.25V8h18V4.75a.25.25 0 0 0-.25-.25H3.25zM21 9.5H3v11.25c0 .138.112.25.25.25h17.5a.25.25 0 0 0 .25-.25V9.5z"/></svg></span> 2022-08-11 路 <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path fill-rule=evenodd d="M0 3.75A.75.75 0 0 1 .75 3h7.497c1.566 0 2.945.8 3.751 2.014A4.496 4.496 0 0 1 15.75 3h7.5a.75.75 0 0 1 .75.75v15.063a.75.75 0 0 1-.755.75l-7.682-.052a3 3 0 0 0-2.142.878l-.89.891a.75.75 0 0 1-1.061 0l-.902-.901a3 3 0 0 0-2.121-.879H.75a.75.75 0 0 1-.75-.75v-15zm11.247 3.747a3 3 0 0 0-3-2.997H1.5V18h6.947a4.5 4.5 0 0 1 2.803.98l-.003-11.483zm1.503 11.485V7.5a3 3 0 0 1 3-3h6.75v13.558l-6.927-.047a4.5 4.5 0 0 0-2.823.971z"/></svg></span> Entry #26 路 <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12.5 7.25a.75.75 0 0 0-1.5 0v5.5c0 .27.144.518.378.651l3.5 2a.75.75 0 0 0 .744-1.302L12.5 12.315V7.25z"/><path fill-rule=evenodd d="M12 1C5.925 1 1 5.925 1 12s4.925 11 11 11 11-4.925 11-11S18.075 1 12 1zM2.5 12a9.5 9.5 0 1 1 19 0 9.5 9.5 0 0 1-19 0z"/></svg></span> 10 min read 路 <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M7.75 6.5a1.25 1.25 0 1 0 0 2.5 1.25 1.25 0 0 0 0-2.5z"/><path fill-rule=evenodd d="M2.5 1A1.5 1.5 0 0 0 1 2.5v8.44c0 .397.158.779.44 1.06l10.25 10.25a1.5 1.5 0 0 0 2.12 0l8.44-8.44a1.5 1.5 0 0 0 0-2.12L12 1.44A1.5 1.5 0 0 0 10.94 1H2.5zm0 1.5h8.44l10.25 10.25-8.44 8.44L2.5 10.94V2.5z"/></svg></span> <a href=https://github.com/kratenko/lovem/releases/tag/v0.0.10-journey>v0.0.10-journey</a> </span></p> </aside> <hr> <p>Over the last few entries we created ourselves a really useful little assembler program. I hope you played around with it and enjoyed not having to write bytecode directly. If you did, you should have noticed that I left out a really important detail. Remember when I was complaining about how bad writing bytecode is? And that it got even worth, when we introduced jumps? Yeah, I did not solve that problem at all. If anything, I made it worse, because you still have to count the relative bytes to your destination, but you do not see those bytes any longer. You just have to know, how many bytes each instruction will produce.</p> <h3 id=labels>Labels<a class=headerlink href=#labels title="Permanent link">&para;</a></h3> <p>There was so much already going on in that assembler program, that I did not want to introduce more complexity up front. Let's fix that now: we will introduce a way to give a position inside your program a name, so that you can <code>goto</code> that name later. And in good tradition, we will call this names <em>labels</em>.</p> <p>The traditional way of defining labels in assembly is by writing them first thing on a line, followed by a colon <code>:</code>. Take a look at this little program, <a href=https://github.com/kratenko/lovem/blob/v0.0.10-journey/pgm/label.lva>label.lva</a>. It is neither good style, nor does it do anything useful, but it shows us labels:</p> <div class=highlight><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>pgm/label.lva</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-23-1> 1</a></span>
<span class=normal><a href=#__codelineno-23-2> 2</a></span>
<span class=normal><a href=#__codelineno-23-3> 3</a></span>
<span class=normal><a href=#__codelineno-23-4> 4</a></span>
<span class=normal><a href=#__codelineno-23-5> 5</a></span>
<span class=normal><a href=#__codelineno-23-6> 6</a></span>
<span class=normal><a href=#__codelineno-23-7> 7</a></span>
<span class=normal><a href=#__codelineno-23-8> 8</a></span>
<span class=normal><a href=#__codelineno-23-9> 9</a></span>
<span class=normal><a href=#__codelineno-23-10>10</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-23-1 name=__codelineno-23-1></a>## A small demonstration of how labels work with goto.
<a id=__codelineno-23-2 name=__codelineno-23-2></a>push_u8 1
<a id=__codelineno-23-3 name=__codelineno-23-3></a>goto coda
<a id=__codelineno-23-4 name=__codelineno-23-4></a>
<a id=__codelineno-23-5 name=__codelineno-23-5></a><span class=hll>back:
</span><a id=__codelineno-23-6 name=__codelineno-23-6></a>  push_u8 3
<a id=__codelineno-23-7 name=__codelineno-23-7></a>  fin
<a id=__codelineno-23-8 name=__codelineno-23-8></a>
<a id=__codelineno-23-9 name=__codelineno-23-9></a><span class=hll> coda:  push_u8 2
</span><a id=__codelineno-23-10 name=__codelineno-23-10></a>goto back
</code></pre></div></td></tr></table></div> <p>There are two labels defined here: <code>back</code> in line 5, and <code>coda</code> in line 9. A label definition is a short string that is directly followed by a colon <code>:</code>. We restrict it to letters, numbers, and underscore, with a letter at the front. For the curious, the regex is: <code>^[A-Za-z][0-9A-Za-z_]{0,31}$</code>. As you can see in the example, there can be an optional instruction in the same line as the label definition. Now, how will our assembler parse those?</p> <h3 id=reconstruction>Reconstruction<a class=headerlink href=#reconstruction title="Permanent link">&para;</a></h3> <p>First of all, I did a little reconstruction inside <code>asm.rs</code>, because I did not like how the parsing was done inside an associated function, that also created the <code>AsmPgm</code> instance. That seems messed up. After the change, the <code>fn assemble()</code> creates the instance itself and then calls a method on it, to parse the source code. Here is the new version:</p> <div class=highlight><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>src/asm.rs</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-24-367>367</a></span>
<span class=normal><a href=#__codelineno-24-368>368</a></span>
<span class=normal><a href=#__codelineno-24-369>369</a></span>
<span class=normal><a href=#__codelineno-24-370>370</a></span>
<span class=normal><a href=#__codelineno-24-371>371</a></span>
<span class=normal><a href=#__codelineno-24-372>372</a></span>
<span class=normal><a href=#__codelineno-24-373>373</a></span>
<span class=normal><a href=#__codelineno-24-374>374</a></span>
<span class=normal><a href=#__codelineno-24-375>375</a></span>
<span class=normal><a href=#__codelineno-24-376>376</a></span>
<span class=normal><a href=#__codelineno-24-377>377</a></span>
<span class=normal><a href=#__codelineno-24-378>378</a></span>
<span class=normal><a href=#__codelineno-24-379>379</a></span>
<span class=normal><a href=#__codelineno-24-380>380</a></span>
<span class=normal><a href=#__codelineno-24-381>381</a></span>
<span class=normal><a href=#__codelineno-24-382>382</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-24-367 name=__codelineno-24-367></a><span class=sd>/// Parse assembly source code and turn it into a runnable program (or create report).</span>
<a id=__codelineno-24-368 name=__codelineno-24-368></a><span class=k>pub</span><span class=w> </span><span class=k>fn</span> <span class=nf>assemble</span><span class=p>(</span><span class=n>name</span>: <span class=kp>&amp;</span><span class=kt>str</span><span class=p>,</span><span class=w> </span><span class=n>content</span>: <span class=kp>&amp;</span><span class=kt>str</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=n>Pgm</span><span class=p>,</span><span class=w> </span><span class=n>AsmErrorReport</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-24-369 name=__codelineno-24-369></a><span class=w>    </span><span class=c1>// create a new, clean instance to fill during parsing:</span>
<a id=__codelineno-24-370 name=__codelineno-24-370></a><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>asm_pgm</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>AsmPgm</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-24-371 name=__codelineno-24-371></a><span class=w>        </span><span class=n>name</span>: <span class=nb>String</span>::<span class=n>from</span><span class=p>(</span><span class=n>name</span><span class=p>),</span>
<a id=__codelineno-24-372 name=__codelineno-24-372></a><span class=w>        </span><span class=n>instructions</span>: <span class=nc>vec</span><span class=o>!</span><span class=p>[],</span>
<a id=__codelineno-24-373 name=__codelineno-24-373></a><span class=w>        </span><span class=n>line_number</span>: <span class=mi>0</span><span class=p>,</span>
<a id=__codelineno-24-374 name=__codelineno-24-374></a><span class=w>        </span><span class=n>text_pos</span>: <span class=mi>0</span><span class=p>,</span>
<a id=__codelineno-24-375 name=__codelineno-24-375></a><span class=w>        </span><span class=n>error</span>: <span class=nb>None</span><span class=p>,</span>
<a id=__codelineno-24-376 name=__codelineno-24-376></a><span class=w>        </span><span class=n>labels</span>: <span class=nb>Default</span>::<span class=n>default</span><span class=p>(),</span>
<a id=__codelineno-24-377 name=__codelineno-24-377></a><span class=w>    </span><span class=p>};</span>
<a id=__codelineno-24-378 name=__codelineno-24-378></a><span class=w>    </span><span class=c1>// evaluate the source code:</span>
<a id=__codelineno-24-379 name=__codelineno-24-379></a><span class=w>    </span><span class=n>asm_pgm</span><span class=p>.</span><span class=n>process_assembly</span><span class=p>(</span><span class=n>content</span><span class=p>);</span>
<a id=__codelineno-24-380 name=__codelineno-24-380></a><span class=w>    </span><span class=c1>// convert to Pgm instance if successful, or to Error Report, if assembly failed:</span>
<a id=__codelineno-24-381 name=__codelineno-24-381></a><span class=w>    </span><span class=n>asm_pgm</span><span class=p>.</span><span class=n>to_program</span><span class=p>()</span>
<a id=__codelineno-24-382 name=__codelineno-24-382></a><span class=p>}</span>
</code></pre></div></td></tr></table></div> <p>And there is no problem with us changing the code like this. The only public function inside <code>asm.rs</code> is that <code>pub fn assemble()</code>. All methods of <code>AsmPgm</code> are private and therefore internal detail. Not that it would matter at this state of development, but it demonstrates how separation of public API and internal implementation work.</p> <p>What is also new in that function is a new field inside <code>AsmPgm</code>: <code>labels</code>.</p> <div class=highlight><pre><span></span><code><a id=__codelineno-25-1 name=__codelineno-25-1 href=#__codelineno-25-1></a><span class=sd>/// A assembler program during parsing/assembling.</span>
<a id=__codelineno-25-2 name=__codelineno-25-2 href=#__codelineno-25-2></a>#<span class=cp>#[derive(Debug)]</span>
<a id=__codelineno-25-3 name=__codelineno-25-3 href=#__codelineno-25-3></a><span class=k>struct</span> <span class=nc>AsmPgm</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-25-4 name=__codelineno-25-4 href=#__codelineno-25-4></a><span class=w>    </span><span class=o>..</span><span class=p>.</span>
<a id=__codelineno-25-5 name=__codelineno-25-5 href=#__codelineno-25-5></a><span class=w>    </span><span class=sd>/// A map storing label definitions by name with there position in bytecode.</span>
<a id=__codelineno-25-6 name=__codelineno-25-6 href=#__codelineno-25-6></a><span class=hll><span class=w>    </span><span class=n>labels</span>: <span class=nc>HashMap</span><span class=o>&lt;</span><span class=nb>String</span><span class=p>,</span><span class=w> </span><span class=kt>usize</span><span class=o>&gt;</span><span class=p>,</span>
</span><a id=__codelineno-25-7 name=__codelineno-25-7 href=#__codelineno-25-7></a><span class=p>}</span>
</code></pre></div> <p>It is a HashMap (aka. associative array in other languages). This is where we put all label definitions we find, while parsing the source file. It maps the label's name to its position inside the bytecode. Here we can look up where to jump, for a goto that wants to jump to a label.</p> <p>This is what our parsing methods now look like:</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-26-327>327</a></span>
<span class=normal><a href=#__codelineno-26-328>328</a></span>
<span class=normal><a href=#__codelineno-26-329>329</a></span>
<span class=normal><a href=#__codelineno-26-330>330</a></span>
<span class=normal><a href=#__codelineno-26-331>331</a></span>
<span class=normal><a href=#__codelineno-26-332>332</a></span>
<span class=normal><a href=#__codelineno-26-333>333</a></span>
<span class=normal><a href=#__codelineno-26-334>334</a></span>
<span class=normal><a href=#__codelineno-26-335>335</a></span>
<span class=normal><a href=#__codelineno-26-336>336</a></span>
<span class=normal><a href=#__codelineno-26-337>337</a></span>
<span class=normal><a href=#__codelineno-26-338>338</a></span>
<span class=normal><a href=#__codelineno-26-339>339</a></span>
<span class=normal><a href=#__codelineno-26-340>340</a></span>
<span class=normal><a href=#__codelineno-26-341>341</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-26-327 name=__codelineno-26-327></a><span class=k>fn</span> <span class=nf>process</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>,</span><span class=w> </span><span class=n>content</span>: <span class=kp>&amp;</span><span class=kt>str</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=p>(),</span><span class=w> </span><span class=n>AsmError</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-26-328 name=__codelineno-26-328></a><span class=w>    </span><span class=c1>// Go over complete source, extracting instructions. Some will have their opargs</span>
<a id=__codelineno-26-329 name=__codelineno-26-329></a><span class=w>    </span><span class=c1>// left empty (with placeholders).</span>
<a id=__codelineno-26-330 name=__codelineno-26-330></a><span class=hll><span class=w>    </span><span class=bp>self</span><span class=p>.</span><span class=n>parse</span><span class=p>(</span><span class=n>content</span><span class=p>)</span><span class=o>?</span><span class=p>;</span>
</span><a id=__codelineno-26-331 name=__codelineno-26-331></a><span class=hll><span class=w>    </span><span class=bp>self</span><span class=p>.</span><span class=n>update_instructions</span><span class=p>()</span>
</span><a id=__codelineno-26-332 name=__codelineno-26-332></a><span class=p>}</span>
<a id=__codelineno-26-333 name=__codelineno-26-333></a>
<a id=__codelineno-26-334 name=__codelineno-26-334></a><span class=sd>/// Process assembly source code. Must be used with &quot;empty&quot; AsmPgm.</span>
<a id=__codelineno-26-335 name=__codelineno-26-335></a><span class=k>fn</span> <span class=nf>process_assembly</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>,</span><span class=w> </span><span class=n>content</span>: <span class=kp>&amp;</span><span class=kt>str</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-26-336 name=__codelineno-26-336></a><span class=w>    </span><span class=c1>// this function is just a wrapper around `process()`, so that I can use the</span>
<a id=__codelineno-26-337 name=__codelineno-26-337></a><span class=w>    </span><span class=c1>// return magic and don&#39;t need to write the error check twice.</span>
<a id=__codelineno-26-338 name=__codelineno-26-338></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=kd>let</span><span class=w> </span><span class=nb>Err</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>process</span><span class=p>(</span><span class=n>content</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-26-339 name=__codelineno-26-339></a><span class=w>        </span><span class=bp>self</span><span class=p>.</span><span class=n>error</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>Some</span><span class=p>(</span><span class=n>e</span><span class=p>);</span>
<a id=__codelineno-26-340 name=__codelineno-26-340></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-26-341 name=__codelineno-26-341></a><span class=p>}</span>
</code></pre></div></td></tr></table></div> <p>The important part is, that we have to steps now. We parse the complete source, as before. The second run is needed to write the actual relative jump address to the instructions. We do not know them during parsing, at least not for jumps forward.</p> <h3 id=parsing-label-definitions>Parsing label definitions<a class=headerlink href=#parsing-label-definitions title="Permanent link">&para;</a></h3> <p>I got a little fancy again, while writing the function for parsing label definitions:</p> <div class=highlight><table class=highlighttable><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-27-257>257</a></span>
<span class=normal><a href=#__codelineno-27-258>258</a></span>
<span class=normal><a href=#__codelineno-27-259>259</a></span>
<span class=normal><a href=#__codelineno-27-260>260</a></span>
<span class=normal><a href=#__codelineno-27-261>261</a></span>
<span class=normal><a href=#__codelineno-27-262>262</a></span>
<span class=normal><a href=#__codelineno-27-263>263</a></span>
<span class=normal><a href=#__codelineno-27-264>264</a></span>
<span class=normal><a href=#__codelineno-27-265>265</a></span>
<span class=normal><a href=#__codelineno-27-266>266</a></span>
<span class=normal><a href=#__codelineno-27-267>267</a></span>
<span class=normal><a href=#__codelineno-27-268>268</a></span>
<span class=normal><a href=#__codelineno-27-269>269</a></span>
<span class=normal><a href=#__codelineno-27-270>270</a></span>
<span class=normal><a href=#__codelineno-27-271>271</a></span>
<span class=normal><a href=#__codelineno-27-272>272</a></span>
<span class=normal><a href=#__codelineno-27-273>273</a></span>
<span class=normal><a href=#__codelineno-27-274>274</a></span>
<span class=normal><a href=#__codelineno-27-275>275</a></span>
<span class=normal><a href=#__codelineno-27-276>276</a></span>
<span class=normal><a href=#__codelineno-27-277>277</a></span>
<span class=normal><a href=#__codelineno-27-278>278</a></span>
<span class=normal><a href=#__codelineno-27-279>279</a></span>
<span class=normal><a href=#__codelineno-27-280>280</a></span>
<span class=normal><a href=#__codelineno-27-281>281</a></span>
<span class=normal><a href=#__codelineno-27-282>282</a></span>
<span class=normal><a href=#__codelineno-27-283>283</a></span>
<span class=normal><a href=#__codelineno-27-284>284</a></span>
<span class=normal><a href=#__codelineno-27-285>285</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-27-257 name=__codelineno-27-257></a><span class=sd>/// Parses and extracts optional label definition from line.</span>
<a id=__codelineno-27-258 name=__codelineno-27-258></a><span class=sd>///</span>
<a id=__codelineno-27-259 name=__codelineno-27-259></a><span class=sd>/// Looks for a colon &#39;:&#39;. If one exists, the part before the first colon will be</span>
<a id=__codelineno-27-260 name=__codelineno-27-260></a><span class=sd>/// seen as the name for a label, that is defined on this line. Instructions inside</span>
<a id=__codelineno-27-261 name=__codelineno-27-261></a><span class=sd>/// the program that execute jumps can refer to these labels as a destination.</span>
<a id=__codelineno-27-262 name=__codelineno-27-262></a><span class=sd>/// Lines containing a label definition may also contain an instruction and/or a comment.</span>
<a id=__codelineno-27-263 name=__codelineno-27-263></a><span class=sd>/// This can return `AsmError::InvalidLabel` if the part before the colon is not a valid</span>
<a id=__codelineno-27-264 name=__codelineno-27-264></a><span class=sd>/// label name, or `AsmError::DuplicateLabel` if a label name is reused.</span>
<a id=__codelineno-27-265 name=__codelineno-27-265></a><span class=sd>/// If a label could be parsed, it will be stored to the `AsmPgm`.</span>
<a id=__codelineno-27-266 name=__codelineno-27-266></a><span class=sd>/// On success, the line without the label definition is returned, so that it can be</span>
<a id=__codelineno-27-267 name=__codelineno-27-267></a><span class=sd>/// used to extract an instruction. This will be the complete line, if there was no</span>
<a id=__codelineno-27-268 name=__codelineno-27-268></a><span class=sd>/// label definition.</span>
<a id=__codelineno-27-269 name=__codelineno-27-269></a><span class=hll><span class=k>fn</span> <span class=nf>parse_label_definition</span><span class=o>&lt;&#39;</span><span class=na>a</span><span class=o>&gt;</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>,</span><span class=w> </span><span class=n>line</span>: <span class=kp>&amp;</span><span class=o>&#39;</span><span class=na>a</span> <span class=kt>str</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;&amp;&#39;</span><span class=na>a</span><span class=w> </span><span class=kt>str</span><span class=p>,</span><span class=w> </span><span class=n>AsmError</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span>
</span><a id=__codelineno-27-270 name=__codelineno-27-270></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=kd>let</span><span class=w> </span><span class=nb>Some</span><span class=p>((</span><span class=n>label</span><span class=p>,</span><span class=w> </span><span class=n>rest</span><span class=p>))</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>line</span><span class=p>.</span><span class=n>split_once</span><span class=p>(</span><span class=s>&quot;:&quot;</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-27-271 name=__codelineno-27-271></a><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>label</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>label</span><span class=p>.</span><span class=n>trim_start</span><span class=p>();</span>
<a id=__codelineno-27-272 name=__codelineno-27-272></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=n>VALID_LABEL</span><span class=p>.</span><span class=n>is_match</span><span class=p>(</span><span class=n>label</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-27-273 name=__codelineno-27-273></a><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>labels</span><span class=p>.</span><span class=n>contains_key</span><span class=p>(</span><span class=n>label</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-27-274 name=__codelineno-27-274></a><span class=w>                </span><span class=nb>Err</span><span class=p>(</span><span class=n>AsmError</span>::<span class=n>DuplicateLabel</span><span class=p>(</span><span class=nb>String</span>::<span class=n>from</span><span class=p>(</span><span class=n>label</span><span class=p>)))</span>
<a id=__codelineno-27-275 name=__codelineno-27-275></a><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-27-276 name=__codelineno-27-276></a><span class=w>                </span><span class=bp>self</span><span class=p>.</span><span class=n>labels</span><span class=p>.</span><span class=n>insert</span><span class=p>(</span><span class=nb>String</span>::<span class=n>from</span><span class=p>(</span><span class=n>label</span><span class=p>),</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>text_pos</span><span class=p>);</span>
<a id=__codelineno-27-277 name=__codelineno-27-277></a><span class=w>                </span><span class=nb>Ok</span><span class=p>(</span><span class=n>rest</span><span class=p>)</span>
<a id=__codelineno-27-278 name=__codelineno-27-278></a><span class=w>            </span><span class=p>}</span>
<a id=__codelineno-27-279 name=__codelineno-27-279></a><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-27-280 name=__codelineno-27-280></a><span class=w>            </span><span class=nb>Err</span><span class=p>(</span><span class=n>AsmError</span>::<span class=n>InvalidLabel</span><span class=p>(</span><span class=nb>String</span>::<span class=n>from</span><span class=p>(</span><span class=n>label</span><span class=p>)))</span>
<a id=__codelineno-27-281 name=__codelineno-27-281></a><span class=w>        </span><span class=p>}</span>
<a id=__codelineno-27-282 name=__codelineno-27-282></a><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-27-283 name=__codelineno-27-283></a><span class=w>        </span><span class=nb>Ok</span><span class=p>(</span><span class=n>line</span><span class=p>)</span>
<a id=__codelineno-27-284 name=__codelineno-27-284></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-27-285 name=__codelineno-27-285></a><span class=p>}</span>
</code></pre></div></td></tr></table></div> <p>The method is trying to find a label definition in the line, and if so, handles it. We use our trusted <code>Result&lt;&gt;</code> returning, to communicate potential errors. But instead of <code>Ok(())</code>, which is the empty okay value, we return a <code>&amp;str</code> on success. This is because there might also be an instruction in the line. If we find a label definition, it returns the line after the colon. If there is none, it returns the complete line it got. This gives us the lines as we used to get before we introduced labels. Great. But what is that weird <code>'a</code> that shows up in that highlighted line everywhere?</p> <h3 id=lifetime>Lifetime<a class=headerlink href=#lifetime title="Permanent link">&para;</a></h3> <p>Yeah, this is where it becomes rusty, again. I said, in an early post, that you would hate the Rust compiler and its pedantic error messages. The thing Rust is most pedantic about, is ownership and access to values you do not own. We are working with references to <code>String</code>s here. A <code>&amp;str</code> references the bytes inside that <code>String</code> directly (a <code>&amp;str</code> need not reference a <code>String</code>, but it does here). We did that before, where is the problem now? This is the first time we are returning a <code>&amp;str</code>.</p> <p>When you are using references, Rust makes sure that the value you are referencing exists at least as long as the reference exists. That is easy for functions, as long as you drop every reference you have when you are done. But in this function, we return a reference to the parameter we got. Rust cannot allow that without some special care. When I remove the <code>'a</code> parts of the method, I get a compilation error:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-28-1 name=__codelineno-28-1 href=#__codelineno-28-1></a>error[E0623]: lifetime mismatch
<a id=__codelineno-28-2 name=__codelineno-28-2 href=#__codelineno-28-2></a>   --&gt; src/asm.rs:277:21
<a id=__codelineno-28-3 name=__codelineno-28-3 href=#__codelineno-28-3></a>    |
<a id=__codelineno-28-4 name=__codelineno-28-4 href=#__codelineno-28-4></a>269 |     fn parse_label_definition(&amp;mut self, line: &amp;str) -&gt; Result&lt;&amp;str, AsmError&gt; {
<a id=__codelineno-28-5 name=__codelineno-28-5 href=#__codelineno-28-5></a>    |                                                ----     ----------------------
<a id=__codelineno-28-6 name=__codelineno-28-6 href=#__codelineno-28-6></a>    |                                                |
<a id=__codelineno-28-7 name=__codelineno-28-7 href=#__codelineno-28-7></a>    |                                                this parameter and the return type are declared with different lifetimes...
<a id=__codelineno-28-8 name=__codelineno-28-8 href=#__codelineno-28-8></a>...
<a id=__codelineno-28-9 name=__codelineno-28-9 href=#__codelineno-28-9></a>277 |                     Ok(rest)
<a id=__codelineno-28-10 name=__codelineno-28-10 href=#__codelineno-28-10></a>    |                     ^^^^^^^^ ...but data from `line` is returned here
<a id=__codelineno-28-11 name=__codelineno-28-11 href=#__codelineno-28-11></a>    |
<a id=__codelineno-28-12 name=__codelineno-28-12 href=#__codelineno-28-12></a>    = note: each elided lifetime in input position becomes a distinct lifetime
<a id=__codelineno-28-13 name=__codelineno-28-13 href=#__codelineno-28-13></a>help: consider introducing a named lifetime parameter and update trait if needed
<a id=__codelineno-28-14 name=__codelineno-28-14 href=#__codelineno-28-14></a>    |
<a id=__codelineno-28-15 name=__codelineno-28-15 href=#__codelineno-28-15></a>269 |     fn parse_label_definition&lt;&#39;a&gt;(&amp;&#39;a mut self, line: &amp;&#39;a str) -&gt; Result&lt;&amp;str, AsmError&gt; {
<a id=__codelineno-28-16 name=__codelineno-28-16 href=#__codelineno-28-16></a>    |                              ++++  ++                  ++
</code></pre></div> <p>The compiler tells me, that I messed up the lifetimes. It even proposes a change that introduces lifetime parameters (but gets it slightly wrong). What do we do with the <code>'a</code>?</p> <p>Well we introduce a lifetime parameter called <code>a</code>. The syntax for that is the apostrophe, which looked weird to me at start, but it is so lightweight, that I came to like it. It is custom, to just call your lifetimes <code>'a</code>, <code>'b</code>, ... &ndash; they normally don't have a long scope anyway. The thing we are telling the compiler with this parameter is this: the lifetime of the returned <code>&amp;str</code> is dependent on the lifetime of the parameter <code>line: &amp;str</code>. So whenever the reference the function is called with runs out of scope, the reference that was returned must be out of scope as well.</p> <h4 id=an-example>An example<a class=headerlink href=#an-example title="Permanent link">&para;</a></h4> <p>This is a concept that is new to many programmers when they learn Rust. I think, what we do here demonstrates it quiet well. Let us look at what happens for line 9 of our assembly program:</p> <div class=highlight><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>pgm/label.lva</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-29-9>9</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-29-9 name=__codelineno-29-9></a> coda:  push_u8 2
</code></pre></div></td></tr></table></div> <p>Our function receives a reference to a <code>String</code> holding that line: <code>" coda: push_u8 2"</code>. It finds the label <code>coda</code> and stores it inside <code>self.labels</code>. Its work is done, but there might be more to this line. It returns a reference to a substring of it (<code>&amp;str</code> are actually slices; they can reference only a part of a <code>String</code>'s data). That is what we return, a reference to the part data inside the <code>String</code>, starting at the first char after the colon, so it looks like this <code>" push_u8 2"</code>. It is <em>not</em> a copy, it is the same area inside the computer's memory! So if you want to make certain, that there are no accesses to memory after its content has run out of scope (use after free, or use of local variable after it runs our of scope), you <em>must not</em> allow access to it, unless you are sure the value still exists. And this is what Rust does. This is what makes Rust a secure language. <em>Many</em> bugs and exploits in the world exist, because most languages do not check this, but leave the responsibility to the programmer. And the really cool thing about Rust is, it does this completely at compile time, as you can see by the fact that we got a compiler error.</p> <p>The way we call our function is not a problem at all:</p> <div class=highlight><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>src/asm.rs</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-30-292>292</a></span>
<span class=normal><a href=#__codelineno-30-293>293</a></span>
<span class=normal><a href=#__codelineno-30-294>294</a></span>
<span class=normal><a href=#__codelineno-30-295>295</a></span>
<span class=normal><a href=#__codelineno-30-296>296</a></span>
<span class=normal><a href=#__codelineno-30-297>297</a></span>
<span class=normal><a href=#__codelineno-30-298>298</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-30-292 name=__codelineno-30-292></a><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>n</span><span class=p>,</span><span class=w> </span><span class=n>line</span><span class=p>)</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=n>content</span><span class=p>.</span><span class=n>lines</span><span class=p>().</span><span class=n>enumerate</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-30-293 name=__codelineno-30-293></a><span class=w>    </span><span class=c1>// File lines start counting at 1:</span>
<a id=__codelineno-30-294 name=__codelineno-30-294></a><span class=w>    </span><span class=bp>self</span><span class=p>.</span><span class=n>line_number</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>n</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=p>;</span>
<a id=__codelineno-30-295 name=__codelineno-30-295></a><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>line</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>parse_label_definition</span><span class=p>(</span><span class=n>line</span><span class=p>)</span><span class=o>?</span><span class=p>;</span>
<a id=__codelineno-30-296 name=__codelineno-30-296></a><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>line</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>AsmPgm</span>::<span class=n>clean_line</span><span class=p>(</span><span class=n>line</span><span class=p>);</span>
<a id=__codelineno-30-297 name=__codelineno-30-297></a><span class=w>    </span><span class=bp>self</span><span class=p>.</span><span class=n>parse_clean_line</span><span class=p>(</span><span class=n>line</span><span class=p>)</span><span class=o>?</span><span class=p>;</span>
<a id=__codelineno-30-298 name=__codelineno-30-298></a><span class=p>}</span>
</code></pre></div></td></tr></table></div> <p>Our initial <code>line</code> comes from line 228. It is already a reference, because <code>content.lines()</code> is also giving us a reference to the memory inside of <code>content</code>. That is a reference already, the <code>String</code> variable that holds (and owns) the data lives inside <code>lovas.rs</code>:</p> <div class=highlight><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>src/bin/lovas.rs</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-31-67>67</a></span>
<span class=normal><a href=#__codelineno-31-68>68</a></span>
<span class=normal><a href=#__codelineno-31-69>69</a></span>
<span class=normal><a href=#__codelineno-31-70>70</a></span>
<span class=normal><a href=#__codelineno-31-71>71</a></span>
<span class=normal><a href=#__codelineno-31-72>72</a></span>
<span class=normal><a href=#__codelineno-31-73>73</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-31-67 name=__codelineno-31-67></a><span class=w>    </span><span class=c1>// read complete source file into String:</span>
<a id=__codelineno-31-68 name=__codelineno-31-68></a><span class=hll><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>content</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>std</span>::<span class=n>fs</span>::<span class=n>read_to_string</span><span class=p>(</span><span class=o>&amp;</span><span class=n>args</span><span class=p>.</span><span class=n>source</span><span class=p>)</span>
</span><a id=__codelineno-31-69 name=__codelineno-31-69></a><span class=w>        </span><span class=p>.</span><span class=n>with_context</span><span class=p>(</span>
<a id=__codelineno-31-70 name=__codelineno-31-70></a><span class=w>            </span><span class=o>||</span><span class=w> </span><span class=fm>format!</span><span class=p>(</span><span class=s>&quot;could not read file `{}`&quot;</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>name</span><span class=p>)</span>
<a id=__codelineno-31-71 name=__codelineno-31-71></a><span class=w>        </span><span class=p>)</span><span class=o>?</span><span class=p>;</span>
<a id=__codelineno-31-72 name=__codelineno-31-72></a><span class=w>    </span><span class=c1>// run the assembler:</span>
<a id=__codelineno-31-73 name=__codelineno-31-73></a><span class=hll><span class=w>    </span><span class=k>match</span><span class=w> </span><span class=n>asm</span>::<span class=n>assemble</span><span class=p>(</span><span class=o>&amp;</span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>content</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
</span></code></pre></div></td></tr></table></div> <p>We do not copy any of that bytes along the way. The first time we do that is in <code>clean_line()</code>. Returning a <code>&amp;str</code> will not work there, because we actually modify the contents of the string, by replacing characters inside it. Have you ever tried to work with inplace "substrings" (I mean char arrays, like this <code>char *str</code>), without modifying the contents (placing <code>\0</code> bytes). It is not fun. In Rust, it can be, if you understand lifetime restrictions.</p> <h4 id=easy-way-out>Easy way out<a class=headerlink href=#easy-way-out title="Permanent link">&para;</a></h4> <p>If you run into problems with your <code>&amp;str</code> inside a Rust program, there is often an easy way to get around that. You can simply create a new <code>String</code> from your <code>&amp;str</code>, as we do in <code>clean_line()</code>. That will copy the bytes. For our program, that would have been no problem at all. Cloning a few bytes of source code for every line during assembly would cost us next to nothing. You would not notice in execution time. But things are different when you need to quickly handle long substrings in a program. Think of a diagnostic job on a busy server. And remember that <code>String</code>s will be created on the heap. That is a complexity that you sometimes want to avoid. When programming microcontrollers, there is a chance that you do not even have a memory allocator at your disposal. And microcontrollers is, what we are aiming for in our project. There are already some parts of lovem, that we will need to change, because of that. But that is a story for another time. I just thought that this was a nice little example to introduce you to lifetime parameters. We will need them at some point...</p> <h3 id=run-it-already>Run it already!<a class=headerlink href=#run-it-already title="Permanent link">&para;</a></h3> <p>This is a long entry already. You can look at the complete state of the assembler directly in the sourcecode. You should know how to find the tags inside the repo by now. But I want to execute our new program, using the labels, before I end this. Here it is again:</p> <div class=highlight><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>pgm/label.lva</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-32-1> 1</a></span>
<span class=normal><a href=#__codelineno-32-2> 2</a></span>
<span class=normal><a href=#__codelineno-32-3> 3</a></span>
<span class=normal><a href=#__codelineno-32-4> 4</a></span>
<span class=normal><a href=#__codelineno-32-5> 5</a></span>
<span class=normal><a href=#__codelineno-32-6> 6</a></span>
<span class=normal><a href=#__codelineno-32-7> 7</a></span>
<span class=normal><a href=#__codelineno-32-8> 8</a></span>
<span class=normal><a href=#__codelineno-32-9> 9</a></span>
<span class=normal><a href=#__codelineno-32-10>10</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-32-1 name=__codelineno-32-1></a>## A small demonstration of how labels work with goto.
<a id=__codelineno-32-2 name=__codelineno-32-2></a>push_u8 1
<a id=__codelineno-32-3 name=__codelineno-32-3></a>goto coda
<a id=__codelineno-32-4 name=__codelineno-32-4></a>
<a id=__codelineno-32-5 name=__codelineno-32-5></a>back:
<a id=__codelineno-32-6 name=__codelineno-32-6></a>  push_u8 3
<a id=__codelineno-32-7 name=__codelineno-32-7></a>  fin
<a id=__codelineno-32-8 name=__codelineno-32-8></a>
<a id=__codelineno-32-9 name=__codelineno-32-9></a> coda:  push_u8 2
<a id=__codelineno-32-10 name=__codelineno-32-10></a>goto back
</code></pre></div></td></tr></table></div> <p>We need to execute it with the <code>--trace</code> flag, or we will not see anything:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-33-1 name=__codelineno-33-1 href=#__codelineno-33-1></a>kratenko@jotun:~/git/lovem$ cargo run --bin lovas -- -r pgm/label.lva --print --trace
<a id=__codelineno-33-2 name=__codelineno-33-2 href=#__codelineno-33-2></a>   Compiling lovem v0.0.10 (/home/kratenko/git/lovem)
<a id=__codelineno-33-3 name=__codelineno-33-3 href=#__codelineno-33-3></a>    Finished dev [unoptimized + debuginfo] target(s) in 1.33s
<a id=__codelineno-33-4 name=__codelineno-33-4 href=#__codelineno-33-4></a>     Running `target/debug/lovas -r pgm/label.lva --print --trace`
<a id=__codelineno-33-5 name=__codelineno-33-5 href=#__codelineno-33-5></a>Pgm { name: &quot;pgm/label.lva&quot;, text: [2, 1, 32, 0, 3, 2, 3, 255, 2, 2, 32, 255, 248] }
<a id=__codelineno-33-6 name=__codelineno-33-6 href=#__codelineno-33-6></a>VM { stack: [], pc: 0, op_cnt: 0, trace: true, watermark: 0 }
<a id=__codelineno-33-7 name=__codelineno-33-7 href=#__codelineno-33-7></a>Executing op 0x02
<a id=__codelineno-33-8 name=__codelineno-33-8 href=#__codelineno-33-8></a>VM { stack: [1], pc: 2, op_cnt: 1, trace: true, watermark: 1 }
<a id=__codelineno-33-9 name=__codelineno-33-9 href=#__codelineno-33-9></a>Executing op 0x20
<a id=__codelineno-33-10 name=__codelineno-33-10 href=#__codelineno-33-10></a>  Jump from 5 by 3
<a id=__codelineno-33-11 name=__codelineno-33-11 href=#__codelineno-33-11></a>VM { stack: [1], pc: 8, op_cnt: 2, trace: true, watermark: 1 }
<a id=__codelineno-33-12 name=__codelineno-33-12 href=#__codelineno-33-12></a>Executing op 0x02
<a id=__codelineno-33-13 name=__codelineno-33-13 href=#__codelineno-33-13></a>VM { stack: [1, 2], pc: 10, op_cnt: 3, trace: true, watermark: 2 }
<a id=__codelineno-33-14 name=__codelineno-33-14 href=#__codelineno-33-14></a>Executing op 0x20
<a id=__codelineno-33-15 name=__codelineno-33-15 href=#__codelineno-33-15></a>  Jump from 13 by -8
<a id=__codelineno-33-16 name=__codelineno-33-16 href=#__codelineno-33-16></a>VM { stack: [1, 2], pc: 5, op_cnt: 4, trace: true, watermark: 2 }
<a id=__codelineno-33-17 name=__codelineno-33-17 href=#__codelineno-33-17></a>Executing op 0x02
<a id=__codelineno-33-18 name=__codelineno-33-18 href=#__codelineno-33-18></a>VM { stack: [1, 2, 3], pc: 7, op_cnt: 5, trace: true, watermark: 3 }
<a id=__codelineno-33-19 name=__codelineno-33-19 href=#__codelineno-33-19></a>Terminated!
<a id=__codelineno-33-20 name=__codelineno-33-20 href=#__codelineno-33-20></a>VM { stack: [1, 2, 3], pc: 8, op_cnt: 6, trace: true, watermark: 3 }
<a id=__codelineno-33-21 name=__codelineno-33-21 href=#__codelineno-33-21></a>Terminated.
<a id=__codelineno-33-22 name=__codelineno-33-22 href=#__codelineno-33-22></a>Runtime=65.598碌s
<a id=__codelineno-33-23 name=__codelineno-33-23 href=#__codelineno-33-23></a>op_cnt=6, pc=8, stack-depth=3, watermark=3
</code></pre></div> <p>The program has three <code>push_u8</code> operations. If you executed them in the order of the source code, they would push <code>[1, 3, 2]</code> to the stack. But because of the <code>goto</code> instructions, they are not executed in that order. You can see the jumps in the trace, and you can see that the stack at termination holds the values in this order: <code>[1, 2, 3]</code>.</p> <p>Not much of a program, but it shows you, how our new labels work. And finally: no more counting bytes!</p> <h3 id=homework>Homework<a class=headerlink href=#homework title="Permanent link">&para;</a></h3> <p>Our programs <code>endless.lva</code> and <code>endless-stack.lva</code> no longer work, because we changed how the <code>goto</code> instruction must be written. Can you fix them?</p> <h2 id=what-if>What if?<a class=headerlink href=#what-if title="Permanent link">&para;</a></h2> <p><strong>Choose your path.</strong></p> <aside class=mdx-author> <p><img alt=@kratenko src=https://avatars.githubusercontent.com/kratenko></p> <p><span><strong>kratenko</strong> 路 <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 16 16"><path fill-rule=evenodd d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"/></svg></span> <a href=https://github.com/kratenko>kratenko</a></span> <span> <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path fill-rule=evenodd d="M6.75 0a.75.75 0 0 1 .75.75V3h9V.75a.75.75 0 0 1 1.5 0V3h2.75c.966 0 1.75.784 1.75 1.75v16a1.75 1.75 0 0 1-1.75 1.75H3.25a1.75 1.75 0 0 1-1.75-1.75v-16C1.5 3.784 2.284 3 3.25 3H6V.75A.75.75 0 0 1 6.75 0zm-3.5 4.5a.25.25 0 0 0-.25.25V8h18V4.75a.25.25 0 0 0-.25-.25H3.25zM21 9.5H3v11.25c0 .138.112.25.25.25h17.5a.25.25 0 0 0 .25-.25V9.5z"/></svg></span> 2022-08-19 路 <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path fill-rule=evenodd d="M0 3.75A.75.75 0 0 1 .75 3h7.497c1.566 0 2.945.8 3.751 2.014A4.496 4.496 0 0 1 15.75 3h7.5a.75.75 0 0 1 .75.75v15.063a.75.75 0 0 1-.755.75l-7.682-.052a3 3 0 0 0-2.142.878l-.89.891a.75.75 0 0 1-1.061 0l-.902-.901a3 3 0 0 0-2.121-.879H.75a.75.75 0 0 1-.75-.75v-15zm11.247 3.747a3 3 0 0 0-3-2.997H1.5V18h6.947a4.5 4.5 0 0 1 2.803.98l-.003-11.483zm1.503 11.485V7.5a3 3 0 0 1 3-3h6.75v13.558l-6.927-.047a4.5 4.5 0 0 0-2.823.971z"/></svg></span> Entry #27 路 <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12.5 7.25a.75.75 0 0 0-1.5 0v5.5c0 .27.144.518.378.651l3.5 2a.75.75 0 0 0 .744-1.302L12.5 12.315V7.25z"/><path fill-rule=evenodd d="M12 1C5.925 1 1 5.925 1 12s4.925 11 11 11 11-4.925 11-11S18.075 1 12 1zM2.5 12a9.5 9.5 0 1 1 19 0 9.5 9.5 0 0 1-19 0z"/></svg></span> 6 min read 路 <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M7.75 6.5a1.25 1.25 0 1 0 0 2.5 1.25 1.25 0 0 0 0-2.5z"/><path fill-rule=evenodd d="M2.5 1A1.5 1.5 0 0 0 1 2.5v8.44c0 .397.158.779.44 1.06l10.25 10.25a1.5 1.5 0 0 0 2.12 0l8.44-8.44a1.5 1.5 0 0 0 0-2.12L12 1.44A1.5 1.5 0 0 0 10.94 1H2.5zm0 1.5h8.44l10.25 10.25-8.44 8.44L2.5 10.94V2.5z"/></svg></span> <a href=https://github.com/kratenko/lovem/releases/tag/v0.0.11-journey>v0.0.11-journey</a> </span></p> </aside> <hr> <p>Our assembler gives us a lot of convenience for testing features of our VM. So let us start doing interesting stuff with it. We do have support for jumps already, but as it is now, save of an endless loop, there is absolutely no reason to do it, yet. All our programs run their predetermined way. If you look again at <code>label.lva</code>, you can see that none of those <code>goto</code>s introduce any dynamic. We could just ditch them and reorder the rest. It would do the same, only more efficient. They simple tangle up our linear code, without removing its linearity.</p> <p>Today we will introduce branches to our VM. A branch is a point in a program from which there are multiple possible paths to take. Two paths, normally. Which of those paths is takes is decided at runtime by looking at the state of the program. For us that means that we look at the value on top of the stack. How does it work?</p> <h3 id=conditional-jump>Conditional jump<a class=headerlink href=#conditional-jump title="Permanent link">&para;</a></h3> <p>We already introduced the <code>goto</code> operation. What we will add now, works exactly the same way, but only <em>if</em> a certain condition is met. And, yes, we will call that operation <em>if</em>. But if what? How about <em>if equal</em>? </p> <p>So we get the new opname <code>ifeq</code>, that pops a value from the stack and only executes its jump when that value is equal. Equal to what, you want to know? How about if it is equal to zero. If you want to compare it to a different number, it is easy to subtract that number from your value before you compare it to zero, and you achieve what you need.</p> <h3 id=new-operations>New operations<a class=headerlink href=#new-operations title="Permanent link">&para;</a></h3> <p>We will introduce multiple if-operations. Six, to be precise.</p> <div class=highlight><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>src/op.rs</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-34-63>63</a></span>
<span class=normal><a href=#__codelineno-34-64>64</a></span>
<span class=normal><a href=#__codelineno-34-65>65</a></span>
<span class=normal><a href=#__codelineno-34-66>66</a></span>
<span class=normal><a href=#__codelineno-34-67>67</a></span>
<span class=normal><a href=#__codelineno-34-68>68</a></span>
<span class=normal><a href=#__codelineno-34-69>69</a></span>
<span class=normal><a href=#__codelineno-34-70>70</a></span>
<span class=normal><a href=#__codelineno-34-71>71</a></span>
<span class=normal><a href=#__codelineno-34-72>72</a></span>
<span class=normal><a href=#__codelineno-34-73>73</a></span>
<span class=normal><a href=#__codelineno-34-74>74</a></span>
<span class=normal><a href=#__codelineno-34-75>75</a></span>
<span class=normal><a href=#__codelineno-34-76>76</a></span>
<span class=normal><a href=#__codelineno-34-77>77</a></span>
<span class=normal><a href=#__codelineno-34-78>78</a></span>
<span class=normal><a href=#__codelineno-34-79>79</a></span>
<span class=normal><a href=#__codelineno-34-80>80</a></span>
<span class=normal><a href=#__codelineno-34-81>81</a></span>
<span class=normal><a href=#__codelineno-34-82>82</a></span>
<span class=normal><a href=#__codelineno-34-83>83</a></span>
<span class=normal><a href=#__codelineno-34-84>84</a></span>
<span class=normal><a href=#__codelineno-34-85>85</a></span>
<span class=normal><a href=#__codelineno-34-86>86</a></span>
<span class=normal><a href=#__codelineno-34-87>87</a></span>
<span class=normal><a href=#__codelineno-34-88>88</a></span>
<span class=normal><a href=#__codelineno-34-89>89</a></span>
<span class=normal><a href=#__codelineno-34-90>90</a></span>
<span class=normal><a href=#__codelineno-34-91>91</a></span>
<span class=normal><a href=#__codelineno-34-92>92</a></span>
<span class=normal><a href=#__codelineno-34-93>93</a></span>
<span class=normal><a href=#__codelineno-34-94>94</a></span>
<span class=normal><a href=#__codelineno-34-95>95</a></span>
<span class=normal><a href=#__codelineno-34-96>96</a></span>
<span class=normal><a href=#__codelineno-34-97>97</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-34-63 name=__codelineno-34-63></a><span class=sd>/// opcode: Conditional relative jump (branch) on pop == zero.</span>
<a id=__codelineno-34-64 name=__codelineno-34-64></a><span class=sd>///</span>
<a id=__codelineno-34-65 name=__codelineno-34-65></a><span class=sd>/// pop: 1, push: 0</span>
<a id=__codelineno-34-66 name=__codelineno-34-66></a><span class=sd>/// oparg: 2B, i16 relative jump</span>
<a id=__codelineno-34-67 name=__codelineno-34-67></a><span class=k>pub</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=n>IFEQ</span>: <span class=kt>u8</span> <span class=o>=</span><span class=w> </span><span class=mh>0x21</span><span class=p>;</span>
<a id=__codelineno-34-68 name=__codelineno-34-68></a>
<a id=__codelineno-34-69 name=__codelineno-34-69></a><span class=sd>/// opcode: Conditional relative jump (branch) on pop != zero.</span>
<a id=__codelineno-34-70 name=__codelineno-34-70></a><span class=sd>///</span>
<a id=__codelineno-34-71 name=__codelineno-34-71></a><span class=sd>/// pop: 1, push: 0</span>
<a id=__codelineno-34-72 name=__codelineno-34-72></a><span class=sd>/// oparg: 2B, i16 relative jump</span>
<a id=__codelineno-34-73 name=__codelineno-34-73></a><span class=k>pub</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=n>IFNE</span>: <span class=kt>u8</span> <span class=o>=</span><span class=w> </span><span class=mh>0x22</span><span class=p>;</span>
<a id=__codelineno-34-74 name=__codelineno-34-74></a>
<a id=__codelineno-34-75 name=__codelineno-34-75></a><span class=sd>/// opcode: Conditional relative jump (branch) on pop &lt; zero.</span>
<a id=__codelineno-34-76 name=__codelineno-34-76></a><span class=sd>///</span>
<a id=__codelineno-34-77 name=__codelineno-34-77></a><span class=sd>/// pop: 1, push: 0</span>
<a id=__codelineno-34-78 name=__codelineno-34-78></a><span class=sd>/// oparg: 2B, i16 relative jump</span>
<a id=__codelineno-34-79 name=__codelineno-34-79></a><span class=k>pub</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=n>IFLT</span>: <span class=kt>u8</span> <span class=o>=</span><span class=w> </span><span class=mh>0x23</span><span class=p>;</span>
<a id=__codelineno-34-80 name=__codelineno-34-80></a>
<a id=__codelineno-34-81 name=__codelineno-34-81></a><span class=sd>/// opcode: Conditional relative jump (branch) on pop &lt;= zero.</span>
<a id=__codelineno-34-82 name=__codelineno-34-82></a><span class=sd>///</span>
<a id=__codelineno-34-83 name=__codelineno-34-83></a><span class=sd>/// pop: 1, push: 0</span>
<a id=__codelineno-34-84 name=__codelineno-34-84></a><span class=sd>/// oparg: 2B, i16 relative jump</span>
<a id=__codelineno-34-85 name=__codelineno-34-85></a><span class=k>pub</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=n>IFLE</span>: <span class=kt>u8</span> <span class=o>=</span><span class=w> </span><span class=mh>0x24</span><span class=p>;</span>
<a id=__codelineno-34-86 name=__codelineno-34-86></a>
<a id=__codelineno-34-87 name=__codelineno-34-87></a><span class=sd>/// opcode: Conditional relative jump (branch) on pop &gt; zero.</span>
<a id=__codelineno-34-88 name=__codelineno-34-88></a><span class=sd>///</span>
<a id=__codelineno-34-89 name=__codelineno-34-89></a><span class=sd>/// pop: 1, push: 0</span>
<a id=__codelineno-34-90 name=__codelineno-34-90></a><span class=sd>/// oparg: 2B, i16 relative jump</span>
<a id=__codelineno-34-91 name=__codelineno-34-91></a><span class=k>pub</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=n>IFGT</span>: <span class=kt>u8</span> <span class=o>=</span><span class=w> </span><span class=mh>0x25</span><span class=p>;</span>
<a id=__codelineno-34-92 name=__codelineno-34-92></a>
<a id=__codelineno-34-93 name=__codelineno-34-93></a><span class=sd>/// opcode: Conditional relative jump (branch) on pop &gt;= zero.</span>
<a id=__codelineno-34-94 name=__codelineno-34-94></a><span class=sd>///</span>
<a id=__codelineno-34-95 name=__codelineno-34-95></a><span class=sd>/// pop: 1, push: 0</span>
<a id=__codelineno-34-96 name=__codelineno-34-96></a><span class=sd>/// oparg: 2B, i16 relative jump</span>
<a id=__codelineno-34-97 name=__codelineno-34-97></a><span class=k>pub</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=n>IFGE</span>: <span class=kt>u8</span> <span class=o>=</span><span class=w> </span><span class=mh>0x26</span><span class=p>;</span>
</code></pre></div></td></tr></table></div> <p>And we add another operation, while we add it: <code>dup</code></p> <div class=highlight><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>src/op.rs</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-35-21>21</a></span>
<span class=normal><a href=#__codelineno-35-22>22</a></span>
<span class=normal><a href=#__codelineno-35-23>23</a></span>
<span class=normal><a href=#__codelineno-35-24>24</a></span>
<span class=normal><a href=#__codelineno-35-25>25</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-35-21 name=__codelineno-35-21></a><span class=sd>/// opcode: Pop value from stack and push it back, twice.</span>
<a id=__codelineno-35-22 name=__codelineno-35-22></a><span class=sd>///</span>
<a id=__codelineno-35-23 name=__codelineno-35-23></a><span class=sd>/// pop: 1, push: 2</span>
<a id=__codelineno-35-24 name=__codelineno-35-24></a><span class=sd>/// oparg: 0</span>
<a id=__codelineno-35-25 name=__codelineno-35-25></a><span class=k>pub</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=n>DUP</span>: <span class=kt>u8</span> <span class=o>=</span><span class=w> </span><span class=mh>0x03</span><span class=p>;</span>
</code></pre></div></td></tr></table></div> <p>This one simply duplicates the value on top of the stack, so that there will be another copy of it on top of it. We will use that often when testing values with an <code>if</code>, if we still need the value after testing it. The <code>if</code> will consume the top most value.</p> <h3 id=extending-the-assembler>Extending the assembler<a class=headerlink href=#extending-the-assembler title="Permanent link">&para;</a></h3> <p>We add the parsing handlers for our new instructions:</p> <div class=highlight><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>src/asm.rs</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-36-235>235</a></span>
<span class=normal><a href=#__codelineno-36-236>236</a></span>
<span class=normal><a href=#__codelineno-36-237>237</a></span>
<span class=normal><a href=#__codelineno-36-238>238</a></span>
<span class=normal><a href=#__codelineno-36-239>239</a></span>
<span class=normal><a href=#__codelineno-36-240>240</a></span>
<span class=normal><a href=#__codelineno-36-241>241</a></span>
<span class=normal><a href=#__codelineno-36-242>242</a></span>
<span class=normal><a href=#__codelineno-36-243>243</a></span>
<span class=normal><a href=#__codelineno-36-244>244</a></span>
<span class=normal><a href=#__codelineno-36-245>245</a></span>
<span class=normal><a href=#__codelineno-36-246>246</a></span>
<span class=normal><a href=#__codelineno-36-247>247</a></span>
<span class=normal><a href=#__codelineno-36-248>248</a></span>
<span class=normal><a href=#__codelineno-36-249>249</a></span>
<span class=normal><a href=#__codelineno-36-250>250</a></span>
<span class=normal><a href=#__codelineno-36-251>251</a></span>
<span class=normal><a href=#__codelineno-36-252>252</a></span>
<span class=normal><a href=#__codelineno-36-253>253</a></span>
<span class=normal><a href=#__codelineno-36-254>254</a></span>
<span class=normal><a href=#__codelineno-36-255>255</a></span>
<span class=normal><a href=#__codelineno-36-256>256</a></span>
<span class=normal><a href=#__codelineno-36-257>257</a></span>
<span class=normal><a href=#__codelineno-36-258>258</a></span>
<span class=normal><a href=#__codelineno-36-259>259</a></span>
<span class=normal><a href=#__codelineno-36-260>260</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-36-235 name=__codelineno-36-235></a><span class=k>fn</span> <span class=nf>parse_instruction</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>,</span><span class=w> </span><span class=n>opname</span>: <span class=kp>&amp;</span><span class=kt>str</span><span class=p>,</span><span class=w> </span><span class=n>oparg</span>: <span class=nb>Option</span><span class=o>&lt;&amp;</span><span class=kt>str</span><span class=o>&gt;</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=p>(),</span><span class=w> </span><span class=n>AsmError</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-36-236 name=__codelineno-36-236></a><span class=w>    </span><span class=k>match</span><span class=w> </span><span class=n>opname</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-36-237 name=__codelineno-36-237></a><span class=w>        </span><span class=s>&quot;nop&quot;</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>parse_a0_instruction</span><span class=p>(</span><span class=n>op</span>::<span class=n>NOP</span><span class=p>,</span><span class=w> </span><span class=n>oparg</span><span class=p>),</span>
<a id=__codelineno-36-238 name=__codelineno-36-238></a><span class=w>        </span><span class=s>&quot;fin&quot;</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>parse_a0_instruction</span><span class=p>(</span><span class=n>op</span>::<span class=n>FIN</span><span class=p>,</span><span class=w> </span><span class=n>oparg</span><span class=p>),</span>
<a id=__codelineno-36-239 name=__codelineno-36-239></a><span class=w>        </span><span class=s>&quot;pop&quot;</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>parse_a0_instruction</span><span class=p>(</span><span class=n>op</span>::<span class=n>POP</span><span class=p>,</span><span class=w> </span><span class=n>oparg</span><span class=p>),</span>
<a id=__codelineno-36-240 name=__codelineno-36-240></a><span class=hll><span class=w>        </span><span class=s>&quot;dup&quot;</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>parse_a0_instruction</span><span class=p>(</span><span class=n>op</span>::<span class=n>DUP</span><span class=p>,</span><span class=w> </span><span class=n>oparg</span><span class=p>),</span>
</span><a id=__codelineno-36-241 name=__codelineno-36-241></a><span class=w>        </span><span class=s>&quot;add&quot;</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>parse_a0_instruction</span><span class=p>(</span><span class=n>op</span>::<span class=n>ADD</span><span class=p>,</span><span class=w> </span><span class=n>oparg</span><span class=p>),</span>
<a id=__codelineno-36-242 name=__codelineno-36-242></a><span class=w>        </span><span class=s>&quot;sub&quot;</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>parse_a0_instruction</span><span class=p>(</span><span class=n>op</span>::<span class=n>SUB</span><span class=p>,</span><span class=w> </span><span class=n>oparg</span><span class=p>),</span>
<a id=__codelineno-36-243 name=__codelineno-36-243></a><span class=w>        </span><span class=s>&quot;mul&quot;</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>parse_a0_instruction</span><span class=p>(</span><span class=n>op</span>::<span class=n>MUL</span><span class=p>,</span><span class=w> </span><span class=n>oparg</span><span class=p>),</span>
<a id=__codelineno-36-244 name=__codelineno-36-244></a><span class=w>        </span><span class=s>&quot;div&quot;</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>parse_a0_instruction</span><span class=p>(</span><span class=n>op</span>::<span class=n>DIV</span><span class=p>,</span><span class=w> </span><span class=n>oparg</span><span class=p>),</span>
<a id=__codelineno-36-245 name=__codelineno-36-245></a><span class=w>        </span><span class=s>&quot;mod&quot;</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>parse_a0_instruction</span><span class=p>(</span><span class=n>op</span>::<span class=n>MOD</span><span class=p>,</span><span class=w> </span><span class=n>oparg</span><span class=p>),</span>
<a id=__codelineno-36-246 name=__codelineno-36-246></a><span class=w>        </span><span class=s>&quot;push_u8&quot;</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-36-247 name=__codelineno-36-247></a><span class=w>            </span><span class=kd>let</span><span class=w> </span><span class=n>oparg</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>oparg</span><span class=p>.</span><span class=n>ok_or</span><span class=p>(</span><span class=n>AsmError</span>::<span class=n>MissingArgument</span><span class=p>)</span><span class=o>?</span><span class=p>;</span>
<a id=__codelineno-36-248 name=__codelineno-36-248></a><span class=w>            </span><span class=kd>let</span><span class=w> </span><span class=n>v</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>parse_int</span>::<span class=n>parse</span>::<span class=o>&lt;</span><span class=kt>u8</span><span class=o>&gt;</span><span class=p>(</span><span class=n>oparg</span><span class=p>).</span><span class=n>or</span><span class=p>(</span><span class=nb>Err</span><span class=p>(</span><span class=n>AsmError</span>::<span class=n>InvalidArgument</span><span class=p>))</span><span class=o>?</span><span class=p>;</span>
<a id=__codelineno-36-249 name=__codelineno-36-249></a><span class=w>            </span><span class=bp>self</span><span class=p>.</span><span class=n>push_a1_instruction</span><span class=p>(</span><span class=n>op</span>::<span class=n>PUSH_U8</span><span class=p>,</span><span class=w> </span><span class=n>v</span><span class=p>)</span>
<a id=__codelineno-36-250 name=__codelineno-36-250></a><span class=w>        </span><span class=p>},</span>
<a id=__codelineno-36-251 name=__codelineno-36-251></a><span class=w>        </span><span class=s>&quot;goto&quot;</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>parse_label_instruction</span><span class=p>(</span><span class=n>op</span>::<span class=n>GOTO</span><span class=p>,</span><span class=w> </span><span class=n>oparg</span><span class=p>),</span>
<a id=__codelineno-36-252 name=__codelineno-36-252></a><span class=hll><span class=w>        </span><span class=s>&quot;ifeq&quot;</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>parse_label_instruction</span><span class=p>(</span><span class=n>op</span>::<span class=n>IFEQ</span><span class=p>,</span><span class=w> </span><span class=n>oparg</span><span class=p>),</span>
</span><a id=__codelineno-36-253 name=__codelineno-36-253></a><span class=hll><span class=w>        </span><span class=s>&quot;ifne&quot;</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>parse_label_instruction</span><span class=p>(</span><span class=n>op</span>::<span class=n>IFNE</span><span class=p>,</span><span class=w> </span><span class=n>oparg</span><span class=p>),</span>
</span><a id=__codelineno-36-254 name=__codelineno-36-254></a><span class=hll><span class=w>        </span><span class=s>&quot;iflt&quot;</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>parse_label_instruction</span><span class=p>(</span><span class=n>op</span>::<span class=n>IFLT</span><span class=p>,</span><span class=w> </span><span class=n>oparg</span><span class=p>),</span>
</span><a id=__codelineno-36-255 name=__codelineno-36-255></a><span class=hll><span class=w>        </span><span class=s>&quot;ifle&quot;</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>parse_label_instruction</span><span class=p>(</span><span class=n>op</span>::<span class=n>IFLE</span><span class=p>,</span><span class=w> </span><span class=n>oparg</span><span class=p>),</span>
</span><a id=__codelineno-36-256 name=__codelineno-36-256></a><span class=hll><span class=w>        </span><span class=s>&quot;ifgt&quot;</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>parse_label_instruction</span><span class=p>(</span><span class=n>op</span>::<span class=n>IFGT</span><span class=p>,</span><span class=w> </span><span class=n>oparg</span><span class=p>),</span>
</span><a id=__codelineno-36-257 name=__codelineno-36-257></a><span class=hll><span class=w>        </span><span class=s>&quot;ifge&quot;</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>parse_label_instruction</span><span class=p>(</span><span class=n>op</span>::<span class=n>IFGE</span><span class=p>,</span><span class=w> </span><span class=n>oparg</span><span class=p>),</span>
</span><a id=__codelineno-36-258 name=__codelineno-36-258></a><span class=w>        </span><span class=n>_</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=nb>Err</span><span class=p>(</span><span class=n>AsmError</span>::<span class=n>UnknownInstruction</span><span class=p>(</span><span class=nb>String</span>::<span class=n>from</span><span class=p>(</span><span class=n>opname</span><span class=p>)))</span>
<a id=__codelineno-36-259 name=__codelineno-36-259></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-36-260 name=__codelineno-36-260></a><span class=p>}</span>
</code></pre></div></td></tr></table></div> <p>And that is all we need to change on our assembler. The way we have written it, it is easy to introduce new operations, when they share the same syntax in assembly and in bytecode as existing ones.</p> <h3 id=adjust-the-vm>Adjust the VM<a class=headerlink href=#adjust-the-vm title="Permanent link">&para;</a></h3> <p>First, we add the handler for the <code>dup</code>. Just pop a value and push it back, twice. Easy. <div class=highlight><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>src/vm.rs</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-37-175>175</a></span>
<span class=normal><a href=#__codelineno-37-176>176</a></span>
<span class=normal><a href=#__codelineno-37-177>177</a></span>
<span class=normal><a href=#__codelineno-37-178>178</a></span>
<span class=normal><a href=#__codelineno-37-179>179</a></span>
<span class=normal><a href=#__codelineno-37-180>180</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-37-175 name=__codelineno-37-175></a><span class=n>op</span>::<span class=n>DUP</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-37-176 name=__codelineno-37-176></a><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>v</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>pop</span><span class=p>()</span><span class=o>?</span><span class=p>;</span>
<a id=__codelineno-37-177 name=__codelineno-37-177></a><span class=w>    </span><span class=bp>self</span><span class=p>.</span><span class=n>push</span><span class=p>(</span><span class=n>v</span><span class=p>)</span><span class=o>?</span><span class=p>;</span>
<a id=__codelineno-37-178 name=__codelineno-37-178></a><span class=w>    </span><span class=bp>self</span><span class=p>.</span><span class=n>push</span><span class=p>(</span><span class=n>v</span><span class=p>)</span><span class=o>?</span><span class=p>;</span>
<a id=__codelineno-37-179 name=__codelineno-37-179></a><span class=w>    </span><span class=nb>Ok</span><span class=p>(())</span>
<a id=__codelineno-37-180 name=__codelineno-37-180></a><span class=p>},</span>
</code></pre></div></td></tr></table></div></p> <p>And now, the <code>if*</code>-handlers. They are similar to the <code>goto</code>-handler, just with an <code>if</code> added. </p> <div class=highlight><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>src/vm.rs</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-38-218>218</a></span>
<span class=normal><a href=#__codelineno-38-219>219</a></span>
<span class=normal><a href=#__codelineno-38-220>220</a></span>
<span class=normal><a href=#__codelineno-38-221>221</a></span>
<span class=normal><a href=#__codelineno-38-222>222</a></span>
<span class=normal><a href=#__codelineno-38-223>223</a></span>
<span class=normal><a href=#__codelineno-38-224>224</a></span>
<span class=normal><a href=#__codelineno-38-225>225</a></span>
<span class=normal><a href=#__codelineno-38-226>226</a></span>
<span class=normal><a href=#__codelineno-38-227>227</a></span>
<span class=normal><a href=#__codelineno-38-228>228</a></span>
<span class=normal><a href=#__codelineno-38-229>229</a></span>
<span class=normal><a href=#__codelineno-38-230>230</a></span>
<span class=normal><a href=#__codelineno-38-231>231</a></span>
<span class=normal><a href=#__codelineno-38-232>232</a></span>
<span class=normal><a href=#__codelineno-38-233>233</a></span>
<span class=normal><a href=#__codelineno-38-234>234</a></span>
<span class=normal><a href=#__codelineno-38-235>235</a></span>
<span class=normal><a href=#__codelineno-38-236>236</a></span>
<span class=normal><a href=#__codelineno-38-237>237</a></span>
<span class=normal><a href=#__codelineno-38-238>238</a></span>
<span class=normal><a href=#__codelineno-38-239>239</a></span>
<span class=normal><a href=#__codelineno-38-240>240</a></span>
<span class=normal><a href=#__codelineno-38-241>241</a></span>
<span class=normal><a href=#__codelineno-38-242>242</a></span>
<span class=normal><a href=#__codelineno-38-243>243</a></span>
<span class=normal><a href=#__codelineno-38-244>244</a></span>
<span class=normal><a href=#__codelineno-38-245>245</a></span>
<span class=normal><a href=#__codelineno-38-246>246</a></span>
<span class=normal><a href=#__codelineno-38-247>247</a></span>
<span class=normal><a href=#__codelineno-38-248>248</a></span>
<span class=normal><a href=#__codelineno-38-249>249</a></span>
<span class=normal><a href=#__codelineno-38-250>250</a></span>
<span class=normal><a href=#__codelineno-38-251>251</a></span>
<span class=normal><a href=#__codelineno-38-252>252</a></span>
<span class=normal><a href=#__codelineno-38-253>253</a></span>
<span class=normal><a href=#__codelineno-38-254>254</a></span>
<span class=normal><a href=#__codelineno-38-255>255</a></span>
<span class=normal><a href=#__codelineno-38-256>256</a></span>
<span class=normal><a href=#__codelineno-38-257>257</a></span>
<span class=normal><a href=#__codelineno-38-258>258</a></span>
<span class=normal><a href=#__codelineno-38-259>259</a></span>
<span class=normal><a href=#__codelineno-38-260>260</a></span>
<span class=normal><a href=#__codelineno-38-261>261</a></span>
<span class=normal><a href=#__codelineno-38-262>262</a></span>
<span class=normal><a href=#__codelineno-38-263>263</a></span>
<span class=normal><a href=#__codelineno-38-264>264</a></span>
<span class=normal><a href=#__codelineno-38-265>265</a></span>
<span class=normal><a href=#__codelineno-38-266>266</a></span>
<span class=normal><a href=#__codelineno-38-267>267</a></span>
<span class=normal><a href=#__codelineno-38-268>268</a></span>
<span class=normal><a href=#__codelineno-38-269>269</a></span>
<span class=normal><a href=#__codelineno-38-270>270</a></span>
<span class=normal><a href=#__codelineno-38-271>271</a></span>
<span class=normal><a href=#__codelineno-38-272>272</a></span>
<span class=normal><a href=#__codelineno-38-273>273</a></span>
<span class=normal><a href=#__codelineno-38-274>274</a></span>
<span class=normal><a href=#__codelineno-38-275>275</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-38-218 name=__codelineno-38-218></a><span class=n>op</span>::<span class=n>GOTO</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-38-219 name=__codelineno-38-219></a><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>d</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>fetch_i16</span><span class=p>(</span><span class=n>pgm</span><span class=p>)</span><span class=o>?</span><span class=p>;</span>
<a id=__codelineno-38-220 name=__codelineno-38-220></a><span class=w>    </span><span class=bp>self</span><span class=p>.</span><span class=n>relative_jump</span><span class=p>(</span><span class=n>pgm</span><span class=p>,</span><span class=w> </span><span class=n>d</span><span class=p>)</span>
<a id=__codelineno-38-221 name=__codelineno-38-221></a><span class=p>},</span>
<a id=__codelineno-38-222 name=__codelineno-38-222></a><span class=n>op</span>::<span class=n>IFEQ</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-38-223 name=__codelineno-38-223></a><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>d</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>fetch_i16</span><span class=p>(</span><span class=n>pgm</span><span class=p>)</span><span class=o>?</span><span class=p>;</span>
<a id=__codelineno-38-224 name=__codelineno-38-224></a><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>v</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>pop</span><span class=p>()</span><span class=o>?</span><span class=p>;</span>
<a id=__codelineno-38-225 name=__codelineno-38-225></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=n>v</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-38-226 name=__codelineno-38-226></a><span class=w>        </span><span class=bp>self</span><span class=p>.</span><span class=n>relative_jump</span><span class=p>(</span><span class=n>pgm</span><span class=p>,</span><span class=w> </span><span class=n>d</span><span class=p>)</span>
<a id=__codelineno-38-227 name=__codelineno-38-227></a><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-38-228 name=__codelineno-38-228></a><span class=w>        </span><span class=nb>Ok</span><span class=p>(())</span>
<a id=__codelineno-38-229 name=__codelineno-38-229></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-38-230 name=__codelineno-38-230></a><span class=p>},</span>
<a id=__codelineno-38-231 name=__codelineno-38-231></a><span class=n>op</span>::<span class=n>IFNE</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-38-232 name=__codelineno-38-232></a><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>d</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>fetch_i16</span><span class=p>(</span><span class=n>pgm</span><span class=p>)</span><span class=o>?</span><span class=p>;</span>
<a id=__codelineno-38-233 name=__codelineno-38-233></a><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>v</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>pop</span><span class=p>()</span><span class=o>?</span><span class=p>;</span>
<a id=__codelineno-38-234 name=__codelineno-38-234></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=n>v</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-38-235 name=__codelineno-38-235></a><span class=w>        </span><span class=bp>self</span><span class=p>.</span><span class=n>relative_jump</span><span class=p>(</span><span class=n>pgm</span><span class=p>,</span><span class=w> </span><span class=n>d</span><span class=p>)</span>
<a id=__codelineno-38-236 name=__codelineno-38-236></a><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-38-237 name=__codelineno-38-237></a><span class=w>        </span><span class=nb>Ok</span><span class=p>(())</span>
<a id=__codelineno-38-238 name=__codelineno-38-238></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-38-239 name=__codelineno-38-239></a><span class=p>},</span>
<a id=__codelineno-38-240 name=__codelineno-38-240></a><span class=n>op</span>::<span class=n>IFLT</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-38-241 name=__codelineno-38-241></a><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>d</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>fetch_i16</span><span class=p>(</span><span class=n>pgm</span><span class=p>)</span><span class=o>?</span><span class=p>;</span>
<a id=__codelineno-38-242 name=__codelineno-38-242></a><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>v</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>pop</span><span class=p>()</span><span class=o>?</span><span class=p>;</span>
<a id=__codelineno-38-243 name=__codelineno-38-243></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=n>v</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-38-244 name=__codelineno-38-244></a><span class=w>        </span><span class=bp>self</span><span class=p>.</span><span class=n>relative_jump</span><span class=p>(</span><span class=n>pgm</span><span class=p>,</span><span class=w> </span><span class=n>d</span><span class=p>)</span>
<a id=__codelineno-38-245 name=__codelineno-38-245></a><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-38-246 name=__codelineno-38-246></a><span class=w>        </span><span class=nb>Ok</span><span class=p>(())</span>
<a id=__codelineno-38-247 name=__codelineno-38-247></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-38-248 name=__codelineno-38-248></a><span class=p>},</span>
<a id=__codelineno-38-249 name=__codelineno-38-249></a><span class=n>op</span>::<span class=n>IFLE</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-38-250 name=__codelineno-38-250></a><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>d</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>fetch_i16</span><span class=p>(</span><span class=n>pgm</span><span class=p>)</span><span class=o>?</span><span class=p>;</span>
<a id=__codelineno-38-251 name=__codelineno-38-251></a><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>v</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>pop</span><span class=p>()</span><span class=o>?</span><span class=p>;</span>
<a id=__codelineno-38-252 name=__codelineno-38-252></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=n>v</span><span class=w> </span><span class=o>&lt;=</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-38-253 name=__codelineno-38-253></a><span class=w>        </span><span class=bp>self</span><span class=p>.</span><span class=n>relative_jump</span><span class=p>(</span><span class=n>pgm</span><span class=p>,</span><span class=w> </span><span class=n>d</span><span class=p>)</span>
<a id=__codelineno-38-254 name=__codelineno-38-254></a><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-38-255 name=__codelineno-38-255></a><span class=w>        </span><span class=nb>Ok</span><span class=p>(())</span>
<a id=__codelineno-38-256 name=__codelineno-38-256></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-38-257 name=__codelineno-38-257></a><span class=p>},</span>
<a id=__codelineno-38-258 name=__codelineno-38-258></a><span class=n>op</span>::<span class=n>IFGT</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-38-259 name=__codelineno-38-259></a><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>d</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>fetch_i16</span><span class=p>(</span><span class=n>pgm</span><span class=p>)</span><span class=o>?</span><span class=p>;</span>
<a id=__codelineno-38-260 name=__codelineno-38-260></a><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>v</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>pop</span><span class=p>()</span><span class=o>?</span><span class=p>;</span>
<a id=__codelineno-38-261 name=__codelineno-38-261></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=n>v</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-38-262 name=__codelineno-38-262></a><span class=w>        </span><span class=bp>self</span><span class=p>.</span><span class=n>relative_jump</span><span class=p>(</span><span class=n>pgm</span><span class=p>,</span><span class=w> </span><span class=n>d</span><span class=p>)</span>
<a id=__codelineno-38-263 name=__codelineno-38-263></a><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-38-264 name=__codelineno-38-264></a><span class=w>        </span><span class=nb>Ok</span><span class=p>(())</span>
<a id=__codelineno-38-265 name=__codelineno-38-265></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-38-266 name=__codelineno-38-266></a><span class=p>},</span>
<a id=__codelineno-38-267 name=__codelineno-38-267></a><span class=n>op</span>::<span class=n>IFGE</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-38-268 name=__codelineno-38-268></a><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>d</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>fetch_i16</span><span class=p>(</span><span class=n>pgm</span><span class=p>)</span><span class=o>?</span><span class=p>;</span>
<a id=__codelineno-38-269 name=__codelineno-38-269></a><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>v</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>pop</span><span class=p>()</span><span class=o>?</span><span class=p>;</span>
<a id=__codelineno-38-270 name=__codelineno-38-270></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=n>v</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-38-271 name=__codelineno-38-271></a><span class=w>        </span><span class=bp>self</span><span class=p>.</span><span class=n>relative_jump</span><span class=p>(</span><span class=n>pgm</span><span class=p>,</span><span class=w> </span><span class=n>d</span><span class=p>)</span>
<a id=__codelineno-38-272 name=__codelineno-38-272></a><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-38-273 name=__codelineno-38-273></a><span class=w>        </span><span class=nb>Ok</span><span class=p>(())</span>
<a id=__codelineno-38-274 name=__codelineno-38-274></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-38-275 name=__codelineno-38-275></a><span class=p>},</span>
</code></pre></div></td></tr></table></div> <p>And that is all the code we have to change. Our VM can now execute conditional jumps. Now we can do some serious programming!</p> <h3 id=a-for-loop>A for-loop<a class=headerlink href=#a-for-loop title="Permanent link">&para;</a></h3> <p>Can't wait to use an <em>if</em> in program:</p> <div class=highlight><table class=highlighttable><tr><th colspan=2 class=filename><span class=filename>pgm/loop.lva</span></th></tr><tr><td class=linenos><div class=linenodiv><pre><span></span><span class=normal><a href=#__codelineno-39-1> 1</a></span>
<span class=normal><a href=#__codelineno-39-2> 2</a></span>
<span class=normal><a href=#__codelineno-39-3> 3</a></span>
<span class=normal><a href=#__codelineno-39-4> 4</a></span>
<span class=normal><a href=#__codelineno-39-5> 5</a></span>
<span class=normal><a href=#__codelineno-39-6> 6</a></span>
<span class=normal><a href=#__codelineno-39-7> 7</a></span>
<span class=normal><a href=#__codelineno-39-8> 8</a></span>
<span class=normal><a href=#__codelineno-39-9> 9</a></span>
<span class=normal><a href=#__codelineno-39-10>10</a></span></pre></div></td><td class=code><div><pre><span></span><code><a id=__codelineno-39-1 name=__codelineno-39-1></a>## Demonstrate the conditional jump (a branch)
<a id=__codelineno-39-2 name=__codelineno-39-2></a>## The program has a loop that it executes thrice, before it terminates.
<a id=__codelineno-39-3 name=__codelineno-39-3></a>  push_u8 3
<a id=__codelineno-39-4 name=__codelineno-39-4></a>loop:
<a id=__codelineno-39-5 name=__codelineno-39-5></a>  push_u8 1
<a id=__codelineno-39-6 name=__codelineno-39-6></a>  sub
<a id=__codelineno-39-7 name=__codelineno-39-7></a>  dup
<a id=__codelineno-39-8 name=__codelineno-39-8></a>  ifgt loop
<a id=__codelineno-39-9 name=__codelineno-39-9></a>  pop
<a id=__codelineno-39-10 name=__codelineno-39-10></a>  fin
</code></pre></div></td></tr></table></div> <p>And execute it:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-40-1 name=__codelineno-40-1 href=#__codelineno-40-1></a>kratenko@jotun:~/git/lovem$ cargo run --bin lovas -- -r pgm/loop.lva --print --trace
<a id=__codelineno-40-2 name=__codelineno-40-2 href=#__codelineno-40-2></a>    Finished dev [unoptimized + debuginfo] target(s) in 0.02s
<a id=__codelineno-40-3 name=__codelineno-40-3 href=#__codelineno-40-3></a>     Running `target/debug/lovas -r pgm/loop.lva --print --trace`
<a id=__codelineno-40-4 name=__codelineno-40-4 href=#__codelineno-40-4></a>Pgm { name: &quot;pgm/loop.lva&quot;, text: [2, 3, 2, 1, 17, 3, 37, 255, 249, 1, 255] }
<a id=__codelineno-40-5 name=__codelineno-40-5 href=#__codelineno-40-5></a>VM { stack: [], pc: 0, op_cnt: 0, trace: true, watermark: 0 }
<a id=__codelineno-40-6 name=__codelineno-40-6 href=#__codelineno-40-6></a>Executing op 0x02
<a id=__codelineno-40-7 name=__codelineno-40-7 href=#__codelineno-40-7></a>VM { stack: [3], pc: 2, op_cnt: 1, trace: true, watermark: 1 }
<a id=__codelineno-40-8 name=__codelineno-40-8 href=#__codelineno-40-8></a>Executing op 0x02
<a id=__codelineno-40-9 name=__codelineno-40-9 href=#__codelineno-40-9></a>VM { stack: [3, 1], pc: 4, op_cnt: 2, trace: true, watermark: 2 }
<a id=__codelineno-40-10 name=__codelineno-40-10 href=#__codelineno-40-10></a>Executing op 0x11
<a id=__codelineno-40-11 name=__codelineno-40-11 href=#__codelineno-40-11></a>VM { stack: [2], pc: 5, op_cnt: 3, trace: true, watermark: 2 }
<a id=__codelineno-40-12 name=__codelineno-40-12 href=#__codelineno-40-12></a>Executing op 0x03
<a id=__codelineno-40-13 name=__codelineno-40-13 href=#__codelineno-40-13></a>VM { stack: [2, 2], pc: 6, op_cnt: 4, trace: true, watermark: 2 }
<a id=__codelineno-40-14 name=__codelineno-40-14 href=#__codelineno-40-14></a>Executing op 0x25
<a id=__codelineno-40-15 name=__codelineno-40-15 href=#__codelineno-40-15></a>  Jump from 9 by -7
<a id=__codelineno-40-16 name=__codelineno-40-16 href=#__codelineno-40-16></a>VM { stack: [2], pc: 2, op_cnt: 5, trace: true, watermark: 2 }
<a id=__codelineno-40-17 name=__codelineno-40-17 href=#__codelineno-40-17></a>Executing op 0x02
<a id=__codelineno-40-18 name=__codelineno-40-18 href=#__codelineno-40-18></a>VM { stack: [2, 1], pc: 4, op_cnt: 6, trace: true, watermark: 2 }
<a id=__codelineno-40-19 name=__codelineno-40-19 href=#__codelineno-40-19></a>Executing op 0x11
<a id=__codelineno-40-20 name=__codelineno-40-20 href=#__codelineno-40-20></a>VM { stack: [1], pc: 5, op_cnt: 7, trace: true, watermark: 2 }
<a id=__codelineno-40-21 name=__codelineno-40-21 href=#__codelineno-40-21></a>Executing op 0x03
<a id=__codelineno-40-22 name=__codelineno-40-22 href=#__codelineno-40-22></a>VM { stack: [1, 1], pc: 6, op_cnt: 8, trace: true, watermark: 2 }
<a id=__codelineno-40-23 name=__codelineno-40-23 href=#__codelineno-40-23></a>Executing op 0x25
<a id=__codelineno-40-24 name=__codelineno-40-24 href=#__codelineno-40-24></a>  Jump from 9 by -7
<a id=__codelineno-40-25 name=__codelineno-40-25 href=#__codelineno-40-25></a>VM { stack: [1], pc: 2, op_cnt: 9, trace: true, watermark: 2 }
<a id=__codelineno-40-26 name=__codelineno-40-26 href=#__codelineno-40-26></a>Executing op 0x02
<a id=__codelineno-40-27 name=__codelineno-40-27 href=#__codelineno-40-27></a>VM { stack: [1, 1], pc: 4, op_cnt: 10, trace: true, watermark: 2 }
<a id=__codelineno-40-28 name=__codelineno-40-28 href=#__codelineno-40-28></a>Executing op 0x11
<a id=__codelineno-40-29 name=__codelineno-40-29 href=#__codelineno-40-29></a>VM { stack: [0], pc: 5, op_cnt: 11, trace: true, watermark: 2 }
<a id=__codelineno-40-30 name=__codelineno-40-30 href=#__codelineno-40-30></a>Executing op 0x03
<a id=__codelineno-40-31 name=__codelineno-40-31 href=#__codelineno-40-31></a>VM { stack: [0, 0], pc: 6, op_cnt: 12, trace: true, watermark: 2 }
<a id=__codelineno-40-32 name=__codelineno-40-32 href=#__codelineno-40-32></a>Executing op 0x25
<a id=__codelineno-40-33 name=__codelineno-40-33 href=#__codelineno-40-33></a>VM { stack: [0], pc: 9, op_cnt: 13, trace: true, watermark: 2 }
<a id=__codelineno-40-34 name=__codelineno-40-34 href=#__codelineno-40-34></a>Executing op 0x01
<a id=__codelineno-40-35 name=__codelineno-40-35 href=#__codelineno-40-35></a>VM { stack: [], pc: 10, op_cnt: 14, trace: true, watermark: 2 }
<a id=__codelineno-40-36 name=__codelineno-40-36 href=#__codelineno-40-36></a>Terminated!
<a id=__codelineno-40-37 name=__codelineno-40-37 href=#__codelineno-40-37></a>VM { stack: [], pc: 11, op_cnt: 15, trace: true, watermark: 2 }
<a id=__codelineno-40-38 name=__codelineno-40-38 href=#__codelineno-40-38></a>Terminated.
<a id=__codelineno-40-39 name=__codelineno-40-39 href=#__codelineno-40-39></a>Runtime=100.972碌s
<a id=__codelineno-40-40 name=__codelineno-40-40 href=#__codelineno-40-40></a>op_cnt=15, pc=11, stack-depth=0, watermark=2
</code></pre></div> <p>Nice! This is basically a for-loop. Granted, it does not do anything but loop, but you can see how the program counts down from <code>3</code> to <code>0</code> and after the third time it reaches line 8, it stops jumping back to <code>loop:</code> and advances to the end.</p> <p>We can increase the number in line 3, and the number of runs increase with it. If we change it to <code>200</code>, we get this (I ditched the <code>--trace</code> for this).</p> <div class=highlight><pre><span></span><code><a id=__codelineno-41-1 name=__codelineno-41-1 href=#__codelineno-41-1></a>kratenko@jotun:~/git/lovem$ cargo run --bin lovas -- -r pgm/loop.lva --print
<a id=__codelineno-41-2 name=__codelineno-41-2 href=#__codelineno-41-2></a>    Finished dev [unoptimized + debuginfo] target(s) in 0.02s
<a id=__codelineno-41-3 name=__codelineno-41-3 href=#__codelineno-41-3></a>     Running `target/debug/lovas -r pgm/loop.lva --print`
<a id=__codelineno-41-4 name=__codelineno-41-4 href=#__codelineno-41-4></a>Pgm { name: &quot;pgm/loop.lva&quot;, text: [2, 200, 2, 1, 17, 3, 37, 255, 249, 1, 255] }
<a id=__codelineno-41-5 name=__codelineno-41-5 href=#__codelineno-41-5></a>Terminated.
<a id=__codelineno-41-6 name=__codelineno-41-6 href=#__codelineno-41-6></a>Runtime=128.709碌s
<a id=__codelineno-41-7 name=__codelineno-41-7 href=#__codelineno-41-7></a>op_cnt=803, pc=11, stack-depth=0, watermark=2
</code></pre></div> <p>More than 800 operations with only 10 lines of code. Shall we cranc it up to a million?</p> <div class=highlight><pre><span></span><code><a id=__codelineno-42-1 name=__codelineno-42-1 href=#__codelineno-42-1></a>kratenko@jotun:~/git/lovem$ cargo run --bin lovas -- -r pgm/loop.lva --print
<a id=__codelineno-42-2 name=__codelineno-42-2 href=#__codelineno-42-2></a>    Finished dev [unoptimized + debuginfo] target(s) in 0.02s
<a id=__codelineno-42-3 name=__codelineno-42-3 href=#__codelineno-42-3></a>     Running `target/debug/lovas -r pgm/loop.lva --print`
<a id=__codelineno-42-4 name=__codelineno-42-4 href=#__codelineno-42-4></a>Pgm { name: &quot;pgm/loop.lva&quot;, text: [2, 100, 2, 100, 18, 2, 100, 18, 2, 1, 17, 3, 37, 255, 249, 1, 255] }
<a id=__codelineno-42-5 name=__codelineno-42-5 href=#__codelineno-42-5></a>Terminated.
<a id=__codelineno-42-6 name=__codelineno-42-6 href=#__codelineno-42-6></a>Runtime=564.184652ms
<a id=__codelineno-42-7 name=__codelineno-42-7 href=#__codelineno-42-7></a>op_cnt=4000007, pc=17, stack-depth=0, watermark=2
</code></pre></div> <p>Takes about have a second to execute, over 4000000 operations where executed. And the stack never held more than 2 values, as you can see by the watermark. We are programming!</p> <h3 id=homework_1>Homework<a class=headerlink href=#homework_1 title="Permanent link">&para;</a></h3> <p>Wait a second! Our only way of getting values on the stack is <code>push_u8</code>. That can only push a <code>u8</code>, so only values <code>0</code> - <code>255</code>. How did I push that <code>1000000</code> there?</p> </article> </div> </div> <a href=# class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg> Back to top </a> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../2024-02/ALL.html class="md-footer__link md-footer__link--prev" aria-label="Previous: February 2024 complete" rel=prev> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </div> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Previous </span> February 2024 complete </div> </div> </a> <a href=../2022-07/ALL.html class="md-footer__link md-footer__link--next" aria-label="Next: July 2022 complete" rel=next> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Next </span> July 2022 complete </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-social> <a href=https://github.com/kratenko target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg> </a> <a href=https://chaos.social/@kratenko target=_blank rel=noopener title=chaos.social class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48 0 0 0-63.72 28.5-63.72 125.7 0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54 0 0 1-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "..", "features": ["navigation.indexes", "navigation.sections", "navigation.top", "navigation.tracking", "navigation.expand"], "search": "../assets/javascripts/workers/search.16e2a7d4.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script> <script src=../assets/javascripts/bundle.5a2dcb6a.min.js></script> </body> </html>