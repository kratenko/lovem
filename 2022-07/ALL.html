<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Lovem & ndash; the low overhead virtual embedded machine. And the journey getting there."><meta name=author content=kratenko><link rel=canonical href=https://kratenko.github.io/lovem/2022-07/ALL.html><link rel=icon href=../assets/images/favicon.png><meta name=generator content="mkdocs-1.5.3, mkdocs-material-8.5.10"><title>July 2022 complete - Lovem</title><link rel=stylesheet href=../assets/stylesheets/main.975780f9.min.css><link rel=stylesheet href=../assets/stylesheets/palette.2505c338.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../stylesheets/custom.css><script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=None data-md-color-accent=None> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#complete-month-of-july-2022 class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../index.html title=Lovem class="md-header__button md-logo" aria-label=Lovem data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Lovem </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> July 2022 complete </span> </div> </div> </div> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/kratenko/lovem title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> kratenko/lovem </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../index.html title=Lovem class="md-nav__button md-logo" aria-label=Lovem data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg> </a> Lovem </label> <div class=md-nav__source> <a href=https://github.com/kratenko/lovem title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> kratenko/lovem </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../index.html class=md-nav__link> The Journey </a> </li> <li class=md-nav__item> <a href=../source-code.html class=md-nav__link> Source Code </a> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle=__nav_3 type=checkbox id=__nav_3 checked> <div class="md-nav__link md-nav__link--index "> <a href=../journal/index.html>Journal</a> <label for=__nav_3> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav aria-label=Journal data-md-level=1> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Journal </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle=__nav_3_2 type=checkbox id=__nav_3_2 checked> <div class="md-nav__link md-nav__link--index "> <a href=../2024-02/index.html>February 2024</a> <label for=__nav_3_2> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav aria-label="February 2024" data-md-level=2> <label class=md-nav__title for=__nav_3_2> <span class="md-nav__icon md-icon"></span> February 2024 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../2024-02/we-have-variables.html class=md-nav__link> We have variables! </a> </li> <li class=md-nav__item> <a href=../2024-02/stop-right-there-that-s-far-enough.html class=md-nav__link> Stop right there, that's far enough! </a> </li> <li class=md-nav__item> <a href=../2024-02/it-has-been-a-while.html class=md-nav__link> It has been a while... </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle=__nav_3_3 type=checkbox id=__nav_3_3 checked> <div class="md-nav__link md-nav__link--index "> <a href=../2022-08/index.html>August 2022</a> <label for=__nav_3_3> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav aria-label="August 2022" data-md-level=2> <label class=md-nav__title for=__nav_3_3> <span class="md-nav__icon md-icon"></span> August 2022 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../2022-08/what-if.html class=md-nav__link> What if? </a> </li> <li class=md-nav__item> <a href=../2022-08/you-labeled-me-i-ll-label-you.html class=md-nav__link> You labeled me, I'll label you </a> </li> <li class=md-nav__item> <a href=../2022-08/running-assembler-programs.html class=md-nav__link> Running assembler programs </a> </li> <li class=md-nav__item> <a href=../2022-08/assembling-bytes.html class=md-nav__link> Assembling bytes </a> </li> <li class=md-nav__item> <a href=../2022-08/handling-instructions.html class=md-nav__link> Handling instructions </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle=__nav_3_4 type=checkbox id=__nav_3_4 checked> <div class="md-nav__link md-nav__link--index "> <a href=index.html>July 2022</a> <label for=__nav_3_4> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav aria-label="July 2022" data-md-level=2> <label class=md-nav__title for=__nav_3_4> <span class="md-nav__icon md-icon"></span> July 2022 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=parsing-the-source.html class=md-nav__link> Parsing the source </a> </li> <li class=md-nav__item> <a href=assemble.html class=md-nav__link> Assemble! </a> </li> <li class=md-nav__item> <a href=don-t-byte-me.html class=md-nav__link> Don't byte me! </a> </li> <li class=md-nav__item> <a href=go-ahead-and-jump.html class=md-nav__link> Go ahead and jump! </a> </li> <li class=md-nav__item> <a href=reverse-polish-notation.html class=md-nav__link> Reverse polish notation </a> </li> <li class=md-nav__item> <a href=more-operations.html class=md-nav__link> More operations </a> </li> <li class=md-nav__item> <a href=early-vm-decisions.html class=md-nav__link> Early VM decisions </a> </li> <li class=md-nav__item> <a href=to-the-library.html class=md-nav__link> To the library! </a> </li> <li class=md-nav__item> <a href=becoming-social.html class=md-nav__link> Becoming social </a> </li> <li class=md-nav__item> <a href=turn-fragile-into-rusty.html class=md-nav__link> Turn "fragile" into "rusty" </a> </li> <li class=md-nav__item> <a href=running-our-first-program.html class=md-nav__link> Running our first program </a> </li> <li class=md-nav__item> <a href=a-vm.html class=md-nav__link> A VM </a> </li> <li class=md-nav__item> <a href=it-looks-so-weird.html class=md-nav__link> It looks so weird </a> </li> <li class=md-nav__item> <a href=let-there-be-source-code.html class=md-nav__link> Let there be source code </a> </li> <li class=md-nav__item> <a href=making-virtual-a-reality.html class=md-nav__link> Making virtual a reality </a> </li> <li class=md-nav__item> <a href=what-is-a-virtual-machine-anyway.html class=md-nav__link> What is a Virtual Machine anyway? </a> </li> <li class=md-nav__item> <a href=all-new-once-more.html class=md-nav__link> All new once more </a> </li> <li class=md-nav__item> <a href=state-of-the-journal.html class=md-nav__link> State of the Journal </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle=__nav_3_5 type=checkbox id=__nav_3_5 checked> <div class="md-nav__link md-nav__link--index "> <a href=../2022-06/index.html>June 2022</a> <label for=__nav_3_5> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav aria-label="June 2022" data-md-level=2> <label class=md-nav__title for=__nav_3_5> <span class="md-nav__icon md-icon"></span> June 2022 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../2022-06/script-or-virtual.html class=md-nav__link> Script or virtual </a> </li> <li class=md-nav__item> <a href=../2022-06/that-use-case.html class=md-nav__link> That use-case I was talking about </a> </li> <li class=md-nav__item> <a href=../2022-06/we-need-another-wheel.html class=md-nav__link> We need another wheel </a> </li> <li class=md-nav__item> <a href=../2022-06/lovem-again.html class=md-nav__link> Lovem again! </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_4 type=checkbox id=__nav_4 checked> <label class=md-nav__link for=__nav_4> Journal (complete months) <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Journal (complete months)" data-md-level=1> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Journal (complete months) </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../2024-02/ALL.html class=md-nav__link> February 2024 complete </a> </li> <li class=md-nav__item> <a href=../2022-08/ALL.html class=md-nav__link> August 2022 complete </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> July 2022 complete <span class="md-nav__icon md-icon"></span> </label> <a href=ALL.html class="md-nav__link md-nav__link--active"> July 2022 complete </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#state-of-the-journal class=md-nav__link> State of the Journal </a> <nav class=md-nav aria-label="State of the Journal"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#what-i-want class=md-nav__link> What I want </a> </li> <li class=md-nav__item> <a href=#how-it-works class=md-nav__link> How it works </a> </li> <li class=md-nav__item> <a href=#the-script class=md-nav__link> The script </a> </li> <li class=md-nav__item> <a href=#todos class=md-nav__link> TODOs </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#all-new-once-more class=md-nav__link> All new once more </a> </li> <li class=md-nav__item> <a href=#what-is-a-virtual-machine-anyway class=md-nav__link> What is a Virtual Machine anyway? </a> <nav class=md-nav aria-label="What is a Virtual Machine anyway?"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#register-machines class=md-nav__link> Register Machines </a> </li> <li class=md-nav__item> <a href=#stack-machines class=md-nav__link> Stack Machines </a> </li> <li class=md-nav__item> <a href=#some-random-thought-on-register-and-stack-machines class=md-nav__link> Some random thought on register and stack machines </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#making-virtual-a-reality class=md-nav__link> Making virtual a reality </a> <nav class=md-nav aria-label="Making virtual a reality"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#registers class=md-nav__link> Registers? </a> </li> <li class=md-nav__item> <a href=#stacks class=md-nav__link> Stacks! </a> </li> <li class=md-nav__item> <a href=#onwards class=md-nav__link> Onwards </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#let-there-be-source-code class=md-nav__link> Let there be source code </a> <nav class=md-nav aria-label="Let there be source code"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#but-where-is-the-code class=md-nav__link> But where is the code? </a> </li> <li class=md-nav__item> <a href=#back-in-time class=md-nav__link> Back in time </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#it-looks-so-weird class=md-nav__link> It looks so weird </a> <nav class=md-nav aria-label="It looks so weird"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#once-again-but-why class=md-nav__link> Once again: but why? </a> </li> <li class=md-nav__item> <a href=#didnt-you-say-you-use-cc class=md-nav__link> Didn't you say, you use C/C++? </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#a-vm class=md-nav__link> A VM </a> <nav class=md-nav aria-label="A VM"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#i-swear-if-i-do-not-see-some-code-in-this-post class=md-nav__link> I swear, if I do not see some code in this post... </a> </li> <li class=md-nav__item> <a href=#behaviour-for-our-vm class=md-nav__link> Behaviour for our VM </a> </li> <li class=md-nav__item> <a href=#how-do-i-work-with-the-code class=md-nav__link> How do I work with the code? </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#running-our-first-program class=md-nav__link> Running our first program </a> <nav class=md-nav aria-label="Running our first program"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#lets-go class=md-nav__link> Let's go! </a> </li> <li class=md-nav__item> <a href=#what-just-happened class=md-nav__link> What just happened? </a> </li> <li class=md-nav__item> <a href=#success class=md-nav__link> Success! </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#turn-fragile-into-rusty class=md-nav__link> Turn "fragile" into "rusty" </a> <nav class=md-nav aria-label="Turn " fragile&quot; into &quot;rusty&quot;&quot;> <ul class=md-nav__list> <li class=md-nav__item> <a href=#it-is-all-in-the-enums class=md-nav__link> It is all in the enums </a> </li> <li class=md-nav__item> <a href=#homework class=md-nav__link> Homework </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#becoming-social class=md-nav__link> Becoming social </a> </li> <li class=md-nav__item> <a href=#to-the-library class=md-nav__link> To the library! </a> <nav class=md-nav aria-label="To the library!"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#no-main class=md-nav__link> No main? </a> </li> <li class=md-nav__item> <a href=#project-layout class=md-nav__link> Project layout </a> <nav class=md-nav aria-label="Project layout"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#cargotoml class=md-nav__link> Cargo.toml </a> </li> <li class=md-nav__item> <a href=#librs class=md-nav__link> lib.rs </a> </li> <li class=md-nav__item> <a href=#oprs class=md-nav__link> op.rs </a> </li> <li class=md-nav__item> <a href=#vmrs class=md-nav__link> vm.rs </a> </li> <li class=md-nav__item> <a href=#bintest-runrs class=md-nav__link> bin/test-run.rs </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#running-the-binary class=md-nav__link> Running the binary </a> </li> <li class=md-nav__item> <a href=#homework_1 class=md-nav__link> Homework </a> </li> <li class=md-nav__item> <a href=#source-code class=md-nav__link> Source code </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#early-vm-decisions class=md-nav__link> Early VM decisions </a> <nav class=md-nav aria-label="Early VM decisions"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#word-size class=md-nav__link> Word size </a> </li> <li class=md-nav__item> <a href=#opargs class=md-nav__link> Opargs </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#more-operations class=md-nav__link> More operations </a> <nav class=md-nav aria-label="More operations"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#arithmetics class=md-nav__link> Arithmetics </a> </li> <li class=md-nav__item> <a href=#the-order-of-things class=md-nav__link> The order of things </a> </li> <li class=md-nav__item> <a href=#blowing-up-the-school class=md-nav__link> Blowing up the school </a> </li> <li class=md-nav__item> <a href=#homework_2 class=md-nav__link> Homework </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#reverse-polish-notation class=md-nav__link> Reverse polish notation </a> <nav class=md-nav aria-label="Reverse polish notation"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#porting-the-code-to-lovem class=md-nav__link> Porting the code to lovem </a> </li> <li class=md-nav__item> <a href=#execution class=md-nav__link> Execution </a> </li> <li class=md-nav__item> <a href=#homework_3 class=md-nav__link> Homework </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#go-ahead-and-jump class=md-nav__link> Go ahead and jump! </a> <nav class=md-nav aria-label="Go ahead and jump!"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#a-new-opcode class=md-nav__link> A new opcode </a> </li> <li class=md-nav__item> <a href=#fetch-more-than-a-byte class=md-nav__link> Fetch more than a byte </a> </li> <li class=md-nav__item> <a href=#goto class=md-nav__link> Goto </a> </li> <li class=md-nav__item> <a href=#safe-goto class=md-nav__link> Safe goto </a> </li> <li class=md-nav__item> <a href=#enter-the-loop class=md-nav__link> Enter the loop </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../2022-06/ALL.html class=md-nav__link> June 2022 complete </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#state-of-the-journal class=md-nav__link> State of the Journal </a> <nav class=md-nav aria-label="State of the Journal"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#what-i-want class=md-nav__link> What I want </a> </li> <li class=md-nav__item> <a href=#how-it-works class=md-nav__link> How it works </a> </li> <li class=md-nav__item> <a href=#the-script class=md-nav__link> The script </a> </li> <li class=md-nav__item> <a href=#todos class=md-nav__link> TODOs </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#all-new-once-more class=md-nav__link> All new once more </a> </li> <li class=md-nav__item> <a href=#what-is-a-virtual-machine-anyway class=md-nav__link> What is a Virtual Machine anyway? </a> <nav class=md-nav aria-label="What is a Virtual Machine anyway?"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#register-machines class=md-nav__link> Register Machines </a> </li> <li class=md-nav__item> <a href=#stack-machines class=md-nav__link> Stack Machines </a> </li> <li class=md-nav__item> <a href=#some-random-thought-on-register-and-stack-machines class=md-nav__link> Some random thought on register and stack machines </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#making-virtual-a-reality class=md-nav__link> Making virtual a reality </a> <nav class=md-nav aria-label="Making virtual a reality"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#registers class=md-nav__link> Registers? </a> </li> <li class=md-nav__item> <a href=#stacks class=md-nav__link> Stacks! </a> </li> <li class=md-nav__item> <a href=#onwards class=md-nav__link> Onwards </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#let-there-be-source-code class=md-nav__link> Let there be source code </a> <nav class=md-nav aria-label="Let there be source code"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#but-where-is-the-code class=md-nav__link> But where is the code? </a> </li> <li class=md-nav__item> <a href=#back-in-time class=md-nav__link> Back in time </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#it-looks-so-weird class=md-nav__link> It looks so weird </a> <nav class=md-nav aria-label="It looks so weird"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#once-again-but-why class=md-nav__link> Once again: but why? </a> </li> <li class=md-nav__item> <a href=#didnt-you-say-you-use-cc class=md-nav__link> Didn't you say, you use C/C++? </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#a-vm class=md-nav__link> A VM </a> <nav class=md-nav aria-label="A VM"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#i-swear-if-i-do-not-see-some-code-in-this-post class=md-nav__link> I swear, if I do not see some code in this post... </a> </li> <li class=md-nav__item> <a href=#behaviour-for-our-vm class=md-nav__link> Behaviour for our VM </a> </li> <li class=md-nav__item> <a href=#how-do-i-work-with-the-code class=md-nav__link> How do I work with the code? </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#running-our-first-program class=md-nav__link> Running our first program </a> <nav class=md-nav aria-label="Running our first program"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#lets-go class=md-nav__link> Let's go! </a> </li> <li class=md-nav__item> <a href=#what-just-happened class=md-nav__link> What just happened? </a> </li> <li class=md-nav__item> <a href=#success class=md-nav__link> Success! </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#turn-fragile-into-rusty class=md-nav__link> Turn "fragile" into "rusty" </a> <nav class=md-nav aria-label="Turn " fragile&quot; into &quot;rusty&quot;&quot;> <ul class=md-nav__list> <li class=md-nav__item> <a href=#it-is-all-in-the-enums class=md-nav__link> It is all in the enums </a> </li> <li class=md-nav__item> <a href=#homework class=md-nav__link> Homework </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#becoming-social class=md-nav__link> Becoming social </a> </li> <li class=md-nav__item> <a href=#to-the-library class=md-nav__link> To the library! </a> <nav class=md-nav aria-label="To the library!"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#no-main class=md-nav__link> No main? </a> </li> <li class=md-nav__item> <a href=#project-layout class=md-nav__link> Project layout </a> <nav class=md-nav aria-label="Project layout"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#cargotoml class=md-nav__link> Cargo.toml </a> </li> <li class=md-nav__item> <a href=#librs class=md-nav__link> lib.rs </a> </li> <li class=md-nav__item> <a href=#oprs class=md-nav__link> op.rs </a> </li> <li class=md-nav__item> <a href=#vmrs class=md-nav__link> vm.rs </a> </li> <li class=md-nav__item> <a href=#bintest-runrs class=md-nav__link> bin/test-run.rs </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#running-the-binary class=md-nav__link> Running the binary </a> </li> <li class=md-nav__item> <a href=#homework_1 class=md-nav__link> Homework </a> </li> <li class=md-nav__item> <a href=#source-code class=md-nav__link> Source code </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#early-vm-decisions class=md-nav__link> Early VM decisions </a> <nav class=md-nav aria-label="Early VM decisions"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#word-size class=md-nav__link> Word size </a> </li> <li class=md-nav__item> <a href=#opargs class=md-nav__link> Opargs </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#more-operations class=md-nav__link> More operations </a> <nav class=md-nav aria-label="More operations"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#arithmetics class=md-nav__link> Arithmetics </a> </li> <li class=md-nav__item> <a href=#the-order-of-things class=md-nav__link> The order of things </a> </li> <li class=md-nav__item> <a href=#blowing-up-the-school class=md-nav__link> Blowing up the school </a> </li> <li class=md-nav__item> <a href=#homework_2 class=md-nav__link> Homework </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#reverse-polish-notation class=md-nav__link> Reverse polish notation </a> <nav class=md-nav aria-label="Reverse polish notation"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#porting-the-code-to-lovem class=md-nav__link> Porting the code to lovem </a> </li> <li class=md-nav__item> <a href=#execution class=md-nav__link> Execution </a> </li> <li class=md-nav__item> <a href=#homework_3 class=md-nav__link> Homework </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#go-ahead-and-jump class=md-nav__link> Go ahead and jump! </a> <nav class=md-nav aria-label="Go ahead and jump!"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#a-new-opcode class=md-nav__link> A new opcode </a> </li> <li class=md-nav__item> <a href=#fetch-more-than-a-byte class=md-nav__link> Fetch more than a byte </a> </li> <li class=md-nav__item> <a href=#goto class=md-nav__link> Goto </a> </li> <li class=md-nav__item> <a href=#safe-goto class=md-nav__link> Safe goto </a> </li> <li class=md-nav__item> <a href=#enter-the-loop class=md-nav__link> Enter the loop </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=complete-month-of-july-2022>Complete month of July 2022<a class=headerlink href=#complete-month-of-july-2022 title="Permanent link">&para;</a></h1> <h2 id=state-of-the-journal>State of the Journal<a class=headerlink href=#state-of-the-journal title="Permanent link">&para;</a></h2> <p><strong>Since I am always focused on my work on lovem, I will never get sidetracked. Unrelated: I spent a few days on reworking the journal on this site.</strong></p> <aside class=mdx-author> <p><img alt=@kratenko src=https://avatars.githubusercontent.com/kratenko></p> <p><span><strong>kratenko</strong> · <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 16 16"><path fill-rule=evenodd d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"/></svg></span> <a href=https://github.com/kratenko>kratenko</a></span> <span> <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path fill-rule=evenodd d="M6.75 0a.75.75 0 0 1 .75.75V3h9V.75a.75.75 0 0 1 1.5 0V3h2.75c.966 0 1.75.784 1.75 1.75v16a1.75 1.75 0 0 1-1.75 1.75H3.25a1.75 1.75 0 0 1-1.75-1.75v-16C1.5 3.784 2.284 3 3.25 3H6V.75A.75.75 0 0 1 6.75 0zm-3.5 4.5a.25.25 0 0 0-.25.25V8h18V4.75a.25.25 0 0 0-.25-.25H3.25zM21 9.5H3v11.25c0 .138.112.25.25.25h17.5a.25.25 0 0 0 .25-.25V9.5z"/></svg></span> 2022-07-01 · <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path fill-rule=evenodd d="M0 3.75A.75.75 0 0 1 .75 3h7.497c1.566 0 2.945.8 3.751 2.014A4.496 4.496 0 0 1 15.75 3h7.5a.75.75 0 0 1 .75.75v15.063a.75.75 0 0 1-.755.75l-7.682-.052a3 3 0 0 0-2.142.878l-.89.891a.75.75 0 0 1-1.061 0l-.902-.901a3 3 0 0 0-2.121-.879H.75a.75.75 0 0 1-.75-.75v-15zm11.247 3.747a3 3 0 0 0-3-2.997H1.5V18h6.947a4.5 4.5 0 0 1 2.803.98l-.003-11.483zm1.503 11.485V7.5a3 3 0 0 1 3-3h6.75v13.558l-6.927-.047a4.5 4.5 0 0 0-2.823.971z"/></svg></span> Entry #5 · <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12.5 7.25a.75.75 0 0 0-1.5 0v5.5c0 .27.144.518.378.651l3.5 2a.75.75 0 0 0 .744-1.302L12.5 12.315V7.25z"/><path fill-rule=evenodd d="M12 1C5.925 1 1 5.925 1 12s4.925 11 11 11 11-4.925 11-11S18.075 1 12 1zM2.5 12a9.5 9.5 0 1 1 19 0 9.5 9.5 0 0 1-19 0z"/></svg></span> 3 min read </span></p> </aside> <hr> <p>So, no update on the core project today, sorry. I was very unhappy with my first solution, on how the Journal entries where created. Way too much to do by hand &ndash; that is <em>not</em> what I learned programming for. But <em>mkdocs</em> is python, and python I can do. So did. And now I can write my Journal entries (like this one) as plain Markdown files with very few metadata entries. And I get entries in the navigation and pages listing the whole month. I even included a <em>whole month in single page</em> version of the journal. I feel it is quite fancy. I will need to do a bit of work on the static content of the site, but one step at a time.</p> <h3 id=what-i-want>What I want<a class=headerlink href=#what-i-want title="Permanent link">&para;</a></h3> <p>I want to write my Journal entries (aka blog posts) as a nice standalone markdown file, one file per entry. I will need to add include a bit of metadata, at least the release date/time. And I want the entries to look fancy without adding the fanciness to each file. Maybe I will be changing the layout later, hmm? And create those teaser pages for me, thank you very much.</p> <p>And I have all that, now! Just look at the <a href=https://github.com/kratenko/lovem/blob/journey/journal/2022-07/05-state-of-the-journal.md>source that is used to generate this entry</a>.</p> <h3 id=how-it-works>How it works<a class=headerlink href=#how-it-works title="Permanent link">&para;</a></h3> <p>I use a plugin called <a href=https://oprypin.github.io/mkdocs-gen-files/ ><code>mkdocs-gen-files</code></a>, by <a class="magiclink magiclink-github magiclink-mention" href=https://github.com/oprypin title="GitHub User: oprypin">@oprypin</a>, that creates additional mkdocs source files on the fly. It does not really put the files on disk, but they are parsed by mkdocs, as if they were in the <code>docs</code> directory. </p> <p>I have a directory <code>journal</code> next to my <code>docs</code> directory, where I put all my posts in a single markdown file each. My script walks through that directory, and processes each file. The content is modified a bit (to put in the card with the author's name and other metadata), and then put in a virtual file inside <code>docs</code>, so that the pages with the entries are created by mkdocs, as if I hat them inside <code>docs</code>.</p> <p>The script also generates two pages for each month: one that shows that month's posts as teasers, with a "continue reading" link, and a second one that shows all posts from a month on a single page, so that you can read them without changing pages all the time.</p> <p>The remaining part is adding all the pages, that the script creates, to the navigation in a way that makes sense. The order is a critical part, being a central aspect of a journal or a log. For that I use another plugin by <a class="magiclink magiclink-github magiclink-mention" href=https://github.com/oprypin title="GitHub User: oprypin">@oprypin</a>: <a href=https://oprypin.github.io/mkdocs-literate-nav/ ><code>mkdocs-literate-nav</code></a>. With it, you can control your navigation (completely or in parts) by adding markdown source files with lists of links. This goes together well with the gen-files plugin, because I can just create that navigation files with it in my script.</p> <p>The plugins are a bit light on the documentation side. It took me a while to understand, that you cannot do multiple layers of nested navigation in those files. That is not a problem, because you can always just add another nesting layer by adding more of those nav files as children. Also, what you can do in those files is very limited. I wanted to do some fancy things in the navigation (adding a second link in a single line with alternative representation). I would guess that those limitations come from the ways mkdocs itself handles the navigation, so that is okay. But a word on that would have been nice. And the error messages popping up did not help at all, because the actual error happens way later in the process inside mkdocs itself and is some weird side effect problem.</p> <h3 id=the-script>The script<a class=headerlink href=#the-script title="Permanent link">&para;</a></h3> <p>If you want to take a look, see <a href=https://github.com/kratenko/lovem/blob/journey/blogem.py><code>blogem.py</code></a>. That will be the script in its current state. For the version of the script at the time of writing, see the permalink, <a href=https://github.com/kratenko/lovem/blob/2d6f5e4c5c95064e8ba2c0dd4468777df08b8e0c/blogem.py>the original <code>blogem.py</code></a>.</p> <h3 id=todos>TODOs<a class=headerlink href=#todos title="Permanent link">&para;</a></h3> <ul> <li><del>Automated reload in <code>mkdocs serve</code> when I edit entry sources.</del> <br> <em>just add parameter <code>-w journal</code> to <code>mkdocs serve</code></em></li> <li>Exclude journal overview and full month pages from search.</li> <li>Exclude <code>NAV.md</code> from generating <code>NAV.html</code>.</li> <li>Maybe add tags and/or categories for posts?</li> <li>Maybe enable comments, as in material's blog.</li> <li>Add links to source in github repo.</li> <li>Add links to entry's history in github repo.</li> <li>Support multiple posts per day (by adding time to "released").</li> </ul> <h2 id=all-new-once-more>All new once more<a class=headerlink href=#all-new-once-more title="Permanent link">&para;</a></h2> <p><strong>Reality strikes again, and code will be written from scratch once more. And the reason is this site.</strong></p> <aside class=mdx-author> <p><img alt=@kratenko src=https://avatars.githubusercontent.com/kratenko></p> <p><span><strong>kratenko</strong> · <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 16 16"><path fill-rule=evenodd d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"/></svg></span> <a href=https://github.com/kratenko>kratenko</a></span> <span> <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path fill-rule=evenodd d="M6.75 0a.75.75 0 0 1 .75.75V3h9V.75a.75.75 0 0 1 1.5 0V3h2.75c.966 0 1.75.784 1.75 1.75v16a1.75 1.75 0 0 1-1.75 1.75H3.25a1.75 1.75 0 0 1-1.75-1.75v-16C1.5 3.784 2.284 3 3.25 3H6V.75A.75.75 0 0 1 6.75 0zm-3.5 4.5a.25.25 0 0 0-.25.25V8h18V4.75a.25.25 0 0 0-.25-.25H3.25zM21 9.5H3v11.25c0 .138.112.25.25.25h17.5a.25.25 0 0 0 .25-.25V9.5z"/></svg></span> 2022-07-03 · <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path fill-rule=evenodd d="M0 3.75A.75.75 0 0 1 .75 3h7.497c1.566 0 2.945.8 3.751 2.014A4.496 4.496 0 0 1 15.75 3h7.5a.75.75 0 0 1 .75.75v15.063a.75.75 0 0 1-.755.75l-7.682-.052a3 3 0 0 0-2.142.878l-.89.891a.75.75 0 0 1-1.061 0l-.902-.901a3 3 0 0 0-2.121-.879H.75a.75.75 0 0 1-.75-.75v-15zm11.247 3.747a3 3 0 0 0-3-2.997H1.5V18h6.947a4.5 4.5 0 0 1 2.803.98l-.003-11.483zm1.503 11.485V7.5a3 3 0 0 1 3-3h6.75v13.558l-6.927-.047a4.5 4.5 0 0 0-2.823.971z"/></svg></span> Entry #6 · <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12.5 7.25a.75.75 0 0 0-1.5 0v5.5c0 .27.144.518.378.651l3.5 2a.75.75 0 0 0 .744-1.302L12.5 12.315V7.25z"/><path fill-rule=evenodd d="M12 1C5.925 1 1 5.925 1 12s4.925 11 11 11 11-4.925 11-11S18.075 1 12 1zM2.5 12a9.5 9.5 0 1 1 19 0 9.5 9.5 0 0 1-19 0z"/></svg></span> &lt; 1 min read </span></p> </aside> <hr> <p>You want me to get to the code. And I really should. I have written so much already, and I want to show it, but there is so much around it. And after I had written up a long text on how I started, I realised that I had no commits during the early state. So I had to write it all again, slower, and with code to be presentable in this journal.</p> <p>If you are reading this live (and no-one is, because I did not even tell anyone I am doing this), you can of course look at the code I was writing earlier, it exists. I put it in a branch <a href=https://github.com/kratenko/lovem/tree/too-early><code>too-early</code></a>. But I will not give explanations to that. I am rewriting it on the master branch, and that will be showed and discussed in the journal. I advise you to wait for that.</p> <p>Yes, it will take a while. As it looks now, it will be slow. But I have written some new posts on the new code already, and I think it is worth it. There will be more background before we get there. Next entry will be a longer one, so there is that.</p> <h2 id=what-is-a-virtual-machine-anyway>What is a Virtual Machine anyway?<a class=headerlink href=#what-is-a-virtual-machine-anyway title="Permanent link">&para;</a></h2> <aside class=mdx-author> <p><img alt=@kratenko src=https://avatars.githubusercontent.com/kratenko></p> <p><span><strong>kratenko</strong> · <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 16 16"><path fill-rule=evenodd d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"/></svg></span> <a href=https://github.com/kratenko>kratenko</a></span> <span> <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path fill-rule=evenodd d="M6.75 0a.75.75 0 0 1 .75.75V3h9V.75a.75.75 0 0 1 1.5 0V3h2.75c.966 0 1.75.784 1.75 1.75v16a1.75 1.75 0 0 1-1.75 1.75H3.25a1.75 1.75 0 0 1-1.75-1.75v-16C1.5 3.784 2.284 3 3.25 3H6V.75A.75.75 0 0 1 6.75 0zm-3.5 4.5a.25.25 0 0 0-.25.25V8h18V4.75a.25.25 0 0 0-.25-.25H3.25zM21 9.5H3v11.25c0 .138.112.25.25.25h17.5a.25.25 0 0 0 .25-.25V9.5z"/></svg></span> 2022-07-04 · <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path fill-rule=evenodd d="M0 3.75A.75.75 0 0 1 .75 3h7.497c1.566 0 2.945.8 3.751 2.014A4.496 4.496 0 0 1 15.75 3h7.5a.75.75 0 0 1 .75.75v15.063a.75.75 0 0 1-.755.75l-7.682-.052a3 3 0 0 0-2.142.878l-.89.891a.75.75 0 0 1-1.061 0l-.902-.901a3 3 0 0 0-2.121-.879H.75a.75.75 0 0 1-.75-.75v-15zm11.247 3.747a3 3 0 0 0-3-2.997H1.5V18h6.947a4.5 4.5 0 0 1 2.803.98l-.003-11.483zm1.503 11.485V7.5a3 3 0 0 1 3-3h6.75v13.558l-6.927-.047a4.5 4.5 0 0 0-2.823.971z"/></svg></span> Entry #7 · <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12.5 7.25a.75.75 0 0 0-1.5 0v5.5c0 .27.144.518.378.651l3.5 2a.75.75 0 0 0 .744-1.302L12.5 12.315V7.25z"/><path fill-rule=evenodd d="M12 1C5.925 1 1 5.925 1 12s4.925 11 11 11 11-4.925 11-11S18.075 1 12 1zM2.5 12a9.5 9.5 0 1 1 19 0 9.5 9.5 0 0 1-19 0z"/></svg></span> 5 min read </span></p> </aside> <hr> <p>So, how do you build a Virtual Machine. There are actually two quite different approaches:</p> <ul> <li><em>Register Machine</em> vs. <em>Stack Machine</em></li> </ul> <p>Let's take a look at those concepts first. This will be very brief and basic. You can, of course, also have some combination of those concepts, and not everything I say here is true for every implementation of virtual machine, but it will be close enough for this article.</p> <h3 id=register-machines>Register Machines<a class=headerlink href=#register-machines title="Permanent link">&para;</a></h3> <p>Most physical computers are register machines. At least those you will be thinking of. You are most likely using one right now to read this article. Virtual register machines use the same concepts, but not in physical hardware, instead inside another computer as software. This allows them to do some things a bit more flexible than a real hardware machine would.</p> <p>A <em>register</em> is nothing more than a dedicated place to store a portion of data where it can be accessed for direct manipulation. They are more or less a variable of the machine's basic data type that have a fixed address, and that can be accessed and manipulated directly by the processing unit. <em>Register machines</em> use those to actually compute and change data. All other storage places are only that: places where data is put when it is not needed at the moment. Register machines have a multitude of registers, from a very few (maybe 4 or 8 in simplistic designs) to hundreds or more in modern computers. The size of the registers often gives the architecture its name. E.g. in the x86-x64 architecture, that most current CPUs by Intel and AMD are of, a register is 64 bits long.</p> <p>The instructions for a register machine are encoded in <em>code words</em>. A code word is a bunch of bytes that tell the machine what to do in the next program step. For simple designs, code words are of a fixed length. This code word length is often longer than the register size. So a 16 bit architecture could have 32 bit instructions. The reason for this is, that instructions consist of an operation code that defines what operation should be executed in the next step, but they also contain the arguments passed to that operation. Because the number and size of arguments needed for an operation differ for different operations, decoding the instruction can be quite complicated. When you put multiple instructions together, you end up with a program. This representation of a computer program is called <em>machine code</em>. For a virtual machine it is also called <em>bytecode</em>, although I think this term fits better for stack machines (more on that later).</p> <p>If you want to understand what I tried to describe here, read this really short article: <a href=https://en.wikibooks.org/wiki/Creating%5fa%5fVirtual%5fMachine/Register%5fVM%5fin%5fC>Creating a Virtual Machine/Register VM in C</a>. It builds a simplistic register VM in C (the whole thing is 87 lines long). It demonstrates the principles used in a register machine (fetch, decode, execute), and shows you what a <em>register</em> is and how it is used. You will understand, how machine code is decoded and executed. The article only uses 16 bit code words and 16 bit data words (register size). If you know C, you should be able to understand what I am talking about in about an hour of reading and coding. If you ever wanted to understand how a computer works on the inside, this might be a nice place to start, before you read about an actual physical computer. </p> <p>A register machine normally has multiple stacks it uses. This does not make it a stack machine, those are just needed to store data when it is not currently used.</p> <p>So a typical operations would be: * "Take the number from register 0, take the number from register 1, add those two numbers together, write the result in register 0." * "Take the lower 16 bits of this instruction and write them in register 2."</p> <p>Lua and Neko are virtual register machines (at least in current versions).</p> <h3 id=stack-machines>Stack Machines<a class=headerlink href=#stack-machines title="Permanent link">&para;</a></h3> <p>And then there are <em>Stack Machines</em>. They are, I think, easier to understand than register machines, but following a program during execution is more confusing, since the manipulated data is more complicated to follow.</p> <p>A <em>stack</em> is just a pile of data. Data is portioned in fixed sizes, a portion is called a word. All you can normally do is put a word on top of the stack - we will call that operation a <em>push</em>, or you can take the word that is currently on top of the stack (if there is one) - we will call that a <em>pop</em>. No other direct manipulations of the stack are allowed (I say "direct manipulations", because indirectly there often are ways that this is done, but that is a detail for later). </p> <p>Manipulation of data is done this way by the machine. If you want to add two numbers, say 5 and 23, you would write a program that does this: </p> <ol> <li>Push the first number to the stack.</li> <li>Push the second number to the stack.</li> <li>Execute the "ADD" operation.</li> </ol> <p>That operation will pop the two numbers from the stack, add them, and push their sum back on the stack (so that after the operation there will be one word less on the stack).</p> <p>A stack machine will also typically have some additional place to store words when you do not need them on the stack. These places can relate to variables inside a program.</p> <p>As you can see from the example above, instructions in a stack machine often do not need to have arguments. If data is to be manipulated, it is always on top of the stack. There is no need to address its location, as you would do in a register machine. </p> <p>Because of this, the instructions for a stack machine are typically encoded in a single byte. This byte holds a number we will call <em>opcode</em> (short for operation code), that simply identifies the operation to execute. If your operation does need additional arguments, you write them to the bytes following your opcode byte (the <em>oparg</em>), so that the operation can read them from your program. This structure of single bytes encoding our program is why we call this representation <em>bytecode</em>.</p> <p>The concept of a stack machine is easy to implement in software, but it is not so easy to do so in hardware. That is why your typical computer is a register machine. There are, however, a lot of historical examples of important physical stack machines.</p> <p>The most famous example of a virtual stack machine is the <em>Java VM</em>. Java source code is compiled to bytecode that is executed inside a virtual machine, the JVM. This vm is so common, that many newer programming languages compile to Java bytecode. It makes it possible to run programs written in that languages on any system that has a JVM; and that includes just about every major and many minor computer systems. A second example for a stack machine is the Python VM.</p> <h3 id=some-random-thought-on-register-and-stack-machines>Some random thought on register and stack machines<a class=headerlink href=#some-random-thought-on-register-and-stack-machines title="Permanent link">&para;</a></h3> <p>While writing this down, describing the two kinds of machines I couldn't help but notice a curious fact:</p> <p>A register machine manipulates data inside addressable registers. When the data is not need, it can be stored away in some kind of stack.</p> <p>A stack machine manipulates data inside a stack. When the data is not needed, it can be stored away in some kind of addressable spaces, not unlike registers.</p> <p>It looks as if you just need both concepts to work efficiently.</p> <h2 id=making-virtual-a-reality>Making virtual a reality<a class=headerlink href=#making-virtual-a-reality title="Permanent link">&para;</a></h2> <p><strong>So I have been talking a lot about VMs without doing anything concrete. Well that is not true, I have done quite a bit already, but I am still describing earlier steps. We will get there.</strong></p> <aside class=mdx-author> <p><img alt=@kratenko src=https://avatars.githubusercontent.com/kratenko></p> <p><span><strong>kratenko</strong> · <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 16 16"><path fill-rule=evenodd d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"/></svg></span> <a href=https://github.com/kratenko>kratenko</a></span> <span> <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path fill-rule=evenodd d="M6.75 0a.75.75 0 0 1 .75.75V3h9V.75a.75.75 0 0 1 1.5 0V3h2.75c.966 0 1.75.784 1.75 1.75v16a1.75 1.75 0 0 1-1.75 1.75H3.25a1.75 1.75 0 0 1-1.75-1.75v-16C1.5 3.784 2.284 3 3.25 3H6V.75A.75.75 0 0 1 6.75 0zm-3.5 4.5a.25.25 0 0 0-.25.25V8h18V4.75a.25.25 0 0 0-.25-.25H3.25zM21 9.5H3v11.25c0 .138.112.25.25.25h17.5a.25.25 0 0 0 .25-.25V9.5z"/></svg></span> 2022-07-06 · <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path fill-rule=evenodd d="M0 3.75A.75.75 0 0 1 .75 3h7.497c1.566 0 2.945.8 3.751 2.014A4.496 4.496 0 0 1 15.75 3h7.5a.75.75 0 0 1 .75.75v15.063a.75.75 0 0 1-.755.75l-7.682-.052a3 3 0 0 0-2.142.878l-.89.891a.75.75 0 0 1-1.061 0l-.902-.901a3 3 0 0 0-2.121-.879H.75a.75.75 0 0 1-.75-.75v-15zm11.247 3.747a3 3 0 0 0-3-2.997H1.5V18h6.947a4.5 4.5 0 0 1 2.803.98l-.003-11.483zm1.503 11.485V7.5a3 3 0 0 1 3-3h6.75v13.558l-6.927-.047a4.5 4.5 0 0 0-2.823.971z"/></svg></span> Entry #8 · <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12.5 7.25a.75.75 0 0 0-1.5 0v5.5c0 .27.144.518.378.651l3.5 2a.75.75 0 0 0 .744-1.302L12.5 12.315V7.25z"/><path fill-rule=evenodd d="M12 1C5.925 1 1 5.925 1 12s4.925 11 11 11 11-4.925 11-11S18.075 1 12 1zM2.5 12a9.5 9.5 0 1 1 19 0 9.5 9.5 0 0 1-19 0z"/></svg></span> 3 min read </span></p> </aside> <hr> <h3 id=registers>Registers?<a class=headerlink href=#registers title="Permanent link">&para;</a></h3> <p>When I was looking around for a scripting language to use inside our embedded devices, I came across an article I mentioned in an earlier post: <a href=https://en.wikibooks.org/wiki/Creating%5fa%5fVirtual%5fMachine/Register%5fVM%5fin%5fC>Creating a Virtual Machine/Register VM in C</a>.</p> <p>Reading it made me want to try working with a register machine, mainly because I have not been stuff like this since my early semesters. Never hurts to refresh rusty knowledge.</p> <p>So I started designing a register VM, starting from that code, but more complex, with longer data words and longer instruction words, more registers, and so forth. For this project I came up with <em>lovem</em> as a working title. It still stuck to now, two approaches and a year later. I also started implementing some concepts I still want to add to lovem in my current approach, but that is for a later post to discuss.</p> <p>I was experimenting with a quite complicated instruction word encoding. I was trying to fit everything in a few bits (32 of them if I recall correctly) with varying instruction code length and quite long arguments. I wanted to include instructions on three registers, which takes up quite some bits to address. Of course, you can get away with two-register operations only - or if you are fancy you can even use a single address or even no address for most instructions. You will just end up with a lot of register swapping. I guess my rational for having three addresses in an instruction was code size. For what I want to do, 32 bit instruction words feel quite long (4 bytes per instruction!). And every swap would mean another 4 bytes of program size. So trying to optimise for fewer operations by having more flexible instructions. </p> <p>I do not even know if that rational makes sense. I guess I would have needed to try different layouts to find out. Or maybe read more about that topic, other people have done similar things I assume. But I never got that far. The experiment showed me, that I do not want to build lovem as a register machine. I think building a clever register based architecture for my goals would make it too complicated. I want simple. To reduce the VM's overhead, but also on principle. Complexity is the enemy.</p> <p>I'm pretty sure, that code still exists somewhere, but there is no sense in publishing it or even in me reading it again, so you will never see it. I think of it as a pre-study with a very useful conclusion: <em>not</em> a register machine.</p> <h3 id=stacks>Stacks!<a class=headerlink href=#stacks title="Permanent link">&para;</a></h3> <p>So a stack machine it is! I have looked at a few during my research for lovem, looking at instruction sets and design ideas. It is not the first time, I have been working with those. In a different project (around the same time I started work on the register based machine), I was starting to implement a stack machine. That one had a different aim and therefore very different challenges. It was more of an object-oriented approach with dynamic program loading and calling code in different programs. It could do quite a few things already, but it will never be continued. I learned a bit about calling conventions and found out that it is not so simple, when you want to switch between multiple programs and objects. That is where the project got too frustrating for me (and some external events made it obsolete, so that is okay). But I take it for a pre-study on stack machines and calling conventions. Not that I have developed a proven concept for it, but I know about the problems there...</p> <p>I had a PoC for lovem as a stack machine back then, too (right after I ditched the register approach). That code won't be published either, but the attempt showed me, that I want to take that road for a serious approach on creating lovem.</p> <h3 id=onwards>Onwards<a class=headerlink href=#onwards title="Permanent link">&para;</a></h3> <p>I guess this concludes the prehistory of the lovem story. I am, for whatever reason, back on the project, currently with a decent amount of motivation. You never know how long that lasts, but right now I like the idea of continuing the development, while talking about the development process, sharing my thoughts on decisions I make. Next post should start on sharing newer thoughts.</p> <h2 id=let-there-be-source-code>Let there be source code<a class=headerlink href=#let-there-be-source-code title="Permanent link">&para;</a></h2> <p><strong>Finally, I will be showing some source code. Not directly in the journal, but I will link you to GitHub, for a start.</strong></p> <aside class=mdx-author> <p><img alt=@kratenko src=https://avatars.githubusercontent.com/kratenko></p> <p><span><strong>kratenko</strong> · <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 16 16"><path fill-rule=evenodd d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"/></svg></span> <a href=https://github.com/kratenko>kratenko</a></span> <span> <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path fill-rule=evenodd d="M6.75 0a.75.75 0 0 1 .75.75V3h9V.75a.75.75 0 0 1 1.5 0V3h2.75c.966 0 1.75.784 1.75 1.75v16a1.75 1.75 0 0 1-1.75 1.75H3.25a1.75 1.75 0 0 1-1.75-1.75v-16C1.5 3.784 2.284 3 3.25 3H6V.75A.75.75 0 0 1 6.75 0zm-3.5 4.5a.25.25 0 0 0-.25.25V8h18V4.75a.25.25 0 0 0-.25-.25H3.25zM21 9.5H3v11.25c0 .138.112.25.25.25h17.5a.25.25 0 0 0 .25-.25V9.5z"/></svg></span> 2022-07-08 · <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path fill-rule=evenodd d="M0 3.75A.75.75 0 0 1 .75 3h7.497c1.566 0 2.945.8 3.751 2.014A4.496 4.496 0 0 1 15.75 3h7.5a.75.75 0 0 1 .75.75v15.063a.75.75 0 0 1-.755.75l-7.682-.052a3 3 0 0 0-2.142.878l-.89.891a.75.75 0 0 1-1.061 0l-.902-.901a3 3 0 0 0-2.121-.879H.75a.75.75 0 0 1-.75-.75v-15zm11.247 3.747a3 3 0 0 0-3-2.997H1.5V18h6.947a4.5 4.5 0 0 1 2.803.98l-.003-11.483zm1.503 11.485V7.5a3 3 0 0 1 3-3h6.75v13.558l-6.927-.047a4.5 4.5 0 0 0-2.823.971z"/></svg></span> Entry #9 · <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12.5 7.25a.75.75 0 0 0-1.5 0v5.5c0 .27.144.518.378.651l3.5 2a.75.75 0 0 0 .744-1.302L12.5 12.315V7.25z"/><path fill-rule=evenodd d="M12 1C5.925 1 1 5.925 1 12s4.925 11 11 11 11-4.925 11-11S18.075 1 12 1zM2.5 12a9.5 9.5 0 1 1 19 0 9.5 9.5 0 0 1-19 0z"/></svg></span> 2 min read </span></p> </aside> <hr> <p>I have written code. And this time, I (re-)started lovem in a public git repository, so you can see what I do, if you are interested. And I hope it puts enough pressure on me, to keep on the project for a while.</p> <p>In fact, there is quite a bit of code there already. I started coding, before writing any of this, and it went so well. I like how it feels. I was working any hour I could spare. When a friend asked me what I was doing, I started a somewhat complex backstory why I was doing it, instead of actually explaining anything of the stuff I was doing &ndash; and was interrupted quite early, so there was more to tell in me still. The next day, I sat down and started to write all of that down as a little story. I wanted to put it somewhere, so I started this journal to publish it. And I decided to do it in blog form, so I am publishing that background story bit by bit.</p> <p>So, as of writing this, there is a lot of work completed on the VM. Tt is amazing what things it can do for how little code there is. When this post goes public, there should be quite lot more done...</p> <h3 id=but-where-is-the-code>But where is the code?<a class=headerlink href=#but-where-is-the-code title="Permanent link">&para;</a></h3> <p>Well, if you read this journal, you will know where it lives. Anyway, this is the repo:</p> <p><a href=https://github.com/kratenko/lovem>https://github.com/kratenko/lovem</a></p> <p>I plan to continue sharing my thoughts while I work on the VM. So you will be able to follow my failures and see the attempts that I will be ditching later. I think the format of this journal can work out, but we will see how I like it over time. It will be behind on progress, as I want to take time to share things as they unfold. And this should help to produce a somewhat continuous publication stream. Git being what git is, should support me in showing you the things I do back in time, using the power of commits.</p> <p>As things are with blogs, my entries will be very different, depending on what I want to tell and on what I did. So far most blogs where conceptional thinking, some research, and a lot of blabla, which I tell because it interests me myself. In the future, there should be concrete problems I find and solve in source code - or which I fail to solve.</p> <h3 id=back-in-time>Back in time<a class=headerlink href=#back-in-time title="Permanent link">&para;</a></h3> <p>Me original first commit was way too late and contained way too much code. Also, I did not plan to show it to you like this, back then. So, as mentioned before, I rolled back and started again, with more commits. And I am keeping tags now, so that I have well-defined versions for my blog posts. That should make it easy for you to follow up, if you want to.</p> <p>The new, artificial "first commit" is now a tag/release: <a href=https://github.com/kratenko/lovem/releases/tag/v0.0.1-journey>v0.0.1-journey</a>. You can view the code for any tag online, this one you will find under: </p> <p><a href=https://github.com/kratenko/lovem/tree/v0.0.1-journey>https://github.com/kratenko/lovem/tree/v0.0.1-journey</a></p> <p>I think this will be a theme of this journal: linking you to what I did, when I am writing about it. And I will try to share my trails of thoughts, leading to my decisions (and errors, as it will be). I will do that, for that v0.0.1-journey, soon, don't worry, I will explain everything I did. But the next journal entry will be about some decisions again; mainly about the language I am using.</p> <h2 id=it-looks-so-weird>It looks so weird<a class=headerlink href=#it-looks-so-weird title="Permanent link">&para;</a></h2> <p><strong>Now, that you have seen some code, I might have to explain a bit again. Depends, on where you are coming from, I guess.</strong></p> <aside class=mdx-author> <p><img alt=@kratenko src=https://avatars.githubusercontent.com/kratenko></p> <p><span><strong>kratenko</strong> · <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 16 16"><path fill-rule=evenodd d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"/></svg></span> <a href=https://github.com/kratenko>kratenko</a></span> <span> <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path fill-rule=evenodd d="M6.75 0a.75.75 0 0 1 .75.75V3h9V.75a.75.75 0 0 1 1.5 0V3h2.75c.966 0 1.75.784 1.75 1.75v16a1.75 1.75 0 0 1-1.75 1.75H3.25a1.75 1.75 0 0 1-1.75-1.75v-16C1.5 3.784 2.284 3 3.25 3H6V.75A.75.75 0 0 1 6.75 0zm-3.5 4.5a.25.25 0 0 0-.25.25V8h18V4.75a.25.25 0 0 0-.25-.25H3.25zM21 9.5H3v11.25c0 .138.112.25.25.25h17.5a.25.25 0 0 0 .25-.25V9.5z"/></svg></span> 2022-07-10 · <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path fill-rule=evenodd d="M0 3.75A.75.75 0 0 1 .75 3h7.497c1.566 0 2.945.8 3.751 2.014A4.496 4.496 0 0 1 15.75 3h7.5a.75.75 0 0 1 .75.75v15.063a.75.75 0 0 1-.755.75l-7.682-.052a3 3 0 0 0-2.142.878l-.89.891a.75.75 0 0 1-1.061 0l-.902-.901a3 3 0 0 0-2.121-.879H.75a.75.75 0 0 1-.75-.75v-15zm11.247 3.747a3 3 0 0 0-3-2.997H1.5V18h6.947a4.5 4.5 0 0 1 2.803.98l-.003-11.483zm1.503 11.485V7.5a3 3 0 0 1 3-3h6.75v13.558l-6.927-.047a4.5 4.5 0 0 0-2.823.971z"/></svg></span> Entry #10 · <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12.5 7.25a.75.75 0 0 0-1.5 0v5.5c0 .27.144.518.378.651l3.5 2a.75.75 0 0 0 .744-1.302L12.5 12.315V7.25z"/><path fill-rule=evenodd d="M12 1C5.925 1 1 5.925 1 12s4.925 11 11 11 11-4.925 11-11S18.075 1 12 1zM2.5 12a9.5 9.5 0 1 1 19 0 9.5 9.5 0 0 1-19 0z"/></svg></span> 4 min read </span></p> </aside> <hr> <p>So, did you take a look at the code, yet? In case you've forgotten, this is my "initial commit":</p> <p><a href=https://github.com/kratenko/lovem/tree/v0.0.1-journey>https://github.com/kratenko/lovem/tree/v0.0.1-journey</a></p> <p>It is not the original initial commit, as I did commit way too late, and it was not suitable for writing a story about it. So I created a new, clean version, with just very simple concepts that I can explain in a single entry. In the next entry, that is.</p> <p>If you are thinking: "What is that weird source code?", then you are in for a real treat (and a lot of pain), should you chose to follow up. The code you are seeing is written in <a href=https://rust-lang.org>Rust</a>.</p> <h3 id=once-again-but-why>Once again: but why?<a class=headerlink href=#once-again-but-why title="Permanent link">&para;</a></h3> <p>Why Rust? Because Rust! Writing Rust can feel so good! And for something like a VM, it is such a good choice. If you have never heard of the language (or heard of it, but never looked into it), it is hard to understand why this is so. My advice: try it! use it! Or read along this journal, code along, you might like it.</p> <p>When you start, chances are high that you will <em>not</em> like Rust. The compiler is a pedantic pain in the ass. But at the same time it is incredibly polite, trying to help you find out, what you did wrong, and suggesting what you might want to do instead. And Rust really, really tries, to keep you from shooting yourself in the foot. It tries to make common mistakes impossible or at least hard to do &ndash; those mistakes that happen everywhere in C/C++ programs and their like. Yes, those mistakes that are the cause of the majority of all security problems and crashes. Buffer overruns, use after free, double free, memory leak &ndash; to name just some common ones from the top of my head. And Rust makes all it can to make those mistakes impossible <em>during compilation!</em> So it does not even add runtime overhead. That is so powerful!</p> <p>And it is so painful. Half of the things you do, when writing C/C++, you will not be able to do in Rust in the same way. Every piece of memory is owned. You can borrow it and return it, but it cannot be owned in two places at once. And if any part of the program has writing access to it, no other part may have any access. This makes some data structures complicated or impossible (there are ways around it), and you will have to think quite differently. But if you give in on that way of thinking, you can gain so much. Even peace of the mind, as the coding world will look a lot saner inside Rust source code. This will, of course, come with the price, that all code in other languages will start to feel dirty to you, but that is the way.</p> <p>Also, there are a lot of ways to write code, that you cannot add to a language that already exists. C and C++ will never be freed of their heritage; they will stay what they are, with all their pros and cons. Things are solved differently in Rust. Did I mention there is no <code>NULL</code>? And I have never missed it for a moment. Rust solves the problems other languages solve with <code>NULL</code> by using enums. That comes with certainty and safety all the way. There are no exceptions either. That problem is also solved by using enums. The way the language embraces those, they are a really powerful feature! And there are lot more convenient ways of organising code, that I keep missing in my daily C/C++ life.</p> <p>I will not write an introduction into Rust here. At least not your typical "how to get started in rust" intro. There are a lot of those out there, and I am already 10 posts into my Journal without programming. Maybe the Journal will become a different kind of Rust introduction, as it will try to take you along a real project, as it develops, from the beginning on. I will run into problems along the way and try to solve them in Rusty ways. This might be a good way, to start thinking in Rust. But, to be honest, I did never finish a project in Rust, yet. I got quite a bit running and functional, and I think in some parts in a rust-like way. But this is for me as much as anyone else as a learning project. I will make weird things. But the basics, I have worked with, yeah.</p> <p>The initial learning curve will be steep! I try to not get too fancy in the first draft, so the code will not be good Rust there! So, if you are shocked at how bad my Rust is &ndash; it will be very different, soon. But I want to give everyone a fair chance to hop on without understanding all the concepts. The initial code should be not too hard to follow, if you know C/C++, I hope. Learning a new thing (writing a VM) in a new, quite different language is a mouth full, I know.</p> <h3 id=didnt-you-say-you-use-cc>Didn't you say, you use C/C++?<a class=headerlink href=#didnt-you-say-you-use-cc title="Permanent link">&para;</a></h3> <p>Yes I did say that. And I do use those. It is not easy to change that, when you have a certain amount of legacy code (and not much experience with the new language, as we do not really have, yet). But we do have a saying these days. Often, after a debugging session that lasted for hours, when we find the bug, understand it and fix it, there is this realisation, that fits in the sentence:</p> <p>"Mit Rust wär' das nicht passiert." &mdash; "This would not have happened with Rust."</p> <p>So, this will not happen to me with this project, because those things will not happen with Rust!</p> <h2 id=a-vm>A VM<a class=headerlink href=#a-vm title="Permanent link">&para;</a></h2> <p><strong>The first draft of source code, that will be our VM, explained.</strong></p> <aside class=mdx-author> <p><img alt=@kratenko src=https://avatars.githubusercontent.com/kratenko></p> <p><span><strong>kratenko</strong> · <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 16 16"><path fill-rule=evenodd d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"/></svg></span> <a href=https://github.com/kratenko>kratenko</a></span> <span> <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path fill-rule=evenodd d="M6.75 0a.75.75 0 0 1 .75.75V3h9V.75a.75.75 0 0 1 1.5 0V3h2.75c.966 0 1.75.784 1.75 1.75v16a1.75 1.75 0 0 1-1.75 1.75H3.25a1.75 1.75 0 0 1-1.75-1.75v-16C1.5 3.784 2.284 3 3.25 3H6V.75A.75.75 0 0 1 6.75 0zm-3.5 4.5a.25.25 0 0 0-.25.25V8h18V4.75a.25.25 0 0 0-.25-.25H3.25zM21 9.5H3v11.25c0 .138.112.25.25.25h17.5a.25.25 0 0 0 .25-.25V9.5z"/></svg></span> 2022-07-11 · <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path fill-rule=evenodd d="M0 3.75A.75.75 0 0 1 .75 3h7.497c1.566 0 2.945.8 3.751 2.014A4.496 4.496 0 0 1 15.75 3h7.5a.75.75 0 0 1 .75.75v15.063a.75.75 0 0 1-.755.75l-7.682-.052a3 3 0 0 0-2.142.878l-.89.891a.75.75 0 0 1-1.061 0l-.902-.901a3 3 0 0 0-2.121-.879H.75a.75.75 0 0 1-.75-.75v-15zm11.247 3.747a3 3 0 0 0-3-2.997H1.5V18h6.947a4.5 4.5 0 0 1 2.803.98l-.003-11.483zm1.503 11.485V7.5a3 3 0 0 1 3-3h6.75v13.558l-6.927-.047a4.5 4.5 0 0 0-2.823.971z"/></svg></span> Entry #11 · <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12.5 7.25a.75.75 0 0 0-1.5 0v5.5c0 .27.144.518.378.651l3.5 2a.75.75 0 0 0 .744-1.302L12.5 12.315V7.25z"/><path fill-rule=evenodd d="M12 1C5.925 1 1 5.925 1 12s4.925 11 11 11 11-4.925 11-11S18.075 1 12 1zM2.5 12a9.5 9.5 0 1 1 19 0 9.5 9.5 0 0 1-19 0z"/></svg></span> 8 min read </span></p> </aside> <hr> <p>I dumped some source code in front of you, and then I started to talk about programming languages. Time now, to explain what I did and why. We only have 132 lines, including comments. We will go through all parts of it. And I will talk a little about how Rust's basic syntax works, while I use it. Not too much, since it is not good Rust code, yet, but to help you start. This will be a longer entry.</p> <h3 id=i-swear-if-i-do-not-see-some-code-in-this-post>I swear, if I do not see some code in this post...<a class=headerlink href=#i-swear-if-i-do-not-see-some-code-in-this-post title="Permanent link">&para;</a></h3> <p>Alright, alright... We will start with our VM:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a>#<span class=cp>#[derive(Debug)]</span>
<a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=k>pub</span><span class=w> </span><span class=k>struct</span> <span class=nc>VM</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=w>    </span><span class=n>stack</span>: <span class=nb>Vec</span><span class=o>&lt;</span><span class=kt>i64</span><span class=o>&gt;</span><span class=p>,</span>
<a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=w>    </span><span class=n>pc</span>: <span class=kt>usize</span><span class=p>,</span>
<a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=w>    </span><span class=n>op_cnt</span>: <span class=kt>usize</span><span class=p>,</span>
<a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=p>}</span>
</code></pre></div> <p>Nothing fancy, just a struct that will represent our Virtual Machine. Only three fields for now:</p> <ol> <li><code>stack</code>: Obviously our stack machine would need one of those. This will hold values during execution. I am using a Vector. That is nothing more than a chunk of memory, that knows how much capacity it has and how many values are in it at the moment. It does support resizing, but I do not want to use that. </li> <li><code>pc</code> will be our <em>program counter</em>. That is a register <sup id=fnref:register><a class=footnote-ref href=#fn:register>1</a></sup> holding the progress in the program during execution. It will always point at the instruction that is to be executed next.</li> <li><code>op_cnt</code> will be counting the number of operations executed. For now, I want that information out of curiosity, but later it will be useful for limiting execution time for programs.</li> </ol> <p><code>usize</code> and <code>i64</code> are Rust's names for integer types. The language is very explicit in those terms (and very strict, as in every aspect). I will not give a real introduction to Rust for you (there are pages that do that), but I will try to start slowly and give you hints on the important things I introduce, so that you get the chance to learn about them parallel to this journal. I hope, that makes it easier to follow for Rust beginners. To readers that know Rust: please excuse the crude code here! I will make it more rusty, soon. Skip to the next post, if you cannot handle it.</p> <p>We will also need a program that we will run in our VM. For the start, a crude array of bytes will do. The VM will be running bytecode after all. And that really is only that: a bunch of bytes, that you will soon be able to understand.</p> <div class=highlight><pre><span></span><code><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a><span class=c1>// assign `pgm` to hold a program:</span>
<a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a><span class=kd>let</span><span class=w> </span><span class=n>pgm</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=mh>0x00</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>u8</span><span class=p>,</span><span class=w> </span><span class=mh>0x01</span><span class=p>,</span><span class=w> </span><span class=mi>100</span><span class=p>,</span><span class=w> </span><span class=mh>0xff</span><span class=p>];</span>
</code></pre></div> <p>We will use a program that is a bit longer, but right now I wanted you to see a program, that is actually nothing but a collection of bytes in Rust code. <code>let</code> declares and assigns a variable here, named <code>pgm</code>. It is an array of 4 bytes (<code>u8</code> is an unsigned 8bit integer - you might know it as <code>uint8_t</code> from other languages). And that variable will not be variable at all. By default, all variables in Rust are immutable. If you want to change it, later, you would have to declare it<br> using the modifier <code>mut</code>. </p> <p>There is no need to modify the program after creation, we just want to read it for execution. But our VM will have to be mutable, as it has changing internal state. Here is our complete <code>main</code> function, creating the (immutable) program and the (mutable) VM, and running the program. Of course, the <code>run(...)</code> method is still missing. And you will see the program, we will be using (with some constants that I did not define, yet).</p> <div class=highlight><pre><span></span><code><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-2-2 name=__codelineno-2-2 href=#__codelineno-2-2></a><span class=w>    </span><span class=c1>// Create a program in bytecode.</span>
<a id=__codelineno-2-3 name=__codelineno-2-3 href=#__codelineno-2-3></a><span class=w>    </span><span class=c1>// We just hardcode the bytes in an array here:</span>
<a id=__codelineno-2-4 name=__codelineno-2-4 href=#__codelineno-2-4></a><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>pgm</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=n>op</span>::<span class=n>NOP</span><span class=p>,</span><span class=w> </span><span class=n>op</span>::<span class=n>PUSH_U8</span><span class=p>,</span><span class=w> </span><span class=mi>100</span><span class=p>,</span><span class=w> </span><span class=n>op</span>::<span class=n>PUSH_U8</span><span class=p>,</span><span class=w> </span><span class=mi>77</span><span class=p>,</span><span class=w> </span><span class=n>op</span>::<span class=n>ADD</span><span class=p>,</span><span class=w> </span><span class=n>op</span>::<span class=n>POP</span><span class=p>,</span><span class=w> </span><span class=mh>0xff</span><span class=p>];</span>
<a id=__codelineno-2-5 name=__codelineno-2-5 href=#__codelineno-2-5></a><span class=w>    </span><span class=c1>// Crate our VM instance.</span>
<a id=__codelineno-2-6 name=__codelineno-2-6 href=#__codelineno-2-6></a><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>vm</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>VM</span><span class=p>{</span>
<a id=__codelineno-2-7 name=__codelineno-2-7 href=#__codelineno-2-7></a><span class=w>        </span><span class=n>stack</span>: <span class=nb>Vec</span>::<span class=n>with_capacity</span><span class=p>(</span><span class=mi>100</span><span class=p>),</span>
<a id=__codelineno-2-8 name=__codelineno-2-8 href=#__codelineno-2-8></a><span class=w>        </span><span class=n>pc</span>: <span class=mi>0</span><span class=p>,</span>
<a id=__codelineno-2-9 name=__codelineno-2-9 href=#__codelineno-2-9></a><span class=w>        </span><span class=n>op_cnt</span>: <span class=mi>0</span>
<a id=__codelineno-2-10 name=__codelineno-2-10 href=#__codelineno-2-10></a><span class=w>    </span><span class=p>};</span>
<a id=__codelineno-2-11 name=__codelineno-2-11 href=#__codelineno-2-11></a><span class=w>    </span><span class=c1>// Execute the program in our VM:</span>
<a id=__codelineno-2-12 name=__codelineno-2-12 href=#__codelineno-2-12></a><span class=w>    </span><span class=n>vm</span><span class=p>.</span><span class=n>run</span><span class=p>(</span><span class=o>&amp;</span><span class=n>pgm</span><span class=p>);</span>
<a id=__codelineno-2-13 name=__codelineno-2-13 href=#__codelineno-2-13></a><span class=p>}</span>
</code></pre></div> <h3 id=behaviour-for-our-vm>Behaviour for our VM<a class=headerlink href=#behaviour-for-our-vm title="Permanent link">&para;</a></h3> <p>So far we only have an initialized data structure and some bytes. Let's do something with it. Rust does not really use objects (and I think that is good). But it has <em>associated functions</em> that work on types, and <em>methods</em> that work on instances of types. We will write some methods for our <code>VM</code> struct. Let's start with the one for reading our program:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a><span class=k>impl</span><span class=w> </span><span class=n>VM</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a><span class=w>    </span><span class=sd>/// Fetch the next byte from the bytecode, increase program counter, and return value.</span>
<a id=__codelineno-3-3 name=__codelineno-3-3 href=#__codelineno-3-3></a><span class=w>    </span><span class=k>fn</span> <span class=nf>fetch_u8</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>,</span><span class=w> </span><span class=n>pgm</span>: <span class=kp>&amp;</span><span class=p>[</span><span class=kt>u8</span><span class=p>])</span><span class=w> </span>-&gt; <span class=kt>u8</span> <span class=p>{</span>
<a id=__codelineno-3-4 name=__codelineno-3-4 href=#__codelineno-3-4></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>pc</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>pgm</span><span class=p>.</span><span class=n>len</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-3-5 name=__codelineno-3-5 href=#__codelineno-3-5></a><span class=w>            </span><span class=fm>panic!</span><span class=p>(</span><span class=s>&quot;End of program exceeded&quot;</span><span class=p>);</span>
<a id=__codelineno-3-6 name=__codelineno-3-6 href=#__codelineno-3-6></a><span class=w>        </span><span class=p>}</span>
<a id=__codelineno-3-7 name=__codelineno-3-7 href=#__codelineno-3-7></a><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>v</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pgm</span><span class=p>[</span><span class=bp>self</span><span class=p>.</span><span class=n>pc</span><span class=p>];</span>
<a id=__codelineno-3-8 name=__codelineno-3-8 href=#__codelineno-3-8></a><span class=w>        </span><span class=bp>self</span><span class=p>.</span><span class=n>pc</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span>
<a id=__codelineno-3-9 name=__codelineno-3-9 href=#__codelineno-3-9></a><span class=w>        </span><span class=n>v</span>
<a id=__codelineno-3-10 name=__codelineno-3-10 href=#__codelineno-3-10></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-3-11 name=__codelineno-3-11 href=#__codelineno-3-11></a><span class=p>}</span>
</code></pre></div> <p>The <code>fetch</code> method will work on our VM instance. The first parameter is <code>&amp;mut self</code> &ndash; that tells us it works on an instance of the type <code>VM</code>. It will work on a reference to the instance (indicated by the <code>&amp;</code>), and it can modify the data (indicated by the <code>mut</code>). It will also take the reference to an array of <code>u8</code>s, but that it will not be able to modify (no <code>mut</code>). It returns a <code>u8</code>.</p> <p>What it does is simply read and return a byte from the program, and increase the VMs internal program counter by one, so that the next call to <code>fetch</code> will return the next byte. Simple. </p> <p>So, what is that <code>panic!()</code> you might ask? Well, if we reach that instruction, it will start to panic, and then it will die. That is not a nice way to act. Do not worry, we will change that to something more reasonable, when we start writing better Rust. And what about the naked <code>v</code> in the last line? It will have the function return the value of <code>v</code>.</p> <p>Now, let's look at that <code>run</code> method, we were calling in <code>main</code>:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a><span class=k>impl</span><span class=w> </span><span class=n>VM</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-4-2 name=__codelineno-4-2 href=#__codelineno-4-2></a><span class=w>    </span><span class=sd>/// Executes a program (encoded in bytecode).</span>
<a id=__codelineno-4-3 name=__codelineno-4-3 href=#__codelineno-4-3></a><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=k>fn</span> <span class=nf>run</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>,</span><span class=w> </span><span class=n>pgm</span>: <span class=kp>&amp;</span><span class=p>[</span><span class=kt>u8</span><span class=p>])</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-4-4 name=__codelineno-4-4 href=#__codelineno-4-4></a><span class=w>        </span><span class=c1>// initialise the VM to be in a clean start state:</span>
<a id=__codelineno-4-5 name=__codelineno-4-5 href=#__codelineno-4-5></a><span class=w>        </span><span class=bp>self</span><span class=p>.</span><span class=n>stack</span><span class=p>.</span><span class=n>clear</span><span class=p>();</span>
<a id=__codelineno-4-6 name=__codelineno-4-6 href=#__codelineno-4-6></a><span class=w>        </span><span class=bp>self</span><span class=p>.</span><span class=n>pc</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
<a id=__codelineno-4-7 name=__codelineno-4-7 href=#__codelineno-4-7></a><span class=w>        </span><span class=bp>self</span><span class=p>.</span><span class=n>op_cnt</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
<a id=__codelineno-4-8 name=__codelineno-4-8 href=#__codelineno-4-8></a>
<a id=__codelineno-4-9 name=__codelineno-4-9 href=#__codelineno-4-9></a><span class=w>        </span><span class=c1>// Loop going through the whole program, one instruction at a time.</span>
<a id=__codelineno-4-10 name=__codelineno-4-10 href=#__codelineno-4-10></a><span class=w>        </span><span class=k>loop</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-4-11 name=__codelineno-4-11 href=#__codelineno-4-11></a><span class=w>            </span><span class=c1>// Log the vm&#39;s complete state, so we can follow what happens in console:</span>
<a id=__codelineno-4-12 name=__codelineno-4-12 href=#__codelineno-4-12></a><span class=w>            </span><span class=fm>println!</span><span class=p>(</span><span class=s>&quot;{:?}&quot;</span><span class=p>,</span><span class=w> </span><span class=bp>self</span><span class=p>);</span>
<a id=__codelineno-4-13 name=__codelineno-4-13 href=#__codelineno-4-13></a><span class=w>            </span><span class=c1>// Fetch next opcode from program (increases program counter):</span>
<a id=__codelineno-4-14 name=__codelineno-4-14 href=#__codelineno-4-14></a><span class=w>            </span><span class=kd>let</span><span class=w> </span><span class=n>opcode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>fetch_u8</span><span class=p>(</span><span class=n>pgm</span><span class=p>);</span>
<a id=__codelineno-4-15 name=__codelineno-4-15 href=#__codelineno-4-15></a><span class=w>            </span><span class=c1>// We count the number of instructions we execute:</span>
<a id=__codelineno-4-16 name=__codelineno-4-16 href=#__codelineno-4-16></a><span class=w>            </span><span class=bp>self</span><span class=p>.</span><span class=n>op_cnt</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span>
<a id=__codelineno-4-17 name=__codelineno-4-17 href=#__codelineno-4-17></a><span class=w>            </span><span class=c1>// If we are done, break loop and stop execution:</span>
<a id=__codelineno-4-18 name=__codelineno-4-18 href=#__codelineno-4-18></a><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=n>opcode</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>op</span>::<span class=n>FIN</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-4-19 name=__codelineno-4-19 href=#__codelineno-4-19></a><span class=w>                </span><span class=k>break</span><span class=p>;</span>
<a id=__codelineno-4-20 name=__codelineno-4-20 href=#__codelineno-4-20></a><span class=w>            </span><span class=p>}</span>
<a id=__codelineno-4-21 name=__codelineno-4-21 href=#__codelineno-4-21></a><span class=w>            </span><span class=c1>// Execute the current instruction (with the opcode we loaded already):</span>
<a id=__codelineno-4-22 name=__codelineno-4-22 href=#__codelineno-4-22></a><span class=w>            </span><span class=bp>self</span><span class=p>.</span><span class=n>execute_op</span><span class=p>(</span><span class=n>pgm</span><span class=p>,</span><span class=w> </span><span class=n>opcode</span><span class=p>);</span>
<a id=__codelineno-4-23 name=__codelineno-4-23 href=#__codelineno-4-23></a><span class=w>        </span><span class=p>}</span>
<a id=__codelineno-4-24 name=__codelineno-4-24 href=#__codelineno-4-24></a><span class=w>        </span><span class=c1>// Execution terminated. Output the final state of the VM:</span>
<a id=__codelineno-4-25 name=__codelineno-4-25 href=#__codelineno-4-25></a><span class=w>        </span><span class=fm>println!</span><span class=p>(</span><span class=s>&quot;Terminated!&quot;</span><span class=p>);</span>
<a id=__codelineno-4-26 name=__codelineno-4-26 href=#__codelineno-4-26></a><span class=w>        </span><span class=fm>println!</span><span class=p>(</span><span class=s>&quot;{:?}&quot;</span><span class=p>,</span><span class=w> </span><span class=bp>self</span><span class=p>);</span>
<a id=__codelineno-4-27 name=__codelineno-4-27 href=#__codelineno-4-27></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-4-28 name=__codelineno-4-28 href=#__codelineno-4-28></a><span class=p>}</span>
</code></pre></div> <p>The comments should explain, what is going on there. Initialise VM, then loop over the program, fetching one instruction at a time and executing it, until we reach the end. And you might have noticed, that our program will be very talkative. I added a lot of <code>println</code>s, that tell just about everything that happens, during execution.</p> <p>I guess it is time to look at those <code>op::</code> constants I keep using.</p> <div class=highlight><pre><span></span><code><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a><span class=sd>/// Module holding the constants defining the opcodes for the VM.</span>
<a id=__codelineno-5-2 name=__codelineno-5-2 href=#__codelineno-5-2></a><span class=k>pub</span><span class=w> </span><span class=k>mod</span> <span class=nn>op</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-5-3 name=__codelineno-5-3 href=#__codelineno-5-3></a><span class=w>    </span><span class=sd>/// opcode: Do nothing. No oparg.</span>
<a id=__codelineno-5-4 name=__codelineno-5-4 href=#__codelineno-5-4></a><span class=w>    </span><span class=sd>///</span>
<a id=__codelineno-5-5 name=__codelineno-5-5 href=#__codelineno-5-5></a><span class=w>    </span><span class=sd>/// pop: 0, push: 0</span>
<a id=__codelineno-5-6 name=__codelineno-5-6 href=#__codelineno-5-6></a><span class=w>    </span><span class=sd>/// oparg: 0</span>
<a id=__codelineno-5-7 name=__codelineno-5-7 href=#__codelineno-5-7></a><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=n>NOP</span>: <span class=kt>u8</span> <span class=o>=</span><span class=w> </span><span class=mh>0x00</span><span class=p>;</span>
<a id=__codelineno-5-8 name=__codelineno-5-8 href=#__codelineno-5-8></a><span class=w>    </span><span class=sd>/// opcode: Pop value from stack and discard it.</span>
<a id=__codelineno-5-9 name=__codelineno-5-9 href=#__codelineno-5-9></a><span class=w>    </span><span class=sd>///</span>
<a id=__codelineno-5-10 name=__codelineno-5-10 href=#__codelineno-5-10></a><span class=w>    </span><span class=sd>/// pop: 1, push: 0</span>
<a id=__codelineno-5-11 name=__codelineno-5-11 href=#__codelineno-5-11></a><span class=w>    </span><span class=sd>/// oparg: 0</span>
<a id=__codelineno-5-12 name=__codelineno-5-12 href=#__codelineno-5-12></a><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=n>POP</span>: <span class=kt>u8</span> <span class=o>=</span><span class=w> </span><span class=mh>0x01</span><span class=p>;</span>
<a id=__codelineno-5-13 name=__codelineno-5-13 href=#__codelineno-5-13></a><span class=w>    </span><span class=sd>/// opcode: Push immediate value to stack.</span>
<a id=__codelineno-5-14 name=__codelineno-5-14 href=#__codelineno-5-14></a><span class=w>    </span><span class=sd>///</span>
<a id=__codelineno-5-15 name=__codelineno-5-15 href=#__codelineno-5-15></a><span class=w>    </span><span class=sd>/// pop: 0, push: 1</span>
<a id=__codelineno-5-16 name=__codelineno-5-16 href=#__codelineno-5-16></a><span class=w>    </span><span class=sd>/// oparg: 1B, u8 value to push</span>
<a id=__codelineno-5-17 name=__codelineno-5-17 href=#__codelineno-5-17></a><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=n>PUSH_U8</span>: <span class=kt>u8</span> <span class=o>=</span><span class=w> </span><span class=mh>0x02</span><span class=p>;</span>
<a id=__codelineno-5-18 name=__codelineno-5-18 href=#__codelineno-5-18></a><span class=w>    </span><span class=sd>/// opcode: Add top two values on stack.</span>
<a id=__codelineno-5-19 name=__codelineno-5-19 href=#__codelineno-5-19></a><span class=w>    </span><span class=sd>///</span>
<a id=__codelineno-5-20 name=__codelineno-5-20 href=#__codelineno-5-20></a><span class=w>    </span><span class=sd>/// pop: 2, push: 1</span>
<a id=__codelineno-5-21 name=__codelineno-5-21 href=#__codelineno-5-21></a><span class=w>    </span><span class=sd>/// oparg: 0</span>
<a id=__codelineno-5-22 name=__codelineno-5-22 href=#__codelineno-5-22></a><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=n>ADD</span>: <span class=kt>u8</span> <span class=o>=</span><span class=w> </span><span class=mh>0x10</span><span class=p>;</span>
<a id=__codelineno-5-23 name=__codelineno-5-23 href=#__codelineno-5-23></a><span class=w>    </span><span class=sd>/// opcode: Terminate program.</span>
<a id=__codelineno-5-24 name=__codelineno-5-24 href=#__codelineno-5-24></a><span class=w>    </span><span class=sd>///</span>
<a id=__codelineno-5-25 name=__codelineno-5-25 href=#__codelineno-5-25></a><span class=w>    </span><span class=sd>/// pop: 0, push: 0</span>
<a id=__codelineno-5-26 name=__codelineno-5-26 href=#__codelineno-5-26></a><span class=w>    </span><span class=sd>/// oparg: 0</span>
<a id=__codelineno-5-27 name=__codelineno-5-27 href=#__codelineno-5-27></a><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=n>FIN</span>: <span class=kt>u8</span> <span class=o>=</span><span class=w> </span><span class=mh>0xff</span><span class=p>;</span>
<a id=__codelineno-5-28 name=__codelineno-5-28 href=#__codelineno-5-28></a><span class=p>}</span>
</code></pre></div> <p>Just 5 <code>u8</code> constants there, grouped in a module as a namespace. And a lot of comments to explain them. We have 5 different operations for our VM. The only thing missing is some code, that actually executes those instructions:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a><span class=k>impl</span><span class=w> </span><span class=n>VM</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-6-2 name=__codelineno-6-2 href=#__codelineno-6-2></a><span class=w>    </span><span class=sd>/// Executes an instruction, using the opcode passed.</span>
<a id=__codelineno-6-3 name=__codelineno-6-3 href=#__codelineno-6-3></a><span class=w>    </span><span class=sd>///</span>
<a id=__codelineno-6-4 name=__codelineno-6-4 href=#__codelineno-6-4></a><span class=w>    </span><span class=sd>/// This might load more data from the program (opargs) and</span>
<a id=__codelineno-6-5 name=__codelineno-6-5 href=#__codelineno-6-5></a><span class=w>    </span><span class=sd>/// manipulate the stack (push, pop).</span>
<a id=__codelineno-6-6 name=__codelineno-6-6 href=#__codelineno-6-6></a><span class=w>    </span><span class=k>fn</span> <span class=nf>execute_op</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>,</span><span class=w> </span><span class=n>pgm</span>: <span class=kp>&amp;</span><span class=p>[</span><span class=kt>u8</span><span class=p>],</span><span class=w> </span><span class=n>opcode</span>: <span class=kt>u8</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-6-7 name=__codelineno-6-7 href=#__codelineno-6-7></a><span class=w>        </span><span class=fm>println!</span><span class=p>(</span><span class=s>&quot;Executing op 0x{:02x}&quot;</span><span class=p>,</span><span class=w> </span><span class=n>opcode</span><span class=p>);</span>
<a id=__codelineno-6-8 name=__codelineno-6-8 href=#__codelineno-6-8></a><span class=w>        </span><span class=k>match</span><span class=w> </span><span class=n>opcode</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-6-9 name=__codelineno-6-9 href=#__codelineno-6-9></a><span class=w>            </span><span class=n>op</span>::<span class=n>NOP</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-6-10 name=__codelineno-6-10 href=#__codelineno-6-10></a><span class=w>                </span><span class=fm>println!</span><span class=p>(</span><span class=s>&quot;  NOP&quot;</span><span class=p>);</span>
<a id=__codelineno-6-11 name=__codelineno-6-11 href=#__codelineno-6-11></a><span class=w>                </span><span class=c1>// do nothing</span>
<a id=__codelineno-6-12 name=__codelineno-6-12 href=#__codelineno-6-12></a><span class=w>            </span><span class=p>},</span>
<a id=__codelineno-6-13 name=__codelineno-6-13 href=#__codelineno-6-13></a><span class=w>            </span><span class=n>op</span>::<span class=n>POP</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-6-14 name=__codelineno-6-14 href=#__codelineno-6-14></a><span class=w>                </span><span class=fm>println!</span><span class=p>(</span><span class=s>&quot;  POP&quot;</span><span class=p>);</span>
<a id=__codelineno-6-15 name=__codelineno-6-15 href=#__codelineno-6-15></a><span class=w>                </span><span class=kd>let</span><span class=w> </span><span class=n>v</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>stack</span><span class=p>.</span><span class=n>pop</span><span class=p>().</span><span class=n>unwrap</span><span class=p>();</span>
<a id=__codelineno-6-16 name=__codelineno-6-16 href=#__codelineno-6-16></a><span class=w>                </span><span class=fm>println!</span><span class=p>(</span><span class=s>&quot;  dropping value {}&quot;</span><span class=p>,</span><span class=w> </span><span class=n>v</span><span class=p>);</span>
<a id=__codelineno-6-17 name=__codelineno-6-17 href=#__codelineno-6-17></a><span class=w>            </span><span class=p>},</span>
<a id=__codelineno-6-18 name=__codelineno-6-18 href=#__codelineno-6-18></a><span class=w>            </span><span class=n>op</span>::<span class=n>PUSH_U8</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-6-19 name=__codelineno-6-19 href=#__codelineno-6-19></a><span class=w>                </span><span class=fm>println!</span><span class=p>(</span><span class=s>&quot;  PUSH_U8&quot;</span><span class=p>);</span>
<a id=__codelineno-6-20 name=__codelineno-6-20 href=#__codelineno-6-20></a><span class=w>                </span><span class=kd>let</span><span class=w> </span><span class=n>v</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>fetch_u8</span><span class=p>(</span><span class=n>pgm</span><span class=p>);</span>
<a id=__codelineno-6-21 name=__codelineno-6-21 href=#__codelineno-6-21></a><span class=w>                </span><span class=fm>println!</span><span class=p>(</span><span class=s>&quot;  value: {}&quot;</span><span class=p>,</span><span class=w> </span><span class=n>v</span><span class=p>);</span>
<a id=__codelineno-6-22 name=__codelineno-6-22 href=#__codelineno-6-22></a><span class=w>                </span><span class=bp>self</span><span class=p>.</span><span class=n>stack</span><span class=p>.</span><span class=n>push</span><span class=p>(</span><span class=n>v</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>i64</span><span class=p>);</span>
<a id=__codelineno-6-23 name=__codelineno-6-23 href=#__codelineno-6-23></a><span class=w>            </span><span class=p>},</span>
<a id=__codelineno-6-24 name=__codelineno-6-24 href=#__codelineno-6-24></a><span class=w>            </span><span class=n>op</span>::<span class=n>ADD</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-6-25 name=__codelineno-6-25 href=#__codelineno-6-25></a><span class=w>                </span><span class=fm>println!</span><span class=p>(</span><span class=s>&quot;  ADD&quot;</span><span class=p>);</span>
<a id=__codelineno-6-26 name=__codelineno-6-26 href=#__codelineno-6-26></a><span class=w>                </span><span class=kd>let</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>stack</span><span class=p>.</span><span class=n>pop</span><span class=p>().</span><span class=n>unwrap</span><span class=p>();</span>
<a id=__codelineno-6-27 name=__codelineno-6-27 href=#__codelineno-6-27></a><span class=w>                </span><span class=kd>let</span><span class=w> </span><span class=n>b</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>stack</span><span class=p>.</span><span class=n>pop</span><span class=p>().</span><span class=n>unwrap</span><span class=p>();</span>
<a id=__codelineno-6-28 name=__codelineno-6-28 href=#__codelineno-6-28></a><span class=w>                </span><span class=bp>self</span><span class=p>.</span><span class=n>stack</span><span class=p>.</span><span class=n>push</span><span class=p>(</span><span class=n>a</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>b</span><span class=p>);</span>
<a id=__codelineno-6-29 name=__codelineno-6-29 href=#__codelineno-6-29></a><span class=w>            </span><span class=p>},</span>
<a id=__codelineno-6-30 name=__codelineno-6-30 href=#__codelineno-6-30></a><span class=w>            </span><span class=n>_</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-6-31 name=__codelineno-6-31 href=#__codelineno-6-31></a><span class=w>                </span><span class=fm>panic!</span><span class=p>(</span><span class=s>&quot;unknown opcode!&quot;</span><span class=p>);</span>
<a id=__codelineno-6-32 name=__codelineno-6-32 href=#__codelineno-6-32></a><span class=w>            </span><span class=p>}</span>
<a id=__codelineno-6-33 name=__codelineno-6-33 href=#__codelineno-6-33></a><span class=w>        </span><span class=p>}</span>
<a id=__codelineno-6-34 name=__codelineno-6-34 href=#__codelineno-6-34></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-6-35 name=__codelineno-6-35 href=#__codelineno-6-35></a><span class=p>}</span>
</code></pre></div> <p>You can think of the <code>match</code> as a switch statement. It is much more than that, but here we use it as one. Each of our opcodes is handled individually. And we log a lot, so that we can read what is happening, when we run it. Ignore the <code>unwrap()</code> thingies for the time being. They are just there to try and ignore potential runtime errors. Again, not good Rust style, but, you know: later.</p> <p>The four operations get more complex in what they do. Let's go through them one by one:</p> <ol> <li><code>NOP</code> &ndash; this does nothing, it just wastes bytecode and execution time. I have included it simply to be the most basic operation possible.</li> <li><code>POP</code> &ndash; this is our first modification of the stack. It simply discards the topmost value, decreasing the stack's size by one.</li> <li><code>PUSH_U8</code> &ndash; this is the only operation that reads additional data from the program. It only reads a single byte (increasing the program counter by one), and puts it on top of the stack, increasing the stack's size by one. This is how you can get data from your program into the VM, to work with them. It is how numeric literals in your program are handled.</li> <li><code>ADD</code> &ndash; the only operation that works on data. It pops its two operands from the stack, adds them, and pushes the sum back on the stack. This is how data is manipulated in a stack machine. The operation reduces the stack's size by one effectively, but there need to be at least 2 values on it for it to be executed.</li> </ol> <p>That is the out complete VM so far, and it will execute a program, if you compile and run it (which we will do in the next post). </p> <p>You can find the complete program here: </p> <p><a href=https://github.com/kratenko/lovem/blob/v0.0.1-journey/src/main.rs>https://github.com/kratenko/lovem/blob/v0.0.1-journey/src/main.rs</a></p> <p>You can access the repo at this state under (there is also a zip file containing all files):</p> <p><a href=https://github.com/kratenko/lovem/releases/tag/v0.0.1-journey>https://github.com/kratenko/lovem/releases/tag/v0.0.1-journey</a></p> <h3 id=how-do-i-work-with-the-code>How do I work with the code?<a class=headerlink href=#how-do-i-work-with-the-code title="Permanent link">&para;</a></h3> <p>The easy way, to get the code and play with it, would be to clone the git repository and check out the tag <code>v0.0.1-journey</code>. If you did not understand any of that, you might want to do a tutorial on git, before you continue reading. Anyways, here is some copy&amp;paste commands, you can hack into your bash prompt, to do, what I just told you to do. Use at your own risk, I'm not responsible for what you do to your system.</p> <div class=highlight><pre><span></span><code><a id=__codelineno-7-1 name=__codelineno-7-1 href=#__codelineno-7-1></a>you@host:~$<span class=w> </span>git<span class=w> </span>clone<span class=w> </span>https://github.com/kratenko/lovem.git
<a id=__codelineno-7-2 name=__codelineno-7-2 href=#__codelineno-7-2></a>
<a id=__codelineno-7-3 name=__codelineno-7-3 href=#__codelineno-7-3></a>you@host:~$<span class=w> </span><span class=nb>cd</span><span class=w> </span>lovem
<a id=__codelineno-7-4 name=__codelineno-7-4 href=#__codelineno-7-4></a>
<a id=__codelineno-7-5 name=__codelineno-7-5 href=#__codelineno-7-5></a>you@host:~/lovem$<span class=w> </span>git<span class=w> </span>checkout<span class=w> </span>v0.0.1-journey
<a id=__codelineno-7-6 name=__codelineno-7-6 href=#__codelineno-7-6></a>
<a id=__codelineno-7-7 name=__codelineno-7-7 href=#__codelineno-7-7></a>you@host:~/lovam$<span class=w> </span>cargo<span class=w> </span>run<span class=w> </span>lovem
</code></pre></div> <p>This will copy all source code from GitHub and its history to your computer, and it will roll the source code to the state we are looking at in this entry. The last command <code>cargo run lovem</code> will compile and execute the program - that is, if Rust is installed and ready to run (and in the correct version). <code>cargo</code> is Rust's package manager, that handles dependencies and compiles your projects. I will not explain those things further, but now you know what to look for.</p> <h2 id=running-our-first-program>Running our first program<a class=headerlink href=#running-our-first-program title="Permanent link">&para;</a></h2> <p><strong>Now, that we have a VM, we will run a program on it.</strong></p> <aside class=mdx-author> <p><img alt=@kratenko src=https://avatars.githubusercontent.com/kratenko></p> <p><span><strong>kratenko</strong> · <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 16 16"><path fill-rule=evenodd d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"/></svg></span> <a href=https://github.com/kratenko>kratenko</a></span> <span> <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path fill-rule=evenodd d="M6.75 0a.75.75 0 0 1 .75.75V3h9V.75a.75.75 0 0 1 1.5 0V3h2.75c.966 0 1.75.784 1.75 1.75v16a1.75 1.75 0 0 1-1.75 1.75H3.25a1.75 1.75 0 0 1-1.75-1.75v-16C1.5 3.784 2.284 3 3.25 3H6V.75A.75.75 0 0 1 6.75 0zm-3.5 4.5a.25.25 0 0 0-.25.25V8h18V4.75a.25.25 0 0 0-.25-.25H3.25zM21 9.5H3v11.25c0 .138.112.25.25.25h17.5a.25.25 0 0 0 .25-.25V9.5z"/></svg></span> 2022-07-12 · <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path fill-rule=evenodd d="M0 3.75A.75.75 0 0 1 .75 3h7.497c1.566 0 2.945.8 3.751 2.014A4.496 4.496 0 0 1 15.75 3h7.5a.75.75 0 0 1 .75.75v15.063a.75.75 0 0 1-.755.75l-7.682-.052a3 3 0 0 0-2.142.878l-.89.891a.75.75 0 0 1-1.061 0l-.902-.901a3 3 0 0 0-2.121-.879H.75a.75.75 0 0 1-.75-.75v-15zm11.247 3.747a3 3 0 0 0-3-2.997H1.5V18h6.947a4.5 4.5 0 0 1 2.803.98l-.003-11.483zm1.503 11.485V7.5a3 3 0 0 1 3-3h6.75v13.558l-6.927-.047a4.5 4.5 0 0 0-2.823.971z"/></svg></span> Entry #12 · <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12.5 7.25a.75.75 0 0 0-1.5 0v5.5c0 .27.144.518.378.651l3.5 2a.75.75 0 0 0 .744-1.302L12.5 12.315V7.25z"/><path fill-rule=evenodd d="M12 1C5.925 1 1 5.925 1 12s4.925 11 11 11 11-4.925 11-11S18.075 1 12 1zM2.5 12a9.5 9.5 0 1 1 19 0 9.5 9.5 0 0 1-19 0z"/></svg></span> 3 min read </span></p> </aside> <hr> <p>So we built our very first VM and studied the code in detail. It is time to execute a program on it and look at it's output. We will look at every single step the program takes. Aren't we lucky, that our VM is so talkative during execution?</p> <p>If you missed the code, look at the previous post, <a href=a-vm.html>A VM</a>.</p> <h3 id=lets-go>Let's go!<a class=headerlink href=#lets-go title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><a id=__codelineno-8-1 name=__codelineno-8-1 href=#__codelineno-8-1></a>/home/kratenko/.cargo/bin/cargo run --color=always --package lovem --bin lovem
<a id=__codelineno-8-2 name=__codelineno-8-2 href=#__codelineno-8-2></a>    Finished dev [unoptimized + debuginfo] target(s) in 0.00s
<a id=__codelineno-8-3 name=__codelineno-8-3 href=#__codelineno-8-3></a>     Running `target/debug/lovem`
<a id=__codelineno-8-4 name=__codelineno-8-4 href=#__codelineno-8-4></a>VM { stack: [], pc: 0, op_cnt: 0 }
<a id=__codelineno-8-5 name=__codelineno-8-5 href=#__codelineno-8-5></a>Executing op 0x00
<a id=__codelineno-8-6 name=__codelineno-8-6 href=#__codelineno-8-6></a>  NOP
<a id=__codelineno-8-7 name=__codelineno-8-7 href=#__codelineno-8-7></a>VM { stack: [], pc: 1, op_cnt: 1 }
<a id=__codelineno-8-8 name=__codelineno-8-8 href=#__codelineno-8-8></a>Executing op 0x02
<a id=__codelineno-8-9 name=__codelineno-8-9 href=#__codelineno-8-9></a>  PUSH_U8
<a id=__codelineno-8-10 name=__codelineno-8-10 href=#__codelineno-8-10></a>  value: 100
<a id=__codelineno-8-11 name=__codelineno-8-11 href=#__codelineno-8-11></a>VM { stack: [100], pc: 3, op_cnt: 2 }
<a id=__codelineno-8-12 name=__codelineno-8-12 href=#__codelineno-8-12></a>Executing op 0x02
<a id=__codelineno-8-13 name=__codelineno-8-13 href=#__codelineno-8-13></a>  PUSH_U8
<a id=__codelineno-8-14 name=__codelineno-8-14 href=#__codelineno-8-14></a>  value: 77
<a id=__codelineno-8-15 name=__codelineno-8-15 href=#__codelineno-8-15></a>VM { stack: [100, 77], pc: 5, op_cnt: 3 }
<a id=__codelineno-8-16 name=__codelineno-8-16 href=#__codelineno-8-16></a>Executing op 0x10
<a id=__codelineno-8-17 name=__codelineno-8-17 href=#__codelineno-8-17></a>  ADD
<a id=__codelineno-8-18 name=__codelineno-8-18 href=#__codelineno-8-18></a>VM { stack: [177], pc: 6, op_cnt: 4 }
<a id=__codelineno-8-19 name=__codelineno-8-19 href=#__codelineno-8-19></a>Executing op 0x01
<a id=__codelineno-8-20 name=__codelineno-8-20 href=#__codelineno-8-20></a>  POP
<a id=__codelineno-8-21 name=__codelineno-8-21 href=#__codelineno-8-21></a>  dropping value 177
<a id=__codelineno-8-22 name=__codelineno-8-22 href=#__codelineno-8-22></a>VM { stack: [], pc: 7, op_cnt: 5 }
<a id=__codelineno-8-23 name=__codelineno-8-23 href=#__codelineno-8-23></a>Terminated!
<a id=__codelineno-8-24 name=__codelineno-8-24 href=#__codelineno-8-24></a>VM { stack: [], pc: 8, op_cnt: 6 }
<a id=__codelineno-8-25 name=__codelineno-8-25 href=#__codelineno-8-25></a>
<a id=__codelineno-8-26 name=__codelineno-8-26 href=#__codelineno-8-26></a>Process finished with exit code 0
</code></pre></div> <h3 id=what-just-happened>What just happened?<a class=headerlink href=#what-just-happened title="Permanent link">&para;</a></h3> <p>It is quite talkative. And isn't it nice, how easy it is, to print the complete state of our VM in Rust? And it costs no overhead during runtime, as it is generated during compilation for us. Isn't that something?</p> <p>So, what is happening there? Our program <code>pgm</code> looks like this:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-9-1 name=__codelineno-9-1 href=#__codelineno-9-1></a><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>pgm</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=n>op</span>::<span class=n>NOP</span><span class=p>,</span><span class=w> </span><span class=n>op</span>::<span class=n>PUSH_U8</span><span class=p>,</span><span class=w> </span><span class=mi>100</span><span class=p>,</span><span class=w> </span><span class=n>op</span>::<span class=n>PUSH_U8</span><span class=p>,</span><span class=w> </span><span class=mi>77</span><span class=p>,</span><span class=w> </span><span class=n>op</span>::<span class=n>ADD</span><span class=p>,</span><span class=w> </span><span class=n>op</span>::<span class=n>POP</span><span class=p>,</span><span class=w> </span><span class=mh>0xff</span><span class=p>];</span>
</code></pre></div> <p>That are 8 bytes that consist of 6 instructions. Each instruction has a 1 byte opcode. Two of those instructions (the <code>PUSH_U8</code>) have one byte of argument each, making up the remaining two bytes of our program. Here they are listed:</p> <ol> <li><code>NOP</code></li> <li><code>PUSH_U8 [100]</code></li> <li><code>PUSH_U8 [77]</code></li> <li><code>ADD</code></li> <li><code>POP</code></li> <li><code>FIN</code></li> </ol> <p>The <code>NOP</code> does not do anything. I just put it in front of the program to let you see fetching, decoding, and executing without any effects:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-10-1 name=__codelineno-10-1 href=#__codelineno-10-1></a>VM { stack: [], pc: 0, op_cnt: 0 }
<a id=__codelineno-10-2 name=__codelineno-10-2 href=#__codelineno-10-2></a>Executing op 0x00
<a id=__codelineno-10-3 name=__codelineno-10-3 href=#__codelineno-10-3></a>  NOP
<a id=__codelineno-10-4 name=__codelineno-10-4 href=#__codelineno-10-4></a>VM { stack: [], pc: 1, op_cnt: 1 }
</code></pre></div> <p>We just increased the program counter by one (we advance one byte in the bytecode), and the operation counter counts this executed instruction. Let's look at the next instruction, that is more interesting:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-11-1 name=__codelineno-11-1 href=#__codelineno-11-1></a>VM { stack: [], pc: 1, op_cnt: 1 }
<a id=__codelineno-11-2 name=__codelineno-11-2 href=#__codelineno-11-2></a>Executing op 0x02
<a id=__codelineno-11-3 name=__codelineno-11-3 href=#__codelineno-11-3></a>  PUSH_U8
<a id=__codelineno-11-4 name=__codelineno-11-4 href=#__codelineno-11-4></a>  value: 100
<a id=__codelineno-11-5 name=__codelineno-11-5 href=#__codelineno-11-5></a>VM { stack: [100], pc: 3, op_cnt: 2 }
</code></pre></div> <p>Here the PC is increased by two. That happens, because we fetch an additional value from the bytecode. The op_cnt is only increased by one. And we now have our first value on the stack! It is the byte we read from the bytecode. Let's do that again:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-12-1 name=__codelineno-12-1 href=#__codelineno-12-1></a>VM { stack: [100], pc: 3, op_cnt: 2 }
<a id=__codelineno-12-2 name=__codelineno-12-2 href=#__codelineno-12-2></a>Executing op 0x02
<a id=__codelineno-12-3 name=__codelineno-12-3 href=#__codelineno-12-3></a>  PUSH_U8
<a id=__codelineno-12-4 name=__codelineno-12-4 href=#__codelineno-12-4></a>  value: 77
<a id=__codelineno-12-5 name=__codelineno-12-5 href=#__codelineno-12-5></a>VM { stack: [100, 77], pc: 5, op_cnt: 3 }
</code></pre></div> <p>Now there are two values on the stack! Time to do something with them. Let's add them up:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-13-1 name=__codelineno-13-1 href=#__codelineno-13-1></a>VM { stack: [100, 77], pc: 5, op_cnt: 3 }
<a id=__codelineno-13-2 name=__codelineno-13-2 href=#__codelineno-13-2></a>Executing op 0x10
<a id=__codelineno-13-3 name=__codelineno-13-3 href=#__codelineno-13-3></a>  ADD
<a id=__codelineno-13-4 name=__codelineno-13-4 href=#__codelineno-13-4></a>VM { stack: [177], pc: 6, op_cnt: 4 }
</code></pre></div> <p>Now there is only one value left on the stack, and it is the sum of the two values we had. There happened quite a lot here. The two values we had before where both popped from the stack (so it was shortly empty). The <code>add</code> operation adds them, and pushes their sum back on the stack. So now there is one value on the stack, and it is the result of our adding operation.</p> <p>What's next?</p> <div class=highlight><pre><span></span><code><a id=__codelineno-14-1 name=__codelineno-14-1 href=#__codelineno-14-1></a>VM { stack: [177], pc: 6, op_cnt: 4 }
<a id=__codelineno-14-2 name=__codelineno-14-2 href=#__codelineno-14-2></a>Executing op 0x01
<a id=__codelineno-14-3 name=__codelineno-14-3 href=#__codelineno-14-3></a>  POP
<a id=__codelineno-14-4 name=__codelineno-14-4 href=#__codelineno-14-4></a>  dropping value 177
<a id=__codelineno-14-5 name=__codelineno-14-5 href=#__codelineno-14-5></a>VM { stack: [], pc: 7, op_cnt: 5 }
</code></pre></div> <p>It is always nice to leave your workplace all tidied up, when you are done. We can do that by popping our result back from the stack, leaving it empty. And besides, our <code>POP</code> operation prints the value it drops. One more instruction to go:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-15-1 name=__codelineno-15-1 href=#__codelineno-15-1></a>VM { stack: [], pc: 7, op_cnt: 5 }
<a id=__codelineno-15-2 name=__codelineno-15-2 href=#__codelineno-15-2></a>Terminated!
<a id=__codelineno-15-3 name=__codelineno-15-3 href=#__codelineno-15-3></a>VM { stack: [], pc: 8, op_cnt: 6 }
</code></pre></div> <p>Well, not much happening there. Just stopping the VM, because we are done.</p> <h3 id=success>Success!<a class=headerlink href=#success title="Permanent link">&para;</a></h3> <p>So, we ran a program in a VM. Hooray, we are done. Only 132 lines of code, including excessive comments and logging. That was easy.</p> <p>Well yeah - it doesn't do much. But you can understand the root principle that makes up a stack machine. It's that simple. </p> <p>Go play around with it a bit. It is the best way to learn and to understand. I mean it! Write a longer program. What happens to the stack? Add another opcode &ndash; how about subtraction? Will your program execute at all? What happens, if it does not?</p> <h2 id=turn-fragile-into-rusty>Turn "fragile" into "rusty"<a class=headerlink href=#turn-fragile-into-rusty title="Permanent link">&para;</a></h2> <p><strong>After we got our Proof of Concept running, we clean up our code and make it look like a respectable Rust program.</strong></p> <aside class=mdx-author> <p><img alt=@kratenko src=https://avatars.githubusercontent.com/kratenko></p> <p><span><strong>kratenko</strong> · <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 16 16"><path fill-rule=evenodd d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"/></svg></span> <a href=https://github.com/kratenko>kratenko</a></span> <span> <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path fill-rule=evenodd d="M6.75 0a.75.75 0 0 1 .75.75V3h9V.75a.75.75 0 0 1 1.5 0V3h2.75c.966 0 1.75.784 1.75 1.75v16a1.75 1.75 0 0 1-1.75 1.75H3.25a1.75 1.75 0 0 1-1.75-1.75v-16C1.5 3.784 2.284 3 3.25 3H6V.75A.75.75 0 0 1 6.75 0zm-3.5 4.5a.25.25 0 0 0-.25.25V8h18V4.75a.25.25 0 0 0-.25-.25H3.25zM21 9.5H3v11.25c0 .138.112.25.25.25h17.5a.25.25 0 0 0 .25-.25V9.5z"/></svg></span> 2022-07-14 · <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path fill-rule=evenodd d="M0 3.75A.75.75 0 0 1 .75 3h7.497c1.566 0 2.945.8 3.751 2.014A4.496 4.496 0 0 1 15.75 3h7.5a.75.75 0 0 1 .75.75v15.063a.75.75 0 0 1-.755.75l-7.682-.052a3 3 0 0 0-2.142.878l-.89.891a.75.75 0 0 1-1.061 0l-.902-.901a3 3 0 0 0-2.121-.879H.75a.75.75 0 0 1-.75-.75v-15zm11.247 3.747a3 3 0 0 0-3-2.997H1.5V18h6.947a4.5 4.5 0 0 1 2.803.98l-.003-11.483zm1.503 11.485V7.5a3 3 0 0 1 3-3h6.75v13.558l-6.927-.047a4.5 4.5 0 0 0-2.823.971z"/></svg></span> Entry #13 · <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12.5 7.25a.75.75 0 0 0-1.5 0v5.5c0 .27.144.518.378.651l3.5 2a.75.75 0 0 0 .744-1.302L12.5 12.315V7.25z"/><path fill-rule=evenodd d="M12 1C5.925 1 1 5.925 1 12s4.925 11 11 11 11-4.925 11-11S18.075 1 12 1zM2.5 12a9.5 9.5 0 1 1 19 0 9.5 9.5 0 0 1-19 0z"/></svg></span> 2 min read </span></p> </aside> <hr> <p>Did you play around with the program from the previous post? If you are new to Rust, you really should! At least mess around with our bytecode. You should find, that our VM does not react well to errors, yet. It simply panics! That is no behaviour for a respectable rust program.</p> <p>We will make it more rusty, look at the enhanced version:</p> <p>Repo: <a href=https://github.com/kratenko/lovem/tree/v0.0.2-journey>https://github.com/kratenko/lovem/tree/v0.0.2-journey</a></p> <p>main.rs: <a href=https://github.com/kratenko/lovem/blob/v0.0.2-journey/src/main.rs>https://github.com/kratenko/lovem/blob/v0.0.2-journey/src/main.rs</a></p> <p>If you do not know your way around Rust, some of those things will be difficult to understand. It might be time to read up on some Rust, if you intend to follow my journey onwards. I will not explain everything here, but I will give you some leads right now, if you want to understand the things I did in that change.</p> <h3 id=it-is-all-in-the-enums>It is all in the enums<a class=headerlink href=#it-is-all-in-the-enums title="Permanent link">&para;</a></h3> <p>The most important thing to understand for you will be <em>Enums</em>. Yeah, I know. That is what I thought at first learning Rust. "I know enums. Yeah, they are handy and useful, but what could be so interesting about them?"</p> <p>Well, in fact, enums in Rust completely change the way you are writing code. They are such an important part of the language that they have an impact on just about every part of it.</p> <p>I introduced an enum to the code:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-16-1 name=__codelineno-16-1 href=#__codelineno-16-1></a>#<span class=cp>#[derive(Debug, Clone, PartialEq)]</span>
<a id=__codelineno-16-2 name=__codelineno-16-2 href=#__codelineno-16-2></a><span class=k>pub</span><span class=w> </span><span class=k>enum</span> <span class=nc>RuntimeError</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-16-3 name=__codelineno-16-3 href=#__codelineno-16-3></a><span class=w>    </span><span class=n>EndOfProgram</span><span class=p>,</span>
<a id=__codelineno-16-4 name=__codelineno-16-4 href=#__codelineno-16-4></a><span class=w>    </span><span class=n>InvalidOperation</span><span class=p>(</span><span class=kt>u8</span><span class=p>),</span>
<a id=__codelineno-16-5 name=__codelineno-16-5 href=#__codelineno-16-5></a><span class=w>    </span><span class=n>StackUnderflow</span><span class=p>,</span>
<a id=__codelineno-16-6 name=__codelineno-16-6 href=#__codelineno-16-6></a><span class=w>    </span><span class=n>StackOverflow</span><span class=p>,</span>
<a id=__codelineno-16-7 name=__codelineno-16-7 href=#__codelineno-16-7></a><span class=p>}</span>
</code></pre></div> <p>It is obviously a datatype to communicate runtime errors of different nature. And I use it a bit like you would exceptions in some other languages. Nevermind the <code>#[derive...]</code> part for now. That is just for fancy debug output (and a bit more). Once you understand <a href=https://github.com/kratenko/lovem/blob/9d97281bd6ffdae894f8052c91ea32d1d761fdb2/src/main.rs#L33>line 33</a>: <code>InvalidOperation(u8),</code>, you are on the right track! To put it into easy terms: values of enums in Rust can hold additional values. And, as you see in our <code>RuntimeError</code>, not all values have to hold the same kind of additional value, or a value at all. This is, what makes enums really powerful.</p> <p>If you know what happens in the return type of fn <code>push</code> in <a href=https://github.com/kratenko/lovem/blob/9d97281bd6ffdae894f8052c91ea32d1d761fdb2/src/main.rs#L70>line 70</a>, you are golden. The <code>Result</code> type can communicate a value on success or an error condition on failure. The great difference to typical exceptions form other languages is, that there is no special way to pass on the errors, as with exceptions that are thrown. It is just your normal <code>return</code> statement used. And this is done, you guessed it, with enums. If you want to read up on <code>Result</code>, try understanding <code>Option</code> first. I am using that in my code, even though you cannot see it.</p> <p>If you are wondering now about the return of fn <code>push</code>, that does not have a <code>return</code> statement to be seen, you should find out, while some of my lines do not have a semicolon <code>;</code> at the end, while most do. </p> <p>And then there is that tiny <code>?</code> in <a href=https://github.com/kratenko/lovem/blob/9d97281bd6ffdae894f8052c91ea32d1d761fdb2/src/main.rs#L101>line 101</a>.</p> <p>Also find out what happens in the <code>match</code> in [line 166][line166]. It might help if you start with the <code>if let</code> statement.</p> <p>Bonus points: <a href=https://github.com/kratenko/lovem/blob/9d97281bd6ffdae894f8052c91ea32d1d761fdb2/src/main.rs#L66>line 66</a>. If that is clear to you, you need have no worries, you are into enums and how to use them</p> <h3 id=homework>Homework<a class=headerlink href=#homework title="Permanent link">&para;</a></h3> <p>So, this is what will get you through a lot here. Try to understand those in the given order:</p> <ol> <li><code>Option</code></li> <li><code>Some(v)</code> vs. <code>None</code></li> <li><code>Result&lt;v, e&gt;</code></li> <li><code>Ok(v)</code> vs. <code>Err(e)</code></li> <li><code>if let Some(v) =</code></li> <li><code>match</code></li> <li><code>Result&lt;(), e&gt;</code></li> <li><code>Ok(())</code></li> <li><code>unwrap()</code></li> <li><code>?</code></li> <li>Bonus: <code>ok()</code>, <code>ok_or()</code>, and their likes</li> </ol> <p>If you understand for each of those, and why I put them in the list, you are prepared to handle most Rust things I will be doing in the next time. If you have problems with parts of it, still, move on. It gets better after a while, when you use them.</p> <h2 id=becoming-social>Becoming social<a class=headerlink href=#becoming-social title="Permanent link">&para;</a></h2> <p><strong>A new way for you to participate in my journey.</strong></p> <aside class=mdx-author> <p><img alt=@kratenko src=https://avatars.githubusercontent.com/kratenko></p> <p><span><strong>kratenko</strong> · <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 16 16"><path fill-rule=evenodd d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"/></svg></span> <a href=https://github.com/kratenko>kratenko</a></span> <span> <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path fill-rule=evenodd d="M6.75 0a.75.75 0 0 1 .75.75V3h9V.75a.75.75 0 0 1 1.5 0V3h2.75c.966 0 1.75.784 1.75 1.75v16a1.75 1.75 0 0 1-1.75 1.75H3.25a1.75 1.75 0 0 1-1.75-1.75v-16C1.5 3.784 2.284 3 3.25 3H6V.75A.75.75 0 0 1 6.75 0zm-3.5 4.5a.25.25 0 0 0-.25.25V8h18V4.75a.25.25 0 0 0-.25-.25H3.25zM21 9.5H3v11.25c0 .138.112.25.25.25h17.5a.25.25 0 0 0 .25-.25V9.5z"/></svg></span> 2022-07-15 · <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path fill-rule=evenodd d="M0 3.75A.75.75 0 0 1 .75 3h7.497c1.566 0 2.945.8 3.751 2.014A4.496 4.496 0 0 1 15.75 3h7.5a.75.75 0 0 1 .75.75v15.063a.75.75 0 0 1-.755.75l-7.682-.052a3 3 0 0 0-2.142.878l-.89.891a.75.75 0 0 1-1.061 0l-.902-.901a3 3 0 0 0-2.121-.879H.75a.75.75 0 0 1-.75-.75v-15zm11.247 3.747a3 3 0 0 0-3-2.997H1.5V18h6.947a4.5 4.5 0 0 1 2.803.98l-.003-11.483zm1.503 11.485V7.5a3 3 0 0 1 3-3h6.75v13.558l-6.927-.047a4.5 4.5 0 0 0-2.823.971z"/></svg></span> Entry #14 · <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12.5 7.25a.75.75 0 0 0-1.5 0v5.5c0 .27.144.518.378.651l3.5 2a.75.75 0 0 0 .744-1.302L12.5 12.315V7.25z"/><path fill-rule=evenodd d="M12 1C5.925 1 1 5.925 1 12s4.925 11 11 11 11-4.925 11-11S18.075 1 12 1zM2.5 12a9.5 9.5 0 1 1 19 0 9.5 9.5 0 0 1-19 0z"/></svg></span> &lt; 1 min read </span></p> </aside> <hr> <p>After a few days of progress on the project itself, I spent a bit of time on the site again. We have the fancy link to our GitHub repo in the upper right corner now. But more important, I added support for comments on my entries. You can now react and ask questions or share your thought.</p> <p>I am using <a href=https://giscus.app>giscus.app</a> (and, again, I copied that idea from <a class="magiclink magiclink-github magiclink-mention" href=https://github.com/squidfunk title="GitHub User: squidfunk">@squidfunk</a> and their site on <a href=https://squidfunk.github.io/mkdocs-material/ >mkdocs-material</a>, which is what I did for this complete site, more or less). Giscus is an open source app that stores the comments completely inside GitHub discussions, so the content is stored along the <em>lovem</em> repository and at the one place where everything is stored already anyway. If you want to participate in the comments, you need to log in using your GitHub account. That is great, because I don't need to care about user management, nor about any database.</p> <p>Feel free to use this entry to try out the new feature, because that is what I am gonna do!</p> <h2 id=to-the-library>To the library!<a class=headerlink href=#to-the-library title="Permanent link">&para;</a></h2> <p><strong>We turn our project from a binary project into a library project.</strong></p> <aside class=mdx-author> <p><img alt=@kratenko src=https://avatars.githubusercontent.com/kratenko></p> <p><span><strong>kratenko</strong> · <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 16 16"><path fill-rule=evenodd d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"/></svg></span> <a href=https://github.com/kratenko>kratenko</a></span> <span> <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path fill-rule=evenodd d="M6.75 0a.75.75 0 0 1 .75.75V3h9V.75a.75.75 0 0 1 1.5 0V3h2.75c.966 0 1.75.784 1.75 1.75v16a1.75 1.75 0 0 1-1.75 1.75H3.25a1.75 1.75 0 0 1-1.75-1.75v-16C1.5 3.784 2.284 3 3.25 3H6V.75A.75.75 0 0 1 6.75 0zm-3.5 4.5a.25.25 0 0 0-.25.25V8h18V4.75a.25.25 0 0 0-.25-.25H3.25zM21 9.5H3v11.25c0 .138.112.25.25.25h17.5a.25.25 0 0 0 .25-.25V9.5z"/></svg></span> 2022-07-18 · <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path fill-rule=evenodd d="M0 3.75A.75.75 0 0 1 .75 3h7.497c1.566 0 2.945.8 3.751 2.014A4.496 4.496 0 0 1 15.75 3h7.5a.75.75 0 0 1 .75.75v15.063a.75.75 0 0 1-.755.75l-7.682-.052a3 3 0 0 0-2.142.878l-.89.891a.75.75 0 0 1-1.061 0l-.902-.901a3 3 0 0 0-2.121-.879H.75a.75.75 0 0 1-.75-.75v-15zm11.247 3.747a3 3 0 0 0-3-2.997H1.5V18h6.947a4.5 4.5 0 0 1 2.803.98l-.003-11.483zm1.503 11.485V7.5a3 3 0 0 1 3-3h6.75v13.558l-6.927-.047a4.5 4.5 0 0 0-2.823.971z"/></svg></span> Entry #15 · <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12.5 7.25a.75.75 0 0 0-1.5 0v5.5c0 .27.144.518.378.651l3.5 2a.75.75 0 0 0 .744-1.302L12.5 12.315V7.25z"/><path fill-rule=evenodd d="M12 1C5.925 1 1 5.925 1 12s4.925 11 11 11 11-4.925 11-11S18.075 1 12 1zM2.5 12a9.5 9.5 0 1 1 19 0 9.5 9.5 0 0 1-19 0z"/></svg></span> 5 min read · <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M7.75 6.5a1.25 1.25 0 1 0 0 2.5 1.25 1.25 0 0 0 0-2.5z"/><path fill-rule=evenodd d="M2.5 1A1.5 1.5 0 0 0 1 2.5v8.44c0 .397.158.779.44 1.06l10.25 10.25a1.5 1.5 0 0 0 2.12 0l8.44-8.44a1.5 1.5 0 0 0 0-2.12L12 1.44A1.5 1.5 0 0 0 10.94 1H2.5zm0 1.5h8.44l10.25 10.25-8.44 8.44L2.5 10.94V2.5z"/></svg></span> <a href=https://github.com/kratenko/lovem/releases/tag/v0.0.3-journey>v0.0.3-journey</a> </span></p> </aside> <hr> <p>So far, our lovem cargo project holds a single binary. That is not very useful for something that should be integrated into other projects. What we need is a <em>library</em>. How is that done? Simple: we rename our <code>main.rs</code> to <code>lib.rs</code>.</p> <h3 id=no-main>No main?<a class=headerlink href=#no-main title="Permanent link">&para;</a></h3> <p>But wait? What about <code>fn main()</code>? We do not need that inside a library. But it would be nice to still have some code that we can execute, right? Well, no problem. Your cargo project can only hold a single library, but it can hold even multiple binaries, each with its own <code>fn main()</code>. Just stuff them in the <code>bin</code> subdir. </p> <h3 id=project-layout>Project layout<a class=headerlink href=#project-layout title="Permanent link">&para;</a></h3> <p>While we are at it, I split the project up into multiple source files, to get it organised. It is small, still, but we will have it grow, soon. Here is, what we are at now:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-17-1 name=__codelineno-17-1 href=#__codelineno-17-1></a>lovem/
<a id=__codelineno-17-2 name=__codelineno-17-2 href=#__codelineno-17-2></a>  src/
<a id=__codelineno-17-3 name=__codelineno-17-3 href=#__codelineno-17-3></a>    bin/
<a id=__codelineno-17-4 name=__codelineno-17-4 href=#__codelineno-17-4></a>      test-run.rs
<a id=__codelineno-17-5 name=__codelineno-17-5 href=#__codelineno-17-5></a>    lib.rs
<a id=__codelineno-17-6 name=__codelineno-17-6 href=#__codelineno-17-6></a>    op.rs
<a id=__codelineno-17-7 name=__codelineno-17-7 href=#__codelineno-17-7></a>    vm.rs
<a id=__codelineno-17-8 name=__codelineno-17-8 href=#__codelineno-17-8></a>  .gitignore
<a id=__codelineno-17-9 name=__codelineno-17-9 href=#__codelineno-17-9></a>  Cargo.toml
</code></pre></div> <p>We skip <code>.gitignore</code>. If you don't know what it is, <a href="https://www.google.com/search?q=.gitignore">google <code>.gitignore</code></a>.</p> <h4 id=cargotoml>Cargo.toml<a class=headerlink href=#cargotoml title="Permanent link">&para;</a></h4> <p>So <code>Cargo.toml</code> holds information about our cargo project. There is not much of interest there currently:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-18-1 name=__codelineno-18-1 href=#__codelineno-18-1></a><span class=k>[package]</span>
<a id=__codelineno-18-2 name=__codelineno-18-2 href=#__codelineno-18-2></a><span class=n>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;lovem&quot;</span>
<a id=__codelineno-18-3 name=__codelineno-18-3 href=#__codelineno-18-3></a><span class=n>version</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;0.0.3&quot;</span>
<a id=__codelineno-18-4 name=__codelineno-18-4 href=#__codelineno-18-4></a><span class=n>edition</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;2021&quot;</span>
<a id=__codelineno-18-5 name=__codelineno-18-5 href=#__codelineno-18-5></a><span class=n>authors</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=s2>&quot;kratenko&quot;</span><span class=p>]</span>
<a id=__codelineno-18-6 name=__codelineno-18-6 href=#__codelineno-18-6></a>
<a id=__codelineno-18-7 name=__codelineno-18-7 href=#__codelineno-18-7></a><span class=k>[dependencies]</span>
</code></pre></div> <p>The only real configuration in that file is <code>edition = "2021"</code>. Rust has a major edition release every three years. These are used to introduce braking changes. You have to specify the edition you use explicitly, and there are migration guides. We use the most recent one, <code>2021</code>.</p> <h4 id=librs>lib.rs<a class=headerlink href=#librs title="Permanent link">&para;</a></h4> <p>Rust manages projects by using default project layouts. That is why we need not write a lot into the <code>Cargo.toml</code>. The <code>src</code> directory holds our source code. The fact that it holds a <code>lib.rs</code> makes it a library, and <code>lib.rs</code> is the entry point. This is what is in it:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-19-1 name=__codelineno-19-1 href=#__codelineno-19-1></a><span class=k>pub</span><span class=w> </span><span class=k>mod</span> <span class=nn>op</span><span class=p>;</span>
<a id=__codelineno-19-2 name=__codelineno-19-2 href=#__codelineno-19-2></a><span class=k>pub</span><span class=w> </span><span class=k>mod</span> <span class=nn>vm</span><span class=p>;</span>
<a id=__codelineno-19-3 name=__codelineno-19-3 href=#__codelineno-19-3></a>
<a id=__codelineno-19-4 name=__codelineno-19-4 href=#__codelineno-19-4></a><span class=c1>// re-export main types</span>
<a id=__codelineno-19-5 name=__codelineno-19-5 href=#__codelineno-19-5></a><span class=k>pub</span><span class=w> </span><span class=k>use</span><span class=w> </span><span class=k>crate</span>::<span class=n>vm</span>::<span class=n>VM</span><span class=p>;</span>
</code></pre></div> <p>Really not a lot. It declares the two modules <code>op</code> and <code>vm</code> and makes them public. So, whatever rust project will be using our library will have access to those modules. The modules will be in the files <code>op.rs</code> and <code>vm.rs</code>. What a coincidence, that are exactly the remaining two source files in this directory!</p> <p>The last line just re-exports a symbol from one of those submodules, so that programs using our library can access more easily. Will will be doing that in our binary.</p> <h4 id=oprs>op.rs<a class=headerlink href=#oprs title="Permanent link">&para;</a></h4> <p>Back in <a href=https://github.com/kratenko/lovem/blob/v0.0.2-journey/src/main.rs><code>v0.0.2-journey</code></a>, we already had a module called <code>op</code> to hold the opcodes. We had it stuffed in our <code>main.rs</code>. Now it lives in a separate file, so we do not have to scroll over it every time.</p> <h4 id=vmrs>vm.rs<a class=headerlink href=#vmrs title="Permanent link">&para;</a></h4> <p>This holds the rest of our source code (except for <code>fn main()</code> which has no place in a lib). The only new thing, compared with our former <code>main.rs</code> is the first line:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-20-1 name=__codelineno-20-1 href=#__codelineno-20-1></a><span class=k>use</span><span class=w> </span><span class=k>crate</span>::<span class=n>op</span><span class=p>;</span>
</code></pre></div> <p>This simply pulls the module <code>op</code> into the namespace of this module, so that we can access our opcode constants as we did before. The rest remains the way we already know.</p> <h4 id=bintest-runrs>bin/test-run.rs<a class=headerlink href=#bintest-runrs title="Permanent link">&para;</a></h4> <p>So how do we use our lib in a project? That is best illustrated by doing it. And we can do so inside our project itself, because we can add binaries. Just put a Rust source file with a <code>fn main()</code> inside the <code>bin</code> subdir. There we can write a binary as we would in a separate project, that can use the lib.</p> <p>We did that in the file <code>test-run.rs</code>:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-21-1 name=__codelineno-21-1 href=#__codelineno-21-1></a><span class=k>use</span><span class=w> </span><span class=n>lovem</span>::<span class=p>{</span><span class=n>op</span><span class=p>,</span><span class=w> </span><span class=n>VM</span><span class=p>};</span>
<a id=__codelineno-21-2 name=__codelineno-21-2 href=#__codelineno-21-2></a>
<a id=__codelineno-21-3 name=__codelineno-21-3 href=#__codelineno-21-3></a><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-21-4 name=__codelineno-21-4 href=#__codelineno-21-4></a><span class=w>    </span><span class=c1>// Create a program in bytecode.</span>
<a id=__codelineno-21-5 name=__codelineno-21-5 href=#__codelineno-21-5></a><span class=w>    </span><span class=c1>// We just hardcode the bytes in an array here:</span>
<a id=__codelineno-21-6 name=__codelineno-21-6 href=#__codelineno-21-6></a><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>pgm</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=n>op</span>::<span class=n>NOP</span><span class=p>,</span><span class=w> </span><span class=n>op</span>::<span class=n>PUSH_U8</span><span class=p>,</span><span class=w> </span><span class=mi>100</span><span class=p>,</span><span class=w> </span><span class=n>op</span>::<span class=n>PUSH_U8</span><span class=p>,</span><span class=w> </span><span class=mi>77</span><span class=p>,</span><span class=w> </span><span class=n>op</span>::<span class=n>ADD</span><span class=p>,</span><span class=w> </span><span class=n>op</span>::<span class=n>POP</span><span class=p>,</span><span class=w> </span><span class=mh>0xff</span><span class=p>];</span>
<a id=__codelineno-21-7 name=__codelineno-21-7 href=#__codelineno-21-7></a><span class=w>    </span><span class=c1>// Crate our VM instance.</span>
<a id=__codelineno-21-8 name=__codelineno-21-8 href=#__codelineno-21-8></a><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>vm</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>VM</span>::<span class=n>new</span><span class=p>(</span><span class=mi>100</span><span class=p>);</span>
<a id=__codelineno-21-9 name=__codelineno-21-9 href=#__codelineno-21-9></a><span class=w>    </span><span class=c1>// Execute the program in our VM:</span>
<a id=__codelineno-21-10 name=__codelineno-21-10 href=#__codelineno-21-10></a><span class=w>    </span><span class=k>match</span><span class=w> </span><span class=n>vm</span><span class=p>.</span><span class=n>run</span><span class=p>(</span><span class=o>&amp;</span><span class=n>pgm</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-21-11 name=__codelineno-21-11 href=#__codelineno-21-11></a><span class=w>        </span><span class=nb>Ok</span><span class=p>(</span><span class=n>_</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-21-12 name=__codelineno-21-12 href=#__codelineno-21-12></a><span class=w>            </span><span class=fm>println!</span><span class=p>(</span><span class=s>&quot;Execution successful.&quot;</span><span class=p>)</span>
<a id=__codelineno-21-13 name=__codelineno-21-13 href=#__codelineno-21-13></a><span class=w>        </span><span class=p>}</span>
<a id=__codelineno-21-14 name=__codelineno-21-14 href=#__codelineno-21-14></a><span class=w>        </span><span class=nb>Err</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-21-15 name=__codelineno-21-15 href=#__codelineno-21-15></a><span class=w>            </span><span class=fm>println!</span><span class=p>(</span><span class=s>&quot;Error during execution: {:?}&quot;</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span>
<a id=__codelineno-21-16 name=__codelineno-21-16 href=#__codelineno-21-16></a><span class=w>        </span><span class=p>}</span>
<a id=__codelineno-21-17 name=__codelineno-21-17 href=#__codelineno-21-17></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-21-18 name=__codelineno-21-18 href=#__codelineno-21-18></a><span class=p>}</span>
</code></pre></div> <p>This is the <code>fn main()</code> function from our former <code>main.rs</code>. Instead of having all the functions and definitions, it just has this single line at the top: </p> <div class=highlight><pre><span></span><code><a id=__codelineno-22-1 name=__codelineno-22-1 href=#__codelineno-22-1></a><span class=k>use</span><span class=w> </span><span class=n>lovem</span>::<span class=p>{</span><span class=n>op</span><span class=p>,</span><span class=w> </span><span class=n>VM</span><span class=p>};</span>
</code></pre></div> <p>Nothing too complicated. It tells the compiler, that our program uses the library called <code>lovem</code> (which is, of course, the one we are writing ourselves here). It also tells it to bring the two symbols <code>op</code> and <code>VM</code> from it into our namespace.</p> <p>The <code>op</code> one is simply the module <code>op</code> defined in <code>op.rs</code>. Because <code>lib.rs</code> declares the module public, we can access it from here. <code>VM</code> does not refer to the module in <code>vm.rs</code>, as that module is called <code>vm</code> (in lower case). <code>VM</code> is actually the struct we defined in <code>vm</code>, that we use to hold the state of our Virtual Machine.</p> <p>We could include the struct as <code>lovem::vm::VM</code>, which is its full path. But I find that a bit anoying, as <code>VM</code> is the main type of our whole library. We will always be using that. So I re-exported it in <code>lib.rs</code>. Remember the line <code>pub use crate::vm::VM;</code>? That's what it did.</p> <h3 id=running-the-binary>Running the binary<a class=headerlink href=#running-the-binary title="Permanent link">&para;</a></h3> <p>So, how do we run our program now? Back in <code>v0.0.2-journey</code> we simply called <code>cargo run</code>. That actually still works, as long as we have exactly one binary.</p> <p>But we can have multiple binaries inside our project. If we do, we need to tell cargo which it should run. That can easily be done:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-23-1 name=__codelineno-23-1 href=#__codelineno-23-1></a>cargo<span class=w> </span>run<span class=w> </span>--bin<span class=w> </span>test-run
</code></pre></div> <p>The parameter to <code>--bin</code> is the name of the file inside <code>bin</code>, without the <code>.rs</code>. And no configuration is needed anywhere, it works by convention of project layout. </p> <h3 id=homework_1>Homework<a class=headerlink href=#homework_1 title="Permanent link">&para;</a></h3> <p>What, homework again? Yeah, why not. If it fits, I might keep adding ideas for you to play around with. Doing things yourself is understanding. Stuff we just read, we tend to forget. So here is what might help you understand the project layout stuff I was writing about:</p> <p>Add a second binary, that runs a different program in the VM (with different bytecode). You have all the knowledge to do so. And then run it with cargo. </p> <h3 id=source-code>Source code<a class=headerlink href=#source-code title="Permanent link">&para;</a></h3> <p>In earlier posts I included explicit links to the source code at the time of writing. That got annoying to do really fast. So I added a new feature to my <code>blogem.py</code> that I use to write this journal. Entries like this, that are explaining a specific state of the source of lovem will have a <em>tag</em> from now on. This corresponds to a tag inside the git repository, as it did in earlier posts. You will find it in the card at the top of the post (where you see the publishing date and the author). It is prefixed with a little tag image. For this post it looks like this:</p> <p><span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M7.75 6.5a1.25 1.25 0 1 0 0 2.5 1.25 1.25 0 0 0 0-2.5z"/><path fill-rule=evenodd d="M2.5 1A1.5 1.5 0 0 0 1 2.5v8.44c0 .397.158.779.44 1.06l10.25 10.25a1.5 1.5 0 0 0 2.12 0l8.44-8.44a1.5 1.5 0 0 0 0-2.12L12 1.44A1.5 1.5 0 0 0 10.94 1H2.5zm0 1.5h8.44l10.25 10.25-8.44 8.44L2.5 10.94V2.5z"/></svg></span> <a href=https://github.com/kratenko/lovem/releases/tag/v0.0.3-journey>v0.0.3-journey</a></p> <p>At the bottom of the entry (if you view it in the entry page, not in the "whole month" page), you will find it again with a list of links that help you access the source in different ways. The best way to work with the code, is to clone the repository and simply check out the tag. I also added a page on this site, explaining how you do that. You can find it under <a href=../source-code.html>Source Code</a>. </p> <p>So, in future I will not be adding explicit links, only this implicit ones. And there will be a link to the explaining page at the bottom. This should be convenient for both, you and me.</p> <h2 id=early-vm-decisions>Early VM decisions<a class=headerlink href=#early-vm-decisions title="Permanent link">&para;</a></h2> <p><strong>Many design decisions must be made for lovem. Here I talk about some of those in the current state.</strong></p> <aside class=mdx-author> <p><img alt=@kratenko src=https://avatars.githubusercontent.com/kratenko></p> <p><span><strong>kratenko</strong> · <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 16 16"><path fill-rule=evenodd d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"/></svg></span> <a href=https://github.com/kratenko>kratenko</a></span> <span> <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path fill-rule=evenodd d="M6.75 0a.75.75 0 0 1 .75.75V3h9V.75a.75.75 0 0 1 1.5 0V3h2.75c.966 0 1.75.784 1.75 1.75v16a1.75 1.75 0 0 1-1.75 1.75H3.25a1.75 1.75 0 0 1-1.75-1.75v-16C1.5 3.784 2.284 3 3.25 3H6V.75A.75.75 0 0 1 6.75 0zm-3.5 4.5a.25.25 0 0 0-.25.25V8h18V4.75a.25.25 0 0 0-.25-.25H3.25zM21 9.5H3v11.25c0 .138.112.25.25.25h17.5a.25.25 0 0 0 .25-.25V9.5z"/></svg></span> 2022-07-19 · <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path fill-rule=evenodd d="M0 3.75A.75.75 0 0 1 .75 3h7.497c1.566 0 2.945.8 3.751 2.014A4.496 4.496 0 0 1 15.75 3h7.5a.75.75 0 0 1 .75.75v15.063a.75.75 0 0 1-.755.75l-7.682-.052a3 3 0 0 0-2.142.878l-.89.891a.75.75 0 0 1-1.061 0l-.902-.901a3 3 0 0 0-2.121-.879H.75a.75.75 0 0 1-.75-.75v-15zm11.247 3.747a3 3 0 0 0-3-2.997H1.5V18h6.947a4.5 4.5 0 0 1 2.803.98l-.003-11.483zm1.503 11.485V7.5a3 3 0 0 1 3-3h6.75v13.558l-6.927-.047a4.5 4.5 0 0 0-2.823.971z"/></svg></span> Entry #16 · <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12.5 7.25a.75.75 0 0 0-1.5 0v5.5c0 .27.144.518.378.651l3.5 2a.75.75 0 0 0 .744-1.302L12.5 12.315V7.25z"/><path fill-rule=evenodd d="M12 1C5.925 1 1 5.925 1 12s4.925 11 11 11 11-4.925 11-11S18.075 1 12 1zM2.5 12a9.5 9.5 0 1 1 19 0 9.5 9.5 0 0 1-19 0z"/></svg></span> 3 min read · <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M7.75 6.5a1.25 1.25 0 1 0 0 2.5 1.25 1.25 0 0 0 0-2.5z"/><path fill-rule=evenodd d="M2.5 1A1.5 1.5 0 0 0 1 2.5v8.44c0 .397.158.779.44 1.06l10.25 10.25a1.5 1.5 0 0 0 2.12 0l8.44-8.44a1.5 1.5 0 0 0 0-2.12L12 1.44A1.5 1.5 0 0 0 10.94 1H2.5zm0 1.5h8.44l10.25 10.25-8.44 8.44L2.5 10.94V2.5z"/></svg></span> <a href=https://github.com/kratenko/lovem/releases/tag/v0.0.3-journey>v0.0.3-journey</a> </span></p> </aside> <hr> <p>I have shared and discussed source code in the recent posts. Now it is time again, to write about design decisions. I made a few of them for the code you saw. So far I have not been reasoning about those here, and some of you might have wondered already. Let's talk about them.</p> <p>Let me remind you: <em>lovem</em> is a research project for myself. And an education project for myself as well. None of my choices at this stage are set into stone. I <em>will</em> make lots of mistakes that I will be changing later. I even choose some paths, that I know I will be leaving again. I might just take any solution for a problem, at this stage, as I do not know, what is the right choice. So start somewhere, see where it goes. Some of those are deliberately weird or bad choices, but they make things clearer or simpler at this stage. </p> <p>Let us address two of those choices you can find in the current source code.</p> <h3 id=word-size>Word size<a class=headerlink href=#word-size title="Permanent link">&para;</a></h3> <p>I talked about register sizes defining architecture, back in <a href=what-is-a-virtual-machine-anyway.html>What is a Virtual Machine anyway?</a>. And then I went totally silent about that topic and just used <code>i64</code> as type for my stack. Is that a good idea? I used it for simplicity. The idea goes back to when I was experimenting with using a register machine for lovem. Having a simple datatype that can handle big values seems simple. After all, other languages/VMs use some version of <em>float</em> as their single numeric datatype:</p> <p><strong>JavaScript</strong></p> <blockquote> <p><strong>JavaScript Numbers are Always 64-bit Floating Point</strong></p> <p>Unlike many other programming languages, JavaScript does not define different types of numbers, like integers, short, long, floating-point etc.</p> <p>JavaScript numbers are always stored as double precision floating point numbers, following the international IEEE 754 standard.</p> <p>&mdash; <cite><a href=https://www.w3schools.com/js/js_numbers.asp>w3schools.com</a> - retrieved 2022-07-11 </cite></p> </blockquote> <p><strong>Lua</strong></p> <blockquote> <p><strong>2.3 - Numbers</strong></p> <p>The number type represents real (double-precision floating-point) numbers. Lua has no integer type, as it does not need it.</p> <p>&mdash; <cite><a href=https://www.lua.org/pil/2.3.html>Programming in Lua</a> - retrieved 2022-07-11</p> </blockquote> <p>Well, reducing complexity is good. But having each little number you use in your programs eat up 8 bytes of memory does not sound low overhead to me. And that is, after all, the goal. So I guess, that will change in the future. But let's keep it for the time being. There will be some interesting things we will be doing in the near future; even if we might dump those features later. I already implemented them during the early phase (when I was not writing a public journal), so not adding them here would be insincere. Having 64 bit values is a part of our journey.</p> <h3 id=opargs>Opargs<a class=headerlink href=#opargs title="Permanent link">&para;</a></h3> <p>I have no glossary, yet, so you have to live with me inventing terms on the spot. I used that word in the source code already. What I mean by it, are the arguments to an instruction inside the bytecode, that follow the opcode and influence the operation. They are the arguments you give inside your program's code.</p> <p>As of <code>v0.0.3-journey</code> we only have a single opcode that takes an oparg, and that is <code>push_u8</code>. You can see how there is a <code>fetch_u8()</code> instruction in the code that handles that operation, and none in the other operations. See <a href=https://github.com/kratenko/lovem/blob/42b373bccf7e761626d424fb9ba8252108805d9d/src/vm.rs#L95><code>execute_op</code></a>. </p> <p>So we have different behaviour depending on the opcode. <code>push_u8</code> fetches an additional byte from the bytecode, the other opcodes do not. Existing VMs handle this differently. The Java VM, for example, has a dynamic number of opargs, too. They call them <em>operands</em>:</p> <blockquote> <p><em>2.11. Instruction Set Summary</em></p> <p>A Java Virtual Machine instruction consists of a one-byte opcode specifying the operation to be performed, followed by zero or more operands supplying arguments or data that are used by the operation. Many instructions have no operands and consist only of an opcode. </p> <p>&mdash; <cite><a href=https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-2.html#jvms-2.11>The Java® Virtual Machine Specification - Java SE 8 Edition</a> - retrieved&nbsp;2022-07-11</cite></p> </blockquote> <p>The Python VM on the other hand, uses exactly one byte as oparg on all instructions </p> <blockquote> <p>The bytecode can be thought of as a series of instructions or a low-level program for the Python interpreter. After version 3.6, Python uses 2 bytes for each instruction. One byte is for the code of that instruction which is called an <em>opcode</em>, and one byte is reserved for its argument which is called the <em>oparg</em>.</p> <p>[...]</p> <p>Some instructions do not need an argument, so they ignore the byte after the opcode. The opcodes which have a value below a certain number ignore their argument. This value is stored in <code>dis.HAVE_ARGUMENT</code> and is currently equal to 90. So the opcodes &gt;=<code>dis.HAVE_ARGUMENT</code> have an argument, and the opcodes &lt; <code>dis.HAVE_ARGUMENT</code> ignore it.</p> <p>&mdash; <cite><a href=https://towardsdatascience.com/understanding-python-bytecode-e7edaae8734d>Reza Bagheri - Understanding Python Bytecode - in Towards Data Science</a> - retrieved&nbsp;2022-07-11</cite></p> </blockquote> <p>That does remove some complexity. And adds new complexity - for opcodes with more than one oparg byte - they exist in python and are handled with a special opcode, that adds an additional oparg byte. I think it will make execution faster, as fetching can be done it advance. If you do not know, how many bytes you need, before your read your opcode, you cannot prefetch the next instructions.</p> <p>For our goal, keeping the bytecode small is much more important than execution time. So I am pretty sure we will stick with the dynamic number of oparg bytes in lovem.</p> <h2 id=more-operations>More operations<a class=headerlink href=#more-operations title="Permanent link">&para;</a></h2> <p><strong>The basic operation of the VM is working. Let us add a few more opcodes, so that we can do calculations.</strong></p> <aside class=mdx-author> <p><img alt=@kratenko src=https://avatars.githubusercontent.com/kratenko></p> <p><span><strong>kratenko</strong> · <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 16 16"><path fill-rule=evenodd d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"/></svg></span> <a href=https://github.com/kratenko>kratenko</a></span> <span> <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path fill-rule=evenodd d="M6.75 0a.75.75 0 0 1 .75.75V3h9V.75a.75.75 0 0 1 1.5 0V3h2.75c.966 0 1.75.784 1.75 1.75v16a1.75 1.75 0 0 1-1.75 1.75H3.25a1.75 1.75 0 0 1-1.75-1.75v-16C1.5 3.784 2.284 3 3.25 3H6V.75A.75.75 0 0 1 6.75 0zm-3.5 4.5a.25.25 0 0 0-.25.25V8h18V4.75a.25.25 0 0 0-.25-.25H3.25zM21 9.5H3v11.25c0 .138.112.25.25.25h17.5a.25.25 0 0 0 .25-.25V9.5z"/></svg></span> 2022-07-20 · <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path fill-rule=evenodd d="M0 3.75A.75.75 0 0 1 .75 3h7.497c1.566 0 2.945.8 3.751 2.014A4.496 4.496 0 0 1 15.75 3h7.5a.75.75 0 0 1 .75.75v15.063a.75.75 0 0 1-.755.75l-7.682-.052a3 3 0 0 0-2.142.878l-.89.891a.75.75 0 0 1-1.061 0l-.902-.901a3 3 0 0 0-2.121-.879H.75a.75.75 0 0 1-.75-.75v-15zm11.247 3.747a3 3 0 0 0-3-2.997H1.5V18h6.947a4.5 4.5 0 0 1 2.803.98l-.003-11.483zm1.503 11.485V7.5a3 3 0 0 1 3-3h6.75v13.558l-6.927-.047a4.5 4.5 0 0 0-2.823.971z"/></svg></span> Entry #17 · <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12.5 7.25a.75.75 0 0 0-1.5 0v5.5c0 .27.144.518.378.651l3.5 2a.75.75 0 0 0 .744-1.302L12.5 12.315V7.25z"/><path fill-rule=evenodd d="M12 1C5.925 1 1 5.925 1 12s4.925 11 11 11 11-4.925 11-11S18.075 1 12 1zM2.5 12a9.5 9.5 0 1 1 19 0 9.5 9.5 0 0 1-19 0z"/></svg></span> 4 min read · <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M7.75 6.5a1.25 1.25 0 1 0 0 2.5 1.25 1.25 0 0 0 0-2.5z"/><path fill-rule=evenodd d="M2.5 1A1.5 1.5 0 0 0 1 2.5v8.44c0 .397.158.779.44 1.06l10.25 10.25a1.5 1.5 0 0 0 2.12 0l8.44-8.44a1.5 1.5 0 0 0 0-2.12L12 1.44A1.5 1.5 0 0 0 10.94 1H2.5zm0 1.5h8.44l10.25 10.25-8.44 8.44L2.5 10.94V2.5z"/></svg></span> <a href=https://github.com/kratenko/lovem/releases/tag/v0.0.4-journey>v0.0.4-journey</a> </span></p> </aside> <hr> <p>We have created a rust library that holds our virtual register machine. We can now add multiple executables to it, so that makes it easier, to write different programs and keep them (to mess around with the VM). We will add a few more opcodes to our repertoire, because only adding numbers is just plain boring.</p> <p>I put some sort into what opcodes to introduce; but be advised, that none of them are final. Not only is the VM experimental and in a very early state, I introduce codes that I do not intend to keep on purpose. This is also a demonstration/introduction. So I add codes that are helpful at the time of writing, for experimenting. <code>FIN</code> is an example of a code, that will most likely be removed at some point. But for now it is nice to have a simple way to explicitly terminate the program. It gives some confidence, when we reach that point, that our program works as intended, and that we did not mess up the bytecode.</p> <h3 id=arithmetics>Arithmetics<a class=headerlink href=#arithmetics title="Permanent link">&para;</a></h3> <p>Baby steps. No rush here. We had <em>adding</em> as a first example. We will introduce <em>subtraction</em>, <em>multiplication</em>, <em>division</em>, and <em>modulo</em>. Sounds like not much, but we will run in some complications, anyways... Here is our addtion to <code>op.rs</code>.</p> <div class=highlight><pre><span></span><code><a id=__codelineno-24-1 name=__codelineno-24-1 href=#__codelineno-24-1></a><span class=sd>/// opcode: Subtract top two values on stack.</span>
<a id=__codelineno-24-2 name=__codelineno-24-2 href=#__codelineno-24-2></a><span class=sd>///</span>
<a id=__codelineno-24-3 name=__codelineno-24-3 href=#__codelineno-24-3></a><span class=sd>/// pop: 2, push: 1</span>
<a id=__codelineno-24-4 name=__codelineno-24-4 href=#__codelineno-24-4></a><span class=sd>/// oparg: 0</span>
<a id=__codelineno-24-5 name=__codelineno-24-5 href=#__codelineno-24-5></a><span class=k>pub</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=n>SUB</span>: <span class=kt>u8</span> <span class=o>=</span><span class=w> </span><span class=mh>0x11</span><span class=p>;</span>
<a id=__codelineno-24-6 name=__codelineno-24-6 href=#__codelineno-24-6></a>
<a id=__codelineno-24-7 name=__codelineno-24-7 href=#__codelineno-24-7></a><span class=sd>/// opcode: Multiply top two values on stack.</span>
<a id=__codelineno-24-8 name=__codelineno-24-8 href=#__codelineno-24-8></a><span class=sd>///</span>
<a id=__codelineno-24-9 name=__codelineno-24-9 href=#__codelineno-24-9></a><span class=sd>/// pop: 2, push: 1</span>
<a id=__codelineno-24-10 name=__codelineno-24-10 href=#__codelineno-24-10></a><span class=sd>/// oparg: 0</span>
<a id=__codelineno-24-11 name=__codelineno-24-11 href=#__codelineno-24-11></a><span class=k>pub</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=n>MUL</span>: <span class=kt>u8</span> <span class=o>=</span><span class=w> </span><span class=mh>0x12</span><span class=p>;</span>
<a id=__codelineno-24-12 name=__codelineno-24-12 href=#__codelineno-24-12></a>
<a id=__codelineno-24-13 name=__codelineno-24-13 href=#__codelineno-24-13></a><span class=sd>/// opcode: Divide top two values on stack.</span>
<a id=__codelineno-24-14 name=__codelineno-24-14 href=#__codelineno-24-14></a><span class=sd>///</span>
<a id=__codelineno-24-15 name=__codelineno-24-15 href=#__codelineno-24-15></a><span class=sd>/// pop: 2, push: 1</span>
<a id=__codelineno-24-16 name=__codelineno-24-16 href=#__codelineno-24-16></a><span class=sd>/// oparg: 0</span>
<a id=__codelineno-24-17 name=__codelineno-24-17 href=#__codelineno-24-17></a><span class=k>pub</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=n>DIV</span>: <span class=kt>u8</span> <span class=o>=</span><span class=w> </span><span class=mh>0x13</span><span class=p>;</span>
<a id=__codelineno-24-18 name=__codelineno-24-18 href=#__codelineno-24-18></a>
<a id=__codelineno-24-19 name=__codelineno-24-19 href=#__codelineno-24-19></a><span class=sd>/// opcode: Calculate modulo of top two values on stack.</span>
<a id=__codelineno-24-20 name=__codelineno-24-20 href=#__codelineno-24-20></a><span class=sd>///</span>
<a id=__codelineno-24-21 name=__codelineno-24-21 href=#__codelineno-24-21></a><span class=sd>/// pop: 2, push: 1</span>
<a id=__codelineno-24-22 name=__codelineno-24-22 href=#__codelineno-24-22></a><span class=sd>/// oparg: 0</span>
<a id=__codelineno-24-23 name=__codelineno-24-23 href=#__codelineno-24-23></a><span class=k>pub</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=n>MOD</span>: <span class=kt>u8</span> <span class=o>=</span><span class=w> </span><span class=mh>0x14</span><span class=p>;</span>
</code></pre></div> <h3 id=the-order-of-things>The order of things<a class=headerlink href=#the-order-of-things title="Permanent link">&para;</a></h3> <p>Simple enough those new codes, just copy and paste from <code>ADD</code>. But it turns out, subtraction is not as easy as addition. Here is the handling code we used for <code>ADD</code>:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-25-1 name=__codelineno-25-1 href=#__codelineno-25-1></a><span class=n>op</span>::<span class=n>ADD</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-25-2 name=__codelineno-25-2 href=#__codelineno-25-2></a><span class=w>    </span><span class=fm>println!</span><span class=p>(</span><span class=s>&quot;  ADD&quot;</span><span class=p>);</span>
<a id=__codelineno-25-3 name=__codelineno-25-3 href=#__codelineno-25-3></a><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>pop</span><span class=p>()</span><span class=o>?</span><span class=p>;</span>
<a id=__codelineno-25-4 name=__codelineno-25-4 href=#__codelineno-25-4></a><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>b</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>pop</span><span class=p>()</span><span class=o>?</span><span class=p>;</span>
<a id=__codelineno-25-5 name=__codelineno-25-5 href=#__codelineno-25-5></a><span class=w>    </span><span class=bp>self</span><span class=p>.</span><span class=n>push</span><span class=p>(</span><span class=n>a</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>b</span><span class=p>)</span>
<a id=__codelineno-25-6 name=__codelineno-25-6 href=#__codelineno-25-6></a><span class=p>},</span>
</code></pre></div> <p>Works. But if we copy and use that for <code>SUB</code>:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-26-1 name=__codelineno-26-1 href=#__codelineno-26-1></a><span class=n>op</span>::<span class=n>SUB</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-26-2 name=__codelineno-26-2 href=#__codelineno-26-2></a><span class=w>    </span><span class=fm>println!</span><span class=p>(</span><span class=s>&quot;  SUB&quot;</span><span class=p>);</span>
<a id=__codelineno-26-3 name=__codelineno-26-3 href=#__codelineno-26-3></a><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>pop</span><span class=p>()</span><span class=o>?</span><span class=p>;</span>
<a id=__codelineno-26-4 name=__codelineno-26-4 href=#__codelineno-26-4></a><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>b</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>pop</span><span class=p>()</span><span class=o>?</span><span class=p>;</span>
<a id=__codelineno-26-5 name=__codelineno-26-5 href=#__codelineno-26-5></a><span class=w>    </span><span class=bp>self</span><span class=p>.</span><span class=n>push</span><span class=p>(</span><span class=n>a</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>b</span><span class=p>)</span>
<a id=__codelineno-26-6 name=__codelineno-26-6 href=#__codelineno-26-6></a><span class=p>},</span>
</code></pre></div> <p>It turns out, that I messed up the order of the operands. That does not matter for addition, but subtraction is not commutative. So let's change that:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-27-1 name=__codelineno-27-1 href=#__codelineno-27-1></a><span class=n>op</span>::<span class=n>ADD</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-27-2 name=__codelineno-27-2 href=#__codelineno-27-2></a><span class=w>    </span><span class=fm>println!</span><span class=p>(</span><span class=s>&quot;  ADD&quot;</span><span class=p>);</span>
<a id=__codelineno-27-3 name=__codelineno-27-3 href=#__codelineno-27-3></a><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>b</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>pop</span><span class=p>()</span><span class=o>?</span><span class=p>;</span>
<a id=__codelineno-27-4 name=__codelineno-27-4 href=#__codelineno-27-4></a><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>pop</span><span class=p>()</span><span class=o>?</span><span class=p>;</span>
<a id=__codelineno-27-5 name=__codelineno-27-5 href=#__codelineno-27-5></a><span class=w>    </span><span class=bp>self</span><span class=p>.</span><span class=n>push</span><span class=p>(</span><span class=n>a</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>b</span><span class=p>)</span>
<a id=__codelineno-27-6 name=__codelineno-27-6 href=#__codelineno-27-6></a><span class=p>},</span>
<a id=__codelineno-27-7 name=__codelineno-27-7 href=#__codelineno-27-7></a><span class=n>op</span>::<span class=n>SUB</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-27-8 name=__codelineno-27-8 href=#__codelineno-27-8></a><span class=w>    </span><span class=fm>println!</span><span class=p>(</span><span class=s>&quot;  SUB&quot;</span><span class=p>);</span>
<a id=__codelineno-27-9 name=__codelineno-27-9 href=#__codelineno-27-9></a><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>b</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>pop</span><span class=p>()</span><span class=o>?</span><span class=p>;</span>
<a id=__codelineno-27-10 name=__codelineno-27-10 href=#__codelineno-27-10></a><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>pop</span><span class=p>()</span><span class=o>?</span><span class=p>;</span>
<a id=__codelineno-27-11 name=__codelineno-27-11 href=#__codelineno-27-11></a><span class=w>    </span><span class=bp>self</span><span class=p>.</span><span class=n>push</span><span class=p>(</span><span class=n>a</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>b</span><span class=p>)</span>
<a id=__codelineno-27-12 name=__codelineno-27-12 href=#__codelineno-27-12></a><span class=p>},</span>
<a id=__codelineno-27-13 name=__codelineno-27-13 href=#__codelineno-27-13></a><span class=n>op</span>::<span class=n>MUL</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-27-14 name=__codelineno-27-14 href=#__codelineno-27-14></a><span class=w>    </span><span class=fm>println!</span><span class=p>(</span><span class=s>&quot;  MUL&quot;</span><span class=p>);</span>
<a id=__codelineno-27-15 name=__codelineno-27-15 href=#__codelineno-27-15></a><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>b</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>pop</span><span class=p>()</span><span class=o>?</span><span class=p>;</span>
<a id=__codelineno-27-16 name=__codelineno-27-16 href=#__codelineno-27-16></a><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>pop</span><span class=p>()</span><span class=o>?</span><span class=p>;</span>
<a id=__codelineno-27-17 name=__codelineno-27-17 href=#__codelineno-27-17></a><span class=w>    </span><span class=bp>self</span><span class=p>.</span><span class=n>push</span><span class=p>(</span><span class=n>a</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>b</span><span class=p>)</span>
<a id=__codelineno-27-18 name=__codelineno-27-18 href=#__codelineno-27-18></a><span class=p>},</span>
<a id=__codelineno-27-19 name=__codelineno-27-19 href=#__codelineno-27-19></a><span class=n>op</span>::<span class=n>DIV</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-27-20 name=__codelineno-27-20 href=#__codelineno-27-20></a><span class=w>    </span><span class=fm>println!</span><span class=p>(</span><span class=s>&quot;  DIV&quot;</span><span class=p>);</span>
<a id=__codelineno-27-21 name=__codelineno-27-21 href=#__codelineno-27-21></a><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>b</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>pop</span><span class=p>()</span><span class=o>?</span><span class=p>;</span>
<a id=__codelineno-27-22 name=__codelineno-27-22 href=#__codelineno-27-22></a><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>pop</span><span class=p>()</span><span class=o>?</span><span class=p>;</span>
<a id=__codelineno-27-23 name=__codelineno-27-23 href=#__codelineno-27-23></a><span class=w>    </span><span class=bp>self</span><span class=p>.</span><span class=n>push</span><span class=p>(</span><span class=n>a</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>b</span><span class=p>)</span>
<a id=__codelineno-27-24 name=__codelineno-27-24 href=#__codelineno-27-24></a><span class=p>},</span>
<a id=__codelineno-27-25 name=__codelineno-27-25 href=#__codelineno-27-25></a><span class=n>op</span>::<span class=n>MOD</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-27-26 name=__codelineno-27-26 href=#__codelineno-27-26></a><span class=w>    </span><span class=fm>println!</span><span class=p>(</span><span class=s>&quot;  MOD&quot;</span><span class=p>);</span>
<a id=__codelineno-27-27 name=__codelineno-27-27 href=#__codelineno-27-27></a><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>b</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>pop</span><span class=p>()</span><span class=o>?</span><span class=p>;</span>
<a id=__codelineno-27-28 name=__codelineno-27-28 href=#__codelineno-27-28></a><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>pop</span><span class=p>()</span><span class=o>?</span><span class=p>;</span>
<a id=__codelineno-27-29 name=__codelineno-27-29 href=#__codelineno-27-29></a><span class=w>    </span><span class=bp>self</span><span class=p>.</span><span class=n>push</span><span class=p>(</span><span class=n>a</span><span class=w> </span><span class=o>%</span><span class=w> </span><span class=n>b</span><span class=p>)</span>
<a id=__codelineno-27-30 name=__codelineno-27-30 href=#__codelineno-27-30></a><span class=p>},</span>
</code></pre></div> <p>So, we learned something. I put the other operators there, as well. But this is too naive. You might already see the problem.</p> <h3 id=blowing-up-the-school>Blowing up the school<a class=headerlink href=#blowing-up-the-school title="Permanent link">&para;</a></h3> <p>As my math teacher liked to say: "... dann fliegt die Schule in die Luft!" &ndash; If we do that the school building will blow up. It is his way of dealing with the issue, that pupils are told "you must never divide by zero", but that they are never given an understandable reason for it. So just own it, and provide a completely absurde one.</p> <p>What happens, is we keep it like this? Well, not much - until you write a program that divides by zero. Then, this will happen:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-28-1 name=__codelineno-28-1 href=#__codelineno-28-1></a>[...]
<a id=__codelineno-28-2 name=__codelineno-28-2 href=#__codelineno-28-2></a>VM { stack: [4, 0], pc: 4, op_cnt: 2 }
<a id=__codelineno-28-3 name=__codelineno-28-3 href=#__codelineno-28-3></a>Executing op 0x13
<a id=__codelineno-28-4 name=__codelineno-28-4 href=#__codelineno-28-4></a>  DIV
<a id=__codelineno-28-5 name=__codelineno-28-5 href=#__codelineno-28-5></a>thread &#39;main&#39; panicked at &#39;attempt to divide by zero&#39;, src/vm.rs:142:31
<a id=__codelineno-28-6 name=__codelineno-28-6 href=#__codelineno-28-6></a>stack backtrace:
<a id=__codelineno-28-7 name=__codelineno-28-7 href=#__codelineno-28-7></a>   0: rust_begin_unwind
<a id=__codelineno-28-8 name=__codelineno-28-8 href=#__codelineno-28-8></a>             at /rustc/fe5b13d681f25ee6474be29d748c65adcd91f69e/library/std/src/panicking.rs:584:5
<a id=__codelineno-28-9 name=__codelineno-28-9 href=#__codelineno-28-9></a>   1: core::panicking::panic_fmt
<a id=__codelineno-28-10 name=__codelineno-28-10 href=#__codelineno-28-10></a>             at /rustc/fe5b13d681f25ee6474be29d748c65adcd91f69e/library/core/src/panicking.rs:143:14
<a id=__codelineno-28-11 name=__codelineno-28-11 href=#__codelineno-28-11></a>   2: core::panicking::panic
<a id=__codelineno-28-12 name=__codelineno-28-12 href=#__codelineno-28-12></a>             at /rustc/fe5b13d681f25ee6474be29d748c65adcd91f69e/library/core/src/panicking.rs:48:5
<a id=__codelineno-28-13 name=__codelineno-28-13 href=#__codelineno-28-13></a>   3: lovem::vm::VM::execute_op
<a id=__codelineno-28-14 name=__codelineno-28-14 href=#__codelineno-28-14></a>             at ./src/vm.rs:142:31
<a id=__codelineno-28-15 name=__codelineno-28-15 href=#__codelineno-28-15></a>   4: lovem::vm::VM::run
<a id=__codelineno-28-16 name=__codelineno-28-16 href=#__codelineno-28-16></a>             at ./src/vm.rs:85:13
<a id=__codelineno-28-17 name=__codelineno-28-17 href=#__codelineno-28-17></a>   5: modulo::main
<a id=__codelineno-28-18 name=__codelineno-28-18 href=#__codelineno-28-18></a>             at ./src/bin/modulo.rs:10:11
<a id=__codelineno-28-19 name=__codelineno-28-19 href=#__codelineno-28-19></a>   6: core::ops::function::FnOnce::call_once
<a id=__codelineno-28-20 name=__codelineno-28-20 href=#__codelineno-28-20></a>             at /rustc/fe5b13d681f25ee6474be29d748c65adcd91f69e/library/core/src/ops/function.rs:227:5
<a id=__codelineno-28-21 name=__codelineno-28-21 href=#__codelineno-28-21></a>note: Some details are omitted, run with `RUST_BACKTRACE=full` for a verbose backtrace.
<a id=__codelineno-28-22 name=__codelineno-28-22 href=#__codelineno-28-22></a>
<a id=__codelineno-28-23 name=__codelineno-28-23 href=#__codelineno-28-23></a>Process finished with exit code 101
</code></pre></div> <p>Our program panics! I told you earlier, that this is not good behaviour. I introduced you to a lot of weird Rust stuff, just to avoid those. So, let us not re-introduce them now. So, what can we do instead?</p> <p>Division by zero is a runtime error, for sure (at least in this numerical domain we are working with). But it should not be a runtime error in our virtual machine, it should be a runtime error in the program it is running. Luckily, we already have that mechanism in our VM. So let us add a new runtime error:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-29-1 name=__codelineno-29-1 href=#__codelineno-29-1></a><span class=sd>/// An error that happens during execution of a program inside the VM.</span>
<a id=__codelineno-29-2 name=__codelineno-29-2 href=#__codelineno-29-2></a>#<span class=cp>#[derive(Debug, Clone, PartialEq)]</span>
<a id=__codelineno-29-3 name=__codelineno-29-3 href=#__codelineno-29-3></a><span class=k>pub</span><span class=w> </span><span class=k>enum</span> <span class=nc>RuntimeError</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-29-4 name=__codelineno-29-4 href=#__codelineno-29-4></a><span class=w>    </span><span class=n>EndOfProgram</span><span class=p>,</span>
<a id=__codelineno-29-5 name=__codelineno-29-5 href=#__codelineno-29-5></a><span class=w>    </span><span class=n>UnknownOpcode</span><span class=p>(</span><span class=kt>u8</span><span class=p>),</span>
<a id=__codelineno-29-6 name=__codelineno-29-6 href=#__codelineno-29-6></a><span class=w>    </span><span class=n>StackUnderflow</span><span class=p>,</span>
<a id=__codelineno-29-7 name=__codelineno-29-7 href=#__codelineno-29-7></a><span class=w>    </span><span class=n>StackOverflow</span><span class=p>,</span>
<a id=__codelineno-29-8 name=__codelineno-29-8 href=#__codelineno-29-8></a><span class=w>    </span><span class=n>DivisionByZero</span><span class=p>,</span>
<a id=__codelineno-29-9 name=__codelineno-29-9 href=#__codelineno-29-9></a><span class=p>}</span>
</code></pre></div> <p>And adjust our opcode handlers:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-30-1 name=__codelineno-30-1 href=#__codelineno-30-1></a><span class=n>op</span>::<span class=n>DIV</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-30-2 name=__codelineno-30-2 href=#__codelineno-30-2></a><span class=w>    </span><span class=fm>println!</span><span class=p>(</span><span class=s>&quot;  DIV&quot;</span><span class=p>);</span>
<a id=__codelineno-30-3 name=__codelineno-30-3 href=#__codelineno-30-3></a><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>b</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>pop</span><span class=p>()</span><span class=o>?</span><span class=p>;</span>
<a id=__codelineno-30-4 name=__codelineno-30-4 href=#__codelineno-30-4></a><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>pop</span><span class=p>()</span><span class=o>?</span><span class=p>;</span>
<a id=__codelineno-30-5 name=__codelineno-30-5 href=#__codelineno-30-5></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=n>b</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-30-6 name=__codelineno-30-6 href=#__codelineno-30-6></a><span class=w>        </span><span class=nb>Err</span><span class=p>(</span><span class=n>RuntimeError</span>::<span class=n>DivisionByZero</span><span class=p>)</span>
<a id=__codelineno-30-7 name=__codelineno-30-7 href=#__codelineno-30-7></a><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-30-8 name=__codelineno-30-8 href=#__codelineno-30-8></a><span class=w>        </span><span class=bp>self</span><span class=p>.</span><span class=n>push</span><span class=p>(</span><span class=n>a</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=n>b</span><span class=p>)</span>
<a id=__codelineno-30-9 name=__codelineno-30-9 href=#__codelineno-30-9></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-30-10 name=__codelineno-30-10 href=#__codelineno-30-10></a><span class=p>},</span>
<a id=__codelineno-30-11 name=__codelineno-30-11 href=#__codelineno-30-11></a><span class=n>op</span>::<span class=n>MOD</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-30-12 name=__codelineno-30-12 href=#__codelineno-30-12></a><span class=w>    </span><span class=fm>println!</span><span class=p>(</span><span class=s>&quot;  MOD&quot;</span><span class=p>);</span>
<a id=__codelineno-30-13 name=__codelineno-30-13 href=#__codelineno-30-13></a><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>b</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>pop</span><span class=p>()</span><span class=o>?</span><span class=p>;</span>
<a id=__codelineno-30-14 name=__codelineno-30-14 href=#__codelineno-30-14></a><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>pop</span><span class=p>()</span><span class=o>?</span><span class=p>;</span>
<a id=__codelineno-30-15 name=__codelineno-30-15 href=#__codelineno-30-15></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=n>b</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-30-16 name=__codelineno-30-16 href=#__codelineno-30-16></a><span class=w>        </span><span class=nb>Err</span><span class=p>(</span><span class=n>RuntimeError</span>::<span class=n>DivisionByZero</span><span class=p>)</span>
<a id=__codelineno-30-17 name=__codelineno-30-17 href=#__codelineno-30-17></a><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-30-18 name=__codelineno-30-18 href=#__codelineno-30-18></a><span class=w>        </span><span class=bp>self</span><span class=p>.</span><span class=n>push</span><span class=p>(</span><span class=n>a</span><span class=w> </span><span class=o>%</span><span class=w> </span><span class=n>b</span><span class=p>)</span>
<a id=__codelineno-30-19 name=__codelineno-30-19 href=#__codelineno-30-19></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-30-20 name=__codelineno-30-20 href=#__codelineno-30-20></a><span class=p>},</span>
</code></pre></div> <p>We add a check for the <code>DIV</code> and <code>MOD</code> handlers (modulo is a division as well). If we run that program dividing by zero again, we now get this:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-31-1 name=__codelineno-31-1 href=#__codelineno-31-1></a>[...]
<a id=__codelineno-31-2 name=__codelineno-31-2 href=#__codelineno-31-2></a>VM { stack: [4, 0], pc: 4, op_cnt: 2 }
<a id=__codelineno-31-3 name=__codelineno-31-3 href=#__codelineno-31-3></a>Executing op 0x13
<a id=__codelineno-31-4 name=__codelineno-31-4 href=#__codelineno-31-4></a>  DIV
<a id=__codelineno-31-5 name=__codelineno-31-5 href=#__codelineno-31-5></a>Error during execution: DivisionByZero
<a id=__codelineno-31-6 name=__codelineno-31-6 href=#__codelineno-31-6></a>
<a id=__codelineno-31-7 name=__codelineno-31-7 href=#__codelineno-31-7></a>Process finished with exit code 0
</code></pre></div> <p>Yes, it still fails. But only the execution of the bytecode fails, not the execution of our virtual machine. You can now handle the problem inside your Rust program in a way that fits your needs. Much better. In the next post, we will be using our new instructions in a fancy way, that works well with a stack machine.</p> <h3 id=homework_2>Homework<a class=headerlink href=#homework_2 title="Permanent link">&para;</a></h3> <p>Oh, not sure. Play around with it, I guess? As always. Feel free to write a calculation into a program and compare the results. It should work, unless I messed up again. You should have at least, at some point, write a program in bytecode yourself, so that you know how that feels.</p> <h2 id=reverse-polish-notation>Reverse polish notation<a class=headerlink href=#reverse-polish-notation title="Permanent link">&para;</a></h2> <p><strong>We are using the design of a stack machine to efficiently execute some calculations.</strong></p> <aside class=mdx-author> <p><img alt=@kratenko src=https://avatars.githubusercontent.com/kratenko></p> <p><span><strong>kratenko</strong> · <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 16 16"><path fill-rule=evenodd d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"/></svg></span> <a href=https://github.com/kratenko>kratenko</a></span> <span> <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path fill-rule=evenodd d="M6.75 0a.75.75 0 0 1 .75.75V3h9V.75a.75.75 0 0 1 1.5 0V3h2.75c.966 0 1.75.784 1.75 1.75v16a1.75 1.75 0 0 1-1.75 1.75H3.25a1.75 1.75 0 0 1-1.75-1.75v-16C1.5 3.784 2.284 3 3.25 3H6V.75A.75.75 0 0 1 6.75 0zm-3.5 4.5a.25.25 0 0 0-.25.25V8h18V4.75a.25.25 0 0 0-.25-.25H3.25zM21 9.5H3v11.25c0 .138.112.25.25.25h17.5a.25.25 0 0 0 .25-.25V9.5z"/></svg></span> 2022-07-21 · <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path fill-rule=evenodd d="M0 3.75A.75.75 0 0 1 .75 3h7.497c1.566 0 2.945.8 3.751 2.014A4.496 4.496 0 0 1 15.75 3h7.5a.75.75 0 0 1 .75.75v15.063a.75.75 0 0 1-.755.75l-7.682-.052a3 3 0 0 0-2.142.878l-.89.891a.75.75 0 0 1-1.061 0l-.902-.901a3 3 0 0 0-2.121-.879H.75a.75.75 0 0 1-.75-.75v-15zm11.247 3.747a3 3 0 0 0-3-2.997H1.5V18h6.947a4.5 4.5 0 0 1 2.803.98l-.003-11.483zm1.503 11.485V7.5a3 3 0 0 1 3-3h6.75v13.558l-6.927-.047a4.5 4.5 0 0 0-2.823.971z"/></svg></span> Entry #18 · <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12.5 7.25a.75.75 0 0 0-1.5 0v5.5c0 .27.144.518.378.651l3.5 2a.75.75 0 0 0 .744-1.302L12.5 12.315V7.25z"/><path fill-rule=evenodd d="M12 1C5.925 1 1 5.925 1 12s4.925 11 11 11 11-4.925 11-11S18.075 1 12 1zM2.5 12a9.5 9.5 0 1 1 19 0 9.5 9.5 0 0 1-19 0z"/></svg></span> 4 min read · <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M7.75 6.5a1.25 1.25 0 1 0 0 2.5 1.25 1.25 0 0 0 0-2.5z"/><path fill-rule=evenodd d="M2.5 1A1.5 1.5 0 0 0 1 2.5v8.44c0 .397.158.779.44 1.06l10.25 10.25a1.5 1.5 0 0 0 2.12 0l8.44-8.44a1.5 1.5 0 0 0 0-2.12L12 1.44A1.5 1.5 0 0 0 10.94 1H2.5zm0 1.5h8.44l10.25 10.25-8.44 8.44L2.5 10.94V2.5z"/></svg></span> <a href=https://github.com/kratenko/lovem/releases/tag/v0.0.5-journey>v0.0.5-journey</a> </span></p> </aside> <hr> <p>The way stack machines work can be used in programs that execute calculations. We will look at it by implementing an example from the Wikipedia page about stack machines.</p> <p>I will quote a lot of it here. You can see the full text of the article and its authors when you follow the <a href="https://en.wikipedia.org/w/index.php?title=Stack_machine&oldid=1097292883#Design">Wikipedia permalink to the article</a>.</p> <blockquote> <p><strong>Design</strong></p> <p>Most or all stack machine instructions assume that operands will be from the stack, and results placed in the stack. The stack easily holds more than two inputs or more than one result, so a rich set of operations can be computed. In stack machine code (sometimes called p-code), instructions will frequently have only an opcode commanding an operation, with no additional fields identifying a constant, register or memory cell, known as a zero address format.<sup id=fnref:1><a class=footnote-ref href=#fn:1>2</a></sup> This greatly simplifies instruction decoding. Branches, load immediates, and load/store instructions require an argument field, but stack machines often arrange that the frequent cases of these still fit together with the opcode into a compact group of bits.</p> <p>&mdash; <cite><a href="https://en.wikipedia.org/w/index.php?title=Stack_machine&oldid=1097292883#Design">Wikipedia</a> - retrieved 2022-07-15</cite></p> </blockquote> <p>So far nothing new - I wrote about all that in my earlier posts.</p> <blockquote> <p>The selection of operands from prior results is done implicitly by ordering the instructions. [...]</p> <p>&mdash; <cite><a href="https://en.wikipedia.org/w/index.php?title=Stack_machine&oldid=1097292883#Design">ibid.</a></cite></p> </blockquote> <p>Now, here it gets interesting.</p> <blockquote> <p>[...]</p> <p>The instruction set carries out most ALU actions with postfix (<a href=https://en.wikipedia.org/wiki/Reverse_Polish_notation>reverse Polish notation</a>) operations that work only on the expression stack, not on data registers or main memory cells. This can be very convenient for executing high-level languages, because most arithmetic expressions can be easily translated into postfix notation. </p> <p>For example, consider the expression A*(B-C)+(D+E), written in reverse Polish notation as A&nbsp;B&nbsp;C&nbsp;-&nbsp;*&nbsp;D&nbsp;E&nbsp;+&nbsp;+. Compiling and running this on a simple imaginary stack machine would take the form: </p> <p><div class=highlight><pre><span></span><code><a id=__codelineno-32-1 name=__codelineno-32-1 href=#__codelineno-32-1></a>                # stack contents (leftmost = top = most recent):
<a id=__codelineno-32-2 name=__codelineno-32-2 href=#__codelineno-32-2></a>push A          #           A
<a id=__codelineno-32-3 name=__codelineno-32-3 href=#__codelineno-32-3></a>push B          #     B     A
<a id=__codelineno-32-4 name=__codelineno-32-4 href=#__codelineno-32-4></a>push C          # C   B     A
<a id=__codelineno-32-5 name=__codelineno-32-5 href=#__codelineno-32-5></a>subtract        #     B-C   A
<a id=__codelineno-32-6 name=__codelineno-32-6 href=#__codelineno-32-6></a>multiply        #           A*(B-C)
<a id=__codelineno-32-7 name=__codelineno-32-7 href=#__codelineno-32-7></a>push D          #     D     A*(B-C)
<a id=__codelineno-32-8 name=__codelineno-32-8 href=#__codelineno-32-8></a>push E          # E   D     A*(B-C)
<a id=__codelineno-32-9 name=__codelineno-32-9 href=#__codelineno-32-9></a>add             #     D+E   A*(B-C)
<a id=__codelineno-32-10 name=__codelineno-32-10 href=#__codelineno-32-10></a>add             #           A*(B-C)+(D+E)
</code></pre></div> &mdash; <cite><a href="https://en.wikipedia.org/w/index.php?title=Stack_machine&oldid=1097292883#Design">ibid.</a></cite></p> </blockquote> <p>Well, I don't know about a "simple <em>imaginary</em> stack machine" - but as it happens to be, we have a very real simple stack machine at our disposal. You know where we will be going next!</p> <h3 id=porting-the-code-to-lovem>Porting the code to lovem<a class=headerlink href=#porting-the-code-to-lovem title="Permanent link">&para;</a></h3> <p>The program from the <a href="https://en.wikipedia.org/w/index.php?title=Stack_machine&oldid=1097292883#Design">Wikipedia article</a> uses 5 variables <code>A</code> to <code>E</code>. We do not support any kind of variables, yet, but that isn't important here. We use immediates (literals from your program) to put some concrete values into the calculation. Let's just take some numbers, totally at random:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-33-1 name=__codelineno-33-1 href=#__codelineno-33-1></a>A = 5, B = 7, C = 11, D = 13, E = 17
</code></pre></div> <p>And we add a new binary to the project: <a href=https://github.com/kratenko/lovem/blob/v0.0.5-journey/src/bin/reverse-polish.rs><code>reverse-polish.rs</code></a></p> <div class=highlight><pre><span></span><code><a id=__codelineno-34-1 name=__codelineno-34-1 href=#__codelineno-34-1></a><span class=sd>//! A small program demonstrating execution of arithmetics in our VM.</span>
<a id=__codelineno-34-2 name=__codelineno-34-2 href=#__codelineno-34-2></a><span class=sd>//!</span>
<a id=__codelineno-34-3 name=__codelineno-34-3 href=#__codelineno-34-3></a><span class=sd>//! For an explanation of what we are doing here, look at this wikipedia article:</span>
<a id=__codelineno-34-4 name=__codelineno-34-4 href=#__codelineno-34-4></a><span class=sd>//! https://en.wikipedia.org/w/index.php?title=Stack_machine&amp;oldid=1097292883#Design</span>
<a id=__codelineno-34-5 name=__codelineno-34-5 href=#__codelineno-34-5></a><span class=k>use</span><span class=w> </span><span class=n>lovem</span>::<span class=p>{</span><span class=n>op</span><span class=p>,</span><span class=w> </span><span class=n>VM</span><span class=p>};</span>
<a id=__codelineno-34-6 name=__codelineno-34-6 href=#__codelineno-34-6></a>
<a id=__codelineno-34-7 name=__codelineno-34-7 href=#__codelineno-34-7></a><span class=c1>// A*(B-C)+(D+E)</span>
<a id=__codelineno-34-8 name=__codelineno-34-8 href=#__codelineno-34-8></a><span class=c1>// A B C - * D E + +</span>
<a id=__codelineno-34-9 name=__codelineno-34-9 href=#__codelineno-34-9></a><span class=c1>// A = 5, B = 7, C = 11, D = 13, E = 17</span>
<a id=__codelineno-34-10 name=__codelineno-34-10 href=#__codelineno-34-10></a><span class=c1>// 5 * (7 - 11) + (13 + 17) = 10</span>
<a id=__codelineno-34-11 name=__codelineno-34-11 href=#__codelineno-34-11></a>
<a id=__codelineno-34-12 name=__codelineno-34-12 href=#__codelineno-34-12></a><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-34-13 name=__codelineno-34-13 href=#__codelineno-34-13></a><span class=w>    </span><span class=c1>// Create a program in bytecode.</span>
<a id=__codelineno-34-14 name=__codelineno-34-14 href=#__codelineno-34-14></a><span class=w>    </span><span class=c1>// We just hardcode the bytes in an array here:</span>
<a id=__codelineno-34-15 name=__codelineno-34-15 href=#__codelineno-34-15></a><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>pgm</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=n>op</span>::<span class=n>PUSH_U8</span><span class=p>,</span><span class=w> </span><span class=mi>5</span><span class=p>,</span><span class=w> </span><span class=n>op</span>::<span class=n>PUSH_U8</span><span class=p>,</span><span class=w> </span><span class=mi>7</span><span class=p>,</span><span class=w> </span><span class=n>op</span>::<span class=n>PUSH_U8</span><span class=p>,</span><span class=w> </span><span class=mi>11</span><span class=p>,</span><span class=w> </span><span class=n>op</span>::<span class=n>SUB</span><span class=p>,</span><span class=w> </span><span class=n>op</span>::<span class=n>MUL</span><span class=p>,</span>
<a id=__codelineno-34-16 name=__codelineno-34-16 href=#__codelineno-34-16></a><span class=w>        </span><span class=n>op</span>::<span class=n>PUSH_U8</span><span class=p>,</span><span class=w> </span><span class=mi>13</span><span class=p>,</span><span class=w> </span><span class=n>op</span>::<span class=n>PUSH_U8</span><span class=p>,</span><span class=w> </span><span class=mi>17</span><span class=p>,</span><span class=w> </span><span class=n>op</span>::<span class=n>ADD</span><span class=p>,</span><span class=w> </span><span class=n>op</span>::<span class=n>ADD</span><span class=p>,</span><span class=w> </span><span class=n>op</span>::<span class=n>POP</span><span class=p>,</span><span class=w> </span><span class=n>op</span>::<span class=n>FIN</span><span class=p>];</span>
<a id=__codelineno-34-17 name=__codelineno-34-17 href=#__codelineno-34-17></a><span class=w>    </span><span class=c1>// Create our VM instance.</span>
<a id=__codelineno-34-18 name=__codelineno-34-18 href=#__codelineno-34-18></a><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>vm</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>VM</span>::<span class=n>new</span><span class=p>(</span><span class=mi>100</span><span class=p>);</span>
<a id=__codelineno-34-19 name=__codelineno-34-19 href=#__codelineno-34-19></a><span class=w>    </span><span class=c1>// Execute the program in our VM:</span>
<a id=__codelineno-34-20 name=__codelineno-34-20 href=#__codelineno-34-20></a><span class=w>    </span><span class=k>match</span><span class=w> </span><span class=n>vm</span><span class=p>.</span><span class=n>run</span><span class=p>(</span><span class=o>&amp;</span><span class=n>pgm</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-34-21 name=__codelineno-34-21 href=#__codelineno-34-21></a><span class=w>        </span><span class=nb>Ok</span><span class=p>(</span><span class=n>_</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-34-22 name=__codelineno-34-22 href=#__codelineno-34-22></a><span class=w>            </span><span class=fm>println!</span><span class=p>(</span><span class=s>&quot;Execution successful.&quot;</span><span class=p>)</span>
<a id=__codelineno-34-23 name=__codelineno-34-23 href=#__codelineno-34-23></a><span class=w>        </span><span class=p>}</span>
<a id=__codelineno-34-24 name=__codelineno-34-24 href=#__codelineno-34-24></a><span class=w>        </span><span class=nb>Err</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-34-25 name=__codelineno-34-25 href=#__codelineno-34-25></a><span class=w>            </span><span class=fm>println!</span><span class=p>(</span><span class=s>&quot;Error during execution: {:?}&quot;</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span>
<a id=__codelineno-34-26 name=__codelineno-34-26 href=#__codelineno-34-26></a><span class=w>        </span><span class=p>}</span>
<a id=__codelineno-34-27 name=__codelineno-34-27 href=#__codelineno-34-27></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-34-28 name=__codelineno-34-28 href=#__codelineno-34-28></a><span class=p>}</span>
</code></pre></div> <p>The comments spoil the result, but we want to check it calculates correctly, so that is okay. The program is the same as before: create a VM and run some hardcoded bytecode on it. Since the VM logs excessively, we will see what happens, when we run it. So the only new thing here is the bytecode program. I'll write it down in a more readable form:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-35-1 name=__codelineno-35-1 href=#__codelineno-35-1></a>push_u8 5
<a id=__codelineno-35-2 name=__codelineno-35-2 href=#__codelineno-35-2></a>push_u8 7
<a id=__codelineno-35-3 name=__codelineno-35-3 href=#__codelineno-35-3></a>push_u8 11
<a id=__codelineno-35-4 name=__codelineno-35-4 href=#__codelineno-35-4></a>sub
<a id=__codelineno-35-5 name=__codelineno-35-5 href=#__codelineno-35-5></a>mul
<a id=__codelineno-35-6 name=__codelineno-35-6 href=#__codelineno-35-6></a>push_u8 13
<a id=__codelineno-35-7 name=__codelineno-35-7 href=#__codelineno-35-7></a>push_u8 17
<a id=__codelineno-35-8 name=__codelineno-35-8 href=#__codelineno-35-8></a>add
<a id=__codelineno-35-9 name=__codelineno-35-9 href=#__codelineno-35-9></a>add
<a id=__codelineno-35-10 name=__codelineno-35-10 href=#__codelineno-35-10></a>pop
<a id=__codelineno-35-11 name=__codelineno-35-11 href=#__codelineno-35-11></a>fin
</code></pre></div> <p>To no-ones surprise, this code is the same as in the article - only with the variables replaced by numbers, and I added a <code>pop</code> and a <code>fin</code> at the end, to keep our program clean.</p> <h3 id=execution>Execution<a class=headerlink href=#execution title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><a id=__codelineno-36-1 name=__codelineno-36-1 href=#__codelineno-36-1></a>VM { stack: [], pc: 0, op_cnt: 0 }
<a id=__codelineno-36-2 name=__codelineno-36-2 href=#__codelineno-36-2></a>Executing op 0x02
<a id=__codelineno-36-3 name=__codelineno-36-3 href=#__codelineno-36-3></a>  PUSH_U8
<a id=__codelineno-36-4 name=__codelineno-36-4 href=#__codelineno-36-4></a>  value: 5
<a id=__codelineno-36-5 name=__codelineno-36-5 href=#__codelineno-36-5></a>VM { stack: [5], pc: 2, op_cnt: 1 }
<a id=__codelineno-36-6 name=__codelineno-36-6 href=#__codelineno-36-6></a>Executing op 0x02
<a id=__codelineno-36-7 name=__codelineno-36-7 href=#__codelineno-36-7></a>  PUSH_U8
<a id=__codelineno-36-8 name=__codelineno-36-8 href=#__codelineno-36-8></a>  value: 7
<a id=__codelineno-36-9 name=__codelineno-36-9 href=#__codelineno-36-9></a>VM { stack: [5, 7], pc: 4, op_cnt: 2 }
<a id=__codelineno-36-10 name=__codelineno-36-10 href=#__codelineno-36-10></a>Executing op 0x02
<a id=__codelineno-36-11 name=__codelineno-36-11 href=#__codelineno-36-11></a>  PUSH_U8
<a id=__codelineno-36-12 name=__codelineno-36-12 href=#__codelineno-36-12></a>  value: 11
<a id=__codelineno-36-13 name=__codelineno-36-13 href=#__codelineno-36-13></a>VM { stack: [5, 7, 11], pc: 6, op_cnt: 3 }
<a id=__codelineno-36-14 name=__codelineno-36-14 href=#__codelineno-36-14></a>Executing op 0x11
<a id=__codelineno-36-15 name=__codelineno-36-15 href=#__codelineno-36-15></a>  SUB
<a id=__codelineno-36-16 name=__codelineno-36-16 href=#__codelineno-36-16></a>VM { stack: [5, -4], pc: 7, op_cnt: 4 }
<a id=__codelineno-36-17 name=__codelineno-36-17 href=#__codelineno-36-17></a>Executing op 0x12
<a id=__codelineno-36-18 name=__codelineno-36-18 href=#__codelineno-36-18></a>  MUL
<a id=__codelineno-36-19 name=__codelineno-36-19 href=#__codelineno-36-19></a>VM { stack: [-20], pc: 8, op_cnt: 5 }
<a id=__codelineno-36-20 name=__codelineno-36-20 href=#__codelineno-36-20></a>Executing op 0x02
<a id=__codelineno-36-21 name=__codelineno-36-21 href=#__codelineno-36-21></a>  PUSH_U8
<a id=__codelineno-36-22 name=__codelineno-36-22 href=#__codelineno-36-22></a>  value: 13
<a id=__codelineno-36-23 name=__codelineno-36-23 href=#__codelineno-36-23></a>VM { stack: [-20, 13], pc: 10, op_cnt: 6 }
<a id=__codelineno-36-24 name=__codelineno-36-24 href=#__codelineno-36-24></a>Executing op 0x02
<a id=__codelineno-36-25 name=__codelineno-36-25 href=#__codelineno-36-25></a>  PUSH_U8
<a id=__codelineno-36-26 name=__codelineno-36-26 href=#__codelineno-36-26></a>  value: 17
<a id=__codelineno-36-27 name=__codelineno-36-27 href=#__codelineno-36-27></a>VM { stack: [-20, 13, 17], pc: 12, op_cnt: 7 }
<a id=__codelineno-36-28 name=__codelineno-36-28 href=#__codelineno-36-28></a>Executing op 0x10
<a id=__codelineno-36-29 name=__codelineno-36-29 href=#__codelineno-36-29></a>  ADD
<a id=__codelineno-36-30 name=__codelineno-36-30 href=#__codelineno-36-30></a>VM { stack: [-20, 30], pc: 13, op_cnt: 8 }
<a id=__codelineno-36-31 name=__codelineno-36-31 href=#__codelineno-36-31></a>Executing op 0x10
<a id=__codelineno-36-32 name=__codelineno-36-32 href=#__codelineno-36-32></a>  ADD
<a id=__codelineno-36-33 name=__codelineno-36-33 href=#__codelineno-36-33></a>VM { stack: [10], pc: 14, op_cnt: 9 }
<a id=__codelineno-36-34 name=__codelineno-36-34 href=#__codelineno-36-34></a>Executing op 0x01
<a id=__codelineno-36-35 name=__codelineno-36-35 href=#__codelineno-36-35></a>  POP
<a id=__codelineno-36-36 name=__codelineno-36-36 href=#__codelineno-36-36></a>  dropping value 10
<a id=__codelineno-36-37 name=__codelineno-36-37 href=#__codelineno-36-37></a>VM { stack: [], pc: 15, op_cnt: 10 }
<a id=__codelineno-36-38 name=__codelineno-36-38 href=#__codelineno-36-38></a>Terminated!
<a id=__codelineno-36-39 name=__codelineno-36-39 href=#__codelineno-36-39></a>VM { stack: [], pc: 16, op_cnt: 11 }
<a id=__codelineno-36-40 name=__codelineno-36-40 href=#__codelineno-36-40></a>Execution successful.
</code></pre></div> <p>The output shows you the stack after every instruction. You can compare it to the stack contents in the Wikipedia listing, and you will find them identical (the order of the stack listing is switched, and of course you have numbers instead of arithmetic expressions with variables &ndash; but if you insert our numbers on the Wikipedia listing they should match).</p> <p>Our PoC stack machine really can do what the imaginary one is claimed to do. That's nice.</p> <h3 id=homework_3>Homework<a class=headerlink href=#homework_3 title="Permanent link">&para;</a></h3> <p>You should really read the article on <a href=https://en.wikipedia.org/wiki/Reverse_Polish_notation>Reverse Polish Notation</a> <em>(<a href="https://en.wikipedia.org/w/index.php?title=Reverse_Polish_notation&oldid=1096284746">permalink to article at time of writing</a>)</em>. It will give some background on why it is important, not at least historically. The Z3, for example, arguably the first computer built by mankind<sup id=fnref:2><a class=footnote-ref href=#fn:2>3</a></sup>, was using it.</p> <h2 id=go-ahead-and-jump>Go ahead and jump!<a class=headerlink href=#go-ahead-and-jump title="Permanent link">&para;</a></h2> <p><strong>All our programs have been linear so far. Let's build the base for jumping around.</strong></p> <aside class=mdx-author> <p><img alt=@kratenko src=https://avatars.githubusercontent.com/kratenko></p> <p><span><strong>kratenko</strong> · <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 16 16"><path fill-rule=evenodd d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"/></svg></span> <a href=https://github.com/kratenko>kratenko</a></span> <span> <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path fill-rule=evenodd d="M6.75 0a.75.75 0 0 1 .75.75V3h9V.75a.75.75 0 0 1 1.5 0V3h2.75c.966 0 1.75.784 1.75 1.75v16a1.75 1.75 0 0 1-1.75 1.75H3.25a1.75 1.75 0 0 1-1.75-1.75v-16C1.5 3.784 2.284 3 3.25 3H6V.75A.75.75 0 0 1 6.75 0zm-3.5 4.5a.25.25 0 0 0-.25.25V8h18V4.75a.25.25 0 0 0-.25-.25H3.25zM21 9.5H3v11.25c0 .138.112.25.25.25h17.5a.25.25 0 0 0 .25-.25V9.5z"/></svg></span> 2022-07-22 · <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path fill-rule=evenodd d="M0 3.75A.75.75 0 0 1 .75 3h7.497c1.566 0 2.945.8 3.751 2.014A4.496 4.496 0 0 1 15.75 3h7.5a.75.75 0 0 1 .75.75v15.063a.75.75 0 0 1-.755.75l-7.682-.052a3 3 0 0 0-2.142.878l-.89.891a.75.75 0 0 1-1.061 0l-.902-.901a3 3 0 0 0-2.121-.879H.75a.75.75 0 0 1-.75-.75v-15zm11.247 3.747a3 3 0 0 0-3-2.997H1.5V18h6.947a4.5 4.5 0 0 1 2.803.98l-.003-11.483zm1.503 11.485V7.5a3 3 0 0 1 3-3h6.75v13.558l-6.927-.047a4.5 4.5 0 0 0-2.823.971z"/></svg></span> Entry #19 · <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12.5 7.25a.75.75 0 0 0-1.5 0v5.5c0 .27.144.518.378.651l3.5 2a.75.75 0 0 0 .744-1.302L12.5 12.315V7.25z"/><path fill-rule=evenodd d="M12 1C5.925 1 1 5.925 1 12s4.925 11 11 11 11-4.925 11-11S18.075 1 12 1zM2.5 12a9.5 9.5 0 1 1 19 0 9.5 9.5 0 0 1-19 0z"/></svg></span> 5 min read · <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M7.75 6.5a1.25 1.25 0 1 0 0 2.5 1.25 1.25 0 0 0 0-2.5z"/><path fill-rule=evenodd d="M2.5 1A1.5 1.5 0 0 0 1 2.5v8.44c0 .397.158.779.44 1.06l10.25 10.25a1.5 1.5 0 0 0 2.12 0l8.44-8.44a1.5 1.5 0 0 0 0-2.12L12 1.44A1.5 1.5 0 0 0 10.94 1H2.5zm0 1.5h8.44l10.25 10.25-8.44 8.44L2.5 10.94V2.5z"/></svg></span> <a href=https://github.com/kratenko/lovem/releases/tag/v0.0.6-journey>v0.0.6-journey</a> </span></p> </aside> <hr> <p>In every program we have written so far, each instruction just advances the PC<sup id=fnref:pc><a class=footnote-ref href=#fn:pc>4</a></sup>, until we reach the end. That is very linear. We will now introduce a new opcode, that jumps to a different position in the program.</p> <h3 id=a-new-opcode>A new opcode<a class=headerlink href=#a-new-opcode title="Permanent link">&para;</a></h3> <p>How do we implement that? That is actually quite easy. Do you remember what I said about the PC? It is a special register, that always points to the instruction in the bytecode, that is executed next. So all our operation needs to do is modify the PC. We will give that opcode an oparg of two bytes, so we can tell it, where to jump to. Here is our new opcode in <code>op.rs</code>:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-37-1 name=__codelineno-37-1 href=#__codelineno-37-1></a><span class=sd>/// opcode: Relative jump.</span>
<a id=__codelineno-37-2 name=__codelineno-37-2 href=#__codelineno-37-2></a><span class=sd>///</span>
<a id=__codelineno-37-3 name=__codelineno-37-3 href=#__codelineno-37-3></a><span class=sd>/// pop: 0, push: 0</span>
<a id=__codelineno-37-4 name=__codelineno-37-4 href=#__codelineno-37-4></a><span class=sd>/// oparg: 2B, i16 relative jump</span>
<a id=__codelineno-37-5 name=__codelineno-37-5 href=#__codelineno-37-5></a><span class=k>pub</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=n>GOTO</span>: <span class=kt>u8</span> <span class=o>=</span><span class=w> </span><span class=mh>0x20</span><span class=p>;</span>
</code></pre></div> <p>Now we have the dreaded <code>goto</code>. Don't be scared - on bytecode level, that is all well. We are not designing a high level language here, there will be gotos. But how do we fetch an <code>i16</code> from our bytecode? So far we can only fetch <code>u8</code>. So we add some more fetching:</p> <h3 id=fetch-more-than-a-byte>Fetch more than a byte<a class=headerlink href=#fetch-more-than-a-byte title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><a id=__codelineno-38-1 name=__codelineno-38-1 href=#__codelineno-38-1></a><span class=sd>/// Reads the next byte from the bytecode, increase programm counter, and return byte.</span>
<a id=__codelineno-38-2 name=__codelineno-38-2 href=#__codelineno-38-2></a><span class=k>fn</span> <span class=nf>fetch_u8</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>,</span><span class=w> </span><span class=n>pgm</span>: <span class=kp>&amp;</span><span class=p>[</span><span class=kt>u8</span><span class=p>])</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=kt>u8</span><span class=p>,</span><span class=w> </span><span class=n>RuntimeError</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-38-3 name=__codelineno-38-3 href=#__codelineno-38-3></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=kd>let</span><span class=w> </span><span class=nb>Some</span><span class=p>(</span><span class=n>v</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pgm</span><span class=p>.</span><span class=n>get</span><span class=p>(</span><span class=bp>self</span><span class=p>.</span><span class=n>pc</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-38-4 name=__codelineno-38-4 href=#__codelineno-38-4></a><span class=w>        </span><span class=bp>self</span><span class=p>.</span><span class=n>pc</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span>
<a id=__codelineno-38-5 name=__codelineno-38-5 href=#__codelineno-38-5></a><span class=w>        </span><span class=nb>Ok</span><span class=p>(</span><span class=o>*</span><span class=n>v</span><span class=p>)</span>
<a id=__codelineno-38-6 name=__codelineno-38-6 href=#__codelineno-38-6></a><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-38-7 name=__codelineno-38-7 href=#__codelineno-38-7></a><span class=w>        </span><span class=nb>Err</span><span class=p>(</span><span class=n>RuntimeError</span>::<span class=n>EndOfProgram</span><span class=p>)</span>
<a id=__codelineno-38-8 name=__codelineno-38-8 href=#__codelineno-38-8></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-38-9 name=__codelineno-38-9 href=#__codelineno-38-9></a><span class=p>}</span>
<a id=__codelineno-38-10 name=__codelineno-38-10 href=#__codelineno-38-10></a>
<a id=__codelineno-38-11 name=__codelineno-38-11 href=#__codelineno-38-11></a><span class=sd>/// Reads the next byte from the bytecode, increase programm counter, and return byte.</span>
<a id=__codelineno-38-12 name=__codelineno-38-12 href=#__codelineno-38-12></a><span class=k>fn</span> <span class=nf>fetch_i8</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>,</span><span class=w> </span><span class=n>pgm</span>: <span class=kp>&amp;</span><span class=p>[</span><span class=kt>u8</span><span class=p>])</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=kt>i8</span><span class=p>,</span><span class=w> </span><span class=n>RuntimeError</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-38-13 name=__codelineno-38-13 href=#__codelineno-38-13></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=kd>let</span><span class=w> </span><span class=nb>Some</span><span class=p>(</span><span class=n>v</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pgm</span><span class=p>.</span><span class=n>get</span><span class=p>(</span><span class=bp>self</span><span class=p>.</span><span class=n>pc</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-38-14 name=__codelineno-38-14 href=#__codelineno-38-14></a><span class=w>        </span><span class=bp>self</span><span class=p>.</span><span class=n>pc</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span>
<a id=__codelineno-38-15 name=__codelineno-38-15 href=#__codelineno-38-15></a><span class=w>        </span><span class=nb>Ok</span><span class=p>(</span><span class=o>*</span><span class=n>v</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>i8</span><span class=p>)</span>
<a id=__codelineno-38-16 name=__codelineno-38-16 href=#__codelineno-38-16></a><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-38-17 name=__codelineno-38-17 href=#__codelineno-38-17></a><span class=w>        </span><span class=nb>Err</span><span class=p>(</span><span class=n>RuntimeError</span>::<span class=n>EndOfProgram</span><span class=p>)</span>
<a id=__codelineno-38-18 name=__codelineno-38-18 href=#__codelineno-38-18></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-38-19 name=__codelineno-38-19 href=#__codelineno-38-19></a><span class=p>}</span>
<a id=__codelineno-38-20 name=__codelineno-38-20 href=#__codelineno-38-20></a>
<a id=__codelineno-38-21 name=__codelineno-38-21 href=#__codelineno-38-21></a><span class=sd>/// Reads the next two bytes from the bytecode, increase programm counter by two, and return as i16.</span>
<a id=__codelineno-38-22 name=__codelineno-38-22 href=#__codelineno-38-22></a><span class=k>fn</span> <span class=nf>fetch_i16</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>,</span><span class=w> </span><span class=n>pgm</span>: <span class=kp>&amp;</span><span class=p>[</span><span class=kt>u8</span><span class=p>])</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=kt>i16</span><span class=p>,</span><span class=w> </span><span class=n>RuntimeError</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-38-23 name=__codelineno-38-23 href=#__codelineno-38-23></a><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>hi</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>fetch_i8</span><span class=p>(</span><span class=n>pgm</span><span class=p>)</span><span class=o>?</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>i16</span><span class=p>;</span>
<a id=__codelineno-38-24 name=__codelineno-38-24 href=#__codelineno-38-24></a><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>lo</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>fetch_u8</span><span class=p>(</span><span class=n>pgm</span><span class=p>)</span><span class=o>?</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>i16</span><span class=p>;</span>
<a id=__codelineno-38-25 name=__codelineno-38-25 href=#__codelineno-38-25></a><span class=w>    </span><span class=nb>Ok</span><span class=p>(</span><span class=n>hi</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=mi>8</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>lo</span><span class=p>)</span>
<a id=__codelineno-38-26 name=__codelineno-38-26 href=#__codelineno-38-26></a><span class=p>}</span>
</code></pre></div> <p>We already know <code>fn fetch_u8()</code>. <code>fn fetch_i8()</code> does almost the exact thing, only that it casts that byte from <code>u8</code> to <code>i8</code>. Simple enough. Casting in Rust has the beautiful syntax <code>&lt;value&gt; as &lt;type&gt;</code>.</p> <p>So why do we need <code>i8</code>? Because we are building an <code>i16</code> from an <code>i8</code> and a <code>u8</code>. Just a bit of bit arithmetic. We can pass on potential <code>EndOfProgram</code> runtime errors easily with <code>?</code> and <code>Result</code>. It allows us to write some short but still easy-to-read code, I think. So now we can fetch the value, we need for our jump. So let us write the handler for the opcode in <code>fn execute_op()</code> of <code>vm.rs</code>.</p> <h3 id=goto>Goto<a class=headerlink href=#goto title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><a id=__codelineno-39-1 name=__codelineno-39-1 href=#__codelineno-39-1></a><span class=n>op</span>::<span class=n>GOTO</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-39-2 name=__codelineno-39-2 href=#__codelineno-39-2></a><span class=w>    </span><span class=fm>println!</span><span class=p>(</span><span class=s>&quot;  GOTO&quot;</span><span class=p>);</span>
<a id=__codelineno-39-3 name=__codelineno-39-3 href=#__codelineno-39-3></a><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>d</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>fetch_i16</span><span class=p>(</span><span class=n>pgm</span><span class=p>)</span><span class=o>?</span><span class=p>;</span>
<a id=__codelineno-39-4 name=__codelineno-39-4 href=#__codelineno-39-4></a><span class=w>    </span><span class=bp>self</span><span class=p>.</span><span class=n>pc</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>d</span><span class=p>;</span>
<a id=__codelineno-39-5 name=__codelineno-39-5 href=#__codelineno-39-5></a><span class=w>    </span><span class=nb>Ok</span><span class=p>(())</span>
<a id=__codelineno-39-6 name=__codelineno-39-6 href=#__codelineno-39-6></a><span class=p>}</span>
</code></pre></div> <p>So, is that all? No, because we made a Rust-beginner-mistake. If we try and compile the code, we get an error: </p> <div class=highlight><pre><span></span><code><a id=__codelineno-40-1 name=__codelineno-40-1 href=#__codelineno-40-1></a>error[E0308]: mismatched types
<a id=__codelineno-40-2 name=__codelineno-40-2 href=#__codelineno-40-2></a>   --&gt; src/vm.rs:174:28
<a id=__codelineno-40-3 name=__codelineno-40-3 href=#__codelineno-40-3></a>    |
<a id=__codelineno-40-4 name=__codelineno-40-4 href=#__codelineno-40-4></a>174 |                 self.pc += d;
<a id=__codelineno-40-5 name=__codelineno-40-5 href=#__codelineno-40-5></a>    |                            ^ expected `usize`, found `i16`
</code></pre></div> <p>Yeah - Rust does not allow us to do calculations with different types of integers. We need to explicitly cast everything. Rust tries to avoid ambiguity, so no implicit conversions. And, to be honest, the compiler has a good point. We should care even more about that calculation; we want our VM to be robust. We change the handler to:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-41-1 name=__codelineno-41-1 href=#__codelineno-41-1></a><span class=n>op</span>::<span class=n>GOTO</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-41-2 name=__codelineno-41-2 href=#__codelineno-41-2></a><span class=w>    </span><span class=fm>println!</span><span class=p>(</span><span class=s>&quot;  GOTO&quot;</span><span class=p>);</span>
<a id=__codelineno-41-3 name=__codelineno-41-3 href=#__codelineno-41-3></a><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>d</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>fetch_i16</span><span class=p>(</span><span class=n>pgm</span><span class=p>)</span><span class=o>?</span><span class=p>;</span>
<a id=__codelineno-41-4 name=__codelineno-41-4 href=#__codelineno-41-4></a><span class=w>    </span><span class=bp>self</span><span class=p>.</span><span class=n>relative_jump</span><span class=p>(</span><span class=n>pgm</span><span class=p>,</span><span class=w> </span><span class=n>d</span><span class=p>)</span>
<a id=__codelineno-41-5 name=__codelineno-41-5 href=#__codelineno-41-5></a><span class=p>}</span>
</code></pre></div> <h3 id=safe-goto>Safe goto<a class=headerlink href=#safe-goto title="Permanent link">&para;</a></h3> <p>And we add a new method (and we add a new RuntimeError):</p> <div class=highlight><pre><span></span><code><a id=__codelineno-42-1 name=__codelineno-42-1 href=#__codelineno-42-1></a><span class=sd>/// Executes a checked relative jump; Runtime error, if jump leaves program. </span>
<a id=__codelineno-42-2 name=__codelineno-42-2 href=#__codelineno-42-2></a><span class=k>fn</span> <span class=nf>relative_jump</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>,</span><span class=w> </span><span class=n>pgm</span>: <span class=kp>&amp;</span><span class=p>[</span><span class=kt>u8</span><span class=p>],</span><span class=w> </span><span class=n>delta</span>: <span class=kt>i16</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=p>(),</span><span class=w> </span><span class=n>RuntimeError</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-42-3 name=__codelineno-42-3 href=#__codelineno-42-3></a><span class=w>    </span><span class=fm>println!</span><span class=p>(</span><span class=s>&quot;  Jump from {} by {}&quot;</span><span class=p>,</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>pc</span><span class=p>,</span><span class=w> </span><span class=n>delta</span><span class=p>);</span>
<a id=__codelineno-42-4 name=__codelineno-42-4 href=#__codelineno-42-4></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=n>delta</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-42-5 name=__codelineno-42-5 href=#__codelineno-42-5></a><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>d</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>-</span><span class=n>delta</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>usize</span><span class=p>;</span>
<a id=__codelineno-42-6 name=__codelineno-42-6 href=#__codelineno-42-6></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>pc</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>d</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-42-7 name=__codelineno-42-7 href=#__codelineno-42-7></a><span class=w>            </span><span class=bp>self</span><span class=p>.</span><span class=n>pc</span><span class=w> </span><span class=o>-=</span><span class=w> </span><span class=n>d</span><span class=p>;</span>
<a id=__codelineno-42-8 name=__codelineno-42-8 href=#__codelineno-42-8></a><span class=w>            </span><span class=nb>Ok</span><span class=p>(())</span>
<a id=__codelineno-42-9 name=__codelineno-42-9 href=#__codelineno-42-9></a><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-42-10 name=__codelineno-42-10 href=#__codelineno-42-10></a><span class=w>            </span><span class=nb>Err</span><span class=p>(</span><span class=n>RuntimeError</span>::<span class=n>InvalidJump</span><span class=p>)</span>
<a id=__codelineno-42-11 name=__codelineno-42-11 href=#__codelineno-42-11></a><span class=w>        </span><span class=p>}</span>
<a id=__codelineno-42-12 name=__codelineno-42-12 href=#__codelineno-42-12></a><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-42-13 name=__codelineno-42-13 href=#__codelineno-42-13></a><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>d</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>delta</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>usize</span><span class=p>;</span>
<a id=__codelineno-42-14 name=__codelineno-42-14 href=#__codelineno-42-14></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>pc</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>d</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>pgm</span><span class=p>.</span><span class=n>len</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-42-15 name=__codelineno-42-15 href=#__codelineno-42-15></a><span class=w>            </span><span class=bp>self</span><span class=p>.</span><span class=n>pc</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>d</span><span class=p>;</span>
<a id=__codelineno-42-16 name=__codelineno-42-16 href=#__codelineno-42-16></a><span class=w>            </span><span class=nb>Ok</span><span class=p>(())</span>
<a id=__codelineno-42-17 name=__codelineno-42-17 href=#__codelineno-42-17></a><span class=w>        </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-42-18 name=__codelineno-42-18 href=#__codelineno-42-18></a><span class=w>            </span><span class=nb>Err</span><span class=p>(</span><span class=n>RuntimeError</span>::<span class=n>InvalidJump</span><span class=p>)</span>
<a id=__codelineno-42-19 name=__codelineno-42-19 href=#__codelineno-42-19></a><span class=w>        </span><span class=p>}</span>
<a id=__codelineno-42-20 name=__codelineno-42-20 href=#__codelineno-42-20></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-42-21 name=__codelineno-42-21 href=#__codelineno-42-21></a><span class=p>}</span>
</code></pre></div> <h3 id=enter-the-loop>Enter the loop<a class=headerlink href=#enter-the-loop title="Permanent link">&para;</a></h3> <p>Now, let us write a <a href=https://github.com/kratenko/lovem/blob/v0.0.6-journey/src/bin/endless.rs>new program</a> that uses the <code>goto</code> opcode:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-43-1 name=__codelineno-43-1 href=#__codelineno-43-1></a><span class=sd>//! Create a VM and run a small bytecode program in it.</span>
<a id=__codelineno-43-2 name=__codelineno-43-2 href=#__codelineno-43-2></a><span class=sd>//!</span>
<a id=__codelineno-43-3 name=__codelineno-43-3 href=#__codelineno-43-3></a><span class=sd>//! This demonstrates the goto operation with an endless loop.</span>
<a id=__codelineno-43-4 name=__codelineno-43-4 href=#__codelineno-43-4></a><span class=k>use</span><span class=w> </span><span class=n>lovem</span>::<span class=p>{</span><span class=n>op</span><span class=p>,</span><span class=w> </span><span class=n>VM</span><span class=p>};</span>
<a id=__codelineno-43-5 name=__codelineno-43-5 href=#__codelineno-43-5></a>
<a id=__codelineno-43-6 name=__codelineno-43-6 href=#__codelineno-43-6></a><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-43-7 name=__codelineno-43-7 href=#__codelineno-43-7></a><span class=w>    </span><span class=c1>// Create a program in bytecode.</span>
<a id=__codelineno-43-8 name=__codelineno-43-8 href=#__codelineno-43-8></a><span class=w>    </span><span class=c1>// We just hardcode the bytes in an array here:</span>
<a id=__codelineno-43-9 name=__codelineno-43-9 href=#__codelineno-43-9></a><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>pgm</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=n>op</span>::<span class=n>PUSH_U8</span><span class=p>,</span><span class=w> </span><span class=mi>123</span><span class=p>,</span><span class=w> </span><span class=n>op</span>::<span class=n>GOTO</span><span class=p>,</span><span class=w> </span><span class=mh>0xff</span><span class=p>,</span><span class=w> </span><span class=mh>0xfb</span><span class=p>,</span><span class=w> </span><span class=n>op</span>::<span class=n>FIN</span><span class=p>];</span>
<a id=__codelineno-43-10 name=__codelineno-43-10 href=#__codelineno-43-10></a><span class=w>    </span><span class=c1>// Create our VM instance.</span>
<a id=__codelineno-43-11 name=__codelineno-43-11 href=#__codelineno-43-11></a><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>vm</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>VM</span>::<span class=n>new</span><span class=p>(</span><span class=mi>100</span><span class=p>);</span>
<a id=__codelineno-43-12 name=__codelineno-43-12 href=#__codelineno-43-12></a><span class=w>    </span><span class=c1>// Execute the program in our VM:</span>
<a id=__codelineno-43-13 name=__codelineno-43-13 href=#__codelineno-43-13></a><span class=w>    </span><span class=k>match</span><span class=w> </span><span class=n>vm</span><span class=p>.</span><span class=n>run</span><span class=p>(</span><span class=o>&amp;</span><span class=n>pgm</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-43-14 name=__codelineno-43-14 href=#__codelineno-43-14></a><span class=w>        </span><span class=nb>Ok</span><span class=p>(</span><span class=n>_</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-43-15 name=__codelineno-43-15 href=#__codelineno-43-15></a><span class=w>            </span><span class=fm>println!</span><span class=p>(</span><span class=s>&quot;Execution successful.&quot;</span><span class=p>)</span>
<a id=__codelineno-43-16 name=__codelineno-43-16 href=#__codelineno-43-16></a><span class=w>        </span><span class=p>}</span>
<a id=__codelineno-43-17 name=__codelineno-43-17 href=#__codelineno-43-17></a><span class=w>        </span><span class=nb>Err</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-43-18 name=__codelineno-43-18 href=#__codelineno-43-18></a><span class=w>            </span><span class=fm>println!</span><span class=p>(</span><span class=s>&quot;Error during execution: {:?}&quot;</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>);</span>
<a id=__codelineno-43-19 name=__codelineno-43-19 href=#__codelineno-43-19></a><span class=w>        </span><span class=p>}</span>
<a id=__codelineno-43-20 name=__codelineno-43-20 href=#__codelineno-43-20></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-43-21 name=__codelineno-43-21 href=#__codelineno-43-21></a><span class=p>}</span>
</code></pre></div> <p>I will write that bytecode down in a more readable format again:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-44-1 name=__codelineno-44-1 href=#__codelineno-44-1></a>push_u8 123
<a id=__codelineno-44-2 name=__codelineno-44-2 href=#__codelineno-44-2></a>goto -5
<a id=__codelineno-44-3 name=__codelineno-44-3 href=#__codelineno-44-3></a>fin
</code></pre></div> <p>Only 3 instructions. And the <code>fin</code> will never be reached. That <code>0xff, 0xfb</code> after the <code>op::GOTO</code> is the 2 byte oparg: an <code>i16</code> with the value <code>-5</code>. But why <code>-5</code>? When the <code>goto</code> executed, we have read both oparg bytes, so the PC points to the <code>fin</code> at index 5. So adding <code>-5</code> to it will set the PC to <code>0</code>. The next executed instruction will be the <code>push_u8</code> once again. This is an endless loop. So will the program run forever? What do you think will happen? Let's try:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-45-1 name=__codelineno-45-1 href=#__codelineno-45-1></a>VM { stack: [], pc: 0, op_cnt: 0 }
<a id=__codelineno-45-2 name=__codelineno-45-2 href=#__codelineno-45-2></a>Executing op 0x02
<a id=__codelineno-45-3 name=__codelineno-45-3 href=#__codelineno-45-3></a>  PUSH_U8
<a id=__codelineno-45-4 name=__codelineno-45-4 href=#__codelineno-45-4></a>  value: 123
<a id=__codelineno-45-5 name=__codelineno-45-5 href=#__codelineno-45-5></a>VM { stack: [123], pc: 2, op_cnt: 1 }
<a id=__codelineno-45-6 name=__codelineno-45-6 href=#__codelineno-45-6></a>Executing op 0x20
<a id=__codelineno-45-7 name=__codelineno-45-7 href=#__codelineno-45-7></a>  GOTO
<a id=__codelineno-45-8 name=__codelineno-45-8 href=#__codelineno-45-8></a>  Jump from 5 by -5
<a id=__codelineno-45-9 name=__codelineno-45-9 href=#__codelineno-45-9></a>VM { stack: [123], pc: 0, op_cnt: 2 }
<a id=__codelineno-45-10 name=__codelineno-45-10 href=#__codelineno-45-10></a>Executing op 0x02
<a id=__codelineno-45-11 name=__codelineno-45-11 href=#__codelineno-45-11></a>  PUSH_U8
<a id=__codelineno-45-12 name=__codelineno-45-12 href=#__codelineno-45-12></a>  value: 123
<a id=__codelineno-45-13 name=__codelineno-45-13 href=#__codelineno-45-13></a>VM { stack: [123, 123], pc: 2, op_cnt: 3 }
<a id=__codelineno-45-14 name=__codelineno-45-14 href=#__codelineno-45-14></a>Executing op 0x20
<a id=__codelineno-45-15 name=__codelineno-45-15 href=#__codelineno-45-15></a>  GOTO
<a id=__codelineno-45-16 name=__codelineno-45-16 href=#__codelineno-45-16></a>
<a id=__codelineno-45-17 name=__codelineno-45-17 href=#__codelineno-45-17></a>[...]
<a id=__codelineno-45-18 name=__codelineno-45-18 href=#__codelineno-45-18></a>
<a id=__codelineno-45-19 name=__codelineno-45-19 href=#__codelineno-45-19></a>VM { stack: [123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123, 123], pc: 0, op_cnt: 200 }
<a id=__codelineno-45-20 name=__codelineno-45-20 href=#__codelineno-45-20></a>Executing op 0x02
<a id=__codelineno-45-21 name=__codelineno-45-21 href=#__codelineno-45-21></a>  PUSH_U8
<a id=__codelineno-45-22 name=__codelineno-45-22 href=#__codelineno-45-22></a>  value: 123
<a id=__codelineno-45-23 name=__codelineno-45-23 href=#__codelineno-45-23></a>Error during execution: StackOverflow
<a id=__codelineno-45-24 name=__codelineno-45-24 href=#__codelineno-45-24></a>
<a id=__codelineno-45-25 name=__codelineno-45-25 href=#__codelineno-45-25></a>Process finished with exit code 0
</code></pre></div> <p>There is a <code>push_u8</code> operation in our endless loop. So it will fill our stack until it is full! The program hits a runtime error after 200 executed instructions. Great, now we tested that, too.</p> <h1 id=nope>NOPE<a class=headerlink href=#nope title="Permanent link">&para;</a></h1> <p>That is not very dynamic. We want to make decisions! We want to choose our path. What we want is <em>branching</em>. We will introduce a new opcode, that will decide, which branch the execution of our program will take, based on a value during runtime. If this sounds unfamiliar to you, let me tell you, what statement we want to introduce: it is the <em>if</em> statement.</p> <p>So, how does that work? As mentioned, normally the PC is incremented on each byte we fetch from the bytecode. And the PC always points to the next instruction, that will be executed. So if we want to change the path of execution, what we have to do is change the value of the PC.</p> <p>An operation, that simply changes the PC statically, would be a <em>GOTO</em> statement. But there is no branching involved in that, the path that will be executed is always clear. The <em>if</em> statement on the other hand only alters the PC, if a certain condition is met.</p> <h3 id=a-new-opcode_1>A new opcode<a class=headerlink href=#a-new-opcode_1 title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><a id=__codelineno-46-1 name=__codelineno-46-1 href=#__codelineno-46-1></a><span class=sd>/// opcode: Branch if top value is equal to zero.</span>
<a id=__codelineno-46-2 name=__codelineno-46-2 href=#__codelineno-46-2></a><span class=sd>///</span>
<a id=__codelineno-46-3 name=__codelineno-46-3 href=#__codelineno-46-3></a><span class=sd>/// pop: 1, push: 0</span>
<a id=__codelineno-46-4 name=__codelineno-46-4 href=#__codelineno-46-4></a><span class=sd>/// oparg: 2B, i16 relative jump</span>
<a id=__codelineno-46-5 name=__codelineno-46-5 href=#__codelineno-46-5></a><span class=k>pub</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=n>IFEQ</span>: <span class=kt>u8</span> <span class=o>=</span><span class=w> </span><span class=mh>0x20</span><span class=p>;</span>
</code></pre></div> <p>Our new operation pops only one value. So what does it get compared to? That's easy: zero. If you need to compare two values to each other, just subtract them instead, and then you can compare with zero. That gives the same result.</p> <p>And what kind of oparg does this operation take? A signed integer. That is the value that should be added to the PC, if our condition is met. This will result in a relative jump.</p> <h3 id=homework_4>Homework<a class=headerlink href=#homework_4 title="Permanent link">&para;</a></h3> <p>Same as always. Write some bytecode. Try some jumping around. Run into troubles! You can write a program, that has a <code>fin</code> in the middle, but executes code that lies behind that instruction.</p> <h2 id=dont-byte-me>Don't byte me!<a class=headerlink href=#dont-byte-me title="Permanent link">&para;</a></h2> <p><strong>I have had it with these motherloving bytes in this motherloving bytecode!</strong></p> <aside class=mdx-author> <p><img alt=@kratenko src=https://avatars.githubusercontent.com/kratenko></p> <p><span><strong>kratenko</strong> · <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 16 16"><path fill-rule=evenodd d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"/></svg></span> <a href=https://github.com/kratenko>kratenko</a></span> <span> <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path fill-rule=evenodd d="M6.75 0a.75.75 0 0 1 .75.75V3h9V.75a.75.75 0 0 1 1.5 0V3h2.75c.966 0 1.75.784 1.75 1.75v16a1.75 1.75 0 0 1-1.75 1.75H3.25a1.75 1.75 0 0 1-1.75-1.75v-16C1.5 3.784 2.284 3 3.25 3H6V.75A.75.75 0 0 1 6.75 0zm-3.5 4.5a.25.25 0 0 0-.25.25V8h18V4.75a.25.25 0 0 0-.25-.25H3.25zM21 9.5H3v11.25c0 .138.112.25.25.25h17.5a.25.25 0 0 0 .25-.25V9.5z"/></svg></span> 2022-07-25 · <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path fill-rule=evenodd d="M0 3.75A.75.75 0 0 1 .75 3h7.497c1.566 0 2.945.8 3.751 2.014A4.496 4.496 0 0 1 15.75 3h7.5a.75.75 0 0 1 .75.75v15.063a.75.75 0 0 1-.755.75l-7.682-.052a3 3 0 0 0-2.142.878l-.89.891a.75.75 0 0 1-1.061 0l-.902-.901a3 3 0 0 0-2.121-.879H.75a.75.75 0 0 1-.75-.75v-15zm11.247 3.747a3 3 0 0 0-3-2.997H1.5V18h6.947a4.5 4.5 0 0 1 2.803.98l-.003-11.483zm1.503 11.485V7.5a3 3 0 0 1 3-3h6.75v13.558l-6.927-.047a4.5 4.5 0 0 0-2.823.971z"/></svg></span> Entry #20 · <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12.5 7.25a.75.75 0 0 0-1.5 0v5.5c0 .27.144.518.378.651l3.5 2a.75.75 0 0 0 .744-1.302L12.5 12.315V7.25z"/><path fill-rule=evenodd d="M12 1C5.925 1 1 5.925 1 12s4.925 11 11 11 11-4.925 11-11S18.075 1 12 1zM2.5 12a9.5 9.5 0 1 1 19 0 9.5 9.5 0 0 1-19 0z"/></svg></span> 5 min read · <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M7.75 6.5a1.25 1.25 0 1 0 0 2.5 1.25 1.25 0 0 0 0-2.5z"/><path fill-rule=evenodd d="M2.5 1A1.5 1.5 0 0 0 1 2.5v8.44c0 .397.158.779.44 1.06l10.25 10.25a1.5 1.5 0 0 0 2.12 0l8.44-8.44a1.5 1.5 0 0 0 0-2.12L12 1.44A1.5 1.5 0 0 0 10.94 1H2.5zm0 1.5h8.44l10.25 10.25-8.44 8.44L2.5 10.94V2.5z"/></svg></span> <a href=https://github.com/kratenko/lovem/releases/tag/v0.0.7-journey>v0.0.7-journey</a> </span></p> </aside> <hr> <p>By now you should have come to a realisation: writing bytecode sucks! It wasn't fun to begin with, but now that we introduce jumps in our code, we need to count how many bytes the jump takes &ndash; and that with instructions that have different numbers of bytes as opargs. Encoding negative numbers in bytes is also no fun. And just think about it: if you change your program (e.g. add a few instructions), you have to adjust those relative jumps! How horrible is that? Can't someone else do it? Well, yeah, of course. We invented a machine that can do annoying and monotone tasks that require accuracy and that must be done over and over again. That machine is, of course, the computer.</p> <p>Well, lucky us, that we know how to tell a computer what it should do. So let's write a program, that writes bytecode for us. I am not talking about compiling a programming language into our VM; at least not yet, not for a long time. But something that lets us write those instructions in a way that is at least a bit more human friendly.</p> <p>Maybe you remember that I already tried to write some of the bytecode programs I showed you in a more readable way, like this:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-47-1 name=__codelineno-47-1 href=#__codelineno-47-1></a>push_u8 5
<a id=__codelineno-47-2 name=__codelineno-47-2 href=#__codelineno-47-2></a>push_u8 7
<a id=__codelineno-47-3 name=__codelineno-47-3 href=#__codelineno-47-3></a>push_u8 11
<a id=__codelineno-47-4 name=__codelineno-47-4 href=#__codelineno-47-4></a>sub
<a id=__codelineno-47-5 name=__codelineno-47-5 href=#__codelineno-47-5></a>mul
<a id=__codelineno-47-6 name=__codelineno-47-6 href=#__codelineno-47-6></a>push_u8 13
<a id=__codelineno-47-7 name=__codelineno-47-7 href=#__codelineno-47-7></a>push_u8 17
<a id=__codelineno-47-8 name=__codelineno-47-8 href=#__codelineno-47-8></a>add
<a id=__codelineno-47-9 name=__codelineno-47-9 href=#__codelineno-47-9></a>add
<a id=__codelineno-47-10 name=__codelineno-47-10 href=#__codelineno-47-10></a>pop
<a id=__codelineno-47-11 name=__codelineno-47-11 href=#__codelineno-47-11></a>fin
</code></pre></div> <p>If that did remind you of something, that might be no coincidence.</p> <h3 id=assembler>Assembler<a class=headerlink href=#assembler title="Permanent link">&para;</a></h3> <p>The listing up there looks a bit like assembler code. And on the earlier draft of <em>lovem</em> I did already write a program that could translate those listings into bytecode. We will do that again, together. But this will take us some time (that is, multiple journal entries). We need to acquire some additional Rust skills for that. And there is so much to explain inside that assembler program itself.</p> <p>Once again, I am making this up along the way. Yes, I have a plan, but I will just start to introduce syntax for the assembler, and it might not be ideal. That means, I might change it all again later. As the VM itself, our assembler will be experimental. You are welcome to give me ideas for the syntax; we do have the comments now, unter each post, feel free to use them. There is the whole <a href=https://github.com/kratenko/lovem/discussions>GitHub discussions</a> page as well. And you can still find me on Twitter. Find the link at the bottom of this page.</p> <h3 id=command-line-tool>Command line tool<a class=headerlink href=#command-line-tool title="Permanent link">&para;</a></h3> <p>The assembler will be a binary that you call with parameters. A typical command line tool, just like <code>gcc</code> or <code>rustc</code> are. So what we need to do, is to learn how one writes a command line tool in Rust. One that can read files, because I plan to write assembly programs in text files. And I have no desire to start parsing command line arguments myself. Neither do I want to write an introduction on writing command line tools in Rust. All this has been done. So I kindly direct you to an online book:</p> <p><a href=https://rust-cli.github.io/book/index.html>Command Line Applications in Rust</a>.</p> <p>That is where I got what I will be using here. They use a crate called <a href=https://docs.rs/clap/latest/clap/ >clap</a>, which seems to be the most used lib for building command line tools in Rust. It takes about 10 minutes to read. Finding out how to use the options of clap that I want took longer, but that will not be a thing for you, as I will just be using those options.</p> <p>This is the first time we are using external crates in Rust. We need to add our dependencies to <a href=https://github.com/kratenko/lovem/blob/v0.0.7-journey/Cargo.toml>Cargo.toml</a>, before we can use them:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-48-1 name=__codelineno-48-1 href=#__codelineno-48-1></a><span class=k>[dependencies]</span>
<a id=__codelineno-48-2 name=__codelineno-48-2 href=#__codelineno-48-2></a><span class=n>clap</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>version</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=s2>&quot;3.2.12&quot;</span><span class=p>,</span><span class=w> </span><span class=n>features</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=p>[</span><span class=s2>&quot;derive&quot;</span><span class=p>]</span><span class=w> </span><span class=p>}</span>
<a id=__codelineno-48-3 name=__codelineno-48-3 href=#__codelineno-48-3></a><span class=n>anyhow</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s2>&quot;1.0.58&quot;</span>
</code></pre></div> <h3 id=introducing-lovas>Introducing lovas<a class=headerlink href=#introducing-lovas title="Permanent link">&para;</a></h3> <p>Now let us start with the assembler. We create a new binary that will become our assembler: <a href=https://github.com/kratenko/lovem/blob/v0.0.7-journey/src/bin/lovas.rs>lovas.rs</a></p> <div class=highlight><pre><span></span><code><a id=__codelineno-49-1 name=__codelineno-49-1 href=#__codelineno-49-1></a><span class=sd>//! An experimental assembler for lovem</span>
<a id=__codelineno-49-2 name=__codelineno-49-2 href=#__codelineno-49-2></a><span class=k>use</span><span class=w> </span><span class=n>clap</span>::<span class=n>Parser</span><span class=p>;</span>
<a id=__codelineno-49-3 name=__codelineno-49-3 href=#__codelineno-49-3></a><span class=k>use</span><span class=w> </span><span class=n>anyhow</span>::<span class=p>{</span><span class=n>Context</span><span class=p>,</span><span class=w> </span><span class=nb>Result</span><span class=p>};</span>
<a id=__codelineno-49-4 name=__codelineno-49-4 href=#__codelineno-49-4></a>
<a id=__codelineno-49-5 name=__codelineno-49-5 href=#__codelineno-49-5></a><span class=sd>/// Struct used to declare the command line tool behaviour using clap.</span>
<a id=__codelineno-49-6 name=__codelineno-49-6 href=#__codelineno-49-6></a><span class=sd>///</span>
<a id=__codelineno-49-7 name=__codelineno-49-7 href=#__codelineno-49-7></a><span class=sd>/// This defines the arguments and options the tool provides. It is also used to </span>
<a id=__codelineno-49-8 name=__codelineno-49-8 href=#__codelineno-49-8></a><span class=sd>/// generate the instructions you get when calling it with `--help`.</span>
<a id=__codelineno-49-9 name=__codelineno-49-9 href=#__codelineno-49-9></a>#<span class=cp>#[derive(Parser, Debug)]</span>
<a id=__codelineno-49-10 name=__codelineno-49-10 href=#__codelineno-49-10></a>#<span class=cp>#[clap(name = </span><span class=s>&quot;lovas&quot;</span><span class=cp>,</span>
<a id=__codelineno-49-11 name=__codelineno-49-11 href=#__codelineno-49-11></a><span class=cp>long_about = </span><span class=s>&quot;An experimental assembler for lovem, the Low Overhead Virtual Embedded Machine.&quot;</span><span class=cp>,</span>
<a id=__codelineno-49-12 name=__codelineno-49-12 href=#__codelineno-49-12></a><span class=cp>)]</span>
<a id=__codelineno-49-13 name=__codelineno-49-13 href=#__codelineno-49-13></a><span class=k>struct</span> <span class=nc>Cli</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-49-14 name=__codelineno-49-14 href=#__codelineno-49-14></a><span class=w>    </span><span class=cp>#[clap(parse(from_os_str), help = </span><span class=s>&quot;Path to assembler source file.&quot;</span><span class=cp>)]</span>
<a id=__codelineno-49-15 name=__codelineno-49-15 href=#__codelineno-49-15></a><span class=w>    </span><span class=n>source</span>: <span class=nc>std</span>::<span class=n>path</span>::<span class=n>PathBuf</span><span class=p>,</span>
<a id=__codelineno-49-16 name=__codelineno-49-16 href=#__codelineno-49-16></a><span class=p>}</span>
<a id=__codelineno-49-17 name=__codelineno-49-17 href=#__codelineno-49-17></a>
<a id=__codelineno-49-18 name=__codelineno-49-18 href=#__codelineno-49-18></a><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=p>()</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-49-19 name=__codelineno-49-19 href=#__codelineno-49-19></a><span class=w>    </span><span class=c1>// read, validate, and evaluate command line parameters:</span>
<a id=__codelineno-49-20 name=__codelineno-49-20 href=#__codelineno-49-20></a><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>args</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Cli</span>::<span class=n>parse</span><span class=p>();</span>
<a id=__codelineno-49-21 name=__codelineno-49-21 href=#__codelineno-49-21></a><span class=w>    </span><span class=c1>// read complete source file into String:</span>
<a id=__codelineno-49-22 name=__codelineno-49-22 href=#__codelineno-49-22></a><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>content</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>std</span>::<span class=n>fs</span>::<span class=n>read_to_string</span><span class=p>(</span><span class=o>&amp;</span><span class=n>args</span><span class=p>.</span><span class=n>source</span><span class=p>)</span>
<a id=__codelineno-49-23 name=__codelineno-49-23 href=#__codelineno-49-23></a><span class=w>        </span><span class=p>.</span><span class=n>with_context</span><span class=p>(</span>
<a id=__codelineno-49-24 name=__codelineno-49-24 href=#__codelineno-49-24></a><span class=w>            </span><span class=o>||</span><span class=w> </span><span class=fm>format!</span><span class=p>(</span><span class=s>&quot;could not read file `{}`&quot;</span><span class=p>,</span><span class=w> </span><span class=n>args</span><span class=p>.</span><span class=n>source</span><span class=p>.</span><span class=n>as_path</span><span class=p>().</span><span class=n>display</span><span class=p>().</span><span class=n>to_string</span><span class=p>())</span>
<a id=__codelineno-49-25 name=__codelineno-49-25 href=#__codelineno-49-25></a><span class=w>        </span><span class=p>)</span><span class=o>?</span><span class=p>;</span>
<a id=__codelineno-49-26 name=__codelineno-49-26 href=#__codelineno-49-26></a><span class=w>    </span><span class=c1>// For now, just print our all the lines in the file:</span>
<a id=__codelineno-49-27 name=__codelineno-49-27 href=#__codelineno-49-27></a><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>n</span><span class=p>,</span><span class=w> </span><span class=n>line</span><span class=p>)</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=n>content</span><span class=p>.</span><span class=n>lines</span><span class=p>().</span><span class=n>enumerate</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-49-28 name=__codelineno-49-28 href=#__codelineno-49-28></a><span class=w>        </span><span class=fm>println!</span><span class=p>(</span><span class=s>&quot;{:4}: &#39;{}&#39;&quot;</span><span class=p>,</span><span class=w> </span><span class=n>n</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=n>line</span><span class=p>);</span>
<a id=__codelineno-49-29 name=__codelineno-49-29 href=#__codelineno-49-29></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-49-30 name=__codelineno-49-30 href=#__codelineno-49-30></a><span class=w>    </span><span class=c1>// We succeeded in our work, so return Ok() as a Result:</span>
<a id=__codelineno-49-31 name=__codelineno-49-31 href=#__codelineno-49-31></a><span class=w>    </span><span class=nb>Ok</span><span class=p>(())</span>
<a id=__codelineno-49-32 name=__codelineno-49-32 href=#__codelineno-49-32></a><span class=p>}</span>
</code></pre></div> <p>As it happens with Rust, the code is very dense. I try to explain what I do inside the code using comments. This does not look like it does too much. Yet it does. You can call it using <code>cargo run --bin lovas</code>, as we learned earlier:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-50-1 name=__codelineno-50-1 href=#__codelineno-50-1></a>kratenko@jotun:~/git/lovem$ cargo run --bin lovas
<a id=__codelineno-50-2 name=__codelineno-50-2 href=#__codelineno-50-2></a>
<a id=__codelineno-50-3 name=__codelineno-50-3 href=#__codelineno-50-3></a>    Finished dev [unoptimized + debuginfo] target(s) in 0.02s
<a id=__codelineno-50-4 name=__codelineno-50-4 href=#__codelineno-50-4></a>     Running `target/debug/lovas`
<a id=__codelineno-50-5 name=__codelineno-50-5 href=#__codelineno-50-5></a>error: The following required arguments were not provided:
<a id=__codelineno-50-6 name=__codelineno-50-6 href=#__codelineno-50-6></a>    &lt;SOURCE&gt;
<a id=__codelineno-50-7 name=__codelineno-50-7 href=#__codelineno-50-7></a>
<a id=__codelineno-50-8 name=__codelineno-50-8 href=#__codelineno-50-8></a>USAGE:
<a id=__codelineno-50-9 name=__codelineno-50-9 href=#__codelineno-50-9></a>    lovas &lt;SOURCE&gt;
<a id=__codelineno-50-10 name=__codelineno-50-10 href=#__codelineno-50-10></a>
<a id=__codelineno-50-11 name=__codelineno-50-11 href=#__codelineno-50-11></a>For more information try --help
</code></pre></div> <p>That is already a lot! It finds out that you did not supply a required argument and tells you in a somewhat understandable error message. We did not write any of that. And it even directs you how to get help: add <code>--help</code> to your call.</p> <p>Now if we use cargo to run our binary, we need to add an extra bit to the call, because we need to tell cargo where its own arguments end, end where the arguments to the called binary begin. This is done (as it is custom) by adding <code>--</code>, to indicate the end of cargo's arguments. So if we want to pass <code>--help</code> to lovas, we can do it like this:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-51-1 name=__codelineno-51-1 href=#__codelineno-51-1></a>kratenko@jotun:~/git/lovem$ cargo run --bin lovas -- --help
<a id=__codelineno-51-2 name=__codelineno-51-2 href=#__codelineno-51-2></a>
<a id=__codelineno-51-3 name=__codelineno-51-3 href=#__codelineno-51-3></a>    Finished dev [unoptimized + debuginfo] target(s) in 0.02s
<a id=__codelineno-51-4 name=__codelineno-51-4 href=#__codelineno-51-4></a>     Running `target/debug/lovas --help`
<a id=__codelineno-51-5 name=__codelineno-51-5 href=#__codelineno-51-5></a>lovas 
<a id=__codelineno-51-6 name=__codelineno-51-6 href=#__codelineno-51-6></a>An experimental assembler for lovem, the Low Overhead Virtual Embedded Machine.
<a id=__codelineno-51-7 name=__codelineno-51-7 href=#__codelineno-51-7></a>
<a id=__codelineno-51-8 name=__codelineno-51-8 href=#__codelineno-51-8></a>USAGE:
<a id=__codelineno-51-9 name=__codelineno-51-9 href=#__codelineno-51-9></a>    lovas &lt;SOURCE&gt;
<a id=__codelineno-51-10 name=__codelineno-51-10 href=#__codelineno-51-10></a>
<a id=__codelineno-51-11 name=__codelineno-51-11 href=#__codelineno-51-11></a>ARGS:
<a id=__codelineno-51-12 name=__codelineno-51-12 href=#__codelineno-51-12></a>    &lt;SOURCE&gt;
<a id=__codelineno-51-13 name=__codelineno-51-13 href=#__codelineno-51-13></a>            Path to assembler source file.
<a id=__codelineno-51-14 name=__codelineno-51-14 href=#__codelineno-51-14></a>
<a id=__codelineno-51-15 name=__codelineno-51-15 href=#__codelineno-51-15></a>OPTIONS:
<a id=__codelineno-51-16 name=__codelineno-51-16 href=#__codelineno-51-16></a>    -h, --help
<a id=__codelineno-51-17 name=__codelineno-51-17 href=#__codelineno-51-17></a>            Print help information
</code></pre></div> <p>How helpful! Also, now you can see why I added those two strings to our <code>Cli</code> struct; they show up in the help message.</p> <h3 id=run-it>Run it<a class=headerlink href=#run-it title="Permanent link">&para;</a></h3> <p>It looks like we need to give it a file to read, if we want the program to succeed and not exit with an error. I did write a little assembly program that we can use: <a href=https://github.com/kratenko/lovem/blob/v0.0.7-journey/pgm/hallo-stack.lass>hallo-stack.lass</a>. Our assembler will not so anything too useful with it, because we did not write an assembler, yet. It will simply print out the lines of the file, prefixed with the line number (the call to <code>.enumerate()</code> is what I use to count the lines, while iterating over them).</p> <div class=highlight><pre><span></span><code><a id=__codelineno-52-1 name=__codelineno-52-1 href=#__codelineno-52-1></a>kratenko@jotun:~/git/lovem$ cargo run --bin lovas -- pgm/hallo-stack.lass
<a id=__codelineno-52-2 name=__codelineno-52-2 href=#__codelineno-52-2></a>
<a id=__codelineno-52-3 name=__codelineno-52-3 href=#__codelineno-52-3></a>    Finished dev [unoptimized + debuginfo] target(s) in 0.02s
<a id=__codelineno-52-4 name=__codelineno-52-4 href=#__codelineno-52-4></a>     Running `target/debug/lovas pgm/hallo-stack.lass`
<a id=__codelineno-52-5 name=__codelineno-52-5 href=#__codelineno-52-5></a>   1: &#39;push_u8 123&#39;
<a id=__codelineno-52-6 name=__codelineno-52-6 href=#__codelineno-52-6></a>   2: &#39;push_u8 200&#39;
<a id=__codelineno-52-7 name=__codelineno-52-7 href=#__codelineno-52-7></a>   3: &#39;add&#39;
<a id=__codelineno-52-8 name=__codelineno-52-8 href=#__codelineno-52-8></a>   4: &#39;pop&#39;
<a id=__codelineno-52-9 name=__codelineno-52-9 href=#__codelineno-52-9></a>   5: &#39;fin&#39;
</code></pre></div> <p>Neat! I feel this is a lot for such a small program! It is also enough for this journal entry. We will be working on <code>lovas</code> for a bit, now.</p> <h3 id=homework_5>Homework<a class=headerlink href=#homework_5 title="Permanent link">&para;</a></h3> <p>Well - if you have not done so, read the book I linked. At least up until chapter 1.4, I guess, that is what we need for now.</p> <p>And try to trigger some errors when calling <code>lovas</code>. What if the file you tell it to open does not exist? What if it cannot be read? Do you understand how those error messages propagate through the program and end up as a readable message in your console?</p> <h2 id=assemble>Assemble!<a class=headerlink href=#assemble title="Permanent link">&para;</a></h2> <p><strong>We introduce an API for assembly to our lovem library.</strong></p> <aside class=mdx-author> <p><img alt=@kratenko src=https://avatars.githubusercontent.com/kratenko></p> <p><span><strong>kratenko</strong> · <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 16 16"><path fill-rule=evenodd d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"/></svg></span> <a href=https://github.com/kratenko>kratenko</a></span> <span> <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path fill-rule=evenodd d="M6.75 0a.75.75 0 0 1 .75.75V3h9V.75a.75.75 0 0 1 1.5 0V3h2.75c.966 0 1.75.784 1.75 1.75v16a1.75 1.75 0 0 1-1.75 1.75H3.25a1.75 1.75 0 0 1-1.75-1.75v-16C1.5 3.784 2.284 3 3.25 3H6V.75A.75.75 0 0 1 6.75 0zm-3.5 4.5a.25.25 0 0 0-.25.25V8h18V4.75a.25.25 0 0 0-.25-.25H3.25zM21 9.5H3v11.25c0 .138.112.25.25.25h17.5a.25.25 0 0 0 .25-.25V9.5z"/></svg></span> 2022-07-26 · <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path fill-rule=evenodd d="M0 3.75A.75.75 0 0 1 .75 3h7.497c1.566 0 2.945.8 3.751 2.014A4.496 4.496 0 0 1 15.75 3h7.5a.75.75 0 0 1 .75.75v15.063a.75.75 0 0 1-.755.75l-7.682-.052a3 3 0 0 0-2.142.878l-.89.891a.75.75 0 0 1-1.061 0l-.902-.901a3 3 0 0 0-2.121-.879H.75a.75.75 0 0 1-.75-.75v-15zm11.247 3.747a3 3 0 0 0-3-2.997H1.5V18h6.947a4.5 4.5 0 0 1 2.803.98l-.003-11.483zm1.503 11.485V7.5a3 3 0 0 1 3-3h6.75v13.558l-6.927-.047a4.5 4.5 0 0 0-2.823.971z"/></svg></span> Entry #21 · <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12.5 7.25a.75.75 0 0 0-1.5 0v5.5c0 .27.144.518.378.651l3.5 2a.75.75 0 0 0 .744-1.302L12.5 12.315V7.25z"/><path fill-rule=evenodd d="M12 1C5.925 1 1 5.925 1 12s4.925 11 11 11 11-4.925 11-11S18.075 1 12 1zM2.5 12a9.5 9.5 0 1 1 19 0 9.5 9.5 0 0 1-19 0z"/></svg></span> 5 min read · <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M7.75 6.5a1.25 1.25 0 1 0 0 2.5 1.25 1.25 0 0 0 0-2.5z"/><path fill-rule=evenodd d="M2.5 1A1.5 1.5 0 0 0 1 2.5v8.44c0 .397.158.779.44 1.06l10.25 10.25a1.5 1.5 0 0 0 2.12 0l8.44-8.44a1.5 1.5 0 0 0 0-2.12L12 1.44A1.5 1.5 0 0 0 10.94 1H2.5zm0 1.5h8.44l10.25 10.25-8.44 8.44L2.5 10.94V2.5z"/></svg></span> <a href=https://github.com/kratenko/lovem/releases/tag/v0.0.8-journey>v0.0.8-journey</a> </span></p> </aside> <hr> <p>Last time, we built the frame of a command line program, that will become our new assembler, <code>lovas</code>. It is time that we give that program the power to assemble.</p> <h3 id=calling-the-real-assembler>Calling the real assembler<a class=headerlink href=#calling-the-real-assembler title="Permanent link">&para;</a></h3> <p><code>lovas.rs</code> is just the executable wrapper around the actual assembler, that will live inside the library. All <code>lovas.rs</code> does, is supply the command line interface. And that CLI-part does not belong in a library function. We got it nicely separated. And programs using the library can assemble source to bytecode themselves, without calling an external binary.</p> <p>We alter <a href=https://github.com/kratenko/lovem/blob/v0.0.8-journey/src/bin/lovas.rs><code>lovas.rs</code></a> a bit. The part that just printed out the source lines is gone. We replace it with a call to a new library function, that can transfer assembly code into bytecode:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-53-1 name=__codelineno-53-1 href=#__codelineno-53-1></a><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=p>()</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-53-2 name=__codelineno-53-2 href=#__codelineno-53-2></a><span class=w>    </span><span class=o>..</span><span class=p>.</span><span class=w> </span><span class=n>the</span><span class=w> </span><span class=n>same</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=n>before</span><span class=w> </span><span class=o>..</span><span class=p>.</span>
<a id=__codelineno-53-3 name=__codelineno-53-3 href=#__codelineno-53-3></a>
<a id=__codelineno-53-4 name=__codelineno-53-4 href=#__codelineno-53-4></a><span class=w>    </span><span class=c1>// run the assembler:</span>
<a id=__codelineno-53-5 name=__codelineno-53-5 href=#__codelineno-53-5></a><span class=w>    </span><span class=k>match</span><span class=w> </span><span class=n>asm</span>::<span class=n>assemble</span><span class=p>(</span><span class=o>&amp;</span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>content</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-53-6 name=__codelineno-53-6 href=#__codelineno-53-6></a><span class=w>        </span><span class=nb>Ok</span><span class=p>(</span><span class=n>pgm</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-53-7 name=__codelineno-53-7 href=#__codelineno-53-7></a><span class=w>            </span><span class=c1>// we succeeded and now have a program with bytecode:</span>
<a id=__codelineno-53-8 name=__codelineno-53-8 href=#__codelineno-53-8></a><span class=w>            </span><span class=fm>println!</span><span class=p>(</span><span class=s>&quot;{:?}&quot;</span><span class=p>,</span><span class=w> </span><span class=n>pgm</span><span class=p>);</span>
<a id=__codelineno-53-9 name=__codelineno-53-9 href=#__codelineno-53-9></a><span class=w>            </span><span class=nb>Ok</span><span class=p>(())</span>
<a id=__codelineno-53-10 name=__codelineno-53-10 href=#__codelineno-53-10></a><span class=w>        </span><span class=p>},</span>
<a id=__codelineno-53-11 name=__codelineno-53-11 href=#__codelineno-53-11></a><span class=w>        </span><span class=nb>Err</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-53-12 name=__codelineno-53-12 href=#__codelineno-53-12></a><span class=w>            </span><span class=c1>// Something went wrong during assembly.</span>
<a id=__codelineno-53-13 name=__codelineno-53-13 href=#__codelineno-53-13></a><span class=w>            </span><span class=c1>// Convert the error report, so that `anyhow` can do its magic</span>
<a id=__codelineno-53-14 name=__codelineno-53-14 href=#__codelineno-53-14></a><span class=w>            </span><span class=c1>// and display some helpful error message:</span>
<a id=__codelineno-53-15 name=__codelineno-53-15 href=#__codelineno-53-15></a><span class=w>            </span><span class=nb>Err</span><span class=p>(</span><span class=n>Error</span>::<span class=n>from</span><span class=p>(</span><span class=n>e</span><span class=p>))</span>
<a id=__codelineno-53-16 name=__codelineno-53-16 href=#__codelineno-53-16></a><span class=w>        </span><span class=p>},</span>
<a id=__codelineno-53-17 name=__codelineno-53-17 href=#__codelineno-53-17></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-53-18 name=__codelineno-53-18 href=#__codelineno-53-18></a><span class=p>}</span>
</code></pre></div> <p>The important part is the call to <code>asm::assemble(&amp;name, &amp;constent)</code>. We created a new module <code>asm</code> inside our lib. It exposes only a single function <code>assemble</code> and a few types for error handling. There will be a lot to unpack inside that module.</p> <p>The good news for us is: we do not need to restrain ourselves as much as we do in the VM itself. Resource usage is not really an issue here, because the assembler is not meant to run in a restricted environment. The idea of <em>lovem</em> is, that you write your programs elsewhere, outside the restricted environment, and only run the compiled bytecode in the VM on the restricted device. And since the scope handled by the assembler will still be defined by that restricted device, we expect to only write relatively small and simple programs. With modern computers used for assembling, we can use as much memory as we want.</p> <p>Oh, by the way... Yeah, I seem to stick to these short, cryptic names for the parts of <em>lovem</em>. <code>VM</code>, <code>Pgm</code>, <code>op</code>, <code>asm</code> - I kinda like it that way, and it goes well with the register names etc. That feels right for something as low-lever as a VM. And I give my best to always document those things properly, so that your IDE of choice will always show you, what each thing is.</p> <h3 id=asm>ASM<a class=headerlink href=#asm title="Permanent link">&para;</a></h3> <p>I wrote a very basic assembler inside <a href=https://github.com/kratenko/lovem/blob/v0.0.8-journey/src/asm.rs><code>asm.rs</code></a>, and it is already over 250 lines long. Quite a lot to unpack. As before, I try to explain as much as possible inside the source code itself, using comments. This makes it easier to follow, and you can even do so inside the source in the repo, without reading this blog.</p> <p>There are four types that I introduce inside the mod:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-54-1 name=__codelineno-54-1 href=#__codelineno-54-1></a><span class=sd>/// Errors that can happen during assembly.</span>
<a id=__codelineno-54-2 name=__codelineno-54-2 href=#__codelineno-54-2></a>#<span class=cp>#[derive(Debug, Clone)]</span>
<a id=__codelineno-54-3 name=__codelineno-54-3 href=#__codelineno-54-3></a><span class=k>pub</span><span class=w> </span><span class=k>enum</span> <span class=nc>AsmError</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-54-4 name=__codelineno-54-4 href=#__codelineno-54-4></a><span class=w>    </span><span class=n>InvalidLine</span><span class=p>,</span>
<a id=__codelineno-54-5 name=__codelineno-54-5 href=#__codelineno-54-5></a><span class=w>    </span><span class=n>UnknownInstruction</span><span class=p>(</span><span class=nb>String</span><span class=p>),</span>
<a id=__codelineno-54-6 name=__codelineno-54-6 href=#__codelineno-54-6></a><span class=w>    </span><span class=n>UnexpectedArgument</span><span class=p>,</span>
<a id=__codelineno-54-7 name=__codelineno-54-7 href=#__codelineno-54-7></a><span class=w>    </span><span class=n>MissingArgument</span><span class=p>,</span>
<a id=__codelineno-54-8 name=__codelineno-54-8 href=#__codelineno-54-8></a><span class=w>    </span><span class=n>InvalidArgument</span><span class=p>,</span>
<a id=__codelineno-54-9 name=__codelineno-54-9 href=#__codelineno-54-9></a><span class=p>}</span>
<a id=__codelineno-54-10 name=__codelineno-54-10 href=#__codelineno-54-10></a>
<a id=__codelineno-54-11 name=__codelineno-54-11 href=#__codelineno-54-11></a><span class=sd>/// Report of failed assembly attempt.</span>
<a id=__codelineno-54-12 name=__codelineno-54-12 href=#__codelineno-54-12></a><span class=sd>///</span>
<a id=__codelineno-54-13 name=__codelineno-54-13 href=#__codelineno-54-13></a><span class=sd>/// Wraps the error that occurred during assembly and supplied information where it did.</span>
<a id=__codelineno-54-14 name=__codelineno-54-14 href=#__codelineno-54-14></a>#<span class=cp>#[derive(Debug)]</span>
<a id=__codelineno-54-15 name=__codelineno-54-15 href=#__codelineno-54-15></a><span class=k>pub</span><span class=w> </span><span class=k>struct</span> <span class=nc>AsmErrorReport</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-54-16 name=__codelineno-54-16 href=#__codelineno-54-16></a><span class=w>    </span><span class=sd>/// Name of the program that failed to assemble.</span>
<a id=__codelineno-54-17 name=__codelineno-54-17 href=#__codelineno-54-17></a><span class=w>    </span><span class=n>name</span>: <span class=nb>String</span><span class=p>,</span>
<a id=__codelineno-54-18 name=__codelineno-54-18 href=#__codelineno-54-18></a><span class=w>    </span><span class=sd>/// Line the error occurred during assembly.</span>
<a id=__codelineno-54-19 name=__codelineno-54-19 href=#__codelineno-54-19></a><span class=w>    </span><span class=n>line</span>: <span class=kt>usize</span><span class=p>,</span>
<a id=__codelineno-54-20 name=__codelineno-54-20 href=#__codelineno-54-20></a><span class=w>    </span><span class=sd>/// Error that occurred.</span>
<a id=__codelineno-54-21 name=__codelineno-54-21 href=#__codelineno-54-21></a><span class=w>    </span><span class=n>error</span>: <span class=nc>AsmError</span><span class=p>,</span>
<a id=__codelineno-54-22 name=__codelineno-54-22 href=#__codelineno-54-22></a><span class=p>}</span>
<a id=__codelineno-54-23 name=__codelineno-54-23 href=#__codelineno-54-23></a>
<a id=__codelineno-54-24 name=__codelineno-54-24 href=#__codelineno-54-24></a><span class=sd>/// A single instruction parsed from the line of an assembly program.</span>
<a id=__codelineno-54-25 name=__codelineno-54-25 href=#__codelineno-54-25></a>#<span class=cp>#[derive(Debug)]</span>
<a id=__codelineno-54-26 name=__codelineno-54-26 href=#__codelineno-54-26></a><span class=k>struct</span> <span class=nc>AsmInstruction</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-54-27 name=__codelineno-54-27 href=#__codelineno-54-27></a><span class=w>    </span><span class=sd>/// Number of line the instruction was read from.</span>
<a id=__codelineno-54-28 name=__codelineno-54-28 href=#__codelineno-54-28></a><span class=w>    </span><span class=sd>///</span>
<a id=__codelineno-54-29 name=__codelineno-54-29 href=#__codelineno-54-29></a><span class=w>    </span><span class=sd>/// The number of the line the instruction was taken from, most likely</span>
<a id=__codelineno-54-30 name=__codelineno-54-30 href=#__codelineno-54-30></a><span class=w>    </span><span class=sd>/// from a source file. Line counting starts at 1.</span>
<a id=__codelineno-54-31 name=__codelineno-54-31 href=#__codelineno-54-31></a><span class=w>    </span><span class=n>line_number</span>: <span class=kt>usize</span><span class=p>,</span>
<a id=__codelineno-54-32 name=__codelineno-54-32 href=#__codelineno-54-32></a><span class=w>    </span><span class=sd>/// Opcode defining which operation is to be executed.</span>
<a id=__codelineno-54-33 name=__codelineno-54-33 href=#__codelineno-54-33></a><span class=w>    </span><span class=n>opcode</span>: <span class=kt>u8</span><span class=p>,</span>
<a id=__codelineno-54-34 name=__codelineno-54-34 href=#__codelineno-54-34></a><span class=w>    </span><span class=sd>/// Arguments used for execution of the operation.</span>
<a id=__codelineno-54-35 name=__codelineno-54-35 href=#__codelineno-54-35></a><span class=w>    </span><span class=sd>///</span>
<a id=__codelineno-54-36 name=__codelineno-54-36 href=#__codelineno-54-36></a><span class=w>    </span><span class=sd>/// Zero or more bytes.</span>
<a id=__codelineno-54-37 name=__codelineno-54-37 href=#__codelineno-54-37></a><span class=w>    </span><span class=n>oparg</span>: <span class=nb>Vec</span><span class=o>&lt;</span><span class=kt>u8</span><span class=o>&gt;</span><span class=p>,</span>
<a id=__codelineno-54-38 name=__codelineno-54-38 href=#__codelineno-54-38></a><span class=w>    </span><span class=sd>/// Position inside bytecode (starting at 0).</span>
<a id=__codelineno-54-39 name=__codelineno-54-39 href=#__codelineno-54-39></a><span class=w>    </span><span class=sd>///</span>
<a id=__codelineno-54-40 name=__codelineno-54-40 href=#__codelineno-54-40></a><span class=w>    </span><span class=sd>/// Number of bytes that come before this instruction in the program.</span>
<a id=__codelineno-54-41 name=__codelineno-54-41 href=#__codelineno-54-41></a><span class=w>    </span><span class=n>pos</span>: <span class=kt>usize</span><span class=p>,</span>
<a id=__codelineno-54-42 name=__codelineno-54-42 href=#__codelineno-54-42></a><span class=p>}</span>
<a id=__codelineno-54-43 name=__codelineno-54-43 href=#__codelineno-54-43></a>
<a id=__codelineno-54-44 name=__codelineno-54-44 href=#__codelineno-54-44></a><span class=sd>/// A assembler program during parsing/assembling.</span>
<a id=__codelineno-54-45 name=__codelineno-54-45 href=#__codelineno-54-45></a>#<span class=cp>#[derive(Debug)]</span>
<a id=__codelineno-54-46 name=__codelineno-54-46 href=#__codelineno-54-46></a><span class=k>struct</span> <span class=nc>AsmPgm</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-54-47 name=__codelineno-54-47 href=#__codelineno-54-47></a><span class=w>    </span><span class=sd>/// Name of the program (just a string supplied by caller).</span>
<a id=__codelineno-54-48 name=__codelineno-54-48 href=#__codelineno-54-48></a><span class=w>    </span><span class=n>name</span>: <span class=nb>String</span><span class=p>,</span>
<a id=__codelineno-54-49 name=__codelineno-54-49 href=#__codelineno-54-49></a><span class=w>    </span><span class=sd>/// Vector of parsed assembler instructions, in the order they are in the source file.</span>
<a id=__codelineno-54-50 name=__codelineno-54-50 href=#__codelineno-54-50></a><span class=w>    </span><span class=n>instructions</span>: <span class=nb>Vec</span><span class=o>&lt;</span><span class=n>AsmInstruction</span><span class=o>&gt;</span><span class=p>,</span>
<a id=__codelineno-54-51 name=__codelineno-54-51 href=#__codelineno-54-51></a><span class=w>    </span><span class=sd>/// Current line number during parsing.</span>
<a id=__codelineno-54-52 name=__codelineno-54-52 href=#__codelineno-54-52></a><span class=w>    </span><span class=sd>///</span>
<a id=__codelineno-54-53 name=__codelineno-54-53 href=#__codelineno-54-53></a><span class=w>    </span><span class=sd>/// Used for error reporting.</span>
<a id=__codelineno-54-54 name=__codelineno-54-54 href=#__codelineno-54-54></a><span class=w>    </span><span class=n>line_number</span>: <span class=kt>usize</span><span class=p>,</span>
<a id=__codelineno-54-55 name=__codelineno-54-55 href=#__codelineno-54-55></a><span class=w>    </span><span class=sd>/// Current position inside bytecode during parsing.</span>
<a id=__codelineno-54-56 name=__codelineno-54-56 href=#__codelineno-54-56></a><span class=w>    </span><span class=sd>///</span>
<a id=__codelineno-54-57 name=__codelineno-54-57 href=#__codelineno-54-57></a><span class=w>    </span><span class=sd>/// Used to calculate the exact position an instruction will be in the bytecode.</span>
<a id=__codelineno-54-58 name=__codelineno-54-58 href=#__codelineno-54-58></a><span class=w>    </span><span class=n>text_pos</span>: <span class=kt>usize</span><span class=p>,</span>
<a id=__codelineno-54-59 name=__codelineno-54-59 href=#__codelineno-54-59></a><span class=w>    </span><span class=sd>/// The error that happened during parsing/assembling, if any.</span>
<a id=__codelineno-54-60 name=__codelineno-54-60 href=#__codelineno-54-60></a><span class=w>    </span><span class=n>error</span>: <span class=nb>Option</span><span class=o>&lt;</span><span class=n>AsmError</span><span class=o>&gt;</span><span class=p>,</span>
<a id=__codelineno-54-61 name=__codelineno-54-61 href=#__codelineno-54-61></a><span class=p>}</span>
</code></pre></div> <p><code>AsmError</code> is easy enough to understand. We used the same idea for the <code>RuntimeError</code> inside the VM. When we run into an Error while trying to assemble the program, we return <code>Err&lt;AsmError&gt;</code> instead of <code>Ok(())</code>, so that we can propagate what happened back to the caller. The nice thing is, that with speaking names for the enum values, and with the occasional embedded value (as in <code>UnknownInstruction(String)</code>), the debug representation of the <code>AsmError</code> alone is enough to make the user understand what error was detected.</p> <p><code>AsmErrorReport</code> is a little wrapper we use to add the information <em>where</em> we ran into an error. <code>InvalidArgument</code> is nice hint how to fix your program - but if that program is 2000 lines long, then good luck. When you know the <code>InvalidArgument</code> happened in line 1337, then you will find it much faster. Especially in an assembly language, that has never more than one single instruction per line.</p> <p><code>AsmInstruction</code> is used to represent a single instruction inside a program. So each instance of this type will be linked to a specific line in the source file. If you don't remember, what counts as an instruction in <em>lovem</em> (at least at the time of writing), let me repeat: an <em>instruction</em> consists of exactly one <em>operation</em> that is to be executed, which is identified by its <em>opcode</em> (which is a number from <code>0x00</code> to <code>0xff</code> stored in a single byte). Each instruction has zero or more bytes used as an argument, defining how the operation is to be executed. This argument is called <em>oparg</em>. We will also store the number of the line we found our instruction inside the source code, and the position inside the bytecode where the instruction will be.</p> <p><code>AsmPgm</code> will represent the complete program during the assembly process. We will collect the instructions we parse from the source in there in a Vector. And we will hold the progress during parsing/assembling. This is not the type that will be returned to the caller, it is only used internally (as you can guess by the fact that it is not defined <code>pub</code>).</p> <h3 id=where-does-the-program-come-from>Where does the program come from?<a class=headerlink href=#where-does-the-program-come-from title="Permanent link">&para;</a></h3> <p>The only function the mod exports it <code>assemble</code>:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-55-1 name=__codelineno-55-1 href=#__codelineno-55-1></a><span class=sd>/// Parse assembly source code and turn it into a runnable program (or create report).</span>
<a id=__codelineno-55-2 name=__codelineno-55-2 href=#__codelineno-55-2></a><span class=k>pub</span><span class=w> </span><span class=k>fn</span> <span class=nf>assemble</span><span class=p>(</span><span class=n>name</span>: <span class=kp>&amp;</span><span class=kt>str</span><span class=p>,</span><span class=w> </span><span class=n>content</span>: <span class=kp>&amp;</span><span class=kt>str</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=n>Pgm</span><span class=p>,</span><span class=w> </span><span class=n>AsmErrorReport</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-55-3 name=__codelineno-55-3 href=#__codelineno-55-3></a><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>asm_pgm</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>AsmPgm</span>::<span class=n>parse</span><span class=p>(</span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>content</span><span class=p>);</span>
<a id=__codelineno-55-4 name=__codelineno-55-4 href=#__codelineno-55-4></a><span class=w>    </span><span class=n>asm_pgm</span><span class=p>.</span><span class=n>to_program</span><span class=p>()</span>
<a id=__codelineno-55-5 name=__codelineno-55-5 href=#__codelineno-55-5></a><span class=p>}</span>
</code></pre></div> <p>It will return an <code>AsmErrorReport</code>, if anything goes wrong and the assembling fails. If the assembler succeeds, it returns an instance of <code>Pgm</code>. Now where does that come from? Our VM takes programs in form of a <code>&amp;[u8]</code>. That will be changed soon, and then it will run programs from a special type <code>Pgm</code> that might have a bit more than just bytecode. I added another new module to the library: <a href=https://github.com/kratenko/lovem/blob/v0.0.8-journey/src/pgm.rs><code>pgm.rs</code></a>. That one is tiny and only holds the new <code>struct Pgm</code> &ndash; which itself is basic. But we have a type that holds a program, now. I believe that will be beneficial to us later.</p> <div class=highlight><pre><span></span><code><a id=__codelineno-56-1 name=__codelineno-56-1 href=#__codelineno-56-1></a><span class=sd>/// Holds a program to be executed in VM.</span>
<a id=__codelineno-56-2 name=__codelineno-56-2 href=#__codelineno-56-2></a>#<span class=cp>#[derive(Debug)]</span>
<a id=__codelineno-56-3 name=__codelineno-56-3 href=#__codelineno-56-3></a><span class=k>pub</span><span class=w> </span><span class=k>struct</span> <span class=nc>Pgm</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-56-4 name=__codelineno-56-4 href=#__codelineno-56-4></a><span class=w>    </span><span class=sd>/// Some name identifying the program.</span>
<a id=__codelineno-56-5 name=__codelineno-56-5 href=#__codelineno-56-5></a><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>name</span>: <span class=nb>String</span><span class=p>,</span>
<a id=__codelineno-56-6 name=__codelineno-56-6 href=#__codelineno-56-6></a><span class=w>    </span><span class=sd>/// Bytecode holding the programs instructions.</span>
<a id=__codelineno-56-7 name=__codelineno-56-7 href=#__codelineno-56-7></a><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=n>text</span>: <span class=nb>Vec</span><span class=o>&lt;</span><span class=kt>u8</span><span class=o>&gt;</span><span class=p>,</span>
<a id=__codelineno-56-8 name=__codelineno-56-8 href=#__codelineno-56-8></a><span class=p>}</span>
</code></pre></div> <p>What is it, that the assembler does, to create such a <code>Pgm</code>. We will start to go through that in the next entry. This has been enough for today.</p> <h2 id=parsing-the-source>Parsing the source<a class=headerlink href=#parsing-the-source title="Permanent link">&para;</a></h2> <aside class=mdx-author> <p><img alt=@kratenko src=https://avatars.githubusercontent.com/kratenko></p> <p><span><strong>kratenko</strong> · <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 16 16"><path fill-rule=evenodd d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"/></svg></span> <a href=https://github.com/kratenko>kratenko</a></span> <span> <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path fill-rule=evenodd d="M6.75 0a.75.75 0 0 1 .75.75V3h9V.75a.75.75 0 0 1 1.5 0V3h2.75c.966 0 1.75.784 1.75 1.75v16a1.75 1.75 0 0 1-1.75 1.75H3.25a1.75 1.75 0 0 1-1.75-1.75v-16C1.5 3.784 2.284 3 3.25 3H6V.75A.75.75 0 0 1 6.75 0zm-3.5 4.5a.25.25 0 0 0-.25.25V8h18V4.75a.25.25 0 0 0-.25-.25H3.25zM21 9.5H3v11.25c0 .138.112.25.25.25h17.5a.25.25 0 0 0 .25-.25V9.5z"/></svg></span> 2022-07-27 · <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path fill-rule=evenodd d="M0 3.75A.75.75 0 0 1 .75 3h7.497c1.566 0 2.945.8 3.751 2.014A4.496 4.496 0 0 1 15.75 3h7.5a.75.75 0 0 1 .75.75v15.063a.75.75 0 0 1-.755.75l-7.682-.052a3 3 0 0 0-2.142.878l-.89.891a.75.75 0 0 1-1.061 0l-.902-.901a3 3 0 0 0-2.121-.879H.75a.75.75 0 0 1-.75-.75v-15zm11.247 3.747a3 3 0 0 0-3-2.997H1.5V18h6.947a4.5 4.5 0 0 1 2.803.98l-.003-11.483zm1.503 11.485V7.5a3 3 0 0 1 3-3h6.75v13.558l-6.927-.047a4.5 4.5 0 0 0-2.823.971z"/></svg></span> Entry #22 · <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12.5 7.25a.75.75 0 0 0-1.5 0v5.5c0 .27.144.518.378.651l3.5 2a.75.75 0 0 0 .744-1.302L12.5 12.315V7.25z"/><path fill-rule=evenodd d="M12 1C5.925 1 1 5.925 1 12s4.925 11 11 11 11-4.925 11-11S18.075 1 12 1zM2.5 12a9.5 9.5 0 1 1 19 0 9.5 9.5 0 0 1-19 0z"/></svg></span> 4 min read · <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M7.75 6.5a1.25 1.25 0 1 0 0 2.5 1.25 1.25 0 0 0 0-2.5z"/><path fill-rule=evenodd d="M2.5 1A1.5 1.5 0 0 0 1 2.5v8.44c0 .397.158.779.44 1.06l10.25 10.25a1.5 1.5 0 0 0 2.12 0l8.44-8.44a1.5 1.5 0 0 0 0-2.12L12 1.44A1.5 1.5 0 0 0 10.94 1H2.5zm0 1.5h8.44l10.25 10.25-8.44 8.44L2.5 10.94V2.5z"/></svg></span> <a href=https://github.com/kratenko/lovem/releases/tag/v0.0.8-journey>v0.0.8-journey</a> </span></p> </aside> <hr> <p>So far we have read an assembly source file into a string, and we got to know some new data structures. It is time we use the one to fill the other. Let us start parsing.</p> <p>What we know so far is this:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-57-1 name=__codelineno-57-1 href=#__codelineno-57-1></a><span class=sd>/// Parse assembly source code and turn it into a runnable program (or create report).</span>
<a id=__codelineno-57-2 name=__codelineno-57-2 href=#__codelineno-57-2></a><span class=k>pub</span><span class=w> </span><span class=k>fn</span> <span class=nf>assemble</span><span class=p>(</span><span class=n>name</span>: <span class=kp>&amp;</span><span class=kt>str</span><span class=p>,</span><span class=w> </span><span class=n>content</span>: <span class=kp>&amp;</span><span class=kt>str</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=n>Pgm</span><span class=p>,</span><span class=w> </span><span class=n>AsmErrorReport</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-57-3 name=__codelineno-57-3 href=#__codelineno-57-3></a><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>asm_pgm</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>AsmPgm</span>::<span class=n>parse</span><span class=p>(</span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>content</span><span class=p>);</span>
<a id=__codelineno-57-4 name=__codelineno-57-4 href=#__codelineno-57-4></a><span class=w>    </span><span class=n>asm_pgm</span><span class=p>.</span><span class=n>to_program</span><span class=p>()</span>
<a id=__codelineno-57-5 name=__codelineno-57-5 href=#__codelineno-57-5></a><span class=p>}</span>
</code></pre></div> <h3 id=assembler-syntax>Assembler syntax<a class=headerlink href=#assembler-syntax title="Permanent link">&para;</a></h3> <p>Our experimental assembler will begin using a simple syntax. Only one instruction per line, short opnames to identify the operation to be executed, optionally a single argument. I have written a short program: <a href=https://github.com/kratenko/lovem/blob/v0.0.8-journey/pgm/hallo-stack.lass><code>hallo-stack.lass</code></a>.</p> <div class=highlight><pre><span></span><code><a id=__codelineno-58-1 name=__codelineno-58-1 href=#__codelineno-58-1></a>push_u8 123
<a id=__codelineno-58-2 name=__codelineno-58-2 href=#__codelineno-58-2></a>push_u8 200
<a id=__codelineno-58-3 name=__codelineno-58-3 href=#__codelineno-58-3></a>add
<a id=__codelineno-58-4 name=__codelineno-58-4 href=#__codelineno-58-4></a>pop
<a id=__codelineno-58-5 name=__codelineno-58-5 href=#__codelineno-58-5></a>fin
</code></pre></div> <p>Straightforward. And you know the syntax already from my human friendly listings of bytecode. Parsing that looks simple. We do want to allow adding whitespaces, though. And we want to allow comments, for sure. Our assembler needs to handle a bit of noise, as in <a href=https://github.com/kratenko/lovem/blob/v0.0.8-journey/pgm/noise.lass><code>noice.lass</code></a>.</p> <div class=highlight><pre><span></span><code><a id=__codelineno-59-1 name=__codelineno-59-1 href=#__codelineno-59-1></a>## This is an awesome program!
<a id=__codelineno-59-2 name=__codelineno-59-2 href=#__codelineno-59-2></a> push_u8 123
<a id=__codelineno-59-3 name=__codelineno-59-3 href=#__codelineno-59-3></a>push_u8     200      # What are we using the # 200 for?
<a id=__codelineno-59-4 name=__codelineno-59-4 href=#__codelineno-59-4></a>
<a id=__codelineno-59-5 name=__codelineno-59-5 href=#__codelineno-59-5></a>
<a id=__codelineno-59-6 name=__codelineno-59-6 href=#__codelineno-59-6></a>add
<a id=__codelineno-59-7 name=__codelineno-59-7 href=#__codelineno-59-7></a>   pop
<a id=__codelineno-59-8 name=__codelineno-59-8 href=#__codelineno-59-8></a>
<a id=__codelineno-59-9 name=__codelineno-59-9 href=#__codelineno-59-9></a>
<a id=__codelineno-59-10 name=__codelineno-59-10 href=#__codelineno-59-10></a>## let&#39;s end it here!
<a id=__codelineno-59-11 name=__codelineno-59-11 href=#__codelineno-59-11></a>fin
</code></pre></div> <p>Those two programs should be identical and produce the same bytecode.</p> <h3 id=one-line-at-a-time>One line at a time<a class=headerlink href=#one-line-at-a-time title="Permanent link">&para;</a></h3> <p>The <code>parse()</code> function we call creates an empty instance of <code>AsmPgm</code> and then processes the source file line after line, filling the <code>AsmPgm</code> on the way.</p> <div class=highlight><pre><span></span><code><a id=__codelineno-60-1 name=__codelineno-60-1 href=#__codelineno-60-1></a><span class=sd>/// Parse an assembly program from source into `AsmPgm` struct.</span>
<a id=__codelineno-60-2 name=__codelineno-60-2 href=#__codelineno-60-2></a><span class=k>fn</span> <span class=nf>parse</span><span class=p>(</span><span class=n>name</span>: <span class=kp>&amp;</span><span class=kt>str</span><span class=p>,</span><span class=w> </span><span class=n>content</span>: <span class=kp>&amp;</span><span class=kt>str</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nc>AsmPgm</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-60-3 name=__codelineno-60-3 href=#__codelineno-60-3></a><span class=w>    </span><span class=c1>// create a new, clean instance to fill during parsing:</span>
<a id=__codelineno-60-4 name=__codelineno-60-4 href=#__codelineno-60-4></a><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>p</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>AsmPgm</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-60-5 name=__codelineno-60-5 href=#__codelineno-60-5></a><span class=w>        </span><span class=n>name</span>: <span class=nb>String</span>::<span class=n>from</span><span class=p>(</span><span class=n>name</span><span class=p>),</span>
<a id=__codelineno-60-6 name=__codelineno-60-6 href=#__codelineno-60-6></a><span class=w>        </span><span class=n>instructions</span>: <span class=nc>vec</span><span class=o>!</span><span class=p>[],</span>
<a id=__codelineno-60-7 name=__codelineno-60-7 href=#__codelineno-60-7></a><span class=w>        </span><span class=n>line_number</span>: <span class=mi>0</span><span class=p>,</span>
<a id=__codelineno-60-8 name=__codelineno-60-8 href=#__codelineno-60-8></a><span class=w>        </span><span class=n>text_pos</span>: <span class=mi>0</span><span class=p>,</span>
<a id=__codelineno-60-9 name=__codelineno-60-9 href=#__codelineno-60-9></a><span class=w>        </span><span class=n>error</span>: <span class=nb>None</span><span class=p>,</span>
<a id=__codelineno-60-10 name=__codelineno-60-10 href=#__codelineno-60-10></a><span class=w>    </span><span class=p>};</span>
<a id=__codelineno-60-11 name=__codelineno-60-11 href=#__codelineno-60-11></a><span class=w>    </span><span class=c1>// read the source, one line at a time, adding instructions:</span>
<a id=__codelineno-60-12 name=__codelineno-60-12 href=#__codelineno-60-12></a><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>n</span><span class=p>,</span><span class=w> </span><span class=n>line</span><span class=p>)</span><span class=w> </span><span class=k>in</span><span class=w> </span><span class=n>content</span><span class=p>.</span><span class=n>lines</span><span class=p>().</span><span class=n>enumerate</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-60-13 name=__codelineno-60-13 href=#__codelineno-60-13></a><span class=w>        </span><span class=n>p</span><span class=p>.</span><span class=n>line_number</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>n</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=p>;</span>
<a id=__codelineno-60-14 name=__codelineno-60-14 href=#__codelineno-60-14></a><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>line</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>AsmPgm</span>::<span class=n>clean_line</span><span class=p>(</span><span class=n>line</span><span class=p>);</span>
<a id=__codelineno-60-15 name=__codelineno-60-15 href=#__codelineno-60-15></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=kd>let</span><span class=w> </span><span class=nb>Err</span><span class=p>(</span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>p</span><span class=p>.</span><span class=n>parse_line</span><span class=p>(</span><span class=n>line</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-60-16 name=__codelineno-60-16 href=#__codelineno-60-16></a><span class=w>            </span><span class=c1>// Store error in program and abort parsing:</span>
<a id=__codelineno-60-17 name=__codelineno-60-17 href=#__codelineno-60-17></a><span class=w>            </span><span class=n>p</span><span class=p>.</span><span class=n>error</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>Some</span><span class=p>(</span><span class=n>e</span><span class=p>);</span>
<a id=__codelineno-60-18 name=__codelineno-60-18 href=#__codelineno-60-18></a><span class=w>            </span><span class=k>break</span><span class=p>;</span>
<a id=__codelineno-60-19 name=__codelineno-60-19 href=#__codelineno-60-19></a><span class=w>        </span><span class=p>}</span>
<a id=__codelineno-60-20 name=__codelineno-60-20 href=#__codelineno-60-20></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-60-21 name=__codelineno-60-21 href=#__codelineno-60-21></a><span class=w>    </span><span class=n>p</span>
<a id=__codelineno-60-22 name=__codelineno-60-22 href=#__codelineno-60-22></a><span class=p>}</span>
</code></pre></div> <p><code>content.lines()</code> gives us an iterator that we can use to handle each line of the String <code>content</code> in a for loop. We extend the iterator by calling <code>enumerate()</code> on it; that gives us a different iterator, which counts the values returned by the first iterator, and adds the number to it. So <code>n</code> will hold the line number and <code>line</code> will hold the line's content.</p> <p>We always keep track of where we are in the source. Because the <code>enumerate()</code> starts counting at <code>0</code> (as things should be), we need to add <code>1</code>. File lines start counting at <code>1</code>. The first thing we do with the line is cleaning it. Then it gets processed by <code>parse_line(line)</code>. If this produces an error, we will store that error and abort parsing. All our errors are fatal. The final line <code>p</code> returns the <code>AsmPgm</code>. We do not use a <code>Result</code> this time, but the <code>AsmPgm</code> can contain an error. Only if its error field is <code>None</code>, the parsing was successful.</p> <h3 id=cleaning-the-noise>Cleaning the noise<a class=headerlink href=#cleaning-the-noise title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><a id=__codelineno-61-1 name=__codelineno-61-1 href=#__codelineno-61-1></a><span class=sd>/// Removes all noise from an assembler program&#39;s line.</span>
<a id=__codelineno-61-2 name=__codelineno-61-2 href=#__codelineno-61-2></a><span class=k>fn</span> <span class=nf>clean_line</span><span class=p>(</span><span class=n>line</span>: <span class=kp>&amp;</span><span class=kt>str</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>String</span> <span class=p>{</span>
<a id=__codelineno-61-3 name=__codelineno-61-3 href=#__codelineno-61-3></a><span class=w>    </span><span class=c1>// Remove comments:</span>
<a id=__codelineno-61-4 name=__codelineno-61-4 href=#__codelineno-61-4></a><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>line</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>if</span><span class=w> </span><span class=kd>let</span><span class=w> </span><span class=nb>Some</span><span class=p>(</span><span class=n>pair</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>line</span><span class=p>.</span><span class=n>split_once</span><span class=p>(</span><span class=s>&quot;#&quot;</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-61-5 name=__codelineno-61-5 href=#__codelineno-61-5></a><span class=w>        </span><span class=n>pair</span><span class=p>.</span><span class=mi>0</span>
<a id=__codelineno-61-6 name=__codelineno-61-6 href=#__codelineno-61-6></a><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-61-7 name=__codelineno-61-7 href=#__codelineno-61-7></a><span class=w>        </span><span class=o>&amp;</span><span class=n>line</span>
<a id=__codelineno-61-8 name=__codelineno-61-8 href=#__codelineno-61-8></a><span class=w>    </span><span class=p>};</span>
<a id=__codelineno-61-9 name=__codelineno-61-9 href=#__codelineno-61-9></a><span class=w>    </span><span class=c1>// Trim start and end:</span>
<a id=__codelineno-61-10 name=__codelineno-61-10 href=#__codelineno-61-10></a><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>line</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>line</span><span class=p>.</span><span class=n>trim</span><span class=p>();</span>
<a id=__codelineno-61-11 name=__codelineno-61-11 href=#__codelineno-61-11></a><span class=w>    </span><span class=c1>// Reduce all whitespaces to a single space (0x20):</span>
<a id=__codelineno-61-12 name=__codelineno-61-12 href=#__codelineno-61-12></a><span class=w>    </span><span class=n>ANY_WHITESPACES</span><span class=p>.</span><span class=n>replace_all</span><span class=p>(</span><span class=n>line</span><span class=p>,</span><span class=w> </span><span class=s>&quot; &quot;</span><span class=p>).</span><span class=n>to_string</span><span class=p>()</span>
<a id=__codelineno-61-13 name=__codelineno-61-13 href=#__codelineno-61-13></a><span class=p>}</span>
</code></pre></div> <p>We use multiple techniques to clean our input: splitting, trimming, regular expressions. When we are done, we only have lines as they look in <a href=https://github.com/kratenko/lovem/blob/v0.0.8-journey/pgm/hallo-stack.lass><code>hallo-stack.lass</code></a>. The cleaned line can also be completely empty. </p> <p>I want to add a word about that regexp in <code>ANY_WHITESPACES</code>. Where does it come from? I am using some more Rust magic there, and the crate <code>lazy_static</code>:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-62-1 name=__codelineno-62-1 href=#__codelineno-62-1></a><span class=k>use</span><span class=w> </span><span class=n>lazy_static</span>::<span class=n>lazy_static</span><span class=p>;</span>
<a id=__codelineno-62-2 name=__codelineno-62-2 href=#__codelineno-62-2></a><span class=k>use</span><span class=w> </span><span class=n>regex</span>::<span class=n>Regex</span><span class=p>;</span>
<a id=__codelineno-62-3 name=__codelineno-62-3 href=#__codelineno-62-3></a>
<a id=__codelineno-62-4 name=__codelineno-62-4 href=#__codelineno-62-4></a><span class=c1>// Regular expressions used by the assembler.</span>
<a id=__codelineno-62-5 name=__codelineno-62-5 href=#__codelineno-62-5></a><span class=c1>// lazy static takes care that they are compiled only once and then reused.</span>
<a id=__codelineno-62-6 name=__codelineno-62-6 href=#__codelineno-62-6></a><span class=n>lazy_static</span><span class=o>!</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-62-7 name=__codelineno-62-7 href=#__codelineno-62-7></a><span class=w>    </span><span class=k>static</span><span class=w> </span><span class=k>ref</span><span class=w> </span><span class=n>ANY_WHITESPACES</span>: <span class=nc>Regex</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>regex</span>::<span class=n>Regex</span>::<span class=n>new</span><span class=p>(</span><span class=s>r&quot;\s+&quot;</span><span class=p>).</span><span class=n>unwrap</span><span class=p>();</span>
<a id=__codelineno-62-8 name=__codelineno-62-8 href=#__codelineno-62-8></a><span class=w>    </span><span class=k>static</span><span class=w> </span><span class=k>ref</span><span class=w> </span><span class=n>OP_LINE_RE</span>: <span class=nc>Regex</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>regex</span>::<span class=n>Regex</span>::<span class=n>new</span><span class=p>(</span><span class=s>r&quot;^(\S+)(?: (.+))?$&quot;</span><span class=p>).</span><span class=n>unwrap</span><span class=p>();</span>
<a id=__codelineno-62-9 name=__codelineno-62-9 href=#__codelineno-62-9></a><span class=p>}</span>
</code></pre></div> <p>I do not pretend to understand the macro magic that happens here. But what happens, is that the regular expressions are compiled only once and then kept as some sort of global static immutable variable, that we can than use again and again all over the program as a reference. Static references are a convenient thing in Rust, if you remember what I told you about ownership. You can always have as many references to immutable static variables, because there is nothing that can happen to them, and they exist throughout the complete runtime of the program.</p> <h3 id=parsing-a-clean-line>Parsing a clean line<a class=headerlink href=#parsing-a-clean-line title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><a id=__codelineno-63-1 name=__codelineno-63-1 href=#__codelineno-63-1></a><span class=sd>/// Handles a single cleaned line from an Assembly program.</span>
<a id=__codelineno-63-2 name=__codelineno-63-2 href=#__codelineno-63-2></a><span class=k>fn</span> <span class=nf>parse_line</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>,</span><span class=w> </span><span class=n>line</span>: <span class=nb>String</span><span class=p>)</span><span class=w> </span>-&gt; <span class=nb>Result</span><span class=o>&lt;</span><span class=p>(),</span><span class=w> </span><span class=n>AsmError</span><span class=o>&gt;</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-63-3 name=__codelineno-63-3 href=#__codelineno-63-3></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=n>line</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=s>&quot;&quot;</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-63-4 name=__codelineno-63-4 href=#__codelineno-63-4></a><span class=w>        </span><span class=c1>// empty line (or comment only) - skip</span>
<a id=__codelineno-63-5 name=__codelineno-63-5 href=#__codelineno-63-5></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nb>Ok</span><span class=p>(());</span>
<a id=__codelineno-63-6 name=__codelineno-63-6 href=#__codelineno-63-6></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-63-7 name=__codelineno-63-7 href=#__codelineno-63-7></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=kd>let</span><span class=w> </span><span class=nb>Some</span><span class=p>(</span><span class=n>caps</span><span class=p>)</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>OP_LINE_RE</span><span class=p>.</span><span class=n>captures</span><span class=p>(</span><span class=o>&amp;</span><span class=n>line</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-63-8 name=__codelineno-63-8 href=#__codelineno-63-8></a><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>opname</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>caps</span><span class=p>.</span><span class=n>get</span><span class=p>(</span><span class=mi>1</span><span class=p>).</span><span class=n>unwrap</span><span class=p>().</span><span class=n>as_str</span><span class=p>();</span>
<a id=__codelineno-63-9 name=__codelineno-63-9 href=#__codelineno-63-9></a><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>parm</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>caps</span><span class=p>.</span><span class=n>get</span><span class=p>(</span><span class=mi>2</span><span class=p>).</span><span class=n>map</span><span class=p>(</span><span class=o>|</span><span class=n>m</span><span class=o>|</span><span class=w> </span><span class=n>m</span><span class=p>.</span><span class=n>as_str</span><span class=p>());</span>
<a id=__codelineno-63-10 name=__codelineno-63-10 href=#__codelineno-63-10></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>parse_instruction</span><span class=p>(</span><span class=n>opname</span><span class=p>,</span><span class=w> </span><span class=n>parm</span><span class=p>);</span>
<a id=__codelineno-63-11 name=__codelineno-63-11 href=#__codelineno-63-11></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-63-12 name=__codelineno-63-12 href=#__codelineno-63-12></a><span class=w>    </span><span class=nb>Err</span><span class=p>(</span><span class=n>AsmError</span>::<span class=n>InvalidLine</span><span class=p>)</span>
<a id=__codelineno-63-13 name=__codelineno-63-13 href=#__codelineno-63-13></a><span class=p>}</span>
</code></pre></div> <p><code>parse_line()</code> processes each line. Empty ones are just skipped. We use another regular expression, to find out if they match our schema. Because we cleaned it the expression can be rather simple: <code>r"^(\S+)(?: (.+))?$"</code>. We look for one or more non-empty chars for our <em>opname</em>. It can be followed by a single argument, which must consist of one or more chars, separated by a single space. That is our optional <em>oparg</em>. If the line fits, we found an introduction we can try to parse. That is the job of <code>parse_instruction()</code>. Everything that is neither empty nor an instruction, is an error, that we can simply return. It will abort the parsing and the caller will know, that there was an invalid line.</p> <p><code>parse_instruction()</code> can also run into an error. We use our tried pattern of returning a <code>Result</code> where the successful outcome does not carry any additional information (which is why we return <code>Ok(())</code>). The error case will return an AsmError, that carries the reason for the error. And because of our the <code>Result</code> type and because of Rust's might enum system, we can simply return what <code>parse_instruction()</code> returns to us.</p> <p>Handling the instruction itself will be handled in the next entry.</p> <div class=footnote> <hr> <ol> <li id=fn:register> <p>Don't let yourself be confused by fancy terms like <em>register</em>. You can think of it as a kind of snobbish variable with a special meaning. In computers sometimes stuff magically happens when you write to a <em>register</em> &ndash; but it should always be documented somewhere.&#160;<a class=footnote-backref href=#fnref:register title="Jump back to footnote 1 in the text">&#8617;</a></p> </li> <li id=fn:1> <p>Beard, Bob (Autumn 1997). <a href=http://www.cs.man.ac.uk/CCS/res/res18.htm#c>"The KDF9 Computer - 30 Years On"</a>. Computer RESURRECTION.&#160;<a class=footnote-backref href=#fnref:1 title="Jump back to footnote 2 in the text">&#8617;</a></p> </li> <li id=fn:2> <p>Yeah, I know. The answer to the question "What was the first machine to qualify as a computer?", differs, depending on whom you ask &ndash; and also on the country you ask the question in. But the Z3 is a prominent candidate.&#160;<a class=footnote-backref href=#fnref:2 title="Jump back to footnote 3 in the text">&#8617;</a></p> </li> <li id=fn:pc> <p>PC: the Program Counter, a special register that points to the next instruction to be executed.&#160;<a class=footnote-backref href=#fnref:pc title="Jump back to footnote 4 in the text">&#8617;</a></p> </li> </ol> </div> </article> </div> </div> <a href=# class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg> Back to top </a> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../2022-08/ALL.html class="md-footer__link md-footer__link--prev" aria-label="Previous: August 2022 complete" rel=prev> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </div> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Previous </span> August 2022 complete </div> </div> </a> <a href=../2022-06/ALL.html class="md-footer__link md-footer__link--next" aria-label="Next: June 2022 complete" rel=next> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Next </span> June 2022 complete </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-social> <a href=https://github.com/kratenko target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg> </a> <a href=https://chaos.social/@kratenko target=_blank rel=noopener title=chaos.social class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48 0 0 0-63.72 28.5-63.72 125.7 0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54 0 0 1-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "..", "features": ["navigation.indexes", "navigation.sections", "navigation.top", "navigation.tracking", "navigation.expand"], "search": "../assets/javascripts/workers/search.16e2a7d4.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script> <script src=../assets/javascripts/bundle.5a2dcb6a.min.js></script> </body> </html>