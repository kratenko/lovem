<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Lovem & ndash; the low overhead virtual embedded machine. And the journey getting there."><meta name=author content=kratenko><link rel=canonical href=https://kratenko.github.io/lovem/2022-07/a-vm.html><link rel=icon href=../assets/images/favicon.png><meta name=generator content="mkdocs-1.5.3, mkdocs-material-8.5.10"><title>A VM - Lovem</title><link rel=stylesheet href=../assets/stylesheets/main.975780f9.min.css><link rel=stylesheet href=../assets/stylesheets/palette.2505c338.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../stylesheets/custom.css><script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=None data-md-color-accent=None> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#a-vm class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../index.html title=Lovem class="md-header__button md-logo" aria-label=Lovem data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Lovem </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> A VM </span> </div> </div> </div> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/kratenko/lovem title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> kratenko/lovem </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../index.html title=Lovem class="md-nav__button md-logo" aria-label=Lovem data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg> </a> Lovem </label> <div class=md-nav__source> <a href=https://github.com/kratenko/lovem title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> kratenko/lovem </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../index.html class=md-nav__link> The Journey </a> </li> <li class=md-nav__item> <a href=../source-code.html class=md-nav__link> Source Code </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3 type=checkbox id=__nav_3 checked> <div class="md-nav__link md-nav__link--index "> <a href=../journal/index.html>Journal</a> <label for=__nav_3> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav aria-label=Journal data-md-level=1> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Journal </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle=__nav_3_2 type=checkbox id=__nav_3_2 checked> <div class="md-nav__link md-nav__link--index "> <a href=../2024-02/index.html>February 2024</a> <label for=__nav_3_2> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav aria-label="February 2024" data-md-level=2> <label class=md-nav__title for=__nav_3_2> <span class="md-nav__icon md-icon"></span> February 2024 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../2024-02/we-have-variables.html class=md-nav__link> We have variables! </a> </li> <li class=md-nav__item> <a href=../2024-02/stop-right-there-that-s-far-enough.html class=md-nav__link> Stop right there, that's far enough! </a> </li> <li class=md-nav__item> <a href=../2024-02/it-has-been-a-while.html class=md-nav__link> It has been a while... </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle=__nav_3_3 type=checkbox id=__nav_3_3 checked> <div class="md-nav__link md-nav__link--index "> <a href=../2022-08/index.html>August 2022</a> <label for=__nav_3_3> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav aria-label="August 2022" data-md-level=2> <label class=md-nav__title for=__nav_3_3> <span class="md-nav__icon md-icon"></span> August 2022 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../2022-08/what-if.html class=md-nav__link> What if? </a> </li> <li class=md-nav__item> <a href=../2022-08/you-labeled-me-i-ll-label-you.html class=md-nav__link> You labeled me, I'll label you </a> </li> <li class=md-nav__item> <a href=../2022-08/running-assembler-programs.html class=md-nav__link> Running assembler programs </a> </li> <li class=md-nav__item> <a href=../2022-08/assembling-bytes.html class=md-nav__link> Assembling bytes </a> </li> <li class=md-nav__item> <a href=../2022-08/handling-instructions.html class=md-nav__link> Handling instructions </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=__nav_3_4 type=checkbox id=__nav_3_4 checked> <div class="md-nav__link md-nav__link--index "> <a href=index.html>July 2022</a> <label for=__nav_3_4> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav aria-label="July 2022" data-md-level=2> <label class=md-nav__title for=__nav_3_4> <span class="md-nav__icon md-icon"></span> July 2022 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=parsing-the-source.html class=md-nav__link> Parsing the source </a> </li> <li class=md-nav__item> <a href=assemble.html class=md-nav__link> Assemble! </a> </li> <li class=md-nav__item> <a href=don-t-byte-me.html class=md-nav__link> Don't byte me! </a> </li> <li class=md-nav__item> <a href=go-ahead-and-jump.html class=md-nav__link> Go ahead and jump! </a> </li> <li class=md-nav__item> <a href=reverse-polish-notation.html class=md-nav__link> Reverse polish notation </a> </li> <li class=md-nav__item> <a href=more-operations.html class=md-nav__link> More operations </a> </li> <li class=md-nav__item> <a href=early-vm-decisions.html class=md-nav__link> Early VM decisions </a> </li> <li class=md-nav__item> <a href=to-the-library.html class=md-nav__link> To the library! </a> </li> <li class=md-nav__item> <a href=becoming-social.html class=md-nav__link> Becoming social </a> </li> <li class=md-nav__item> <a href=turn-fragile-into-rusty.html class=md-nav__link> Turn "fragile" into "rusty" </a> </li> <li class=md-nav__item> <a href=running-our-first-program.html class=md-nav__link> Running our first program </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> A VM <span class="md-nav__icon md-icon"></span> </label> <a href=a-vm.html class="md-nav__link md-nav__link--active"> A VM </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#i-swear-if-i-do-not-see-some-code-in-this-post class=md-nav__link> I swear, if I do not see some code in this post... </a> </li> <li class=md-nav__item> <a href=#behaviour-for-our-vm class=md-nav__link> Behaviour for our VM </a> </li> <li class=md-nav__item> <a href=#how-do-i-work-with-the-code class=md-nav__link> How do I work with the code? </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=it-looks-so-weird.html class=md-nav__link> It looks so weird </a> </li> <li class=md-nav__item> <a href=let-there-be-source-code.html class=md-nav__link> Let there be source code </a> </li> <li class=md-nav__item> <a href=making-virtual-a-reality.html class=md-nav__link> Making virtual a reality </a> </li> <li class=md-nav__item> <a href=what-is-a-virtual-machine-anyway.html class=md-nav__link> What is a Virtual Machine anyway? </a> </li> <li class=md-nav__item> <a href=all-new-once-more.html class=md-nav__link> All new once more </a> </li> <li class=md-nav__item> <a href=state-of-the-journal.html class=md-nav__link> State of the Journal </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle=__nav_3_5 type=checkbox id=__nav_3_5 checked> <div class="md-nav__link md-nav__link--index "> <a href=../2022-06/index.html>June 2022</a> <label for=__nav_3_5> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav aria-label="June 2022" data-md-level=2> <label class=md-nav__title for=__nav_3_5> <span class="md-nav__icon md-icon"></span> June 2022 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../2022-06/script-or-virtual.html class=md-nav__link> Script or virtual </a> </li> <li class=md-nav__item> <a href=../2022-06/that-use-case.html class=md-nav__link> That use-case I was talking about </a> </li> <li class=md-nav__item> <a href=../2022-06/we-need-another-wheel.html class=md-nav__link> We need another wheel </a> </li> <li class=md-nav__item> <a href=../2022-06/lovem-again.html class=md-nav__link> Lovem again! </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle=__nav_4 type=checkbox id=__nav_4 checked> <label class=md-nav__link for=__nav_4> Journal (complete months) <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Journal (complete months)" data-md-level=1> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Journal (complete months) </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../2024-02/ALL.html class=md-nav__link> February 2024 complete </a> </li> <li class=md-nav__item> <a href=../2022-08/ALL.html class=md-nav__link> August 2022 complete </a> </li> <li class=md-nav__item> <a href=ALL.html class=md-nav__link> July 2022 complete </a> </li> <li class=md-nav__item> <a href=../2022-06/ALL.html class=md-nav__link> June 2022 complete </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#i-swear-if-i-do-not-see-some-code-in-this-post class=md-nav__link> I swear, if I do not see some code in this post... </a> </li> <li class=md-nav__item> <a href=#behaviour-for-our-vm class=md-nav__link> Behaviour for our VM </a> </li> <li class=md-nav__item> <a href=#how-do-i-work-with-the-code class=md-nav__link> How do I work with the code? </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=a-vm>A VM<a class=headerlink href=#a-vm title="Permanent link">&para;</a></h1> <p><strong>The first draft of source code, that will be our VM, explained.</strong></p> <aside class=mdx-author> <p><img alt=@kratenko src=https://avatars.githubusercontent.com/kratenko></p> <p><span><strong>kratenko</strong> · <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 16 16"><path fill-rule=evenodd d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"/></svg></span> <a href=https://github.com/kratenko>kratenko</a></span> <span> <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path fill-rule=evenodd d="M6.75 0a.75.75 0 0 1 .75.75V3h9V.75a.75.75 0 0 1 1.5 0V3h2.75c.966 0 1.75.784 1.75 1.75v16a1.75 1.75 0 0 1-1.75 1.75H3.25a1.75 1.75 0 0 1-1.75-1.75v-16C1.5 3.784 2.284 3 3.25 3H6V.75A.75.75 0 0 1 6.75 0zm-3.5 4.5a.25.25 0 0 0-.25.25V8h18V4.75a.25.25 0 0 0-.25-.25H3.25zM21 9.5H3v11.25c0 .138.112.25.25.25h17.5a.25.25 0 0 0 .25-.25V9.5z"/></svg></span> 2022-07-11 · <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path fill-rule=evenodd d="M0 3.75A.75.75 0 0 1 .75 3h7.497c1.566 0 2.945.8 3.751 2.014A4.496 4.496 0 0 1 15.75 3h7.5a.75.75 0 0 1 .75.75v15.063a.75.75 0 0 1-.755.75l-7.682-.052a3 3 0 0 0-2.142.878l-.89.891a.75.75 0 0 1-1.061 0l-.902-.901a3 3 0 0 0-2.121-.879H.75a.75.75 0 0 1-.75-.75v-15zm11.247 3.747a3 3 0 0 0-3-2.997H1.5V18h6.947a4.5 4.5 0 0 1 2.803.98l-.003-11.483zm1.503 11.485V7.5a3 3 0 0 1 3-3h6.75v13.558l-6.927-.047a4.5 4.5 0 0 0-2.823.971z"/></svg></span> Entry #11 · <span class=twemoji><svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12.5 7.25a.75.75 0 0 0-1.5 0v5.5c0 .27.144.518.378.651l3.5 2a.75.75 0 0 0 .744-1.302L12.5 12.315V7.25z"/><path fill-rule=evenodd d="M12 1C5.925 1 1 5.925 1 12s4.925 11 11 11 11-4.925 11-11S18.075 1 12 1zM2.5 12a9.5 9.5 0 1 1 19 0 9.5 9.5 0 0 1-19 0z"/></svg></span> 8 min read </span></p> </aside> <hr> <p>I dumped some source code in front of you, and then I started to talk about programming languages. Time now, to explain what I did and why. We only have 132 lines, including comments. We will go through all parts of it. And I will talk a little about how Rust's basic syntax works, while I use it. Not too much, since it is not good Rust code, yet, but to help you start. This will be a longer entry.</p> <h2 id=i-swear-if-i-do-not-see-some-code-in-this-post>I swear, if I do not see some code in this post...<a class=headerlink href=#i-swear-if-i-do-not-see-some-code-in-this-post title="Permanent link">&para;</a></h2> <p>Alright, alright... We will start with our VM:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=cp>#[derive(Debug)]</span>
<a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=k>pub</span><span class=w> </span><span class=k>struct</span> <span class=nc>VM</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=w>    </span><span class=n>stack</span>: <span class=nb>Vec</span><span class=o>&lt;</span><span class=kt>i64</span><span class=o>&gt;</span><span class=p>,</span>
<a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=w>    </span><span class=n>pc</span>: <span class=kt>usize</span><span class=p>,</span>
<a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=w>    </span><span class=n>op_cnt</span>: <span class=kt>usize</span><span class=p>,</span>
<a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=p>}</span>
</code></pre></div> <p>Nothing fancy, just a struct that will represent our Virtual Machine. Only three fields for now:</p> <ol> <li><code>stack</code>: Obviously our stack machine would need one of those. This will hold values during execution. I am using a Vector. That is nothing more than a chunk of memory, that knows how much capacity it has and how many values are in it at the moment. It does support resizing, but I do not want to use that. </li> <li><code>pc</code> will be our <em>program counter</em>. That is a register <sup id=fnref:register><a class=footnote-ref href=#fn:register>1</a></sup> holding the progress in the program during execution. It will always point at the instruction that is to be executed next.</li> <li><code>op_cnt</code> will be counting the number of operations executed. For now, I want that information out of curiosity, but later it will be useful for limiting execution time for programs.</li> </ol> <p><code>usize</code> and <code>i64</code> are Rust's names for integer types. The language is very explicit in those terms (and very strict, as in every aspect). I will not give a real introduction to Rust for you (there are pages that do that), but I will try to start slowly and give you hints on the important things I introduce, so that you get the chance to learn about them parallel to this journal. I hope, that makes it easier to follow for Rust beginners. To readers that know Rust: please excuse the crude code here! I will make it more rusty, soon. Skip to the next post, if you cannot handle it.</p> <p>We will also need a program that we will run in our VM. For the start, a crude array of bytes will do. The VM will be running bytecode after all. And that really is only that: a bunch of bytes, that you will soon be able to understand.</p> <div class=highlight><pre><span></span><code><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a><span class=c1>// assign `pgm` to hold a program:</span>
<a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a><span class=kd>let</span><span class=w> </span><span class=n>pgm</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=mh>0x00</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>u8</span><span class=p>,</span><span class=w> </span><span class=mh>0x01</span><span class=p>,</span><span class=w> </span><span class=mi>100</span><span class=p>,</span><span class=w> </span><span class=mh>0xff</span><span class=p>];</span>
</code></pre></div> <p>We will use a program that is a bit longer, but right now I wanted you to see a program, that is actually nothing but a collection of bytes in Rust code. <code>let</code> declares and assigns a variable here, named <code>pgm</code>. It is an array of 4 bytes (<code>u8</code> is an unsigned 8bit integer - you might know it as <code>uint8_t</code> from other languages). And that variable will not be variable at all. By default, all variables in Rust are immutable. If you want to change it, later, you would have to declare it<br> using the modifier <code>mut</code>. </p> <p>There is no need to modify the program after creation, we just want to read it for execution. But our VM will have to be mutable, as it has changing internal state. Here is our complete <code>main</code> function, creating the (immutable) program and the (mutable) VM, and running the program. Of course, the <code>run(...)</code> method is still missing. And you will see the program, we will be using (with some constants that I did not define, yet).</p> <div class=highlight><pre><span></span><code><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a><span class=k>fn</span> <span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-2-2 name=__codelineno-2-2 href=#__codelineno-2-2></a><span class=w>    </span><span class=c1>// Create a program in bytecode.</span>
<a id=__codelineno-2-3 name=__codelineno-2-3 href=#__codelineno-2-3></a><span class=w>    </span><span class=c1>// We just hardcode the bytes in an array here:</span>
<a id=__codelineno-2-4 name=__codelineno-2-4 href=#__codelineno-2-4></a><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=n>pgm</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=n>op</span>::<span class=n>NOP</span><span class=p>,</span><span class=w> </span><span class=n>op</span>::<span class=n>PUSH_U8</span><span class=p>,</span><span class=w> </span><span class=mi>100</span><span class=p>,</span><span class=w> </span><span class=n>op</span>::<span class=n>PUSH_U8</span><span class=p>,</span><span class=w> </span><span class=mi>77</span><span class=p>,</span><span class=w> </span><span class=n>op</span>::<span class=n>ADD</span><span class=p>,</span><span class=w> </span><span class=n>op</span>::<span class=n>POP</span><span class=p>,</span><span class=w> </span><span class=mh>0xff</span><span class=p>];</span>
<a id=__codelineno-2-5 name=__codelineno-2-5 href=#__codelineno-2-5></a><span class=w>    </span><span class=c1>// Crate our VM instance.</span>
<a id=__codelineno-2-6 name=__codelineno-2-6 href=#__codelineno-2-6></a><span class=w>    </span><span class=kd>let</span><span class=w> </span><span class=k>mut</span><span class=w> </span><span class=n>vm</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>VM</span><span class=p>{</span>
<a id=__codelineno-2-7 name=__codelineno-2-7 href=#__codelineno-2-7></a><span class=w>        </span><span class=n>stack</span>: <span class=nb>Vec</span>::<span class=n>with_capacity</span><span class=p>(</span><span class=mi>100</span><span class=p>),</span>
<a id=__codelineno-2-8 name=__codelineno-2-8 href=#__codelineno-2-8></a><span class=w>        </span><span class=n>pc</span>: <span class=mi>0</span><span class=p>,</span>
<a id=__codelineno-2-9 name=__codelineno-2-9 href=#__codelineno-2-9></a><span class=w>        </span><span class=n>op_cnt</span>: <span class=mi>0</span>
<a id=__codelineno-2-10 name=__codelineno-2-10 href=#__codelineno-2-10></a><span class=w>    </span><span class=p>};</span>
<a id=__codelineno-2-11 name=__codelineno-2-11 href=#__codelineno-2-11></a><span class=w>    </span><span class=c1>// Execute the program in our VM:</span>
<a id=__codelineno-2-12 name=__codelineno-2-12 href=#__codelineno-2-12></a><span class=w>    </span><span class=n>vm</span><span class=p>.</span><span class=n>run</span><span class=p>(</span><span class=o>&amp;</span><span class=n>pgm</span><span class=p>);</span>
<a id=__codelineno-2-13 name=__codelineno-2-13 href=#__codelineno-2-13></a><span class=p>}</span>
</code></pre></div> <h2 id=behaviour-for-our-vm>Behaviour for our VM<a class=headerlink href=#behaviour-for-our-vm title="Permanent link">&para;</a></h2> <p>So far we only have an initialized data structure and some bytes. Let's do something with it. Rust does not really use objects (and I think that is good). But it has <em>associated functions</em> that work on types, and <em>methods</em> that work on instances of types. We will write some methods for our <code>VM</code> struct. Let's start with the one for reading our program:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a><span class=k>impl</span><span class=w> </span><span class=n>VM</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a><span class=w>    </span><span class=sd>/// Fetch the next byte from the bytecode, increase program counter, and return value.</span>
<a id=__codelineno-3-3 name=__codelineno-3-3 href=#__codelineno-3-3></a><span class=w>    </span><span class=k>fn</span> <span class=nf>fetch_u8</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>,</span><span class=w> </span><span class=n>pgm</span>: <span class=kp>&amp;</span><span class=p>[</span><span class=kt>u8</span><span class=p>])</span><span class=w> </span>-&gt; <span class=kt>u8</span> <span class=p>{</span>
<a id=__codelineno-3-4 name=__codelineno-3-4 href=#__codelineno-3-4></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>pc</span><span class=w> </span><span class=o>&gt;=</span><span class=w> </span><span class=n>pgm</span><span class=p>.</span><span class=n>len</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-3-5 name=__codelineno-3-5 href=#__codelineno-3-5></a><span class=w>            </span><span class=fm>panic!</span><span class=p>(</span><span class=s>&quot;End of program exceeded&quot;</span><span class=p>);</span>
<a id=__codelineno-3-6 name=__codelineno-3-6 href=#__codelineno-3-6></a><span class=w>        </span><span class=p>}</span>
<a id=__codelineno-3-7 name=__codelineno-3-7 href=#__codelineno-3-7></a><span class=w>        </span><span class=kd>let</span><span class=w> </span><span class=n>v</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>pgm</span><span class=p>[</span><span class=bp>self</span><span class=p>.</span><span class=n>pc</span><span class=p>];</span>
<a id=__codelineno-3-8 name=__codelineno-3-8 href=#__codelineno-3-8></a><span class=w>        </span><span class=bp>self</span><span class=p>.</span><span class=n>pc</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span>
<a id=__codelineno-3-9 name=__codelineno-3-9 href=#__codelineno-3-9></a><span class=w>        </span><span class=n>v</span>
<a id=__codelineno-3-10 name=__codelineno-3-10 href=#__codelineno-3-10></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-3-11 name=__codelineno-3-11 href=#__codelineno-3-11></a><span class=p>}</span>
</code></pre></div> <p>The <code>fetch</code> method will work on our VM instance. The first parameter is <code>&amp;mut self</code> &ndash; that tells us it works on an instance of the type <code>VM</code>. It will work on a reference to the instance (indicated by the <code>&amp;</code>), and it can modify the data (indicated by the <code>mut</code>). It will also take the reference to an array of <code>u8</code>s, but that it will not be able to modify (no <code>mut</code>). It returns a <code>u8</code>.</p> <p>What it does is simply read and return a byte from the program, and increase the VMs internal program counter by one, so that the next call to <code>fetch</code> will return the next byte. Simple. </p> <p>So, what is that <code>panic!()</code> you might ask? Well, if we reach that instruction, it will start to panic, and then it will die. That is not a nice way to act. Do not worry, we will change that to something more reasonable, when we start writing better Rust. And what about the naked <code>v</code> in the last line? It will have the function return the value of <code>v</code>.</p> <p>Now, let's look at that <code>run</code> method, we were calling in <code>main</code>:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a><span class=k>impl</span><span class=w> </span><span class=n>VM</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-4-2 name=__codelineno-4-2 href=#__codelineno-4-2></a><span class=w>    </span><span class=sd>/// Executes a program (encoded in bytecode).</span>
<a id=__codelineno-4-3 name=__codelineno-4-3 href=#__codelineno-4-3></a><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=k>fn</span> <span class=nf>run</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>,</span><span class=w> </span><span class=n>pgm</span>: <span class=kp>&amp;</span><span class=p>[</span><span class=kt>u8</span><span class=p>])</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-4-4 name=__codelineno-4-4 href=#__codelineno-4-4></a><span class=w>        </span><span class=c1>// initialise the VM to be in a clean start state:</span>
<a id=__codelineno-4-5 name=__codelineno-4-5 href=#__codelineno-4-5></a><span class=w>        </span><span class=bp>self</span><span class=p>.</span><span class=n>stack</span><span class=p>.</span><span class=n>clear</span><span class=p>();</span>
<a id=__codelineno-4-6 name=__codelineno-4-6 href=#__codelineno-4-6></a><span class=w>        </span><span class=bp>self</span><span class=p>.</span><span class=n>pc</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
<a id=__codelineno-4-7 name=__codelineno-4-7 href=#__codelineno-4-7></a><span class=w>        </span><span class=bp>self</span><span class=p>.</span><span class=n>op_cnt</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
<a id=__codelineno-4-8 name=__codelineno-4-8 href=#__codelineno-4-8></a>
<a id=__codelineno-4-9 name=__codelineno-4-9 href=#__codelineno-4-9></a><span class=w>        </span><span class=c1>// Loop going through the whole program, one instruction at a time.</span>
<a id=__codelineno-4-10 name=__codelineno-4-10 href=#__codelineno-4-10></a><span class=w>        </span><span class=k>loop</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-4-11 name=__codelineno-4-11 href=#__codelineno-4-11></a><span class=w>            </span><span class=c1>// Log the vm&#39;s complete state, so we can follow what happens in console:</span>
<a id=__codelineno-4-12 name=__codelineno-4-12 href=#__codelineno-4-12></a><span class=w>            </span><span class=fm>println!</span><span class=p>(</span><span class=s>&quot;{:?}&quot;</span><span class=p>,</span><span class=w> </span><span class=bp>self</span><span class=p>);</span>
<a id=__codelineno-4-13 name=__codelineno-4-13 href=#__codelineno-4-13></a><span class=w>            </span><span class=c1>// Fetch next opcode from program (increases program counter):</span>
<a id=__codelineno-4-14 name=__codelineno-4-14 href=#__codelineno-4-14></a><span class=w>            </span><span class=kd>let</span><span class=w> </span><span class=n>opcode</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>fetch_u8</span><span class=p>(</span><span class=n>pgm</span><span class=p>);</span>
<a id=__codelineno-4-15 name=__codelineno-4-15 href=#__codelineno-4-15></a><span class=w>            </span><span class=c1>// We count the number of instructions we execute:</span>
<a id=__codelineno-4-16 name=__codelineno-4-16 href=#__codelineno-4-16></a><span class=w>            </span><span class=bp>self</span><span class=p>.</span><span class=n>op_cnt</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span>
<a id=__codelineno-4-17 name=__codelineno-4-17 href=#__codelineno-4-17></a><span class=w>            </span><span class=c1>// If we are done, break loop and stop execution:</span>
<a id=__codelineno-4-18 name=__codelineno-4-18 href=#__codelineno-4-18></a><span class=w>            </span><span class=k>if</span><span class=w> </span><span class=n>opcode</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>op</span>::<span class=n>FIN</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-4-19 name=__codelineno-4-19 href=#__codelineno-4-19></a><span class=w>                </span><span class=k>break</span><span class=p>;</span>
<a id=__codelineno-4-20 name=__codelineno-4-20 href=#__codelineno-4-20></a><span class=w>            </span><span class=p>}</span>
<a id=__codelineno-4-21 name=__codelineno-4-21 href=#__codelineno-4-21></a><span class=w>            </span><span class=c1>// Execute the current instruction (with the opcode we loaded already):</span>
<a id=__codelineno-4-22 name=__codelineno-4-22 href=#__codelineno-4-22></a><span class=w>            </span><span class=bp>self</span><span class=p>.</span><span class=n>execute_op</span><span class=p>(</span><span class=n>pgm</span><span class=p>,</span><span class=w> </span><span class=n>opcode</span><span class=p>);</span>
<a id=__codelineno-4-23 name=__codelineno-4-23 href=#__codelineno-4-23></a><span class=w>        </span><span class=p>}</span>
<a id=__codelineno-4-24 name=__codelineno-4-24 href=#__codelineno-4-24></a><span class=w>        </span><span class=c1>// Execution terminated. Output the final state of the VM:</span>
<a id=__codelineno-4-25 name=__codelineno-4-25 href=#__codelineno-4-25></a><span class=w>        </span><span class=fm>println!</span><span class=p>(</span><span class=s>&quot;Terminated!&quot;</span><span class=p>);</span>
<a id=__codelineno-4-26 name=__codelineno-4-26 href=#__codelineno-4-26></a><span class=w>        </span><span class=fm>println!</span><span class=p>(</span><span class=s>&quot;{:?}&quot;</span><span class=p>,</span><span class=w> </span><span class=bp>self</span><span class=p>);</span>
<a id=__codelineno-4-27 name=__codelineno-4-27 href=#__codelineno-4-27></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-4-28 name=__codelineno-4-28 href=#__codelineno-4-28></a><span class=p>}</span>
</code></pre></div> <p>The comments should explain, what is going on there. Initialise VM, then loop over the program, fetching one instruction at a time and executing it, until we reach the end. And you might have noticed, that our program will be very talkative. I added a lot of <code>println</code>s, that tell just about everything that happens, during execution.</p> <p>I guess it is time to look at those <code>op::</code> constants I keep using.</p> <div class=highlight><pre><span></span><code><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a><span class=sd>/// Module holding the constants defining the opcodes for the VM.</span>
<a id=__codelineno-5-2 name=__codelineno-5-2 href=#__codelineno-5-2></a><span class=k>pub</span><span class=w> </span><span class=k>mod</span> <span class=nn>op</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-5-3 name=__codelineno-5-3 href=#__codelineno-5-3></a><span class=w>    </span><span class=sd>/// opcode: Do nothing. No oparg.</span>
<a id=__codelineno-5-4 name=__codelineno-5-4 href=#__codelineno-5-4></a><span class=w>    </span><span class=sd>///</span>
<a id=__codelineno-5-5 name=__codelineno-5-5 href=#__codelineno-5-5></a><span class=w>    </span><span class=sd>/// pop: 0, push: 0</span>
<a id=__codelineno-5-6 name=__codelineno-5-6 href=#__codelineno-5-6></a><span class=w>    </span><span class=sd>/// oparg: 0</span>
<a id=__codelineno-5-7 name=__codelineno-5-7 href=#__codelineno-5-7></a><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=n>NOP</span>: <span class=kt>u8</span> <span class=o>=</span><span class=w> </span><span class=mh>0x00</span><span class=p>;</span>
<a id=__codelineno-5-8 name=__codelineno-5-8 href=#__codelineno-5-8></a><span class=w>    </span><span class=sd>/// opcode: Pop value from stack and discard it.</span>
<a id=__codelineno-5-9 name=__codelineno-5-9 href=#__codelineno-5-9></a><span class=w>    </span><span class=sd>///</span>
<a id=__codelineno-5-10 name=__codelineno-5-10 href=#__codelineno-5-10></a><span class=w>    </span><span class=sd>/// pop: 1, push: 0</span>
<a id=__codelineno-5-11 name=__codelineno-5-11 href=#__codelineno-5-11></a><span class=w>    </span><span class=sd>/// oparg: 0</span>
<a id=__codelineno-5-12 name=__codelineno-5-12 href=#__codelineno-5-12></a><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=n>POP</span>: <span class=kt>u8</span> <span class=o>=</span><span class=w> </span><span class=mh>0x01</span><span class=p>;</span>
<a id=__codelineno-5-13 name=__codelineno-5-13 href=#__codelineno-5-13></a><span class=w>    </span><span class=sd>/// opcode: Push immediate value to stack.</span>
<a id=__codelineno-5-14 name=__codelineno-5-14 href=#__codelineno-5-14></a><span class=w>    </span><span class=sd>///</span>
<a id=__codelineno-5-15 name=__codelineno-5-15 href=#__codelineno-5-15></a><span class=w>    </span><span class=sd>/// pop: 0, push: 1</span>
<a id=__codelineno-5-16 name=__codelineno-5-16 href=#__codelineno-5-16></a><span class=w>    </span><span class=sd>/// oparg: 1B, u8 value to push</span>
<a id=__codelineno-5-17 name=__codelineno-5-17 href=#__codelineno-5-17></a><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=n>PUSH_U8</span>: <span class=kt>u8</span> <span class=o>=</span><span class=w> </span><span class=mh>0x02</span><span class=p>;</span>
<a id=__codelineno-5-18 name=__codelineno-5-18 href=#__codelineno-5-18></a><span class=w>    </span><span class=sd>/// opcode: Add top two values on stack.</span>
<a id=__codelineno-5-19 name=__codelineno-5-19 href=#__codelineno-5-19></a><span class=w>    </span><span class=sd>///</span>
<a id=__codelineno-5-20 name=__codelineno-5-20 href=#__codelineno-5-20></a><span class=w>    </span><span class=sd>/// pop: 2, push: 1</span>
<a id=__codelineno-5-21 name=__codelineno-5-21 href=#__codelineno-5-21></a><span class=w>    </span><span class=sd>/// oparg: 0</span>
<a id=__codelineno-5-22 name=__codelineno-5-22 href=#__codelineno-5-22></a><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=n>ADD</span>: <span class=kt>u8</span> <span class=o>=</span><span class=w> </span><span class=mh>0x10</span><span class=p>;</span>
<a id=__codelineno-5-23 name=__codelineno-5-23 href=#__codelineno-5-23></a><span class=w>    </span><span class=sd>/// opcode: Terminate program.</span>
<a id=__codelineno-5-24 name=__codelineno-5-24 href=#__codelineno-5-24></a><span class=w>    </span><span class=sd>///</span>
<a id=__codelineno-5-25 name=__codelineno-5-25 href=#__codelineno-5-25></a><span class=w>    </span><span class=sd>/// pop: 0, push: 0</span>
<a id=__codelineno-5-26 name=__codelineno-5-26 href=#__codelineno-5-26></a><span class=w>    </span><span class=sd>/// oparg: 0</span>
<a id=__codelineno-5-27 name=__codelineno-5-27 href=#__codelineno-5-27></a><span class=w>    </span><span class=k>pub</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=n>FIN</span>: <span class=kt>u8</span> <span class=o>=</span><span class=w> </span><span class=mh>0xff</span><span class=p>;</span>
<a id=__codelineno-5-28 name=__codelineno-5-28 href=#__codelineno-5-28></a><span class=p>}</span>
</code></pre></div> <p>Just 5 <code>u8</code> constants there, grouped in a module as a namespace. And a lot of comments to explain them. We have 5 different operations for our VM. The only thing missing is some code, that actually executes those instructions:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a><span class=k>impl</span><span class=w> </span><span class=n>VM</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-6-2 name=__codelineno-6-2 href=#__codelineno-6-2></a><span class=w>    </span><span class=sd>/// Executes an instruction, using the opcode passed.</span>
<a id=__codelineno-6-3 name=__codelineno-6-3 href=#__codelineno-6-3></a><span class=w>    </span><span class=sd>///</span>
<a id=__codelineno-6-4 name=__codelineno-6-4 href=#__codelineno-6-4></a><span class=w>    </span><span class=sd>/// This might load more data from the program (opargs) and</span>
<a id=__codelineno-6-5 name=__codelineno-6-5 href=#__codelineno-6-5></a><span class=w>    </span><span class=sd>/// manipulate the stack (push, pop).</span>
<a id=__codelineno-6-6 name=__codelineno-6-6 href=#__codelineno-6-6></a><span class=w>    </span><span class=k>fn</span> <span class=nf>execute_op</span><span class=p>(</span><span class=o>&amp;</span><span class=k>mut</span><span class=w> </span><span class=bp>self</span><span class=p>,</span><span class=w> </span><span class=n>pgm</span>: <span class=kp>&amp;</span><span class=p>[</span><span class=kt>u8</span><span class=p>],</span><span class=w> </span><span class=n>opcode</span>: <span class=kt>u8</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-6-7 name=__codelineno-6-7 href=#__codelineno-6-7></a><span class=w>        </span><span class=fm>println!</span><span class=p>(</span><span class=s>&quot;Executing op 0x{:02x}&quot;</span><span class=p>,</span><span class=w> </span><span class=n>opcode</span><span class=p>);</span>
<a id=__codelineno-6-8 name=__codelineno-6-8 href=#__codelineno-6-8></a><span class=w>        </span><span class=k>match</span><span class=w> </span><span class=n>opcode</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-6-9 name=__codelineno-6-9 href=#__codelineno-6-9></a><span class=w>            </span><span class=n>op</span>::<span class=n>NOP</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-6-10 name=__codelineno-6-10 href=#__codelineno-6-10></a><span class=w>                </span><span class=fm>println!</span><span class=p>(</span><span class=s>&quot;  NOP&quot;</span><span class=p>);</span>
<a id=__codelineno-6-11 name=__codelineno-6-11 href=#__codelineno-6-11></a><span class=w>                </span><span class=c1>// do nothing</span>
<a id=__codelineno-6-12 name=__codelineno-6-12 href=#__codelineno-6-12></a><span class=w>            </span><span class=p>},</span>
<a id=__codelineno-6-13 name=__codelineno-6-13 href=#__codelineno-6-13></a><span class=w>            </span><span class=n>op</span>::<span class=n>POP</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-6-14 name=__codelineno-6-14 href=#__codelineno-6-14></a><span class=w>                </span><span class=fm>println!</span><span class=p>(</span><span class=s>&quot;  POP&quot;</span><span class=p>);</span>
<a id=__codelineno-6-15 name=__codelineno-6-15 href=#__codelineno-6-15></a><span class=w>                </span><span class=kd>let</span><span class=w> </span><span class=n>v</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>stack</span><span class=p>.</span><span class=n>pop</span><span class=p>().</span><span class=n>unwrap</span><span class=p>();</span>
<a id=__codelineno-6-16 name=__codelineno-6-16 href=#__codelineno-6-16></a><span class=w>                </span><span class=fm>println!</span><span class=p>(</span><span class=s>&quot;  dropping value {}&quot;</span><span class=p>,</span><span class=w> </span><span class=n>v</span><span class=p>);</span>
<a id=__codelineno-6-17 name=__codelineno-6-17 href=#__codelineno-6-17></a><span class=w>            </span><span class=p>},</span>
<a id=__codelineno-6-18 name=__codelineno-6-18 href=#__codelineno-6-18></a><span class=w>            </span><span class=n>op</span>::<span class=n>PUSH_U8</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-6-19 name=__codelineno-6-19 href=#__codelineno-6-19></a><span class=w>                </span><span class=fm>println!</span><span class=p>(</span><span class=s>&quot;  PUSH_U8&quot;</span><span class=p>);</span>
<a id=__codelineno-6-20 name=__codelineno-6-20 href=#__codelineno-6-20></a><span class=w>                </span><span class=kd>let</span><span class=w> </span><span class=n>v</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>fetch_u8</span><span class=p>(</span><span class=n>pgm</span><span class=p>);</span>
<a id=__codelineno-6-21 name=__codelineno-6-21 href=#__codelineno-6-21></a><span class=w>                </span><span class=fm>println!</span><span class=p>(</span><span class=s>&quot;  value: {}&quot;</span><span class=p>,</span><span class=w> </span><span class=n>v</span><span class=p>);</span>
<a id=__codelineno-6-22 name=__codelineno-6-22 href=#__codelineno-6-22></a><span class=w>                </span><span class=bp>self</span><span class=p>.</span><span class=n>stack</span><span class=p>.</span><span class=n>push</span><span class=p>(</span><span class=n>v</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=kt>i64</span><span class=p>);</span>
<a id=__codelineno-6-23 name=__codelineno-6-23 href=#__codelineno-6-23></a><span class=w>            </span><span class=p>},</span>
<a id=__codelineno-6-24 name=__codelineno-6-24 href=#__codelineno-6-24></a><span class=w>            </span><span class=n>op</span>::<span class=n>ADD</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-6-25 name=__codelineno-6-25 href=#__codelineno-6-25></a><span class=w>                </span><span class=fm>println!</span><span class=p>(</span><span class=s>&quot;  ADD&quot;</span><span class=p>);</span>
<a id=__codelineno-6-26 name=__codelineno-6-26 href=#__codelineno-6-26></a><span class=w>                </span><span class=kd>let</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>stack</span><span class=p>.</span><span class=n>pop</span><span class=p>().</span><span class=n>unwrap</span><span class=p>();</span>
<a id=__codelineno-6-27 name=__codelineno-6-27 href=#__codelineno-6-27></a><span class=w>                </span><span class=kd>let</span><span class=w> </span><span class=n>b</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=bp>self</span><span class=p>.</span><span class=n>stack</span><span class=p>.</span><span class=n>pop</span><span class=p>().</span><span class=n>unwrap</span><span class=p>();</span>
<a id=__codelineno-6-28 name=__codelineno-6-28 href=#__codelineno-6-28></a><span class=w>                </span><span class=bp>self</span><span class=p>.</span><span class=n>stack</span><span class=p>.</span><span class=n>push</span><span class=p>(</span><span class=n>a</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>b</span><span class=p>);</span>
<a id=__codelineno-6-29 name=__codelineno-6-29 href=#__codelineno-6-29></a><span class=w>            </span><span class=p>},</span>
<a id=__codelineno-6-30 name=__codelineno-6-30 href=#__codelineno-6-30></a><span class=w>            </span><span class=n>_</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-6-31 name=__codelineno-6-31 href=#__codelineno-6-31></a><span class=w>                </span><span class=fm>panic!</span><span class=p>(</span><span class=s>&quot;unknown opcode!&quot;</span><span class=p>);</span>
<a id=__codelineno-6-32 name=__codelineno-6-32 href=#__codelineno-6-32></a><span class=w>            </span><span class=p>}</span>
<a id=__codelineno-6-33 name=__codelineno-6-33 href=#__codelineno-6-33></a><span class=w>        </span><span class=p>}</span>
<a id=__codelineno-6-34 name=__codelineno-6-34 href=#__codelineno-6-34></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-6-35 name=__codelineno-6-35 href=#__codelineno-6-35></a><span class=p>}</span>
</code></pre></div> <p>You can think of the <code>match</code> as a switch statement. It is much more than that, but here we use it as one. Each of our opcodes is handled individually. And we log a lot, so that we can read what is happening, when we run it. Ignore the <code>unwrap()</code> thingies for the time being. They are just there to try and ignore potential runtime errors. Again, not good Rust style, but, you know: later.</p> <p>The four operations get more complex in what they do. Let's go through them one by one:</p> <ol> <li><code>NOP</code> &ndash; this does nothing, it just wastes bytecode and execution time. I have included it simply to be the most basic operation possible.</li> <li><code>POP</code> &ndash; this is our first modification of the stack. It simply discards the topmost value, decreasing the stack's size by one.</li> <li><code>PUSH_U8</code> &ndash; this is the only operation that reads additional data from the program. It only reads a single byte (increasing the program counter by one), and puts it on top of the stack, increasing the stack's size by one. This is how you can get data from your program into the VM, to work with them. It is how numeric literals in your program are handled.</li> <li><code>ADD</code> &ndash; the only operation that works on data. It pops its two operands from the stack, adds them, and pushes the sum back on the stack. This is how data is manipulated in a stack machine. The operation reduces the stack's size by one effectively, but there need to be at least 2 values on it for it to be executed.</li> </ol> <p>That is the out complete VM so far, and it will execute a program, if you compile and run it (which we will do in the next post). </p> <p>You can find the complete program here: </p> <p><a href=https://github.com/kratenko/lovem/blob/v0.0.1-journey/src/main.rs>https://github.com/kratenko/lovem/blob/v0.0.1-journey/src/main.rs</a></p> <p>You can access the repo at this state under (there is also a zip file containing all files):</p> <p><a href=https://github.com/kratenko/lovem/releases/tag/v0.0.1-journey>https://github.com/kratenko/lovem/releases/tag/v0.0.1-journey</a></p> <h2 id=how-do-i-work-with-the-code>How do I work with the code?<a class=headerlink href=#how-do-i-work-with-the-code title="Permanent link">&para;</a></h2> <p>The easy way, to get the code and play with it, would be to clone the git repository and check out the tag <code>v0.0.1-journey</code>. If you did not understand any of that, you might want to do a tutorial on git, before you continue reading. Anyways, here is some copy&amp;paste commands, you can hack into your bash prompt, to do, what I just told you to do. Use at your own risk, I'm not responsible for what you do to your system.</p> <div class=highlight><pre><span></span><code><a id=__codelineno-7-1 name=__codelineno-7-1 href=#__codelineno-7-1></a>you@host:~$<span class=w> </span>git<span class=w> </span>clone<span class=w> </span>https://github.com/kratenko/lovem.git
<a id=__codelineno-7-2 name=__codelineno-7-2 href=#__codelineno-7-2></a>
<a id=__codelineno-7-3 name=__codelineno-7-3 href=#__codelineno-7-3></a>you@host:~$<span class=w> </span><span class=nb>cd</span><span class=w> </span>lovem
<a id=__codelineno-7-4 name=__codelineno-7-4 href=#__codelineno-7-4></a>
<a id=__codelineno-7-5 name=__codelineno-7-5 href=#__codelineno-7-5></a>you@host:~/lovem$<span class=w> </span>git<span class=w> </span>checkout<span class=w> </span>v0.0.1-journey
<a id=__codelineno-7-6 name=__codelineno-7-6 href=#__codelineno-7-6></a>
<a id=__codelineno-7-7 name=__codelineno-7-7 href=#__codelineno-7-7></a>you@host:~/lovam$<span class=w> </span>cargo<span class=w> </span>run<span class=w> </span>lovem
</code></pre></div> <p>This will copy all source code from GitHub and its history to your computer, and it will roll the source code to the state we are looking at in this entry. The last command <code>cargo run lovem</code> will compile and execute the program - that is, if Rust is installed and ready to run (and in the correct version). <code>cargo</code> is Rust's package manager, that handles dependencies and compiles your projects. I will not explain those things further, but now you know what to look for.</p> <script src=https://giscus.app/client.js data-repo=kratenko/lovem data-repo-id=R_kgDOHjmZ5Q data-category=Comments data-category-id=DIC_kwDOHjmZ5c4CQPDu data-mapping=pathname data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=light data-lang=en data-loading=lazy crossorigin=anonymous async>
</script> <div class=footnote> <hr> <ol> <li id=fn:register> <p>Don't let yourself be confused by fancy terms like <em>register</em>. You can think of it as a kind of snobbish variable with a special meaning. In computers sometimes stuff magically happens when you write to a <em>register</em> &ndash; but it should always be documented somewhere.&#160;<a class=footnote-backref href=#fnref:register title="Jump back to footnote 1 in the text">&#8617;</a></p> </li> </ol> </div> </article> </div> </div> <a href=# class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg> Back to top </a> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=running-our-first-program.html class="md-footer__link md-footer__link--prev" aria-label="Previous:  Running our first program" rel=prev> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </div> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Previous </span> Running our first program </div> </div> </a> <a href=it-looks-so-weird.html class="md-footer__link md-footer__link--next" aria-label="Next:  It looks so weird" rel=next> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Next </span> It looks so weird </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-social> <a href=https://github.com/kratenko target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg> </a> <a href=https://chaos.social/@kratenko target=_blank rel=noopener title=chaos.social class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48 0 0 0-63.72 28.5-63.72 125.7 0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54 0 0 1-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "..", "features": ["navigation.indexes", "navigation.sections", "navigation.top", "navigation.tracking", "navigation.expand"], "search": "../assets/javascripts/workers/search.16e2a7d4.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script> <script src=../assets/javascripts/bundle.5a2dcb6a.min.js></script> </body> </html>